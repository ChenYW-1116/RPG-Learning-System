<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>Gemini API Key 診斷工具</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #252540;
            padding: 20px;
            border-radius: 10px;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
        }

        input {
            background: #111;
            color: #0f0;
            font-family: monospace;
        }

        button {
            background: #00d4ff;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            color: #ccc;
        }

        .success {
            color: #0f0;
        }

        .error {
            color: #f55;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>🔍 Gemini API Key 獨立診斷工具</h2>
        <p>此工具獨立於主系統，用於驗證您的 Key 與 Google 伺服器的連線。</p>

        <label>請貼上您的 API Key:</label>
        <input type="text" id="apiKey" placeholder="AIzaSy...">

        <label>選擇測試模型:</label>
        <select id="model"
            style="width:100%; padding:10px; margin:10px 0; background:#111; color:#fff; border:none; border-radius:5px;">
            <option value="gemini-1.5-flash">gemini-1.5-flash (穩定版 - 推薦)</option>
            <option value="gemini-3-flash-preview">gemini-3-flash(最新實驗版)</option>
            <option value="gemini-3-flash-preview">gemini-2.5-flash-preview (您目前設定的)</option>
        </select>

        <button onclick="testKey()">🚀 開始測試 (Test Connection)</button>

        <div id="log">等待測試...</div>

        <hr style="margin: 20px 0; border: 1px solid #444;">

        <h3>💾 LocalStorage 檢測 (Storage Inspector)</h3>
        <p>檢測是否有殘留的舊 Key 或設定導致問題。</p>

        <div id="storage-info"
            style="background: #111; padding: 10px; border-radius: 5px; font-family: monospace; color: #aaa; margin-bottom: 10px;">
            讀取中...
        </div>

        <button onclick="clearGeminiStorage()" style="background: #f55; color: #fff;">🗑️ 清除所有 Gemini 設定 (Clear
            Config)</button>
    </div>

    <script>
        function log(msg, type = '') {
            const el = document.getElementById('log');
            const span = document.createElement('div');
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type) span.className = type;
            el.appendChild(span);
            el.scrollTop = el.scrollHeight;
        }

        async function testKey() {
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('model').value;

            if (!key) return log('❌ 請先輸入 API Key', 'error');

            log(`-----------------------------------`);
            log(`開始測試...`);
            log(`Key: ${key.substring(0, 8)}...${key.substring(key.length - 4)}`);
            log(`Model: ${model}`);

            // 檢查是否包含空白等隱藏字元
            if (key !== key.trim() || key.includes(' ')) {
                log(`⚠️ 警告: Key 包含空白字元，已自動移除`, 'error');
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
            log(`請求 URL: ${url.split('?')[0]}...`);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: "Hello, reply 'OK' if you see this." }] }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        const reply = data.candidates[0].content.parts[0].text;
                        log(`✅ 測試成功!`, 'success');
                        log(`🤖 Google 回應: ${reply}`, 'success');
                    } else {
                        log(`⚠️ 請求成功但無內容: ${JSON.stringify(data)}`);
                    }
                } else {
                    const text = await response.text();
                    log(`❌ 測試失敗 (HTTP ${response.status})`, 'error');
                    log(`錯誤詳情: ${text}`, 'error');

                    if (response.status === 400 && text.includes('API_KEY_INVALID')) {
                        log(`👉 結論: Google 拒絕了這把 Key。可能原因：\n1. Key 真的已經失效\n2. 該 Project 未啟用 Generative Language API\n3. Key 有 IP/Referrer 限制`, 'error');
                    } else if (response.status === 404) {
                        log(`👉 結論: 找不到模型 (${model})。請嘗試切換到 gemini-1.5-flash`, 'error');
                    }
                }
            } catch (e) {
                log(`❌ 連線錯誤: ${e.message}`, 'error');
            }
        }

        // 🟢 新增：檢查 LocalStorage 並顯示
        function checkStorage() {
            const infoEl = document.getElementById('storage-info');
            const simpleKey = localStorage.getItem('gemini_api_key');
            const fullConfig = localStorage.getItem('speckit_config');

            let html = '';

            if (simpleKey) {
                html += `<div><strong>gemini_api_key:</strong> <span style="color: #f77;">${simpleKey.substring(0, 10)}...${simpleKey.slice(-4)}</span></div>`;
            } else {
                html += `<div><strong>gemini_api_key:</strong> <span style="color: #666;">(未設定)</span></div>`;
            }

            if (fullConfig) {
                try {
                    const cfg = JSON.parse(fullConfig);
                    const gemini = cfg.gemini || {};
                    const key = gemini.key || '';
                    const backupKeys = gemini.keys || [];

                    html += `<div style="margin-top:5px;"><strong>speckit_config (Active Key):</strong> <span style="color: #f77;">${key ? key.substring(0, 10) + '...' + key.slice(-4) : '(無)'}</span></div>`;

                    if (backupKeys.length > 0) {
                        html += `<div><strong>Backup Keys (${backupKeys.length}):</strong></div>`;
                        backupKeys.forEach((k, i) => {
                            html += `<div style="padding-left:10px;">- Key #${i + 1}: ${k.substring(0, 10)}...</div>`;
                        });
                    }
                } catch (e) {
                    html += `<div><strong>speckit_config:</strong> (JSON 解析失敗)</div>`;
                }
            } else {
                html += `<div><strong>speckit_config:</strong> <span style="color: #666;">(未設定)</span></div>`;
            }

            if (!simpleKey && !fullConfig) {
                html = '✅ LocalStorage 乾淨 (無殘留設定)';
            }

            infoEl.innerHTML = html;
        }

        // 🟢 新增：清除設定
        function clearGeminiStorage() {
            if (!confirm('確定要清除所有 Gemini 相關的 LocalStorage 設定嗎？\n這將移除您儲存的 API Key。')) return;

            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('speckit_config');
            checkStorage();
            log('已清除 LocalStorage 設定。請重新整理主頁面並輸入新的 Key。', 'success');
        }

        // 初始執行檢查
        checkStorage();
    </script>
</body>

</html>