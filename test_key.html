<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>Gemini API Key è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #252540;
            padding: 20px;
            border-radius: 10px;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
        }

        input {
            background: #111;
            color: #0f0;
            font-family: monospace;
        }

        button {
            background: #00d4ff;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            color: #ccc;
        }

        .success {
            color: #0f0;
        }

        .error {
            color: #f55;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>ğŸ” Gemini API Key ç¨ç«‹è¨ºæ–·å·¥å…·</h2>
        <p>æ­¤å·¥å…·ç¨ç«‹æ–¼ä¸»ç³»çµ±ï¼Œç”¨æ–¼é©—è­‰æ‚¨çš„ Key èˆ‡ Google ä¼ºæœå™¨çš„é€£ç·šã€‚</p>

        <label>è«‹è²¼ä¸Šæ‚¨çš„ API Key:</label>
        <input type="text" id="apiKey" placeholder="AIzaSy...">

        <label>é¸æ“‡æ¸¬è©¦æ¨¡å‹:</label>
        <select id="model"
            style="width:100%; padding:10px; margin:10px 0; background:#111; color:#fff; border:none; border-radius:5px;">
            <option value="gemini-1.5-flash">gemini-1.5-flash (ç©©å®šç‰ˆ - æ¨è–¦)</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash (æœ€æ–°å¯¦é©—ç‰ˆ)</option>
            <option value="gemini-2.5-flash-preview-09-2025">gemini-2.5-flash-preview (æ‚¨ç›®å‰è¨­å®šçš„)</option>
        </select>

        <button onclick="testKey()">ğŸš€ é–‹å§‹æ¸¬è©¦ (Test Connection)</button>

        <div id="log">ç­‰å¾…æ¸¬è©¦...</div>

        <hr style="margin: 20px 0; border: 1px solid #444;">

        <h3>ğŸ’¾ LocalStorage æª¢æ¸¬ (Storage Inspector)</h3>
        <p>æª¢æ¸¬æ˜¯å¦æœ‰æ®˜ç•™çš„èˆŠ Key æˆ–è¨­å®šå°è‡´å•é¡Œã€‚</p>

        <div id="storage-info"
            style="background: #111; padding: 10px; border-radius: 5px; font-family: monospace; color: #aaa; margin-bottom: 10px;">
            è®€å–ä¸­...
        </div>

        <button onclick="clearGeminiStorage()" style="background: #f55; color: #fff;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ Gemini è¨­å®š (Clear
            Config)</button>
    </div>

    <script>
        function log(msg, type = '') {
            const el = document.getElementById('log');
            const span = document.createElement('div');
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type) span.className = type;
            el.appendChild(span);
            el.scrollTop = el.scrollHeight;
        }

        async function testKey() {
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('model').value;

            if (!key) return log('âŒ è«‹å…ˆè¼¸å…¥ API Key', 'error');

            log(`-----------------------------------`);
            log(`é–‹å§‹æ¸¬è©¦...`);
            log(`Key: ${key.substring(0, 8)}...${key.substring(key.length - 4)}`);
            log(`Model: ${model}`);

            // æª¢æŸ¥æ˜¯å¦åŒ…å«ç©ºç™½ç­‰éš±è—å­—å…ƒ
            if (key !== key.trim() || key.includes(' ')) {
                log(`âš ï¸ è­¦å‘Š: Key åŒ…å«ç©ºç™½å­—å…ƒï¼Œå·²è‡ªå‹•ç§»é™¤`, 'error');
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
            log(`è«‹æ±‚ URL: ${url.split('?')[0]}...`);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: "Hello, reply 'OK' if you see this." }] }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        const reply = data.candidates[0].content.parts[0].text;
                        log(`âœ… æ¸¬è©¦æˆåŠŸ!`, 'success');
                        log(`ğŸ¤– Google å›æ‡‰: ${reply}`, 'success');
                    } else {
                        log(`âš ï¸ è«‹æ±‚æˆåŠŸä½†ç„¡å…§å®¹: ${JSON.stringify(data)}`);
                    }
                } else {
                    const text = await response.text();
                    log(`âŒ æ¸¬è©¦å¤±æ•— (HTTP ${response.status})`, 'error');
                    log(`éŒ¯èª¤è©³æƒ…: ${text}`, 'error');

                    if (response.status === 400 && text.includes('API_KEY_INVALID')) {
                        log(`ğŸ‘‰ çµè«–: Google æ‹’çµ•äº†é€™æŠŠ Keyã€‚å¯èƒ½åŸå› ï¼š\n1. Key çœŸçš„å·²ç¶“å¤±æ•ˆ\n2. è©² Project æœªå•Ÿç”¨ Generative Language API\n3. Key æœ‰ IP/Referrer é™åˆ¶`, 'error');
                    } else if (response.status === 404) {
                        log(`ğŸ‘‰ çµè«–: æ‰¾ä¸åˆ°æ¨¡å‹ (${model})ã€‚è«‹å˜—è©¦åˆ‡æ›åˆ° gemini-1.5-flash`, 'error');
                    }
                }
            } catch (e) {
                log(`âŒ é€£ç·šéŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        // ğŸŸ¢ æ–°å¢ï¼šæª¢æŸ¥ LocalStorage ä¸¦é¡¯ç¤º
        function checkStorage() {
            const infoEl = document.getElementById('storage-info');
            const simpleKey = localStorage.getItem('gemini_api_key');
            const fullConfig = localStorage.getItem('speckit_config');

            let html = '';

            if (simpleKey) {
                html += `<div><strong>gemini_api_key:</strong> <span style="color: #f77;">${simpleKey.substring(0, 10)}...${simpleKey.slice(-4)}</span></div>`;
            } else {
                html += `<div><strong>gemini_api_key:</strong> <span style="color: #666;">(æœªè¨­å®š)</span></div>`;
            }

            if (fullConfig) {
                try {
                    const cfg = JSON.parse(fullConfig);
                    const gemini = cfg.gemini || {};
                    const key = gemini.key || '';
                    const backupKeys = gemini.keys || [];

                    html += `<div style="margin-top:5px;"><strong>speckit_config (Active Key):</strong> <span style="color: #f77;">${key ? key.substring(0, 10) + '...' + key.slice(-4) : '(ç„¡)'}</span></div>`;

                    if (backupKeys.length > 0) {
                        html += `<div><strong>Backup Keys (${backupKeys.length}):</strong></div>`;
                        backupKeys.forEach((k, i) => {
                            html += `<div style="padding-left:10px;">- Key #${i + 1}: ${k.substring(0, 10)}...</div>`;
                        });
                    }
                } catch (e) {
                    html += `<div><strong>speckit_config:</strong> (JSON è§£æå¤±æ•—)</div>`;
                }
            } else {
                html += `<div><strong>speckit_config:</strong> <span style="color: #666;">(æœªè¨­å®š)</span></div>`;
            }

            if (!simpleKey && !fullConfig) {
                html = 'âœ… LocalStorage ä¹¾æ·¨ (ç„¡æ®˜ç•™è¨­å®š)';
            }

            infoEl.innerHTML = html;
        }

        // ğŸŸ¢ æ–°å¢ï¼šæ¸…é™¤è¨­å®š
        function clearGeminiStorage() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ Gemini ç›¸é—œçš„ LocalStorage è¨­å®šå—ï¼Ÿ\né€™å°‡ç§»é™¤æ‚¨å„²å­˜çš„ API Keyã€‚')) return;

            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('speckit_config');
            checkStorage();
            log('å·²æ¸…é™¤ LocalStorage è¨­å®šã€‚è«‹é‡æ–°æ•´ç†ä¸»é é¢ä¸¦è¼¸å…¥æ–°çš„ Keyã€‚', 'success');
        }

        // åˆå§‹åŸ·è¡Œæª¢æŸ¥
        checkStorage();
    </script>
</body>

</html>