<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub æª”æ¡ˆç®¡ç†çµ‚ç«¯ v2.9.6 (Exe Support + AI Path + Gamified Heatmap)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Dev-Scribe RPG Engine -->
    <script src="DevScribeRPG.js"></script>


    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F172A, #1E293B);
            min-height: 100vh;
            color: #E2E8F0;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563EB, #7C3AED);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #B91C1C);
            transition: all 0.3s ease;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .input-field {
            background: #0F172A;
            border: 1px solid #334155;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            outline: none;
        }

        /* --- Tree View Specific Styles --- */
        .tree-container {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            /* VS Code style font */
            font-size: 13px;
        }

        .tree-node {
            display: flex;
            align-items: center;
            padding: 3px 0;
            cursor: pointer;
            color: #cbd5e1;
            user-select: none;
            transition: background-color 0.1s;
        }

        .tree-node:hover {
            background-color: #334155;
            color: #fff;
        }

        .tree-node.selected {
            background-color: #2563eb !important;
            /* VS Code Blue */
            color: #fff !important;
        }

        .tree-toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #94a3b8;
            transition: transform 0.2s ease;
        }

        .tree-toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .tree-toggle-icon.invisible {
            visibility: hidden;
        }

        .tree-icon {
            margin-right: 6px;
            width: 16px;
            text-align: center;
        }

        .tree-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading indicator inside tree */
        .tree-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 4px;
        }

        .drag-over {
            border-color: #3B82F6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            transform: scale(1.02);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
            color: #fff;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body li {
            margin-bottom: 0.3em;
        }

        .markdown-body code {
            background-color: #334155;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
        }

        .markdown-body pre {
            background-color: #1e293b;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-body p {
            margin-bottom: 0.8em;
        }

        .markdown-body strong {
            color: #A5B4FC;
        }

        /* --- Heatmap Contribution Graph Styles (Enhanced) --- */
        .heatmap-container {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background-color: #1e293b;
            /* é è¨­: ç„¡è²¢ç» */
            position: relative;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .heatmap-day:hover {
            border: 1px solid rgba(255, 255, 255, 0.8);
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        /* Contribution Levels (Enhanced Green Colors) */
        .level-0 {
            background-color: #1e293b;
        }

        .level-1 {
            background-color: #0e4429;
        }

        .level-2 {
            background-color: #006d32;
        }

        .level-3 {
            background-color: #26a641;
        }

        .level-4 {
            background-color: #39d353;
            box-shadow: 0 0 4px rgba(57, 211, 83, 0.4);
            /* Glow for max effort */
        }

        /* Stats Cards */
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Custom Tooltip for Heatmap */
        .heatmap-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid #334155;
            z-index: 50;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <!-- Gemini API Key Status Container -->
    <div class="fixed top-4 right-4 z-50">
        <div class="glass-card flex items-center gap-4 text-left shadow-2xl">
            <div class="flex-1 flex items-center gap-3">
                <label class="block text-xs font-bold text-indigo-400 tracking-wider">GEMINI AI</label>
                <span id="gemini-key-status-container" class="text-sm"></span>
            </div>
            <div class="text-xs text-gray-500 hidden md:block border-l border-gray-700 pl-3">
                <i class="fas fa-shield-alt text-green-400"></i> <span data-i18n="keySafe">Key åƒ…ä¿å­˜åœ¨æœ¬åœ°</span>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- å·¦å´é¢æ¿ï¼šè¨­å®šèˆ‡æª”æ¡ˆç€è¦½å™¨ -->
        <div class="lg:col-span-1 space-y-6">

            <!-- 1. è¨­å®šå€å¡Š -->
            <div class="glass-panel rounded-2xl p-6 shadow-xl relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center text-blue-400">
                        <i class="fa-brands fa-github mr-2"></i> <span data-i18n="repoSettings">å€‰åº«è¨­å®š</span>
                    </h2>
                    <button id="langToggleBtn" onclick="toggleLanguage()"
                        class="bg-slate-700 hover:bg-slate-600 text-gray-300 text-xs py-1.5 px-3 rounded-lg border border-slate-600 transition flex items-center">
                        <i class="fa-solid fa-globe mr-1"></i> EN
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Token -->
                    <div>
                        <div class="flex justify-between items-end">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider"
                                data-i18n="githubToken">GitHub PAT Token</label>
                            <span id="tokenStatus" class="text-[10px] text-green-400 opacity-0 transition-opacity"><i
                                    class="fa-solid fa-check"></i> <span data-i18n="tokenSaved">å·²ç´€éŒ„</span></span>
                        </div>
                        <div class="relative">
                            <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx"
                                class="input-field w-full p-2.5 rounded-lg text-sm mt-1 pr-10">
                            <button onclick="toggleTokenVisibility('token', 'eyeIcon')"
                                class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                                <i class="fa-regular fa-eye" id="eyeIcon"></i>
                            </button>
                        </div>

                        <div class="flex items-center mt-2 group cursor-pointer">
                            <input type="checkbox" id="saveToken"
                                class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500 cursor-pointer w-4 h-4">
                            <label for="saveToken"
                                class="ml-2 text-xs text-gray-400 group-hover:text-blue-300 transition-colors cursor-pointer select-none">
                                <i class="fa-solid fa-database mr-1"></i> <span data-i18n="autoSaveToken">è‡ªå‹•å„²å­˜ Token
                                    (ä¸‹æ¬¡å•Ÿå‹•è‡ªå‹•å¸¶å…¥)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Gemini API Key (Managed Globally) -->
                    <div class="border-t border-slate-700 pt-4">
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="fa-solid fa-robot mr-1"></i> Gemini API</span>
                            <span class="text-indigo-400">Managed via Hub</span>
                        </div>
                    </div>

                    <!-- Repo & Branch -->
                    <div class="border-t border-slate-700 pt-4">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider"
                                data-i18n="ownerRepo">Owner / Repo</label>
                            <button onclick="fetchRepositories(document.getElementById('token').value)"
                                class="text-[10px] text-blue-400 hover:text-blue-300" title="é‡æ–°æ•´ç†åˆ—è¡¨">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                        <select id="repo" onchange="fetchBranches(document.getElementById('token').value)"
                            class="input-field w-full p-2.5 rounded-lg text-sm mt-1 appearance-none">
                            <option value="t26020402-debug/Personal_Learning_Database">
                                t26020402-debug/Personal_Learning_Database</option>
                            <option value="" disabled>è«‹è¼¸å…¥ Token ä»¥è®€å–æ›´å¤š...</option>
                        </select>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider"
                                data-i18n="branch">Branch</label>
                        </div>
                        <select id="branch" class="input-field w-full p-2.5 rounded-lg text-sm mt-1 appearance-none">
                            <option value="master">master</option>
                        </select>
                    </div>

                    <button onclick="initTreeBrowser()"
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 rounded-lg text-sm transition flex justify-center items-center shadow-lg mt-4">
                        <i class="fa-solid fa-rotate mr-2"></i> <span data-i18n="connectAndLoad">é€£ç·šä¸¦è®€å– (Root)</span>
                    </button>

                    <!-- æ‰‹å‹•å‚™ä»½å€å¡Š -->
                    <div class="border-t border-slate-700 pt-4 mt-2">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="configBackup">è¨­å®šæª”å‚™ä»½
                                (Config Backup)</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="ConfigDB.exportToFile()"
                                class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 rounded border border-gray-600 transition">
                                <i class="fa-solid fa-download mr-1"></i> <span
                                    data-i18n="exportConfig">åŒ¯å‡ºè¨­å®š.json</span>
                            </button>
                            <button onclick="document.getElementById('importConfigInput').click()"
                                class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 rounded border border-gray-600 transition">
                                <i class="fa-solid fa-upload mr-1"></i> <span data-i18n="importConfig">åŒ¯å…¥è¨­å®š.json</span>
                            </button>
                            <input type="file" id="importConfigInput" accept=".json" class="hidden"
                                onchange="ConfigDB.importFromFile(this)">
                        </div>
                        <p class="text-[9px] text-gray-500 mt-1 text-center" data-i18n="configBackupHint">
                            å¯å°‡è¨­å®šåŒ¯å‡ºç‚ºå¯¦é«”æª”æ¡ˆä¿å­˜æ–¼é›»è…¦</p>
                    </div>
                </div>
            </div>

            <!-- 2. æª”æ¡ˆç€è¦½å™¨ (Tree View) -->
            <div class="glass-panel rounded-2xl p-4 shadow-xl flex flex-col h-[500px]">
                <div class="flex items-center justify-between mb-2 pb-2 border-b border-slate-700">
                    <h2 class="text-lg font-bold flex items-center text-emerald-400">
                        <i class="fa-regular fa-folder-open mr-2"></i> <span data-i18n="fileBrowser">æª”æ¡ˆç€è¦½å™¨</span>
                    </h2>
                    <span id="repoNameDisplay" class="text-xs text-gray-500 font-mono"></span>
                </div>

                <!-- æ¨¹ç‹€åˆ—è¡¨å€åŸŸ -->
                <div id="fileList"
                    class="flex-grow overflow-y-auto overflow-x-hidden bg-[#0F172A] rounded border border-slate-800 p-1 tree-container">
                    <div class="text-center text-gray-500 mt-10 text-xs">
                        <p data-i18n="enterSettingsHint">è«‹è¼¸å…¥è¨­å®šä¸¦é»æ“Šä¸Šæ–¹<br>ã€Œé€£ç·šä¸¦è®€å–ã€æŒ‰éˆ•</p>
                    </div>
                </div>

                <div class="mt-2 text-[10px] text-gray-500 text-center flex justify-between px-2">
                    <span><i class="fa-solid fa-mouse-pointer mr-1"></i><span
                            data-i18n="clickToSelect">é»æ“Šé¸å–</span></span>
                    <span><i class="fa-solid fa-chevron-right mr-1"></i><span
                            data-i18n="expandFolder">å±•é–‹è³‡æ–™å¤¾</span></span>
                </div>
            </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šä¸Šå‚³èˆ‡æ“ä½œå€ -->
        <div class="lg:col-span-2 space-y-6">

            <!-- 3. ä¸Šå‚³/ç·¨è¼¯å€ -->
            <div class="glass-panel rounded-2xl p-6 md:p-10 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="fa-brands fa-git-alt text-9xl"></i>
                </div>

                <h1 class="text-3xl font-extrabold text-white mb-4 tracking-tight flex items-center gap-3">
                    <span data-i18n="uploadTitle">æª”æ¡ˆä¸Šå‚³èˆ‡æ™ºèƒ½æ“ä½œ</span>
                    <span class="text-xs font-normal bg-blue-600 text-white px-2 py-1 rounded-full align-middle"
                        data-i18n="aiPowered">AI
                        Powered</span>
                </h1>

                <div class="mb-6">
                    <a href="rpg-hub.html"
                        class="inline-flex items-center px-4 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600 rounded-full text-indigo-400 hover:text-indigo-300 text-sm transition"
                        data-i18n="backLink">
                        â† è¿”å› Quest Empire
                    </a>
                </div>

                <!-- RPG Status Card -->
                <div id="rpg-status-card" class="mb-6 max-w-md mx-auto md:mx-0"></div>

                <!-- ç›®æ¨™è·¯å¾‘ (AI æ¨è–¦æŒ‰éˆ•) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1" data-i18n="targetPath">ç›®æ¨™è·¯å¾‘
                        (å«æª”å)</label>
                    <div class="flex gap-2">
                        <div class="flex flex-1">
                            <span
                                class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-600 bg-slate-700 text-gray-400 text-sm">
                                /
                            </span>
                            <input type="text" id="targetPath" placeholder="folder/filename.ext"
                                class="input-field flex-1 p-3 rounded-r-lg focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                        <button onclick="suggestPathWithAI()" id="btnAiPath"
                            class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-3 py-2 text-xs font-bold transition flex items-center shadow-lg whitespace-nowrap border border-indigo-400/50">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> <span data-i18n="aiSuggestPath">AI
                                æ¨è–¦ä½ç½®</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-1" data-i18n="targetPathHint">ä¸Šå‚³å‰è«‹ç¢ºèªè·¯å¾‘ã€‚å¯æ‰‹å‹•è¼¸å…¥æˆ–é»æ“Šã€ŒAI
                        æ¨è–¦ä½ç½®ã€ç”±ç³»çµ±è‡ªå‹•åˆ¤æ–·ã€‚</p>
                </div>

                <!-- æª”æ¡ˆé¸æ“‡å€åŸŸ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2" data-i18n="selectFile">é¸æ“‡æª”æ¡ˆ</label>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- æ‹–æ”¾å€ -->
                        <div id="dropZone"
                            class="md:col-span-2 relative border-2 border-dashed border-slate-600 rounded-xl p-6 hover:border-blue-500 transition-all duration-200 cursor-pointer bg-slate-800/50 flex flex-col items-center justify-center"
                            onclick="document.getElementById('fileInput').click()" ondragover="handleDragOver(event)"
                            ondragleave="handleDragLeave(event)" ondrop="handleFileDrop(event)">

                            <input type="file" id="fileInput" class="hidden"
                                accept=".txt,.html,.css,.js,.json,.md,.png,.jpg,.jpeg,.gif,.svg,.webp,.py,.java,.cpp,.ts,.tsx,.jsx"
                                onchange="handleFileSelect(this)">

                            <div class="text-center space-y-2 pointer-events-none">
                                <i
                                    class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-blue-400 transition"></i>
                                <p id="fileNameDisplay" class="text-sm text-gray-300 font-medium"
                                    data-i18n="dropOrClick">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
                                <p class="text-[10px] text-gray-500 leading-tight max-w-xs mx-auto">
                                    <span data-i18n="supportedFormats">æ”¯æ´æ ¼å¼:</span> <br>
                                    <span class="text-gray-400" data-i18n="textCode">æ–‡å­—/ä»£ç¢¼:</span> .txt, .md, .html,
                                    .css, .js, .py, .json,
                                    .cpp, .java<br>
                                    <span class="text-gray-400" data-i18n="images">åœ–ç‰‡:</span> .png, .jpg, .jpeg, .gif,
                                    .svg, .webp
                                </p>
                            </div>
                        </div>

                        <!-- é è¦½å€ -->
                        <div
                            class="md:col-span-1 border border-slate-700 rounded-xl bg-slate-900 flex items-center justify-center overflow-hidden relative min-h-[120px]">
                            <img id="imagePreview" class="hidden w-full h-full object-contain p-1" alt="Preview">
                            <div id="textPreviewIcon" class="hidden text-gray-600 flex flex-col items-center gap-2">
                                <i class="fa-regular fa-file-code text-4xl"></i>
                                <span class="text-xs" data-i18n="codeFile">ç¨‹å¼ç¢¼æª”æ¡ˆ</span>
                            </div>
                            <span id="noPreviewText" class="text-xs text-gray-600" data-i18n="noPreview">ç„¡é è¦½</span>

                            <!-- æ¸…é™¤æŒ‰éˆ• -->
                            <button onclick="clearFileSelection(event)" id="clearFileBtn"
                                class="hidden absolute top-1 right-1 bg-red-500/80 hover:bg-red-600 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs backdrop-blur-sm shadow-md">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gemini AI åŠŸèƒ½å€ -->
                <div class="mb-6 p-4 rounded-xl border border-indigo-500/30 bg-indigo-900/10">
                    <label class="block text-sm font-bold text-indigo-300 mb-3 flex items-center">
                        <i class="fa-solid fa-robot mr-2"></i> <span data-i18n="geminiAssistant">Gemini AI æ™ºèƒ½åŠ©æ‰‹</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="runGeminiTask('summary')" id="btnSummary" disabled
                            class="bg-indigo-600/20 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-file-lines mr-2"></i> <span data-i18n="fileSummary">æª”æ¡ˆæ‘˜è¦</span>
                        </button>
                        <button onclick="runGeminiTask('commit')" id="btnCommitMsg" disabled
                            class="bg-amber-600/20 border border-amber-500/30 text-amber-300 hover:bg-amber-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-message mr-2"></i> <span data-i18n="writeCommitMsg">å¯« Commit è¨Šæ¯</span>
                        </button>
                        <button onclick="runGeminiTask('review')" id="btnCodeReview" disabled
                            class="bg-emerald-600/20 border border-emerald-500/30 text-emerald-300 hover:bg-emerald-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed relative overflow-hidden group">
                            <span
                                class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></span>
                            <i class="fa-solid fa-bug-slash mr-2"></i> <span data-i18n="smartCodeReview">âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥</span>
                        </button>
                    </div>

                    <!-- Gemini è¼¸å‡ºå€å¡Š -->
                    <div id="geminiOutputContainer" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-indigo-300 font-bold" id="aiOutputTitle" data-i18n="aiResponse">AI
                                å›æ‡‰:</span>
                            <button onclick="document.getElementById('geminiOutputContainer').classList.add('hidden')"
                                class="text-xs text-gray-500 hover:text-white">
                                <i class="fa-solid fa-times"></i> <span data-i18n="close">é—œé–‰</span>
                            </button>
                        </div>
                        <div id="geminiOutput"
                            class="p-4 bg-slate-800/80 border border-indigo-500/20 rounded-lg text-sm text-gray-200 markdown-body max-h-64 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <!-- ğŸŒŸ Contribution Heatmap (Gamified Version) -->
                <div class="mb-6 p-4 rounded-xl border border-slate-700 bg-slate-800/50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center">
                            <i class="fa-solid fa-chart-line mr-2 text-green-400"></i> <span
                                data-i18n="recentContributions">è¿‘æœŸè²¢ç»æ¦‚è¦½ (Activity)</span>
                        </label>
                        <span class="text-[10px] text-gray-500" data-i18n="last90Days">Last 90 Days</span>
                    </div>

                    <!-- Stats Dashboard (NEW) -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <!-- Streak Card -->
                        <div class="stat-card p-3 rounded-lg text-center">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1"
                                data-i18n="currentStreak">Current Streak</div>
                            <div class="flex items-center justify-center text-xl font-bold text-orange-400">
                                <i class="fa-solid fa-fire mr-1.5 animate-pulse"></i> <span id="statStreak">0</span>
                            </div>
                            <div class="text-[9px] text-gray-500 mt-1"><span data-i18n="bestStreak">Best:</span> <span
                                    id="statMaxStreak">0</span> <span data-i18n="days">Days</span>
                            </div>
                        </div>

                        <!-- Total Card -->
                        <div class="stat-card p-3 rounded-lg text-center">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1"
                                data-i18n="totalCommits">Total Commits</div>
                            <div class="flex items-center justify-center text-xl font-bold text-blue-400">
                                <span id="statTotal">0</span>
                            </div>
                            <div class="text-[9px] text-gray-500 mt-1" data-i18n="in3Months">In 3 Months</div>
                        </div>

                        <!-- Rank Card -->
                        <div class="stat-card p-3 rounded-lg text-center">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1"
                                data-i18n="currentRank">Current Rank</div>
                            <div
                                class="flex items-center justify-center text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                                <span id="statRank">Novice</span>
                            </div>
                            <div class="text-[9px] text-gray-500 mt-1" id="nextLevelMsg">Keep coding!</div>
                        </div>
                    </div>

                    <div class="overflow-x-auto pb-1">
                        <div id="contributionHeatmap"
                            class="heatmap-container min-h-[60px] flex items-center justify-center text-gray-500 text-xs"
                            data-i18n="loading">
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                    <div class="flex items-center justify-end mt-2 gap-1 text-[10px] text-gray-500">
                        <span data-i18n="less">Less</span>
                        <div class="w-2.5 h-2.5 rounded bg-[#1e293b]"></div>
                        <div class="w-2.5 h-2.5 rounded bg-[#0e4429]"></div>
                        <div class="w-2.5 h-2.5 rounded bg-[#006d32]"></div>
                        <div class="w-2.5 h-2.5 rounded bg-[#26a641]"></div>
                        <div class="w-2.5 h-2.5 rounded bg-[#39d353]"></div>
                        <span data-i18n="more">More</span>
                    </div>
                </div>

                <!-- Commit Message -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1" data-i18n="commitMessage">Commit
                        Message</label>
                    <input type="text" id="commitMessage" value="Update via AI GitHub Manager"
                        class="input-field w-full p-3 rounded-lg">
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="performAction('upload')" id="btnUpload"
                        class="btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerUpload" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-cloud-upload-alt mr-2"></i> <span data-i18n="uploadUpdate">ä¸Šå‚³ / æ›´æ–°</span>
                    </button>
                    <button onclick="performAction('delete')" id="btnDelete"
                        class="btn-danger text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerDelete" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-trash-alt mr-2"></i> <span data-i18n="deleteFile">åˆªé™¤æª”æ¡ˆ</span>
                    </button>
                </div>
            </div>

            <!-- ç‹€æ…‹èˆ‡çµæœ -->
            <div id="statusArea" class="hidden p-4 rounded-xl border transition-all duration-300">
                <div class="flex items-start">
                    <i id="statusIcon" class="fa-solid fa-circle-info mt-1 mr-3"></i>
                    <div class="flex-1 overflow-hidden">
                        <h4 id="statusTitle" class="font-bold text-sm mb-1" data-i18n="statusUpdate">ç‹€æ…‹æ›´æ–°</h4>
                        <p id="statusMsg" class="text-xs opacity-90 break-all"></p>

                        <!-- æˆåŠŸå¾Œçš„é€£çµ -->
                        <div id="successLinks" class="hidden mt-3 pt-3 border-t border-white/20">
                            <label class="text-[10px] uppercase font-bold opacity-70" data-i18n="rawUrl">Raw URL</label>
                            <div class="flex mt-1">
                                <input type="text" id="resultUrl" readonly
                                    class="bg-black/20 border-none rounded-l text-xs w-full px-2 py-1 select-all text-white">
                                <button onclick="copyUrl()"
                                    class="bg-white/20 hover:bg-white/30 px-3 rounded-r text-xs font-bold transition"
                                    data-i18n="copy">
                                    COPY
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Tooltip Element -->
    <div id="heatmapTooltip" class="heatmap-tooltip"></div>

    <script>
        // --- Internationalization (i18n) System ---
        const i18n = {
            currentLang: 'zh',
            translations: {
                zh: {
                    // Page Title
                    pageTitle: 'GitHub æª”æ¡ˆç®¡ç†çµ‚ç«¯ v2.9.6',

                    // Settings Panel
                    repoSettings: 'å€‰åº«è¨­å®š',
                    githubToken: 'GitHub PAT Token',
                    tokenSaved: 'å·²ç´€éŒ„',
                    syncComplete: 'åŒæ­¥å®Œæˆ',
                    autoSaveToken: 'è‡ªå‹•å„²å­˜ Token (ä¸‹æ¬¡å•Ÿå‹•è‡ªå‹•å¸¶å…¥)',
                    geminiApiKey: 'Gemini API Key (é¸å¡«)',
                    autoSaveApiKey: 'è‡ªå‹•å„²å­˜ API Key (ä¸‹æ¬¡å•Ÿå‹•è‡ªå‹•å¸¶å…¥)',
                    ownerRepo: 'Owner / Repo',
                    branch: 'Branch',
                    connectAndLoad: 'é€£ç·šä¸¦è®€å– (Root)',
                    configBackup: 'è¨­å®šæª”å‚™ä»½ (Config Backup)',
                    exportConfig: 'åŒ¯å‡ºè¨­å®š.json',
                    importConfig: 'åŒ¯å…¥è¨­å®š.json',
                    configBackupHint: 'å¯å°‡è¨­å®šåŒ¯å‡ºç‚ºå¯¦é«”æª”æ¡ˆä¿å­˜æ–¼é›»è…¦',

                    // File Browser
                    fileBrowser: 'æª”æ¡ˆç€è¦½å™¨',
                    clickToSelect: 'é»æ“Šé¸å–',
                    expandFolder: 'å±•é–‹è³‡æ–™å¤¾',
                    enterSettingsHint: 'è«‹è¼¸å…¥è¨­å®šä¸¦é»æ“Šä¸Šæ–¹<br>ã€Œé€£ç·šä¸¦è®€å–ã€æŒ‰éˆ•',
                    loadingRepoList: 'æ­£åœ¨åŒæ­¥ Repo åˆ—è¡¨...',
                    loadingBranches: 'è®€å–åˆ†æ”¯ä¸­...',
                    noRepoFound: 'æ‰¾ä¸åˆ°ä»»ä½•å€‰åº«',
                    readFailed: 'è®€å–å¤±æ•—',
                    folderReadFailed: 'è®€å–è³‡æ–™å¤¾å¤±æ•—',

                    // Upload Panel
                    uploadTitle: 'æª”æ¡ˆä¸Šå‚³èˆ‡æ™ºèƒ½æ“ä½œ',
                    aiPowered: 'AI Powered',
                    targetPath: 'ç›®æ¨™è·¯å¾‘ (å«æª”å)',
                    aiSuggestPath: 'AI æ¨è–¦ä½ç½®',
                    targetPathHint: 'ä¸Šå‚³å‰è«‹ç¢ºèªè·¯å¾‘ã€‚å¯æ‰‹å‹•è¼¸å…¥æˆ–é»æ“Šã€ŒAI æ¨è–¦ä½ç½®ã€ç”±ç³»çµ±è‡ªå‹•åˆ¤æ–·ã€‚',
                    selectFile: 'é¸æ“‡æª”æ¡ˆ',
                    dropOrClick: 'é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤',
                    supportedFormats: 'æ”¯æ´æ ¼å¼:',
                    textCode: 'æ–‡å­—/ä»£ç¢¼:',
                    images: 'åœ–ç‰‡:',
                    codeFile: 'ç¨‹å¼ç¢¼æª”æ¡ˆ',
                    noPreview: 'ç„¡é è¦½',

                    // Gemini AI
                    geminiAssistant: 'Gemini AI æ™ºèƒ½åŠ©æ‰‹',
                    fileSummary: 'æª”æ¡ˆæ‘˜è¦',
                    writeCommitMsg: 'å¯« Commit è¨Šæ¯',
                    smartCodeReview: 'âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥',
                    aiResponse: 'AI å›æ‡‰:',
                    close: 'é—œé–‰',
                    analyzing: 'Gemini æ­£åœ¨åˆ†ææª”æ¡ˆçµæ§‹...',
                    comparingRemote: 'æ­£åœ¨æ¯”å°é ç«¯æª”æ¡ˆä¸¦ç”Ÿæˆæ‘˜è¦...',
                    codeReviewing: 'æ­£åœ¨é€²è¡Œä»£ç¢¼å¯©æŸ¥...',

                    // Heatmap
                    recentContributions: 'è¿‘æœŸè²¢ç»æ¦‚è¦½ (Activity)',
                    last90Days: 'Last 90 Days',
                    currentStreak: 'Current Streak',
                    bestStreak: 'Best:',
                    days: 'Days',
                    totalCommits: 'Total Commits',
                    in3Months: 'In 3 Months',
                    currentRank: 'Current Rank',
                    loading: 'è¼‰å…¥ä¸­...',
                    less: 'Less',
                    more: 'More',
                    contributions: 'contributions',
                    setTokenRepoHint: 'è«‹å…ˆè¨­å®š Token èˆ‡ Repo ä»¥æª¢è¦–è²¢ç»åœ–',
                    loadingContribData: 'è®€å–è²¢ç»æ•¸æ“š...',

                    // Commit & Actions
                    commitMessage: 'Commit Message',
                    uploadUpdate: 'ä¸Šå‚³ / æ›´æ–°',
                    deleteFile: 'åˆªé™¤æª”æ¡ˆ',

                    // Status Messages
                    statusUpdate: 'ç‹€æ…‹æ›´æ–°',
                    processing: 'æ­£åœ¨è™•ç†è«‹æ±‚...',
                    error: 'ç™¼ç”ŸéŒ¯èª¤',
                    success: 'æ“ä½œæˆåŠŸ',
                    warning: 'è­¦å‘Š',
                    inProgress: 'è™•ç†ä¸­',
                    rawUrl: 'Raw URL',
                    copy: 'COPY',

                    // Error/Info Messages
                    enterTokenRepo: 'è«‹è¼¸å…¥ GitHub Token å’Œ Repository åç¨±ä»¥è®€å–åˆ—è¡¨',
                    selectFileFirst: 'è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ',
                    setGeminiKey: 'è«‹å…ˆè¨­å®š Gemini API Key',
                    setTokenRepoForAnalysis: 'è«‹å…ˆè¨­å®š GitHub Token å’Œ Repository ä»¥ä¾¿åˆ†æè³‡æ–™å¤¾çµæ§‹',
                    fillAllFields: 'è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½ (Token, Repo, Branch, Path, Message)',
                    fileNotChanged: 'æª”æ¡ˆå…§å®¹æœªè®Šæ›´ï¼Œç„¡éœ€ä¸Šå‚³æ›´æ–°ã€‚',
                    aiAnalyzingDiff: 'å…§å®¹æœ‰è®Šå‹•ï¼Œæ­£åœ¨ä½¿ç”¨ AI åˆ†æå·®ç•°ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...',
                    aiSummarizingNew: 'æ–°æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨ AI æ‘˜è¦å…§å®¹ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...',
                    fileNotExist: 'æª”æ¡ˆä¸å­˜åœ¨ï¼Œç„¡æ³•åˆªé™¤',
                    uploadSuccess: 'æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼',
                    updateSuccess: 'æª”æ¡ˆæ›´æ–°æˆåŠŸï¼',
                    deleteSuccess: 'æª”æ¡ˆåˆªé™¤æˆåŠŸï¼',
                    operationFailed: 'æ“ä½œå¤±æ•—',
                    tokenInvalidOrNetwork: 'Token ç„¡æ•ˆæˆ–ç¶²è·¯éŒ¯èª¤',
                    repoSyncFailed: 'Repo åˆ—è¡¨åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèª Token æ¬Šé™ã€‚ç›®å‰ä½¿ç”¨å¿«å–è¨­å®šã€‚',
                    cannotReadBranch: 'ç„¡æ³•è®€å–åˆ†æ”¯',
                    cannotReadCommits: 'ç„¡æ³•è®€å– Commit ç´€éŒ„',
                    configExportSuccess: 'è¨­å®šæª”åŒ¯å‡ºæˆåŠŸï¼',
                    exportCancelledOrFailed: 'åŒ¯å‡ºå·²å–æ¶ˆæˆ–å¤±æ•—ã€‚',
                    pythonExportFailed: 'å‘¼å« Python åŒ¯å‡ºåŠŸèƒ½å¤±æ•—ã€‚',
                    configExported: 'è¨­å®šæª”å·²åŒ¯å‡ºï¼Œè«‹å¦¥å–„ä¿å­˜ã€‚',
                    configImportSuccess: 'è¨­å®šæª”åŒ¯å…¥æˆåŠŸï¼',
                    configFormatError: 'è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥ã€‚',
                    openingSaveDialog: 'æ­£åœ¨é–‹å•Ÿå­˜æª”å°è©±æ¡†...',
                    aiSuggestedPath: 'AI å·²å»ºè­°è·¯å¾‘',
                    aiSuggestFailed: 'AI æ¨è–¦å¤±æ•—',
                    aiRequestFailed: 'AI è«‹æ±‚å¤±æ•—',
                    autoFilledTitle: 'å·²è‡ªå‹•å¡«å…¥æ¨™é¡Œ',
                    newFileMode: '(æ–°æª”æ¡ˆæ¨¡å¼ï¼šç„¡è®Šæ›´æ‘˜è¦)',
                    copySummaryHint: 'â†‘ æ‚¨å¯ä»¥é¸å–ä¸¦è¤‡è£½ä¸Šæ–¹çš„æ‘˜è¦ä½œç‚ºè©³ç´°æè¿°',

                    // Language
                    language: 'èªè¨€',
                    chinese: 'ä¸­æ–‡',
                    english: 'English',

                    // Ranks
                    rankNovice: 'ğŸŒ± æ–°æ‰‹',
                    rankBuilder: 'ğŸ”¨ å»ºé€ è€…',
                    rankContributor: 'ğŸš€ è²¢ç»è€…',
                    rankNinja: 'ğŸ”¥ ç¨‹å¼å¿è€…',
                    rankLegend: 'ğŸ‘‘ Git å‚³å¥‡',
                    // RPG Ranks (DevScribeRPG)
                    rpgRank1: 'æ–°æ‰‹æŒ‘æˆ°è€…',
                    rpgRank2: 'è¦‹ç¿’å†’éšªå®¶',
                    rpgRank3: 'æ¢ç´¢è€…',
                    rpgRank4: 'æŒ‘æˆ°é”äºº',
                    rpgRank5: 'ç²¾è‹±æˆ°å£«',
                    rpgRank6: 'å°ˆå®¶å¼•å°è€…',
                    rpgRank7: 'å¤§å¸«å‰µé€ è€…',
                    rpgRank8: 'å®—å¸«ç…‰é‡‘å¸«',
                    rpgRank9: 'å‚³å¥‡ç· é€ è€…',
                    rpgRank10: 'å¸åœ‹é ˜è¢–',
                    rpgXpNeeded: 'é‚„éœ€ {xp} XP å‡ç´š',
                    backLink: 'â† è¿”å› Quest Empire',
                    msgStart: 'é–‹å§‹ä½ çš„æ—…ç¨‹ï¼',
                    msgKeepBuilding: 'ç¹¼çºŒå»ºé€ ï¼',
                    msgFlyingHigh: 'ä½ æ­£åœ¨é«˜é£›ï¼',
                    msgUnstoppable: 'å‹¢ä¸å¯æ“‹ï¼',
                    msgMaxRespect: 'æœ€é«˜æ•¬æ„ï¼',

                    // Dynamic Messages (JavaScript)
                    analyzingAI: 'åˆ†æä¸­...',
                    fileSummaryTitle: 'ğŸ“„ æª”æ¡ˆæ‘˜è¦',
                    diffSummaryTitle: 'ğŸ’¬ å·®ç•°æ‘˜è¦èˆ‡ Commit å»ºè­°',
                    codeReviewTitle: 'âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥',
                    fileActionSuccess: 'æª”æ¡ˆ{action}æˆåŠŸï¼ Commit SHA: {sha}',
                    actionUpload: 'ä¸Šå‚³',
                    actionUpdate: 'æ›´æ–°',
                    actionDelete: 'åˆªé™¤',
                    refreshList: 'é‡æ–°æ•´ç†åˆ—è¡¨',
                    savedManual: '(Saved/Manual)',
                    private: '(Private)',
                    readFailedWithBranch: '(è®€å–å¤±æ•—)'
                },
                en: {
                    // Page Title
                    pageTitle: 'GitHub File Manager Terminal v2.9.6',

                    // Settings Panel
                    repoSettings: 'Repository Settings',
                    githubToken: 'GitHub PAT Token',
                    tokenSaved: 'Saved',
                    syncComplete: 'Sync Complete',
                    autoSaveToken: 'Auto-save Token (load on next startup)',
                    geminiApiKey: 'Gemini API Key (Optional)',
                    autoSaveApiKey: 'Auto-save API Key (load on next startup)',
                    ownerRepo: 'Owner / Repo',
                    branch: 'Branch',
                    connectAndLoad: 'Connect & Load (Root)',
                    configBackup: 'Config Backup',
                    exportConfig: 'Export Config.json',
                    importConfig: 'Import Config.json',
                    configBackupHint: 'Export settings to a local file for backup',

                    // File Browser
                    fileBrowser: 'File Browser',
                    clickToSelect: 'Click to select',
                    expandFolder: 'Expand folder',
                    enterSettingsHint: 'Please enter settings and click<br>"Connect & Load" button above',
                    loadingRepoList: 'Syncing repository list...',
                    loadingBranches: 'Loading branches...',
                    noRepoFound: 'No repositories found',
                    readFailed: 'Read failed',
                    folderReadFailed: 'Failed to read folder',

                    // Upload Panel
                    uploadTitle: 'File Upload & Smart Operations',
                    aiPowered: 'AI Powered',
                    targetPath: 'Target Path (with filename)',
                    aiSuggestPath: 'AI Suggest Path',
                    targetPathHint: 'Confirm path before uploading. Enter manually or click "AI Suggest Path" for auto-detection.',
                    selectFile: 'Select File',
                    dropOrClick: 'Click or drag file here',
                    supportedFormats: 'Supported formats:',
                    textCode: 'Text/Code:',
                    images: 'Images:',
                    codeFile: 'Code file',
                    noPreview: 'No preview',

                    // Gemini AI
                    geminiAssistant: 'Gemini AI Smart Assistant',
                    fileSummary: 'File Summary',
                    writeCommitMsg: 'Write Commit Message',
                    smartCodeReview: 'âœ¨ Smart Code Review',
                    aiResponse: 'AI Response:',
                    close: 'Close',
                    analyzing: 'Gemini is analyzing file structure...',
                    comparingRemote: 'Comparing with remote file and generating summary...',
                    codeReviewing: 'Performing code review...',

                    // Heatmap
                    recentContributions: 'Recent Contributions (Activity)',
                    last90Days: 'Last 90 Days',
                    currentStreak: 'Current Streak',
                    bestStreak: 'Best:',
                    days: 'Days',
                    totalCommits: 'Total Commits',
                    in3Months: 'In 3 Months',
                    currentRank: 'Current Rank',
                    loading: 'Loading...',
                    less: 'Less',
                    more: 'More',
                    contributions: 'contributions',
                    setTokenRepoHint: 'Set Token & Repo to view contribution graph',
                    loadingContribData: 'Loading contribution data...',

                    // Commit & Actions
                    commitMessage: 'Commit Message',
                    uploadUpdate: 'Upload / Update',
                    deleteFile: 'Delete File',

                    // Status Messages
                    statusUpdate: 'Status Update',
                    processing: 'Processing request...',
                    error: 'Error',
                    success: 'Success',
                    warning: 'Warning',
                    inProgress: 'In Progress',
                    rawUrl: 'Raw URL',
                    copy: 'COPY',

                    // Error/Info Messages
                    enterTokenRepo: 'Please enter GitHub Token and Repository name to load list',
                    selectFileFirst: 'Please select a file to upload first',
                    setGeminiKey: 'Please set Gemini API Key first',
                    setTokenRepoForAnalysis: 'Please set GitHub Token and Repository for folder structure analysis',
                    fillAllFields: 'Please fill all required fields (Token, Repo, Branch, Path, Message)',
                    fileNotChanged: 'File content unchanged, no update needed.',
                    aiAnalyzingDiff: 'Content changed, using AI to analyze diff and generate commit message...',
                    aiSummarizingNew: 'Uploading new file, using AI to summarize and generate commit message...',
                    fileNotExist: 'File does not exist, cannot delete',
                    uploadSuccess: 'File uploaded successfully!',
                    updateSuccess: 'File updated successfully!',
                    deleteSuccess: 'File deleted successfully!',
                    operationFailed: 'Operation failed',
                    tokenInvalidOrNetwork: 'Token invalid or network error',
                    repoSyncFailed: 'Repo list sync failed, please check Token permissions. Using cached settings.',
                    cannotReadBranch: 'Cannot read branches',
                    cannotReadCommits: 'Cannot read commit history',
                    configExportSuccess: 'Config exported successfully!',
                    exportCancelledOrFailed: 'Export cancelled or failed.',
                    pythonExportFailed: 'Failed to call Python export function.',
                    configExported: 'Config exported, please keep it safe.',
                    configImportSuccess: 'Config imported successfully!',
                    configFormatError: 'Config format error, cannot import.',
                    openingSaveDialog: 'Opening save dialog...',
                    aiSuggestedPath: 'AI suggested path',
                    aiSuggestFailed: 'AI suggestion failed',
                    aiRequestFailed: 'AI request failed',
                    autoFilledTitle: 'Auto-filled title',
                    newFileMode: '(New file mode: no change summary)',
                    copySummaryHint: 'â†‘ You can select and copy the summary above as detailed description',

                    // Language
                    language: 'Language',
                    chinese: 'ä¸­æ–‡',
                    english: 'English',

                    // Ranks
                    rankNovice: 'ğŸŒ± Novice',
                    rankBuilder: 'ğŸ”¨ Builder',
                    rankContributor: 'ğŸš€ Contributor',
                    rankNinja: 'ğŸ”¥ Code Ninja',
                    rankLegend: 'ğŸ‘‘ Git Legend',
                    // RPG Ranks (DevScribeRPG)
                    rpgRank1: 'Novice Challenger',
                    rpgRank2: 'Apprentice Adventurer',
                    rpgRank3: 'Explorer',
                    rpgRank4: 'Challenge Master',
                    rpgRank5: 'Elite Warrior',
                    rpgRank6: 'Expert Guide',
                    rpgRank7: 'Master Creator',
                    rpgRank8: 'Grandmaster Alchemist',
                    rpgRank9: 'Legendary Founder',
                    rpgRank10: 'Empire Leader',
                    rpgXpNeeded: 'Need {xp} XP to level up',
                    backLink: 'â† Back to Quest Empire',
                    msgStart: 'Start your journey!',
                    msgKeepBuilding: 'Keep building!',
                    msgFlyingHigh: "You're flying high!",
                    msgUnstoppable: 'Unstoppable!',
                    msgMaxRespect: 'Maximum Respect!',

                    // Dynamic Messages (JavaScript)
                    analyzingAI: 'Analyzing...',
                    fileSummaryTitle: 'ğŸ“„ File Summary',
                    diffSummaryTitle: 'ğŸ’¬ Diff Summary & Commit Suggestion',
                    codeReviewTitle: 'âœ¨ Smart Code Review',
                    fileActionSuccess: 'File {action} successful! Commit SHA: {sha}',
                    actionUpload: 'uploaded',
                    actionUpdate: 'updated',
                    actionDelete: 'deleted',
                    refreshList: 'Refresh list',
                    savedManual: '(Saved/Manual)',
                    private: '(Private)',
                    readFailedWithBranch: '(Read failed)'
                }
            },

            t: function (key) {
                return this.translations[this.currentLang][key] || key;
            },

            setLanguage: function (lang) {
                this.currentLang = lang;
                localStorage.setItem('github_manager_lang', lang);
                this.applyTranslations();
            },

            loadSavedLanguage: function () {
                const savedLang = localStorage.getItem('github_manager_lang');
                if (savedLang && this.translations[savedLang]) {
                    this.currentLang = savedLang;
                }
            },

            applyTranslations: function () {
                // Update all elements with data-i18n attribute
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const translation = this.t(key);
                    if (el.tagName === 'INPUT' && el.type !== 'checkbox') {
                        if (el.placeholder) el.placeholder = translation;
                    } else {
                        el.innerHTML = translation;
                    }
                });

                // Update page title
                document.title = this.t('pageTitle');

                // Update language toggle button
                const langBtn = document.getElementById('langToggleBtn');
                if (langBtn) {
                    langBtn.innerHTML = `<i class="fa-solid fa-globe mr-1"></i> ${this.currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡'}`;
                }

                // Update RPG Status Card (Refresh content with new language)
                if (typeof DevScribeRPG !== 'undefined' && document.getElementById('rpg-status-card')) {
                    document.getElementById('rpg-status-card').innerHTML = DevScribeRPG.generateStatusCardHTML();
                }
            }
        };
        // Expose i18n for external scripts (like DevScribeRPG)
        window.i18n = i18n;

        function toggleLanguage() {
            const newLang = i18n.currentLang === 'zh' ? 'en' : 'zh';
            i18n.setLanguage(newLang);
        }

        // --- å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸ ---
        const DEFAULT_UPLOAD_MESSAGE = "Update via AI GitHub Manager";

        let selectedFile = null;
        let selectedFileBase64 = null;

        // Tree View State
        let currentlySelectedNode = null;

        // --- 1. å°å‹è³‡æ–™åº« (Config Manager) ---
        const ConfigDB = {
            KEYS: {
                GITHUB_TOKEN: 'github_pat_token',
                GEMINI_KEY: 'gemini_api_key',
                REPO: 'github_repo_name',
                BRANCH: 'github_branch_name'
            },

            save: function (key, value) {
                if (value) {
                    localStorage.setItem(key, value);
                    this.showSaveIndicator(key);
                } else {
                    localStorage.removeItem(key);
                    this.hideSaveIndicator(key);
                }
            },

            remove: function (key) {
                localStorage.removeItem(key);
                this.hideSaveIndicator(key);
            },

            get: function (key) {
                return localStorage.getItem(key);
            },

            showSaveIndicator: function (key) {
                let elId = '';
                if (key === this.KEYS.GITHUB_TOKEN) elId = 'tokenStatus';
                if (key === this.KEYS.GEMINI_KEY) elId = 'geminiStatus';

                const el = document.getElementById(elId);
                if (el) el.style.opacity = 1;
            },

            hideSaveIndicator: function (key) {
                let elId = '';
                if (key === this.KEYS.GITHUB_TOKEN) elId = 'tokenStatus';
                if (key === this.KEYS.GEMINI_KEY) elId = 'geminiStatus';

                const el = document.getElementById(elId);
                if (el) el.style.opacity = 0;
            },

            exportToFile: function () {
                const config = {
                    github_token: localStorage.getItem(this.KEYS.GITHUB_TOKEN) || '',
                    gemini_key: localStorage.getItem(this.KEYS.GEMINI_KEY) || '',
                    repo: document.getElementById('repo').value,
                    branch: document.getElementById('branch').value
                };

                const jsonString = JSON.stringify(config, null, 2);

                if (window.pywebview && window.pywebview.api) {
                    showStatus('info', 'æ­£åœ¨é–‹å•Ÿå­˜æª”å°è©±æ¡†...');
                    window.pywebview.api.export_json(jsonString).then(result => {
                        if (result) {
                            showStatus('success', i18n.t('configExportSuccess'));
                        } else {
                            showStatus('warning', i18n.t('exportCancelledOrFailed'));
                        }
                    }).catch(err => {
                        console.error(err);
                        showStatus('error', i18n.t('pythonExportFailed'));
                    });
                } else {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "github_manager_config.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    showStatus('info', i18n.t('configExported'));
                }
            },

            importFromFile: function (inputElement) {
                const file = inputElement.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        if (config.github_token) {
                            document.getElementById('token').value = config.github_token;
                            document.getElementById('saveToken').checked = true;
                            ConfigDB.save(ConfigDB.KEYS.GITHUB_TOKEN, config.github_token);
                            // è‡ªå‹•è§¸ç™¼ Repo åŒæ­¥
                            fetchRepositories(config.github_token, config.repo);
                        }
                        if (config.gemini_key) {
                            // Check if element exists before setting value (it might be removed)
                            const keyEl = document.getElementById('geminiApiKey');
                            if (keyEl) {
                                keyEl.value = config.gemini_key;
                                document.getElementById('saveGeminiKey').checked = true;
                            }
                            ConfigDB.save(ConfigDB.KEYS.GEMINI_KEY, config.gemini_key);
                            // Also update status UI if manager exists
                            if (typeof GeminiKeyManager !== 'undefined') {
                                GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
                            }
                        }
                        // å¦‚æœæœ‰ Branch è¨­å®šï¼Œå…ˆå­˜å…¥ LocalStorageï¼Œè®“ç¨å¾Œçš„ fetchBranches èƒ½æŠ“åˆ°
                        if (config.branch) {
                            ConfigDB.save(ConfigDB.KEYS.BRANCH, config.branch);
                        }

                        showStatus('success', i18n.t('configImportSuccess'));
                    } catch (err) {
                        console.error(err);
                        showStatus('error', i18n.t('configFormatError'));
                    }
                    inputElement.value = '';
                };
                reader.readAsText(file);
            }
        };

        window.onload = async function () {
            // Initialize i18n system
            i18n.loadSavedLanguage();
            i18n.applyTranslations();

            let tokenToUse = ConfigDB.get(ConfigDB.KEYS.GITHUB_TOKEN);

            // Try to fetch from Render Environment
            try {
                const response = await fetch('/api/config/github-token');
                const data = await response.json();
                if (data.token) {
                    tokenToUse = data.token;
                    console.log('GitHub Token loaded from Render environment.');
                }
            } catch (err) {
                console.warn('Could not fetch token from server, using local storage.');
            }

            if (tokenToUse) {
                document.getElementById('token').value = tokenToUse;
                if (tokenToUse === ConfigDB.get(ConfigDB.KEYS.GITHUB_TOKEN)) {
                    document.getElementById('saveToken').checked = true;
                }
                ConfigDB.showSaveIndicator(ConfigDB.KEYS.GITHUB_TOKEN);
                // è‡ªå‹•è®€å– Repo
                fetchRepositories(tokenToUse);
            }

            document.getElementById('commitMessage').value = DEFAULT_UPLOAD_MESSAGE;
            setupRealtimeSync('token', 'saveToken', ConfigDB.KEYS.GITHUB_TOKEN);
            setupRealtimeSync('branch', 'saveToken', ConfigDB.KEYS.BRANCH);

            // Note: Gemini status is initialized in the DOMContentLoaded handler at bottom of file

            // ç›£è½ Token è®Šæ›´ä»¥è‡ªå‹•è®€å– Repo
            document.getElementById('token').addEventListener('change', function () {
                fetchRepositories(this.value);
            });

            // ç›£è½ Repo è®Šæ›´ä»¥æ›´æ–° Heatmap
            document.getElementById('repo').addEventListener('change', function () {
                updateContributionHeatmap();
            });

            // ğŸ® RPG: Initialize Status Card
            if (typeof DevScribeRPG !== 'undefined') {
                const card = document.getElementById('rpg-status-card');
                if (card) {
                    card.innerHTML = DevScribeRPG.generateStatusCardHTML();
                    // Listen for updates from RPG engine
                    window.addEventListener('questempire:action', () => {
                        card.innerHTML = DevScribeRPG.generateStatusCardHTML();
                    });
                }
            }
        };

        async function fetchRepositories(token, preferredRepo = null) {
            if (!token) return;

            const repoSelect = document.getElementById('repo');
            const currentSelection = preferredRepo || repoSelect.value || ConfigDB.get(ConfigDB.KEYS.REPO) || "t26020402-debug/Personal_Learning_Database";

            repoSelect.disabled = true;
            const originalText = repoSelect.innerHTML;
            repoSelect.innerHTML = `<option>${i18n.t('loadingRepoList')}</option>`;

            try {
                // æŠ“å–å‰ 100 å€‹ Reposï¼Œä¾æ›´æ–°æ™‚é–“æ’åº
                const response = await fetch('https://api.github.com/user/repos?sort=updated&per_page=100&type=all', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(i18n.t('tokenInvalidOrNetwork'));
                }

                const repos = await response.json();

                repoSelect.innerHTML = '';

                if (repos.length === 0) {
                    repoSelect.innerHTML = `<option value="">${i18n.t('noRepoFound')}</option>`;
                } else {
                    repos.forEach(repo => {
                        const option = document.createElement('option');
                        option.value = repo.full_name;
                        option.textContent = repo.full_name + (repo.private ? ' ' + i18n.t('private') : '');
                        option.dataset.defaultBranch = repo.default_branch;
                        repoSelect.appendChild(option);
                    });

                    let found = false;
                    for (let i = 0; i < repoSelect.options.length; i++) {
                        if (repoSelect.options[i].value === currentSelection) {
                            repoSelect.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }

                    if (!found && currentSelection) {
                        const option = document.createElement('option');
                        option.value = currentSelection;
                        option.textContent = currentSelection + ' ' + i18n.t('savedManual');
                        option.selected = true;
                        option.dataset.defaultBranch = 'master';
                        repoSelect.prepend(option);
                    }
                }

                const statusEl = document.getElementById('tokenStatus');
                if (statusEl) {
                    statusEl.innerHTML = `<i class="fa-solid fa-check"></i> <span data-i18n="syncComplete">${i18n.t('syncComplete')}</span>`;
                    statusEl.style.opacity = 1;
                    setTimeout(() => {
                        if (statusEl) statusEl.innerHTML = `<i class="fa-solid fa-check"></i> <span data-i18n="tokenSaved">${i18n.t('tokenSaved')}</span>`;
                    }, 3000);
                }

                await fetchBranches(token);
                // Trigger Heatmap update after repo loaded
                updateContributionHeatmap();

            } catch (error) {
                console.error("Repo fetch failed:", error);
                repoSelect.innerHTML = `<option value="${currentSelection}">${currentSelection}</option>`;
                showStatus('warning', i18n.t('repoSyncFailed'));
                await fetchBranches(token);
            } finally {
                repoSelect.disabled = false;
            }
        }

        async function fetchBranches(token) {
            const repoSelect = document.getElementById('repo');
            const branchSelect = document.getElementById('branch');
            const repoName = repoSelect.value;

            if (!token || !repoName) return;

            branchSelect.disabled = true;
            branchSelect.innerHTML = `<option>${i18n.t('loadingBranches')}</option>`;

            try {
                const selectedOption = repoSelect.options[repoSelect.selectedIndex];
                let defaultBranch = selectedOption ? selectedOption.dataset.defaultBranch : 'master';

                const response = await fetch(`https://api.github.com/repos/${repoName}/branches`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) throw new Error(i18n.t('cannotReadBranch'));
                const branches = await response.json();

                branchSelect.innerHTML = '';
                branches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.name;
                    opt.textContent = b.name;
                    branchSelect.appendChild(opt);
                });

                const savedBranch = ConfigDB.get(ConfigDB.KEYS.BRANCH);
                const savedRepo = ConfigDB.get(ConfigDB.KEYS.REPO);

                let targetBranch = defaultBranch;

                if (savedRepo === repoName && savedBranch && branches.some(b => b.name === savedBranch)) {
                    targetBranch = savedBranch;
                } else if (branches.some(b => b.name === defaultBranch)) {
                    targetBranch = defaultBranch;
                } else if (branches.length > 0) {
                    targetBranch = branches[0].name;
                }

                branchSelect.value = targetBranch;

                if (document.getElementById('saveToken').checked) {
                    ConfigDB.save(ConfigDB.KEYS.BRANCH, targetBranch);
                    ConfigDB.save(ConfigDB.KEYS.REPO, repoName);
                }

            } catch (e) {
                console.error(e);
                branchSelect.innerHTML = `<option value="master">master ${i18n.t('readFailedWithBranch')}</option>`;
            } finally {
                branchSelect.disabled = false;
            }
        }

        function setupRealtimeSync(inputId, checkboxId, storageKey) {
            const inputEl = document.getElementById(inputId);
            const checkboxEl = document.getElementById(checkboxId);
            if (!inputEl || !checkboxEl) return;

            const syncLogic = () => {
                if (checkboxEl.checked) {
                    const val = inputEl.value.trim();
                    if (val) {
                        ConfigDB.save(storageKey, val);
                    }
                } else {
                    ConfigDB.remove(storageKey);
                }
            };

            inputEl.addEventListener('input', () => { if (checkboxEl.checked) syncLogic(); });
            inputEl.addEventListener('change', () => { if (checkboxEl.checked) syncLogic(); });
            checkboxEl.addEventListener('change', syncLogic);
        }

        function toggleTokenVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }


        // --- 2. æª”æ¡ˆç€è¦½å™¨é‚è¼¯ (VS Code Tree View Style) ---

        async function initTreeBrowser() {
            const inputs = getInputs(false);
            if (!inputs.token || !inputs.repo) {
                showStatus('error', 'è«‹è¼¸å…¥ GitHub Token å’Œ Repository åç¨±ä»¥è®€å–åˆ—è¡¨');
                return;
            }

            const listContainer = document.getElementById('fileList');
            const repoDisplay = document.getElementById('repoNameDisplay');

            listContainer.innerHTML = '<div class="flex justify-center py-4"><span class="spinner"></span></div>';
            repoDisplay.textContent = inputs.repo;

            try {
                const items = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, '');

                listContainer.innerHTML = '';

                items.sort(sortItems);

                items.forEach(item => {
                    listContainer.appendChild(createTreeNode(item, 0));
                });

                // Also refresh heatmap just in case
                updateContributionHeatmap();

            } catch (error) {
                listContainer.innerHTML = `<div class="text-red-400 text-center text-sm p-2">è®€å–å¤±æ•—<br>${error.message}</div>`;
            }
        }

        async function fetchItemsFromApi(repo, token, branch, path) {
            const timestamp = new Date().getTime();
            const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}&_t=${timestamp}`;

            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const data = await response.json();
            return Array.isArray(data) ? data : [data];
        }

        function sortItems(a, b) {
            if (a.type === b.type) return a.name.localeCompare(b.name);
            return a.type === 'dir' ? -1 : 1;
        }

        function createTreeNode(item, level) {
            const container = document.createElement('div');

            const nodeRow = document.createElement('div');
            nodeRow.className = 'tree-node rounded';
            nodeRow.style.paddingLeft = `${level * 16 + 4}px`;

            const toggleIcon = document.createElement('div');
            toggleIcon.className = 'tree-toggle-icon';
            if (item.type === 'dir') {
                toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            } else {
                toggleIcon.classList.add('invisible');
                toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            }
            nodeRow.appendChild(toggleIcon);

            const fileIcon = document.createElement('div');
            fileIcon.className = 'tree-icon';
            const iconClass = item.type === 'dir' ? 'fa-folder text-yellow-400' : getFileIcon(item.name);
            fileIcon.innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
            nodeRow.appendChild(fileIcon);

            const label = document.createElement('span');
            label.className = 'tree-label ml-1';
            label.textContent = item.name;
            nodeRow.appendChild(label);

            container.appendChild(nodeRow);

            let childrenContainer = null;
            if (item.type === 'dir') {
                childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children hidden';
                container.appendChild(childrenContainer);
            }

            nodeRow.onclick = async (e) => {
                e.stopPropagation();

                if (currentlySelectedNode) {
                    currentlySelectedNode.classList.remove('selected');
                }
                nodeRow.classList.add('selected');
                currentlySelectedNode = nodeRow;

                if (item.type === 'file') {
                    document.getElementById('targetPath').value = item.path;

                } else if (item.type === 'dir') {
                    const inputs = getInputs(false);

                    if (childrenContainer.innerHTML === '') {
                        toggleIcon.innerHTML = '<div class="tree-spinner"></div>';

                        try {
                            const subItems = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, item.path);
                            subItems.sort(sortItems);

                            subItems.forEach(subItem => {
                                childrenContainer.appendChild(createTreeNode(subItem, level + 1));
                            });

                            childrenContainer.classList.remove('hidden');
                            toggleIcon.classList.add('expanded');
                            toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';

                            fileIcon.innerHTML = '<i class="fa-solid fa-folder-open text-yellow-400"></i>';

                        } catch (err) {
                            toggleIcon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>';
                            showStatus('error', `è®€å–è³‡æ–™å¤¾å¤±æ•—: ${err.message}`);
                        }
                    } else {
                        const isHidden = childrenContainer.classList.contains('hidden');
                        if (isHidden) {
                            childrenContainer.classList.remove('hidden');
                            toggleIcon.classList.add('expanded');
                            fileIcon.innerHTML = '<i class="fa-solid fa-folder-open text-yellow-400"></i>';
                        } else {
                            childrenContainer.classList.add('hidden');
                            toggleIcon.classList.remove('expanded');
                            fileIcon.innerHTML = '<i class="fa-solid fa-folder text-yellow-400"></i>';
                        }
                    }
                }
            };

            return container;
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.html')) return 'fa-html5 text-orange-500';
            if (filename.endsWith('.js')) return 'fa-js text-yellow-300';
            if (filename.endsWith('.css')) return 'fa-css3-alt text-blue-500';
            if (filename.match(/\.(jpg|jpeg|png|gif|svg)$/i)) return 'fa-image text-purple-400';
            if (filename.endsWith('.md')) return 'fa-markdown text-white';
            if (filename.endsWith('.json')) return 'fa-file-code text-yellow-500';
            if (filename.endsWith('.py')) return 'fa-python text-blue-300';
            return 'fa-file-lines text-gray-400';
        }

        // --- 3. æª”æ¡ˆè™•ç† (Drag & Drop, é¸æ“‡, é è¦½) ---

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');

            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files.length > 0) {
                handleFileSelect({ files: files });
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            selectedFile = file;
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const previewImg = document.getElementById('imagePreview');
            const previewText = document.getElementById('textPreviewIcon');
            const noPreview = document.getElementById('noPreviewText');
            const clearBtn = document.getElementById('clearFileBtn');
            const targetPath = document.getElementById('targetPath');

            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add('text-blue-300');
            clearBtn.classList.remove('hidden');
            noPreview.classList.add('hidden');

            const currentVal = targetPath.value;
            const lastSlashIndex = currentVal.lastIndexOf('/');

            if (lastSlashIndex !== -1) {
                const dir = currentVal.substring(0, lastSlashIndex + 1);
                targetPath.value = dir + file.name;
            } else {
                if (targetPath.value === '') {
                    targetPath.value = file.name;
                }
            }

            const reader = new FileReader();

            if (file.type.startsWith('image/')) {
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    selectedFileBase64 = e.target.result.split(',')[1];
                    enableGemini(false);
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.classList.add('hidden');
                previewText.classList.remove('hidden');

                reader.onload = (e) => {
                    selectedFileBase64 = btoa(unescape(encodeURIComponent(e.target.result)));
                    enableGemini(true);
                };
                reader.readAsText(file);
            }
        }

        function clearFileSelection(e) {
            if (e) e.stopPropagation();
            document.getElementById('fileInput').value = '';
            selectedFile = null;
            selectedFileBase64 = null;
            document.getElementById('fileNameDisplay').textContent = i18n.t('dropOrClick');
            document.getElementById('fileNameDisplay').classList.remove('text-blue-300');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('textPreviewIcon').classList.add('hidden');
            document.getElementById('noPreviewText').classList.remove('hidden');
            document.getElementById('clearFileBtn').classList.add('hidden');
            document.getElementById('geminiOutputContainer').classList.add('hidden');
            enableGemini(false);
        }

        // --- 4. ä¸Šå‚³èˆ‡åˆªé™¤é‚è¼¯ ---

        function isTextFile(filename) {
            return /\.(txt|md|html|css|js|json|py|java|cpp|ts|xml|csv|rb|go|php)$/i.test(filename);
        }

        async function performAction(action) {
            const inputs = getInputs(true);
            if (!inputs) return;

            const btn = action === 'upload' ? document.getElementById('btnUpload') : document.getElementById('btnDelete');
            const spinner = action === 'upload' ? document.getElementById('spinnerUpload') : document.getElementById('spinnerDelete');

            if (action === 'upload' && !selectedFileBase64) {
                showStatus('error', i18n.t('selectFileFirst'));
                return;
            }

            btn.disabled = true;
            spinner.classList.remove('hidden');
            showStatus('info', i18n.t('processing'));

            try {
                // 1. Check File Existence (GET SHA)
                const ts = new Date().getTime();
                const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}&_t=${ts}`;
                const checkRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${inputs.token}` }
                });

                let sha = null;
                let remoteContentBase64 = null;

                if (checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    remoteContentBase64 = data.content;
                }

                if (action === 'upload') {

                    if (sha) {
                        const cleanRemoteBase64 = remoteContentBase64.replace(/\n/g, '');

                        if (cleanRemoteBase64 === selectedFileBase64) {
                            showStatus('info', i18n.t('fileNotChanged'));
                            btn.disabled = false;
                            spinner.classList.add('hidden');
                            return;
                        }

                        if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey && isTextFile(inputs.path)) {
                            showStatus('info', i18n.t('aiAnalyzingDiff'));
                            try {
                                const remoteContent = decodeURIComponent(escape(atob(cleanRemoteBase64)));
                                const localContent = decodeURIComponent(escape(atob(selectedFileBase64)));
                                const newCommitMessage = await generateDiffCommitMessage(inputs.geminiApiKey, remoteContent, localContent, inputs.path);
                                inputs.message = newCommitMessage;
                                document.getElementById('commitMessage').value = newCommitMessage;
                            } catch (geminiError) {
                                console.error("Gemini Diff failed:", geminiError);
                            }
                        }
                    } else if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey && isTextFile(inputs.path)) {
                        showStatus('info', i18n.t('aiSummarizingNew'));
                        try {
                            const localContent = decodeURIComponent(escape(atob(selectedFileBase64)));
                            const newCommitMessage = await generateNewFileCommitMessage(inputs.geminiApiKey, localContent, inputs.path);
                            inputs.message = newCommitMessage;
                            document.getElementById('commitMessage').value = newCommitMessage;
                        } catch (geminiError) {
                            console.error("Gemini New File failed:", geminiError);
                        }
                    }

                    // æº–å‚™ Payload
                    let finalBase64 = selectedFileBase64;
                    if (isTextFile(inputs.path)) {
                        let content = decodeURIComponent(escape(atob(selectedFileBase64)));
                        const tokenRegex = /(<input[^>]*value=")(ghp_[^"]*)("[^>]*>)/gi;
                        if (tokenRegex.test(content)) {
                            content = content.replace(tokenRegex, '$1""$3');
                            finalBase64 = btoa(unescape(encodeURIComponent(content)));
                            console.log('HTML Token cleaned.');
                        }
                    }

                    var method = 'PUT';
                    var payload = {
                        message: inputs.message,
                        branch: inputs.branch,
                        content: finalBase64
                    };
                    if (sha) payload.sha = sha;

                } else {
                    if (!sha) throw new Error(i18n.t('fileNotExist'));
                    var method = 'DELETE';
                    var payload = {
                        message: inputs.message,
                        branch: inputs.branch,
                        sha: sha
                    };
                }


                // 3. Execute
                const executeUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}`;
                const res = await fetch(executeUrl, {
                    method: method,
                    headers: {
                        'Authorization': `token ${inputs.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const resultData = await res.json();

                if (res.ok) {
                    const actionKey = action === 'upload' ? (sha ? 'actionUpdate' : 'actionUpload') : 'actionDelete';
                    const actionName = i18n.t(actionKey);
                    const successMsg = i18n.t('fileActionSuccess').replace('{action}', actionName).replace('{sha}', resultData.commit.sha.substring(0, 7));
                    showStatus('success', successMsg);

                    initTreeBrowser();

                    if (action === 'upload') {
                        const rawUrl = `https://github.com/${inputs.repo}/raw/${inputs.branch}/${inputs.path}`;
                        document.getElementById('resultUrl').value = rawUrl;
                        document.getElementById('successLinks').classList.remove('hidden');
                    } else {
                        document.getElementById('successLinks').classList.add('hidden');
                        clearFileSelection();
                        document.getElementById('targetPath').value = '';
                    }

                    // æ›´æ–° Heatmap
                    updateContributionHeatmap();

                } else {
                    throw new Error(resultData.message || res.statusText);
                }

            } catch (error) {
                showStatus('error', `${i18n.t('operationFailed')}: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        async function generateDiffCommitMessage(apiKey, oldContent, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const diffContext = `File: ${filePath}\n\n--- OLD CONTENT ---\n${oldContent.substring(0, MAX_CONTEXT_LENGTH)}\n\n--- NEW CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const langPrompt = i18n.currentLang === 'zh' ? 'ç¹é«”ä¸­æ–‡' : 'English';
            const userQuery = `è«‹æ ¹æ“šå…§å®¹å·®ç•°ï¼Œç”Ÿæˆä¸€å€‹ ${langPrompt} Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, diffContext, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }

        async function generateNewFileCommitMessage(apiKey, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const context = `File: ${filePath}\n\n--- FILE CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const langPrompt = i18n.currentLang === 'zh' ? 'ç¹é«”ä¸­æ–‡' : 'English';
            const userQuery = `é€™æ˜¯ä¸€å€‹æ–°æª”æ¡ˆã€‚è«‹æ ¹æ“šå…§å®¹ï¼Œç”Ÿæˆä¸€å€‹ ${langPrompt} Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ï¼Œé–‹é ­ä½¿ç”¨ 'feat:' æˆ– 'add:'ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, context, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }


        // --- 5. Gemini æ·±åº¦æ•´åˆåŠŸèƒ½ ---

        function enableGemini(enabled) {
            let hasKey = false;
            if (typeof GeminiKeyManager !== 'undefined') {
                const key = GeminiKeyManager.getActiveKey();
                hasKey = !!(key && key !== '__USE_ADMIN_KEY__');
            }

            const finalState = enabled && hasKey;

            document.getElementById('btnSummary').disabled = !finalState;
            document.getElementById('btnCommitMsg').disabled = !finalState;
            document.getElementById('btnCodeReview').disabled = !finalState;
            document.getElementById('geminiOutputContainer').classList.add('hidden');
        }

        async function suggestPathWithAI() {
            const inputs = getInputs(false);

            let apiKey = null;
            if (typeof GeminiKeyManager !== 'undefined') {
                await GeminiKeyManager.checkQuotaAndAlert();
                const key = GeminiKeyManager.getActiveKey();
                if (key && key !== '__USE_ADMIN_KEY__') apiKey = key;
            }

            if (!selectedFile) {
                showStatus('warning', i18n.t('selectFileFirst'));
                return;
            }
            if (!apiKey) {
                showStatus('error', i18n.t('setGeminiKey') + ' (in Hub)');
                return;
            }
            if (!inputs.token || !inputs.repo) {
                showStatus('error', i18n.t('setTokenRepoForAnalysis'));
                return;
            }

            const btn = document.getElementById('btnAiPath');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${i18n.t('analyzingAI')}`;

            try {
                let folderList = [];
                try {
                    const items = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, '');
                    folderList = items.filter(i => i.type === 'dir').map(i => i.name);
                } catch (e) {
                    console.warn("Could not fetch repo structure, proceeding with generic advice.", e);
                }

                const folderContext = folderList.length > 0
                    ? `Current top-level folders in repo: ${folderList.join(', ')}`
                    : "Current repo structure is unknown.";

                const systemPrompt = "You are a helpful GitHub repository file organizer. Respond with ONLY the path string.";
                const userQuery = `I want to push a file named "${selectedFile.name}" to my repo.
                ${folderContext}
                
                Based on the file extension and name, suggests the best relative path to store this file.
                - If it fits in an existing folder, use that folder (e.g. 'src/${selectedFile.name}').
                - If it needs a new folder, suggest a logical name (e.g., 'src/', 'docs/', 'images/', 'components/').
                - If it is a root level file (like README.md, LICENSE), put it in root (just the filename).
                
                Reply with ONLY the full relative path including the filename. Do not add any markdown, quotes or explanation.`;

                let suggestedPath = await callGeminiApi(systemPrompt, userQuery, "", apiKey);

                suggestedPath = suggestedPath.replace(/['"`]/g, '').trim();
                if (suggestedPath.startsWith('/')) suggestedPath = suggestedPath.substring(1);

                document.getElementById('targetPath').value = suggestedPath;
                showStatus('success', `${i18n.t('aiSuggestedPath')}: ${suggestedPath}`);

                const input = document.getElementById('targetPath');
                input.classList.add('ring-2', 'ring-indigo-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-indigo-500'), 2000);

            } catch (err) {
                showStatus('error', `${i18n.t('aiSuggestFailed')}: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function runGeminiTask(task) {
            const file = selectedFile;

            let apiKey = null;
            if (typeof GeminiKeyManager !== 'undefined') {
                await GeminiKeyManager.checkQuotaAndAlert();
                const key = GeminiKeyManager.getActiveKey();
                if (key && key !== '__USE_ADMIN_KEY__') apiKey = key;
            }

            if (!file) return;
            if (!apiKey) {
                showStatus('error', i18n.t('setGeminiKey') + ' (in Hub)');
                return;
            }

            const outputContainer = document.getElementById('geminiOutputContainer');
            const outputDiv = document.getElementById('geminiOutput');
            const title = document.getElementById('aiOutputTitle');

            outputContainer.classList.remove('hidden');

            const localText = await new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => resolve(e.target.result);
                r.readAsText(file);
            });

            let prompt = "";
            let systemInstruction = "";
            let contextText = localText;

            try {
                const langName = i18n.currentLang === 'zh' ? 'Traditional Chinese' : 'English';

                if (task === 'summary') {
                    outputDiv.innerHTML = `<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">${i18n.t('analyzing')}</span></div>`;
                    title.textContent = i18n.t('fileSummaryTitle');
                    systemInstruction = `You are a helpful summary assistant. Respond in ${langName}.`;
                    prompt = `Please summarize the main functions and structure of this code or document in ${langName}, using Markdown format.`;

                } else if (task === 'commit') {
                    outputDiv.innerHTML = `<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">${i18n.t('comparingRemote')}</span></div>`;
                    title.textContent = i18n.t('diffSummaryTitle');

                    const inputs = getInputs(false);
                    let oldContent = "";
                    let isNewFile = true;

                    if (inputs && inputs.token && inputs.repo && inputs.path) {
                        try {
                            const ts = new Date().getTime();
                            const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}&_t=${ts}`;
                            const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${inputs.token}` } });
                            if (res.ok) {
                                const data = await res.json();
                                oldContent = decodeURIComponent(escape(atob(data.content.replace(/\n/g, ''))));
                                isNewFile = false;
                            }
                        } catch (e) {
                            console.log("Remote file fetch failed (likely new file):", e);
                        }
                    }

                    systemInstruction = `You are a professional Git assistant. Analyze code differences. Respond in ${langName}.`;

                    /* --- Prompt Generation --- */
                    if (isNewFile) {
                        prompt = `This is a new file. Please generate a high-quality ${langName} Git Commit Message (under 50 chars).
                        
                        Important: Since it is a new file, DO NOT generate a Diff Summary. Output ONLY the Commit Message.

                        Output Format:
                        ---COMMIT_MSG_START---
                        (Commit Message)
                        ---COMMIT_MSG_END---
                        `;
                    } else {
                        const summaryHeader = i18n.currentLang === 'zh' ? 'è®Šæ›´æ‘˜è¦' : 'Change Summary';
                        prompt = `This is a modification to an existing file. Please detailedly compare 'OLD_CONTENT' and 'NEW_CONTENT' (Diff).

                        Definitions:
                        - OLD_CONTENT: Remote old code (Before)
                        - NEW_CONTENT: Local new code (After)
                        - **Additions**: Content in NEW but not in OLD.
                        - **Deletions**: Content in OLD but not in NEW.

                        Tasks:
                        1. **Diff Analysis**: Identify meaningful changes, additions, or deletions.
                        2. **Summary**: Convert these changes into a "natural language" bulleted summary (Markdown Bullet Points) in ${langName}.
                        3. **Commit Message**: Generate a high-quality Commit Message title (under 50 chars) in ${langName} based on the changes.

                        Output Format:
                        ---COMMIT_MSG_START---
                        (Commit Message)
                        ---COMMIT_MSG_END---

                        ### ${summaryHeader}
                        (List the Diff analysis summary here in ${langName})
                        `;
                    }
                    /* --- ä¿®æ”¹çµæŸ --- */

                    const MAX_LEN = 15000;
                    contextText = `File Path: ${inputs ? inputs.path : file.name}\n\n--- OLD_CONTENT ---\n${oldContent.substring(0, MAX_LEN)}\n\n--- NEW_CONTENT ---\n${localText.substring(0, MAX_LEN)}`;

                } else if (task === 'review') {
                    outputDiv.innerHTML = `<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">${i18n.t('codeReviewing')}</span></div>`;
                    title.textContent = i18n.t('codeReviewTitle');
                    systemInstruction = `You are a senior software engineer conducting a code review. Be constructive, strict but polite. Respond in ${langName} using Markdown.`;
                    prompt = `Please review the following code. Include:
1. **Overall Score** (0-10)
2. **Potential Bugs & Security Risks**
3. **Optimization Suggestions** (Performance, Readability)
4. **Refactoring Examples** (Better ways to write key parts)

Respond entirely in ${langName}.
Code to review:`;
                }

                const result = await callGeminiApi(systemInstruction, prompt, contextText, apiKey);

                if (task === 'commit') {
                    const msgMatch = result.match(/---COMMIT_MSG_START---([\s\S]*?)---COMMIT_MSG_END---/);
                    let commitMsg = "Update file";
                    let explanation = result;

                    if (msgMatch) {
                        commitMsg = msgMatch[1].trim();
                        explanation = result.replace(/---COMMIT_MSG_START---[\s\S]*?---COMMIT_MSG_END---/, '').trim();
                    }

                    document.getElementById('commitMessage').value = commitMsg;

                    /* --- Result Display --- */
                    if (explanation && explanation.length > 5) {
                        outputDiv.innerHTML = `
                            <div class="mb-3 p-2 bg-green-900/30 border border-green-500/30 rounded text-xs text-green-300">
                                <i class="fa-solid fa-check-circle mr-1"></i> ${i18n.t('autoFilledTitle')}: <b>${commitMsg}</b>
                            </div>
                            <div class="markdown-body text-sm">${marked.parse(explanation)}</div>
                            <div class="mt-2 text-center text-xs text-gray-500">${i18n.t('copySummaryHint')}</div>
                        `;
                    } else {
                        outputDiv.innerHTML = `
                            <div class="mb-3 p-2 bg-green-900/30 border border-green-500/30 rounded text-xs text-green-300">
                                <i class="fa-solid fa-check-circle mr-1"></i> ${i18n.t('autoFilledTitle')}: <b>${commitMsg}</b>
                            </div>
                            <div class="text-center text-xs text-gray-500">${i18n.t('newFileMode')}</div>
                        `;
                    }
                } else {
                    outputDiv.innerHTML = marked.parse(result);
                }

                // ğŸ® RPG: Award XP for AI Assistance
                if (typeof DevScribeRPG !== 'undefined') {
                    const rpgResult = DevScribeRPG.recordModuleAction('guild', 'vocab_generated');
                    if (rpgResult) DevScribeRPG.showXPNotification(rpgResult);
                }

            } catch (error) {
                outputDiv.innerHTML = `<span class="text-red-400">${i18n.t('aiRequestFailed')}: ${error.message}</span>`;
            }
        }

        async function callGeminiApi(systemPrompt, userQuery, contextText = "", apiKey) {
            if (typeof GeminiKeyManager !== 'undefined') {
                await GeminiKeyManager.checkQuotaAndAlert();
                if (!apiKey) {
                    const key = GeminiKeyManager.getActiveKey();
                    // If user key exists and is not the proxy signal (since this fetch is client-side)
                    if (key && key !== '__USE_ADMIN_KEY__') apiKey = key;
                }
            }
            if (!apiKey) {
                throw new Error("Gemini API Key is missing.");
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const finalPrompt = contextText ? `${userQuery}\n\nContent:\n${contextText.substring(0, 30000)}` : userQuery;

            const payload = {
                contents: [{ parts: [{ text: finalPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const maxRetries = 3;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error("Rate limit exceeded");
                        }
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || `API Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
                } catch (e) {
                    attempt++;
                    console.warn(`Attempt ${attempt} failed: ${e.message}`);
                    if (attempt >= maxRetries) throw e;
                    await new Promise(r => setTimeout(r, 1000 * attempt));
                }
            }
        }

        // --- 6. Contribution Heatmap Logic (Gamified) ---

        async function updateContributionHeatmap() {
            const inputs = getInputs(false);
            const container = document.getElementById('contributionHeatmap');

            // Stats Elements
            const statStreak = document.getElementById('statStreak');
            const statMaxStreak = document.getElementById('statMaxStreak');
            const statTotal = document.getElementById('statTotal');
            const statRank = document.getElementById('statRank');
            const nextLevelMsg = document.getElementById('nextLevelMsg');

            if (!inputs.token || !inputs.repo) {
                container.innerHTML = i18n.t('setTokenRepoHint');
                return;
            }

            container.innerHTML = `<span class="spinner" style="width:16px;height:16px;"></span> <span class="ml-2">${i18n.t('loadingContribData')}</span>`;

            try {
                // 1. Calculate Start Date (90 days ago)
                const today = new Date();
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 90);
                const sinceDate = pastDate.toISOString();

                // 2. Fetch Commits from GitHub API
                const url = `https://api.github.com/repos/${inputs.repo}/commits?since=${sinceDate}&per_page=100`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${inputs.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) throw new Error(i18n.t('cannotReadCommits'));
                const commits = await response.json();

                // 3. Process Data: Count commits per day
                const counts = {};
                commits.forEach(commit => {
                    const dateStr = commit.commit.author.date.split('T')[0]; // YYYY-MM-DD
                    counts[dateStr] = (counts[dateStr] || 0) + 1;
                });

                // 4. Calculate Advanced Stats
                const stats = calculateStats(counts);

                // Update UI Stats
                statStreak.textContent = `${stats.currentStreak} Days`;
                statMaxStreak.textContent = stats.maxStreak;
                statTotal.textContent = stats.total;

                // Gamification Rank
                const rankData = getGamifiedRank(stats.total);
                statRank.textContent = rankData.rank;
                nextLevelMsg.textContent = rankData.msg;

                // 5. Generate Grid
                renderHeatmapGrid(container, counts, 84); // 84 days = 12 weeks

            } catch (error) {
                console.error(error);
                container.innerHTML = `<span class="text-red-400">è®€å–å¤±æ•—: ${error.message}</span>`;
            }
        }

        function calculateStats(counts) {
            const today = new Date();
            let currentStreak = 0;
            let maxStreak = 0;
            let total = 0;
            let tempStreak = 0;

            // Helper to format date key
            const getDateKey = (d) => d.toISOString().split('T')[0];

            // Check Current Streak (starting from today backwards)
            // Note: If user hasn't committed TODAY yet, check YESTERDAY to keep streak alive.
            let d = new Date(today);
            let checkDate = getDateKey(d);

            if (!counts[checkDate]) {
                // Try yesterday
                d.setDate(d.getDate() - 1);
                checkDate = getDateKey(d);
            }

            while (counts[checkDate] > 0) {
                currentStreak++;
                d.setDate(d.getDate() - 1);
                checkDate = getDateKey(d);
            }

            // Calculate Max Streak & Total over the 90 days window
            // We iterate all keys in data
            const sortedDates = Object.keys(counts).sort();

            if (sortedDates.length > 0) {
                // Determine streak continuity
                // Simple logic: iterate expected days range or just sort keys and check difference?
                // For simplicity on small dataset, let's iterate last 90 days logic:
                let scanDate = new Date();
                scanDate.setDate(scanDate.getDate() - 90);

                for (let i = 0; i <= 90; i++) {
                    const key = getDateKey(scanDate);
                    const count = counts[key] || 0;
                    total += count;

                    if (count > 0) {
                        tempStreak++;
                    } else {
                        if (tempStreak > maxStreak) maxStreak = tempStreak;
                        tempStreak = 0;
                    }
                    scanDate.setDate(scanDate.getDate() + 1);
                }
                if (tempStreak > maxStreak) maxStreak = tempStreak;
            }

            return { currentStreak, maxStreak, total };
        }

        function getGamifiedRank(totalCommits) {
            if (totalCommits < 10) return { rank: i18n.t('rankNovice'), msg: i18n.t('msgStart') };
            if (totalCommits < 30) return { rank: i18n.t('rankBuilder'), msg: i18n.t('msgKeepBuilding') };
            if (totalCommits < 60) return { rank: i18n.t('rankContributor'), msg: i18n.t('msgFlyingHigh') };
            if (totalCommits < 100) return { rank: i18n.t('rankNinja'), msg: i18n.t('msgUnstoppable') };
            return { rank: i18n.t('rankLegend'), msg: i18n.t('msgMaxRespect') };
        }

        function renderHeatmapGrid(container, data, totalDays) {
            container.innerHTML = '';

            const today = new Date();
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - totalDays);

            // Adjust start date to previous Sunday
            while (startDate.getDay() !== 0) {
                startDate.setDate(startDate.getDate() - 1);
            }

            const tooltip = document.getElementById('heatmapTooltip');
            let currentWeekDiv = document.createElement('div');
            currentWeekDiv.className = 'heatmap-week';

            let currentDate = new Date(startDate);
            let dayCount = 0;

            // For animation delay
            let animationDelay = 0;

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const count = data[dateStr] || 0;

                const level = count === 0 ? 0 :
                    count <= 2 ? 1 :
                        count <= 5 ? 2 :
                            count <= 10 ? 3 : 4;

                const dayDiv = document.createElement('div');
                dayDiv.className = `heatmap-day level-${level}`;

                // Animation Stagger
                dayDiv.style.animationDelay = `${animationDelay}ms`;
                animationDelay += 5; // increment delay

                // Tooltip
                dayDiv.onmouseenter = (e) => {
                    tooltip.innerHTML = `<strong>${dateStr}</strong><br>${count} ${i18n.t('contributions')}`;
                    tooltip.style.display = 'block';
                    const rect = dayDiv.getBoundingClientRect();
                    tooltip.style.left = `${rect.left - 40}px`;
                    tooltip.style.top = `${rect.top - 45}px`;
                };
                dayDiv.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };

                currentWeekDiv.appendChild(dayDiv);

                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;

                if (dayCount % 7 === 0) {
                    container.appendChild(currentWeekDiv);
                    currentWeekDiv = document.createElement('div');
                    currentWeekDiv.className = 'heatmap-week';
                }
            }
            if (currentWeekDiv.hasChildNodes()) {
                container.appendChild(currentWeekDiv);
            }

            container.scrollLeft = container.scrollWidth;
        }

        // --- Helpers ---

        function getInputs(validateAll = true) {
            const token = document.getElementById('token').value.trim();

            let geminiApiKey = '';
            // Use Manager if available
            if (typeof GeminiKeyManager !== 'undefined') {
                const key = GeminiKeyManager.getActiveKey();
                if (key && key !== '__USE_ADMIN_KEY__') geminiApiKey = key;
            }

            const repo = document.getElementById('repo').value.trim();
            const branch = document.getElementById('branch').value.trim();
            const path = document.getElementById('targetPath').value.trim();
            const message = document.getElementById('commitMessage').value.trim();

            if (validateAll && (!token || !repo || !branch || !path || !message)) {
                showStatus('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½ (Token, Repo, Branch, Path, Message)');
                return null;
            }
            return { token, geminiApiKey, repo, branch, path, message };
        }

        function showStatus(type, msg) {
            const el = document.getElementById('statusArea');
            const title = document.getElementById('statusTitle');
            const body = document.getElementById('statusMsg');
            const icon = document.getElementById('statusIcon');

            el.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'border-red-500', 'border-green-500', 'border-blue-500');
            icon.className = 'mt-1 mr-3 fa-solid';

            if (type === 'error') {
                el.classList.add('bg-red-900/50', 'border-red-500', 'text-red-200');
                icon.classList.add('fa-circle-xmark');
                title.textContent = i18n.t('error');
            } else if (type === 'success') {
                el.classList.add('bg-green-900/50', 'border-green-500', 'text-green-200');
                icon.classList.add('fa-circle-check');
                title.textContent = i18n.t('success');
                document.getElementById('successLinks').classList.remove('hidden');

                // ğŸ® RPG: Award XP for Guild Contribution
                if (typeof DevScribeRPG !== 'undefined') {
                    // Avoid rewarding for config imports (check msg)
                    if (!msg.includes(i18n.t('configImportSuccess')) && !msg.includes(i18n.t('configExportSuccess'))) {
                        const rpgResult = DevScribeRPG.recordModuleAction('guild', 'pr_merged');
                        if (rpgResult) DevScribeRPG.showXPNotification(rpgResult);
                    }
                }
            } else if (type === 'info' || type === 'warning') {
                el.classList.add('bg-blue-900/50', 'border-blue-500', 'text-blue-200');
                icon.classList.add('fa-spinner', 'fa-spin');
                title.textContent = i18n.t('processing');
                document.getElementById('successLinks').classList.add('hidden');
                if (type === 'warning') {
                    icon.classList.replace('fa-spinner', 'fa-triangle-exclamation');
                    icon.classList.remove('fa-spin');
                    title.textContent = i18n.t('warning');
                } else if (type === 'info') {
                    title.textContent = i18n.t('processing');
                }
            }
            body.textContent = msg;
            el.classList.remove('hidden');
        }

        function copyUrl() {
            const input = document.getElementById('resultUrl');
            input.select();
            document.execCommand('copy');
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'OK!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }
    </script>

    <!-- Gemini Key Manager -->
    <script src="modules/gemini-key-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const updateKeyStatus = async () => {
                const currentLang = (typeof i18n !== 'undefined' && i18n.currentLang === 'en') ? 'en' : 'zh';
                GeminiKeyManager.setLang(currentLang);
                await GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
            };

            setTimeout(updateKeyStatus, 500);

            // Hook into toggleLanguage if it exists in this scope
            const originalToggleLanguage = window.toggleLanguage;
            if (typeof originalToggleLanguage === 'function') {
                window.toggleLanguage = function () {
                    originalToggleLanguage();
                    setTimeout(updateKeyStatus, 100);
                };
            }
        });
    </script>
</body>

</html>