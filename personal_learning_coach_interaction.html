<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Learning Coach - AI È©ÖÂãïÂ≠∏ÁøíÊïôÁ∑¥</title>
  <!-- ËºâÂÖ• Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ËºâÂÖ• React, ReactDOM, Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- ËºâÂÖ• PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700;900&display=swap"
    rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
            mono: ['Orbitron', 'monospace'],
          },
          colors: {
            slate: {
              850: '#1e293b', // Custom dark shade
              900: '#0f172a',
              950: '#020617',
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Global Styles & Animations */
    body {
      background: linear-gradient(135deg, #0F0F1A 0%, #1A1A2E 50%, #0F0F1A 100%);
      color: #E2E8F0;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }

    .title-glow {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899, #F59E0B, #10B981, #6366F1);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: titleShimmer 5s linear infinite;
    }

    @keyframes titleShimmer {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 300% 50%;
      }
    }

    .glass-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.8);
    }

    /* AI Response Formatting */
    .ai-response-block pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Inter', sans-serif;
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      color: #E2E8F0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #6366F1, #8B5CF6);
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(100%);
    }

    /* Inputs */
    .input-dark {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: white;
      transition: all 0.2s;
    }

    .input-dark:focus {
      border-color: #8B5CF6;
      outline: none;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
      background: rgba(30, 41, 59, 0.8);
    }

    .xp-bar-container {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 3px;
    }

    .xp-bar {
      height: 8px;
      border-radius: 10px;
      background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899);
      transition: width 0.5s ease;
    }
  </style>
  <!-- Dev-Scribe RPG Engine -->
  <script src="DevScribeRPG.js"></script>
</head>

<body>
  <!-- Gemini API Key Status Container -->
  <div class="fixed top-4 right-4 z-50">
    <div class="glass-card flex items-center gap-4 p-4 text-left shadow-2xl border-indigo-500/20">
      <div class="flex-1 flex items-center gap-3">
        <label class="block text-xs font-bold text-indigo-400 tracking-wider">GEMINI AI</label>
        <span id="gemini-key-status-container" class="text-sm">‚è≥</span>
      </div>
      <div class="text-xs text-gray-400 hidden md:block border-l border-indigo-500/20 pl-3">
        <i class="fas fa-shield-alt text-indigo-400"></i> Local Key Only
      </div>
    </div>
  </div>
  <div id="root"></div>

  <!-- Gemini Key Manager -->
  <script src="modules/gemini-key-manager.js"></script>
  <script>
    // Initial status render - React useEffect will handle subsequent updates
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof GeminiKeyManager !== 'undefined') {
        GeminiKeyManager.setLang('zh');
        await GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
      }
    });
  </script>

  <script type="text/babel">
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const { useState, useCallback, useEffect, useRef } = React;

    // --- Translations ---
    const i18n = {
      zh: {
        backToHub: "ËøîÂõû‰∏ªÈ†Å",
        appTitle: "Â≠∏ÁøíÊïôÁ∑¥ - Ë≠âÊìöÂàÜÊûêËàá N+1 Êé®Ë´ñ",
        appSubtitle: "AI È©ÖÂãïÁöÑÊ∑±Â∫¶Â≠∏ÁøíÂä©Êâã",
        secSettings: "Ë®≠ÂÆöËàáË≥áÊñô",
        secExplore: "Êé¢Á¥¢ËàáÂàÜÊûê",
        secSummary: "Á∏ΩÁµêËàáÂõûÈ°ß",
        labelGoal: "Êú¨Ê¨°Êé¢Á¥¢ÁõÆÊ®ô",
        phGoal: "‰æãÂ¶ÇÔºöÈÄôÈÉ®ÂΩ±ÁâáÊòØÂê¶ÊîØÊåÅ...",
        labelImport: "ÂåØÂÖ•‰∏äÊ¨°Á∏ΩÁµê (.md/.txt)",
        labelTranscript: "Âü∫Á§éÈÄêÂ≠óÁ®ø",
        phTranscript: "Ë≤º‰∏äÈÄêÂ≠óÁ®ø...",
        labelScreenshots: "Âü∫Á§éÊà™Âúñ",
        labelSupp: "N+1 È©óË≠âË≥áÊñô",
        tagAccuracy: "ÊèêÂçáÊ∫ñÁ¢∫Â∫¶",
        labelSuppText: "Ë£úÂÖÖÊñáÂ≠ó/ËßÄÂØü",
        phSuppText: "Áõ¥Êé•Ë≤º‰∏äÊñ∞ÁöÑË≠âÊìöÊñáÂ≠ó...",
        labelSuppFile: "‰∏äÂÇ≥‰ΩêË≠âÊ™îÊ°à (PDF, TXT, ÂúñÁâá)",
        msgNoData: "Ë´ãÂÖàË®≠ÂÆöÁõÆÊ®ô‰∏¶‰∏äÂÇ≥Ë≥áÊñô„ÄÇ",
        msgThinking: "ÊÄùËÄÉ‰∏≠...",
        btnAsk: "ÁôºÈÄÅ",
        btnFollowUp: "ËøΩÂïè",
        btnSummarize: "Á∏ΩÁµêÊàëÁöÑÁôºÁèæ (Âê´ N+1 Ë≥áÊñô)",
        btnProcessing: "ËôïÁêÜ‰∏≠...",
        btnQuiz: "ÁîüÊàêÊ∏¨È©óÈ°å ‚ú®",
        btnClear: "Ê∏ÖÈô§Á∏ΩÁµê",
        btnExport: "ÂåØÂá∫Á∏ΩÁµê",
        headerSummary: "Êú¨Ê¨°Á∏ΩÁµêÔºö",
        headerQuiz: "Ê∏¨È©óËàáÂèçÊÄùÈ°å",

        // Ranks
        rpgRank1: "Êñ∞ÊâãÊåëÊà∞ËÄÖ",
        rpgRank2: "Ë¶ãÁøíÂÜíÈö™ÂÆ∂",
        rpgRank3: "Êé¢Á¥¢ËÄÖ",
        rpgRank4: "ÊåëÊà∞ÈÅî‰∫∫",
        rpgRank5: "Á≤æËã±Êà∞Â£´",
        rpgRank6: "Â∞àÂÆ∂ÂºïÂ∞éËÄÖ",
        rpgRank7: "Â§ßÂ∏´ÂâµÈÄ†ËÄÖ",
        rpgRank8: "ÂÆóÂ∏´ÁÖâÈáëÂ∏´",
        rpgRank9: "ÂÇ≥Â•áÁ∑†ÈÄ†ËÄÖ",
        rpgRank10: "Â∏ùÂúãÈ†òË¢ñ",

        statusXP: "Á∂ìÈ©óÂÄº",
        statusTokens: "‰ª£Âπ£",
        nextLevel: "‰∏ãÂÄãÁ≠âÁ¥ö",
        statAnalyses: "Â∑≤ÂàÜÊûê"
      },
      en: {
        backToHub: "Back to Hub",
        appTitle: "Learning Coach - Evidence & Inference",
        appSubtitle: "AI-Powered Deep Learning Assistant",
        secSettings: "Settings & Data",
        secExplore: "Exploration & Analysis",
        secSummary: "Summary & Review",
        labelGoal: "Exploration Goal",
        phGoal: "E.g., Does this video support...",
        labelImport: "Import Summary (.md/.txt)",
        labelTranscript: "Base Transcript",
        phTranscript: "Paste transcript here...",
        labelScreenshots: "Base Screenshots",
        labelSupp: "N+1 Verification Data",
        tagAccuracy: "Accuracy Boost",
        labelSuppText: "Supplementary Text/Notes",
        phSuppText: "Paste new evidence here...",
        labelSuppFile: "Upload Proof (PDF, TXT, Image)",
        msgNoData: "Please set a goal and upload data first.",
        msgThinking: "Thinking...",
        btnAsk: "Send",
        btnFollowUp: "Follow Up",
        btnSummarize: "Summarize Findings (w/ N+1 Data)",
        btnProcessing: "Processing...",
        btnQuiz: "Generate Quiz ‚ú®",
        btnClear: "Clear",
        btnExport: "Export",
        headerSummary: "Current Summary:",
        headerQuiz: "Quiz & Reflection",

        // Ranks
        rpgRank1: "Novice Challenger",
        rpgRank2: "Apprentice Adventurer",
        rpgRank3: "Explorer",
        rpgRank4: "Challenge Expert",
        rpgRank5: "Elite Warrior",
        rpgRank6: "Specialist Guide",
        rpgRank7: "Master Creator",
        rpgRank8: "Grandmaster Alchemist",
        rpgRank9: "Legendary Architect",
        rpgRank10: "Empire Leader",

        statusXP: "XP",
        statusTokens: "Tokens",
        nextLevel: "Next Lvl",
        statAnalyses: "Analyses"
      }
    };

    // --- Helpers ---
    const toBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });

    const readTextFile = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = (e) => reject(e);
      reader.readAsText(file);
    });

    const readPdfFile = async (file) => {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += `[Page ${i}] ${textContent.items.map(item => item.str).join(" ")}\n`;
      }
      return fullText;
    };

    async function fetchWithRetry(url, options, retries = 3) {
      let attempt = 0;
      while (attempt < retries) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          return await response.json();
        } catch (error) {
          attempt++;
          if (attempt >= retries) throw error;
          await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
        }
      }
    }

    // --- Components ---

    const PlayerStatusCard = ({ lang, t }) => {
      const [state, setState] = useState(null);
      const [progress, setProgress] = useState({ progress: 0, xpNeeded: 0 });
      const [rankInfo, setRankInfo] = useState({ title: '', icon: '' });

      const updateStatus = useCallback(() => {
        if (typeof window.DevScribeRPG !== 'undefined') {
          const s = window.DevScribeRPG.getState();
          const level = s.level || 1;
          const prog = window.DevScribeRPG.getProgressToNextLevel(s.totalXP);
          const rankData = window.DevScribeRPG.RANKS.find(r => r.level === level);

          setState(s);
          setProgress(prog);

          const rankKey = 'rpgRank' + level;
          setRankInfo({
            title: t[rankKey] || rankData.title,
            icon: rankData.icon
          });
        }
      }, [t]);

      useEffect(() => {
        updateStatus();
        const handleUpdate = () => updateStatus();
        // Listen to RPG events
        window.addEventListener('devscribe:action', handleUpdate);
        window.addEventListener('devscribe:levelUp', handleUpdate);
        window.addEventListener('devscribe:challengeCompleted', handleUpdate);

        return () => {
          window.removeEventListener('devscribe:action', handleUpdate);
          window.removeEventListener('devscribe:levelUp', handleUpdate);
          window.removeEventListener('devscribe:challengeCompleted', handleUpdate);
        };
      }, [updateStatus]);

      if (!state) return <div className="glass-card p-4 mb-4 text-center text-gray-500 text-xs">Loading Profile...</div>;

      return (
        <div className="glass-card p-4 mb-6 relative overflow-hidden group">
          {/* Glow Effect */}
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-50"></div>

          <div className="flex items-center gap-4">
            {/* Rank Icon */}
            <div className="text-center min-w-[3.5rem]">
              <div className="text-4xl mb-1 filter drop-shadow-[0_0_10px_rgba(139,92,246,0.3)]">{rankInfo.icon}</div>
              <div className="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Lv.{state.level}</div>
            </div>

            {/* Stats */}
            <div className="flex-1 min-w-0">
              <div className="text-sm font-bold text-white truncate mb-1">{rankInfo.title}</div>

              <div className="flex justify-between items-end mb-1">
                <span className="text-[10px] text-gray-400 font-mono">{t.statusXP}</span>
                <span className="text-[10px] text-yellow-400 font-mono font-bold">{state.totalXP}</span>
              </div>

              <div className="xp-bar-container mb-2">
                <div className="xp-bar" style={{ width: `${progress.progress}%` }}></div>
              </div>

              <div className="flex justify-between items-end">
                <span className="text-[10px] text-gray-400 font-mono">{t.statusTokens}</span>
                <div className="flex items-center text-amber-400 font-bold text-sm">
                  <span className="mr-1">üí∞</span>{state.tokens}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const ModelMessage = ({ text }) => (
      <div className="flex justify-start w-full">
        <div className="max-w-[90%] px-5 py-4 rounded-2xl rounded-tl-none bg-slate-800/80 border border-slate-700 text-gray-200 shadow-xl ai-response-block ring-1 ring-white/5">
          <pre className="whitespace-pre-wrap font-sans text-sm leading-relaxed">{text}</pre>
        </div>
      </div>
    );

    const UserMessage = ({ text }) => (
      <div className="flex justify-end w-full">
        <div className="max-w-[85%] px-5 py-3 rounded-2xl rounded-tr-none bg-gradient-to-br from-indigo-600 to-purple-700 text-white shadow-lg text-sm">
          {text}
        </div>
      </div>
    );

    // --- Main App ---
    function App() {
      const [lang, setLang] = useState('zh');
      const t = i18n[lang];


      // Track if first mount
      const isFirstRender = useRef(true);

      // Sync GeminiKeyManager language (only re-render when lang CHANGES, not initial)
      useEffect(() => {
        if (typeof GeminiKeyManager !== 'undefined') {
          GeminiKeyManager.setLang(lang);
          // Only re-render on language change, not initial mount (DOM already handles that)
          if (!isFirstRender.current) {
            GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
          }
          isFirstRender.current = false;
        }
      }, [lang]);

      // State
      const [problemStatement, setProblemStatement] = useState('');
      const [transcript, setTranscript] = useState('');
      const [images, setImages] = useState([]);
      const [suppText, setSuppText] = useState('');
      const [suppFiles, setSuppFiles] = useState([]);

      const [chatHistory, setChatHistory] = useState([]);
      const [userQuery, setUserQuery] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [categorization, setCategorization] = useState('');
      const [importedSummary, setImportedSummary] = useState('');
      const [quizContent, setQuizContent] = useState('');
      const [isQuizLoading, setIsQuizLoading] = useState(false);
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);

      const apiKey = "AIzaSyCZAXCtLPnIE52p6Qpp8u_bzHH1QlpF7Bg"; // Updated API Key handling would be ideal

      // Toggle Lang
      const toggleLang = () => setLang(l => l === 'zh' ? 'en' : 'zh');

      // Handlers (Similar to original but updated for styling)
      const handleImageUpload = async (e) => {
        if (e.target.files) {
          setIsLoading(true);
          const newImages = [];
          for (const file of e.target.files) {
            if (file.type.startsWith('image/')) {
              try {
                const base64 = await toBase64(file);
                newImages.push({ name: file.name, base64 });
              } catch (err) { console.error(err); }
            }
          }
          setImages(prev => [...prev, ...newImages]);
          setIsLoading(false);
        }
      };

      const handleSuppFileUpload = async (e) => {
        if (!e.target.files) return;
        setIsLoading(true);
        const newFiles = [];
        for (const file of e.target.files) {
          try {
            let d = null;
            if (file.type === 'application/pdf') {
              const txt = await readPdfFile(file);
              d = { type: 'text', name: file.name, content: txt };
            } else if (file.type === 'text/plain') {
              const txt = await readTextFile(file);
              d = { type: 'text', name: file.name, content: txt };
            } else if (file.type.startsWith('image/')) {
              const b64 = await toBase64(file);
              d = { type: 'image', name: file.name, content: b64 };
            }
            if (d) newFiles.push(d);
          } catch (err) { console.error(err); }
        }
        setSuppFiles(prev => [...prev, ...newFiles]);
        setIsLoading(false);
      };

      const callGeminiAPI = async (contents, sysPrompt) => {
        setIsLoading(true);
        if (typeof GeminiKeyManager !== 'undefined') {
          await GeminiKeyManager.checkQuotaAndAlert();
        }
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
          const data = await fetchWithRetry(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: sysPrompt }] } })
          });
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
        } catch (e) {
          return `Error: ${e.message}`;
        } finally {
          setIsLoading(false);
        }
      };

      const handleQuerySubmit = async (e) => {
        e.preventDefault();
        if (!userQuery.trim() || isLoading) return;
        setQuizContent('');

        const q = userQuery;
        setChatHistory(prev => [...prev, { role: 'user', text: q }]);
        setUserQuery('');

        // Construct context (simplified for brevity, keeping logic)
        const sysPrompt = `
            ‰Ω†ÊòØ‰∏Ä‰ΩçË≠âÊìöÂûãÂ≠∏ÁøíÂàÜÊûêÊïôÁ∑¥„ÄÇ
            Áï∂‰ΩøÁî®ËÄÖË¶ÅÊ±ÇÊé®Ë´ñÊôÇÔºåË´ã‰ΩøÁî® N+1 Êé®Ë´ñÊ©üÂà∂Ôºö
            1. ÁèæÁãÄÁ¢∫Ë™ç (N): Â∑≤Áü•‰∫ãÂØ¶„ÄÅÁº∫Âè£„ÄÇ
            2. Êé®ÁêÜÈÅéÁ®ã (N+1): ÈÇèËºØÊé®Êºî„ÄÇ
            3. Ë≥áÊñôÈúÄÊ±Ç: ÈúÄË¶Å‰ªÄÈ∫ºË£úÂÖÖË≥áÊñô‰æÜÈ©óË≠â„ÄÇ
            Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÊáâ„ÄÇ
        `;

        const parts = [
          { text: `ÁõÆÊ®ô: ${problemStatement}` },
          { text: `ÈÄêÂ≠óÁ®ø: ${transcript}` }
        ];

        // Add images
        images.forEach((img, i) => {
          const b64 = img.base64.split(',')[1];
          parts.push({ text: `Âúñ${i + 1}:` });
          parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } });
        });

        // Add Supp
        if (suppText || suppFiles.length) {
          parts.push({ text: `Ë£úÂÖÖË≥áÊñô N+1: ${suppText}` });
          suppFiles.forEach(f => {
            if (f.type === 'text') parts.push({ text: `Ë£úÂÖÖÊñá‰ª∂ ${f.name}: ${f.content}` });
            else {
              const b64 = f.content.split(',')[1];
              parts.push({ text: `Ë£úÂÖÖÂúñ ${f.name}:` });
              parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } });
            }
          });
        }

        if (categorization) parts.push({ text: `ÂÖàÂâçÁ∏ΩÁµê: ${categorization}` });
        parts.push({ text: `ÂïèÈ°å: ${q}` });

        const resp = await callGeminiAPI([{ role: 'user', parts }], sysPrompt);
        setChatHistory(prev => [...prev, { role: 'model', text: resp }]);
      };

      const handleCategorize = async () => {
        const sysPrompt = `Ë´ãÁ∏ΩÁµê‰ΩøÁî®ËÄÖÁöÑÁôºÁèæÔºåÂúçÁπûÁõÆÊ®ôÔºö${problemStatement}„ÄÇÊ†ºÂºèÔºöÁõÆÊ®ô„ÄÅÊëòË¶Å„ÄÅÊ®ôÁ±§„ÄÇ`;
        // Re-use parts construction logic...
        const parts = [{ text: `ÁõÆÊ®ô: ${problemStatement}\nÈÄêÂ≠óÁ®ø: ${transcript}\nÊ≠∑Âè≤Â∞çË©±: ${chatHistory.map(m => m.text).join('\n')}` }];
        if (importedSummary) parts.push({ text: `‰∏äÊ¨°Á∏ΩÁµê: ${importedSummary}` });

        const resp = await callGeminiAPI([{ role: 'user', parts }], sysPrompt);
        setCategorization(resp);

        // Award XP
        if (typeof window.DevScribeRPG !== 'undefined') {
          const res = window.DevScribeRPG.recordModuleAction('library', 'knowledge_synthesis');
          window.DevScribeRPG.showXPNotification(res);
        }
      };

      const handleGenerateQuestions = async () => {
        setIsQuizLoading(true);
        const sys = "Ë´ãÊ†πÊìöÂÖßÂÆπÁîüÊàê 3-5 È°åÊ∏¨È©óÔºåÈôÑÁ≠îÊ°à„ÄÇMarkdownÊ†ºÂºè„ÄÇ";
        const cnt = [{ role: 'user', parts: [{ text: categorization }] }];
        const res = await callGeminiAPI(cnt, sys);
        setQuizContent(res);
        setIsQuizLoading(false);
      };

      return (
        <div className="flex flex-col md:flex-row h-screen overflow-hidden text-gray-200">
          {/* Lang Toggle */}
          <div className="fixed bottom-6 right-6 z-50">
            <button onClick={toggleLang} className="bg-slate-800/90 text-indigo-400 hover:text-white px-4 py-2 rounded-full border border-indigo-500/30 shadow-lg backdrop-blur-md transition flex items-center font-mono text-sm">
              <span className="mr-2">üåê</span>
              {lang === 'zh' ? 'EN' : '‰∏≠'}
            </button>
          </div>

          {/* --- Left Sidebar --- */}
          <div className={`${isSidebarOpen ? 'w-full md:w-[320px] lg:w-[380px]' : 'hidden'} flex-shrink-0 flex flex-col h-full bg-slate-900/50 backdrop-blur-xl border-r border-white/10 transition-all duration-300`}>
            <div className="p-5 overflow-y-auto custom-scrollbar flex-1 space-y-6">
              {/* Header */}
              <div className="flex items-center justify-between">
                <a href="rpg-hub.html" className="text-gray-400 hover:text-indigo-400 text-xs flex items-center transition">
                  <span className="mr-1">‚Üê</span> {t.backToHub}
                </a>
                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-gray-400">‚úï</button>
              </div>

              <div className="text-center">
                <h1 className="title-glow text-2xl font-black mb-1 px-2 leading-tight">{t.appTitle}</h1>
                <p className="text-xs text-gray-500">{t.appSubtitle}</p>
              </div>

              {/* Status Card */}
              <PlayerStatusCard lang={lang} t={t} />

              {/* Section 1: Settings */}
              <div className="space-y-4">
                <div className="flex items-center text-indigo-400 font-bold mb-2">
                  <span className="w-6 h-6 rounded-full bg-indigo-500/20 flex items-center justify-center text-xs mr-2 border border-indigo-500/30">1</span>
                  {t.secSettings}
                </div>

                <div className="glass-panel p-3">
                  <label className="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">{t.labelGoal}</label>
                  <textarea
                    value={problemStatement}
                    onChange={e => setProblemStatement(e.target.value)}
                    className="input-dark w-full p-2.5 rounded-lg text-sm min-h-[80px]"
                    placeholder={t.phGoal}
                  />
                </div>

                <div className="glass-panel p-3">
                  <label className="block text-xs font-bold text-gray-400 mb-2">{t.labelImport}</label>
                  <input type="file" onChange={e => {
                    const f = e.target.files[0];
                    if (f) {
                      const r = new FileReader();
                      r.onload = ev => { setImportedSummary(ev.target.result); alert('Loaded!'); };
                      r.readAsText(f);
                    }
                  }} className="block w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:bg-slate-700 file:text-indigo-300 hover:file:bg-slate-600 cursor-pointer" />
                </div>

                <div className="glass-panel p-3">
                  <label className="block text-xs font-bold text-gray-400 mb-2">{t.labelTranscript}</label>
                  <textarea
                    value={transcript}
                    onChange={e => setTranscript(e.target.value)}
                    className="input-dark w-full p-2.5 rounded-lg text-sm min-h-[100px]"
                    placeholder={t.phTranscript}
                  />
                </div>

                <div className="glass-panel p-3">
                  <label className="block text-xs font-bold text-gray-400 mb-2">{t.labelScreenshots}</label>
                  <input type="file" multiple accept="image/*" onChange={handleImageUpload} className="block w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:bg-slate-700 file:text-indigo-300 hover:file:bg-slate-600" />
                  {images.length > 0 && <div className="mt-2 grid grid-cols-3 gap-2">{images.map((img, i) => <div key={i} className="relative group"><img src={img.base64} className="h-12 w-full object-cover rounded border border-white/10" /><button onClick={() => setImages(p => p.filter((_, idx) => idx !== i))} className="absolute -top-1 -right-1 bg-red-500 rounded-full w-4 h-4 text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100">√ó</button></div>)}</div>}
                </div>

                {/* N+1 Data */}
                <div className="glass-panel p-3 border-orange-500/30 bg-orange-500/5">
                  <div className="flex justify-between items-center mb-2">
                    <label className="text-xs font-bold text-orange-400 uppercase">{t.labelSupp}</label>
                    <span className="text-[10px] bg-orange-500/20 text-orange-300 px-2 py-0.5 rounded-full border border-orange-500/30">{t.tagAccuracy}</span>
                  </div>

                  <textarea
                    value={suppText}
                    onChange={e => setSuppText(e.target.value)}
                    className="input-dark w-full p-2.5 rounded-lg text-sm min-h-[60px] mb-3 border-orange-500/20 focus:border-orange-500"
                    placeholder={t.phSuppText}
                  />
                  <input type="file" multiple accept=".pdf,.txt,image/*" onChange={handleSuppFileUpload} className="block w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:bg-orange-500/20 file:text-orange-300 hover:file:bg-orange-500/30" />

                  <div className="mt-2 space-y-1">
                    {suppFiles.map((f, i) => (
                      <div key={i} className="flex justify-between bg-black/20 p-1.5 rounded text-[10px] text-gray-400 border border-white/5">
                        <span className="truncate">{f.name}</span>
                        <button onClick={() => setSuppFiles(p => p.filter((_, idx) => idx !== i))} className="text-red-400 hover:text-red-300">√ó</button>
                      </div>
                    ))}
                  </div>
                </div>

              </div>
            </div>
          </div>

          {/* --- Main Content --- */}
          <div className="flex-1 flex flex-col h-full bg-slate-900/30 relative">
            {/* Mobile Toggle */}
            {!isSidebarOpen && <button onClick={() => setIsSidebarOpen(true)} className="absolute top-4 left-4 z-10 bg-slate-800 p-2 rounded-lg border border-white/10 shadow-lg md:hidden">‚ò∞</button>}
            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="hidden md:flex absolute top-1/2 -left-3 z-20 bg-slate-800 border border-white/10 w-6 h-12 rounded-full items-center justify-center text-gray-500 hover:text-white transition shadow-lg">{isSidebarOpen ? '‚Äπ' : '‚Ä∫'}</button>

            {/* Chat Area */}
            <div className="flex-1 flex flex-col min-h-0">
              <div className="p-4 border-b border-white/5 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center z-10">
                <div className="flex items-center text-indigo-400 font-bold">
                  <span className="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-sm mr-2 border border-indigo-500/30">2</span>
                  <span className="text-lg">{t.secExplore}</span>
                </div>
              </div>

              <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar">
                {chatHistory.length === 0 && (
                  <div className="h-full flex flex-col items-center justify-center text-gray-500 opacity-60">
                    <div className="text-6xl mb-4">üí¨</div>
                    <p>{t.msgNoData}</p>
                  </div>
                )}
                {chatHistory.map((msg, i) => (
                  msg.role === 'user' ? <UserMessage key={i} text={msg.text} /> : <ModelMessage key={i} text={msg.text} />
                ))}
                {isLoading && <div className="animate-pulse flex gap-2 items-center text-indigo-400 text-sm p-4"><div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></div>{t.msgThinking}</div>}
              </div>

              {/* Input Area */}
              <div className="p-4 md:p-6 bg-slate-900/80 border-t border-white/10 backdrop-blur-lg">
                <form onSubmit={handleQuerySubmit} className="flex gap-3 max-w-4xl mx-auto items-end">
                  <textarea
                    value={userQuery}
                    onChange={e => setUserQuery(e.target.value)}
                    className="input-dark flex-1 p-3 rounded-xl resize-none min-h-[50px] max-h-[120px]"
                    placeholder={t.btnAsk + "..."}
                    rows="1"
                  />
                  <button type="submit" disabled={isLoading || !userQuery.trim()} className="btn-primary h-[50px] px-6 rounded-xl font-bold flex items-center justify-center">
                    {chatHistory.length > 0 ? t.btnFollowUp : t.btnAsk}
                    <span className="ml-2 transform -rotate-45">‚û§</span>
                  </button>
                </form>
              </div>
            </div>

            {/* Summary Section (Collapsible or bottom panel) */}
            <div className="bg-slate-950/80 border-t border-white/10 p-4 md:p-6 max-h-[40vh] overflow-y-auto custom-scrollbar">
              <div className="max-w-4xl mx-auto">
                <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                  <div className="flex items-center text-indigo-400 font-bold">
                    <span className="w-6 h-6 rounded-full bg-indigo-500/20 flex items-center justify-center text-xs mr-2 border border-indigo-500/30">3</span>
                    {t.secSummary}
                  </div>
                  <div className="flex gap-2">
                    <button onClick={handleCategorize} disabled={isLoading} className="btn-primary px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-green-500/20 bg-gradient-to-r from-emerald-500 to-green-600 border-none">
                      {isLoading ? t.btnProcessing : t.btnSummarize}
                    </button>
                    {categorization && (
                      <>
                        <button onClick={handleGenerateQuestions} className="px-3 py-2 bg-purple-600/20 text-purple-300 border border-purple-500/50 rounded-lg text-xs hover:bg-purple-600/40 transition">{t.btnQuiz}</button>
                        <button onClick={() => handleExport} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs transition">{t.btnExport}</button>
                      </>
                    )}
                  </div>
                </div>

                {categorization && (
                  <div className="space-y-4 animate-fadeIn">
                    <div className="glass-panel p-6 border-emerald-500/20 bg-emerald-900/10">
                      <h3 className="text-emerald-400 font-bold mb-3 flex items-center"><span className="mr-2">üìù</span>{t.headerSummary}</h3>
                      <pre className="whitespace-pre-wrap font-sans text-sm text-gray-300 leading-relaxed">{categorization}</pre>
                    </div>

                    {isQuizLoading && <div className="text-center text-purple-400 animate-pulse">Generating Quiz...</div>}
                    {quizContent && (
                      <div className="glass-panel p-6 border-purple-500/20 bg-purple-900/10">
                        <h3 className="text-purple-400 font-bold mb-3 flex items-center"><span className="mr-2">üß†</span>{t.headerQuiz}</h3>
                        <pre className="whitespace-pre-wrap font-sans text-sm text-gray-300 leading-relaxed">{quizContent}</pre>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>