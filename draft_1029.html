<!DOCTYPE html>
<!-- v2.9.3-en: Changed lang to English and translated all UI elements -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Vocabulary & Collocation System (v2.9.3)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Style */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Highlight Style */
        .highlight {
            background-color: rgba(147, 197, 253, 0.4);
            /* blue-300/40 */
            color: #dbeafe;
            /* text-blue-100 */
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
            white-space: nowrap;
            /*
Ensure highlighted part does not wrap */
        }

        /* Hide Element */
        .hidden {
            display: none;
        }

        /* Simple Spinner Animation */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .band-tag {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    </style>
    <!-- Dev-Scribe RPG Engine -->
    <script src="DevScribeRPG.js"></script>
    <script src="modules/gemini-key-manager.js"></script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <!-- 語言切換按鈕 (固定位置，避免蓋到字) -->
    <div class="fixed bottom-6 right-6 z-50">
        <button id="langToggleBtn" type="button" onclick="toggleLanguage()"
            class="bg-slate-700/80 hover:bg-slate-600 backdrop-blur-md text-gray-300 text-sm py-2 px-4 rounded-full border border-slate-600 shadow-2xl transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
            </svg>
            <span id="langBtnText">EN</span>
        </button>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wider" data-i18n="pageTitle">
                ⚗️ 煉金實驗室 - Smart Vocabulary & Collocation System (v2.9.3)
            </h1>
            <div class="text-center">
                <a href="rpg-hub.html"
                    class="inline-flex items-center mt-4 px-4 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700 rounded-full text-indigo-400 hover:text-indigo-300 text-sm transition"
                    data-i18n="backLink">
                    ← 返回 Quest Empire
                </a>
            </div>
            <!-- v2.9.3-en: Translated -->
            <p class="text-lg text-gray-400 mt-4" data-i18n="pageSubtitle">
                Integrating Grammar Validation (GVL), Correction (GCE), and Cohesion & Coherence (C&C) Analysis
            </p>
            <!-- RPG Status Card -->
            <div id="rpg-status-card" class="mt-4 max-w-md mx-auto"></div>
            <!-- Gemini Status -->
            <!-- API Key Status (Synced Style) -->
            <div class="glass-card flex items-center gap-4 max-w-lg mx-auto mt-4 px-6 py-4 text-left">
                <div class="flex-1 flex items-center gap-3">
                    <label class="block text-xs font-bold text-indigo-400 tracking-wider">GEMINI AI</label>
                    <span id="gemini-key-status-container" class="text-sm"></span>
                </div>
                <div class="text-xs text-gray-500 hidden md:block">
                    <i class="fas fa-shield-alt text-green-400"></i> <span data-i18n="keySafe">Key 僅保存在本地</span>
                </div>
            </div>
        </header>

        <!-- API Key Input (Hidden: Managed by GeminiKeyManager) -->
        <div class="max-w-xl mx-auto mb-6 p-4 bg-gray-800 rounded-lg shadow-inner border border-gray-700 hidden">
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-300 mb-2" data-i18n="apiKeyLabel">
                Gemini API Key
            </label>
            <!-- v2.9.3-en: Translated -->
            <input type="password" id="apiKeyInput"
                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Managed by System" value="">
            <!-- v2.9.3-en: Translated -->
            <p class="text-xs text-gray-500 mt-2" data-i18n="apiKeyHint">
                Please paste your own Gemini API key to ensure service availability.
            </p>
        </div>

        <!-- Feature Tabs -->
        <!-- v2.9.3-en: Translated -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button id="tabPrediction"
                class="tab-button px-6 py-3 font-semibold text-white bg-gray-800 rounded-t-lg -mb-px border-t border-l border-r border-gray-700"
                data-i18n="tab1">
                1. Word Prediction
            </button>
            <button id="tabValidation"
                class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg"
                data-i18n="tab2">
                2. Collocation Validation
            </button>
            <button id="tabContinuation"
                class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg"
                data-i18n="tab3">
                3. Paragraph Analysis
            </button>
        </div>

        <!-- Main Content Area -->
        <main>
            <!-- 1. Prediction Content -->
            <div id="predictionContent">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <form id="predictionForm" class="space-y-4">
                        <!-- v2.9.3-en: Translated -->
                        <label for="predInput" class="block text-sm font-medium text-gray-300 mb-2"
                            data-i18n="inputContextLabel">Input Context
                            Phrase</label>
                        <input type="text" id="predInput"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="e.g., The government should implement effective policies to...">

                        <div id="igpvlPredError" class="text-sm rounded-lg"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <!-- v2.9.3-en: Translated -->
                                <label for="predPos" class="block text-sm font-medium text-gray-300 mb-2"
                                    data-i18n="wordClassLabel">Specify Word
                                    Class</label>
                                <select id="predPos"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- v2.9.3-en: Translated -->
                                    <option value="any" data-i18n="optAny">Any</option>
                                    <option value="N" data-i18n="optNoun">Noun</option>
                                    <option value="V" data-i18n="optVerb">Verb</option>
                                    <option value="Adj" data-i18n="optAdj">Adjective</option>
                                    <option value="Adv" data-i18n="optAdv">Adverb</option>
                                </select>
                            </div>
                            <div>
                                <!-- v2.9.3-en: Translated -->
                                <label for="predTask" class="block text-sm font-medium text-gray-300 mb-2"
                                    data-i18n="writingModeLabel">Writing
                                    Mode</label>
                                <select id="predTask"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- v2.9.3-en: Translated -->
                                    <option value="general" data-i18n="optGeneral">General</option>
                                    <option value="task1" data-i18n="optTask1">Data & Visual Report</option>
                                    <option value="task2" data-i18n="optTask2">Academic Essay</option>
                                    <option value="TechWriting" data-i18n="optTech">TechWriting</option>
                                </select>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <!-- v2.9.3-en: Translated -->
                            <h3 class="text-sm font-medium text-gray-300 mb-2" data-i18n="consistencyTitle">Consistency
                                Manager</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="block">
                                    <span class="text-xs text-gray-400" data-i18n="tempLabel">Temperature</span>
                                    <input type="number" id="predTemp" value="0.7" step="0.1" min="0.1" max="1.0"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400" data-i18n="topPLabel">Top-P (Nucleus
                                        Sampling)</span>
                                    <input type="number" id="predTopP" value="0.95" step="0.05" min="0.0" max="1.0"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400" data-i18n="contextWordsLabel">Context
                                        Words</span>
                                    <input type="number" id="predContextLen" value="20" min="5" max="50"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400" data-i18n="scLabel">Self-Consistency
                                        Iterations</span>
                                    <input type="number" id="predSC" value="3" min="1" max="5" disabled
                                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-gray-500 text-sm">
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="predButton"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50 mt-4">
                            <!-- v2.9.3-en: Translated -->
                            <span id="predButtonText" data-i18n="btnGetPredictions">Get 6 Predictions</span>
                            <div id="predLoading" class="spinner hidden"></div>
                        </button>
                    </form>

                    <!-- Custom Word Validation Area -->
                    <div class="pt-6 border-t border-gray-700 mt-6">
                        <!-- v2.9.3-en: Translated -->
                        <h2 class="text-xl font-semibold text-white mb-3" data-i18n="customWordTitle">2. Custom Word
                            Check</h2>
                        <form id="customWordForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <!-- v2.9.3-en: Translated -->
                                <input type="text" id="customWordInput"
                                    class="bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                                    placeholder="Enter word to check (e.g., 'growth')">
                                <button type="submit" id="customButton"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                                    <!-- v2.9.3-en: Translated -->
                                    <span id="customButtonText" data-i18n="btnCheckWord">Check Word</span>
                                    <div id="customLoading" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        <div id="igpvlCustomError" class="text-sm rounded-lg mt-4"></div>
                        <div id="customResults" class="mt-4"></div>
                    </div>
                </div>

                <!-- Prediction Results Area -->
                <div id="predError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="predictionResults" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Prediction result cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- 2. Validation Content -->
            <div id="validationContent" class="hidden">
                <form id="validationForm" class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <div>
                        <!-- v2.9.3-en: Translated -->
                        <label for="valInput1" class="block text-sm font-medium text-gray-300 mb-2"
                            data-i18n="valInitPhraseLabel">Collocation -
                            Initial Phrase</label>
                        <input type="text" id="valInput1"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="e.g., make a">
                    </div>
                    <div>
                        <!-- v2.9.3-en: Translated -->
                        <label for="valInput2" class="block text-sm font-medium text-gray-300 mb-2"
                            data-i18n="valTargetWordLabel">Collocation - Target
                            Word/Phrase</label>
                        <input type="text" id="valInput2"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="e.g., decision">
                    </div>

                    <div id="igpvlValError" class="text-sm rounded-lg"></div>

                    <button type="submit" id="valButton"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                        <!-- v2.9.3-en: Translated -->
                        <span id="valButtonText" data-i18n="btnValidateCollocation">Validate Collocation</span>
                        <div id="valLoading" class="spinner hidden"></div>
                    </button>
                </form>

                <!-- Validation Results Area -->
                <div id="valError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="validationResults" class="mt-8 bg-gray-800 p-6 rounded-lg shadow-xl hidden">
                    <!-- Validation results will be dynamically inserted here -->
                </div>
            </div>

            <!-- 3. Continuation Content -->
            <div id="continuationContent" class="hidden">
                <!-- Form 1: Paragraph Continuation -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white" data-i18n="contTitle1">1. Paragraph Continuation &
                        Analysis</h2>
                    <form id="continuationForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="contInput" class="block text-sm font-medium text-gray-300 mb-2"
                                data-i18n="contParagraphLabel">Input
                                Paragraph</label>
                            <textarea id="contInput" rows="5"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., The silk industry has a long history in Asia..."></textarea>
                        </div>

                        <!-- IGPVL Error Area -->
                        <div id="igpvlContError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="contButton"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="contButtonText" data-i18n="btnAnalyzeContinuation">Predict Next Sentence &
                                Analyze</span>
                            <div id="contLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- Continuation Results Area -->
                    <div id="contError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="continuationResult" class="mt-6 hidden">
                        <!-- Continuation results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Form 2: Sentence Band Prediction -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6 mt-8">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white" data-i18n="contTitle2">2. Single Sentence Band
                        Prediction</h2>
                    <form id="bandPredictionForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="bandInput" class="block text-sm font-medium text-gray-300 mb-2"
                                data-i18n="bandSentenceLabel">Input
                                Sentence</label>
                            <input type="text" id="bandInput"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., This process begins with the cultivation of silkworms.">
                        </div>

                        <!-- IGPVL Error Area -->
                        <div id="igpvlBandError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="bandButton"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="bandButtonText" data-i18n="btnBandPrediction">Predict Sentence Band</span>
                            <div id="bandLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- Band Prediction Results Area -->
                    <div id="bandError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="bandPredictionResult" class="mt-6 hidden">
                        <!-- Band prediction results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- === [MODIFICATION START] v2.9.3 SWOT Analysis Form === -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6 mt-8">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white" data-i18n="swotTitle">3. Cohesion &amp; Coherence (C&C)
                        SWOT Analysis</h2>
                    <!-- v2.9.3-en: Translated -->
                    <p class="text-sm text-gray-400" data-i18n="swotSubtitle">
                        Evaluates the logical coherence between the 'Previous Paragraph' and the 'Opening Sentence of
                        the next'.
                        <br>
                        <strong class="text-teal-300">v2.9.3 Update:</strong> Enter two options, and the system will
                        compare and analyze the best choice.
                    </p>
                    <form id="swotForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputParagraph" class="block text-sm font-medium text-gray-300 mb-2"
                                data-i18n="swotParagraphLabel">Input
                                Full Previous Paragraph</label>
                            <textarea id="swotInputParagraph" rows="5"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., ...This reliance on private vehicles has led to significant traffic congestion."></textarea>
                        </div>
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputSentence1" class="block text-sm font-medium text-gray-300 mb-2"
                                data-i18n="swotOption1Label">Input
                                Next Paragraph Opening (Option 1)</label>
                            <input type="text" id="swotInputSentence1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., However, the government has failed to invest in public transport.">
                        </div>
                        <!-- v2.9.3 Add -->
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputSentence2" class="block text-sm font-medium text-gray-300 mb-2"
                                data-i18n="swotOption2Label">Input
                                Next Paragraph Opening (Option 2)</label>
                            <input type="text" id="swotInputSentence2"
                                class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., To address this issue, improving public transportation is essential.">
                        </div>

                        <!-- IGPVL Error Area -->
                        <div id="igpvlSwotError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="swotButton"
                            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="swotButtonText" data-i18n="btnRunSwot">Compare & Run SWOT Analysis</span>
                            <div id="swotLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- SWOT Results Area -->
                    <div id="swotError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="swotResult" class="mt-6 hidden">
                        <!-- SWOT results will be dynamically inserted here -->
                    </div>
                </div>
                <!-- === [MODIFICATION END] v2.9.3 SWOT Analysis Form === -->

            </div>

        </main>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- Internationalization (i18n) System ---
        window.i18n = {
            currentLang: 'zh',
            translations: {
                zh: {
                    pageTitle: '⚗️ 煉金實驗室 - Smart Vocabulary & Collocation System (v2.9.3)',
                    pageSubtitle: '整合語法驗證 (GVL)、更正 (GCE) 與連貫性 (C&C) 分析',
                    apiKeyLabel: 'Gemini API 金鑰',
                    apiKeyHint: '請貼上您自己的 Gemini API 金鑰以確保服務可用性。',
                    tab1: '1. 單字預測 (Word Prediction)',
                    tab2: '2. 搭配詞驗證 (Validation)',
                    tab3: '3. 段落分析 (Paragraph Analysis)',
                    inputContextLabel: '輸入上下文語句 (Input Context)',
                    wordClassLabel: '指定詞性 (Word Class)',
                    optAny: '不限',
                    optNoun: '名詞 (Noun)',
                    optVerb: '動詞 (Verb)',
                    optAdj: '形容詞 (Adjective)',
                    optAdv: '副詞 (Adverb)',
                    writingModeLabel: '寫作模式',
                    optGeneral: '通用寫作 (General)',
                    optTask1: '數據與圖表報告 (Task 1)',
                    optTask2: '學術論文 (Task 2)',
                    optTech: '技術寫作 (Tech)',
                    consistencyTitle: '一致性管理器 (Consistency Manager)',
                    tempLabel: '溫度 (Temperature)',
                    topPLabel: '核採樣 (Top-P)',
                    contextWordsLabel: '上下文單字數',
                    scLabel: '自我一致性迭代 (Self-Consistency)',
                    btnGetPredictions: '取得 6 個預測',
                    customWordTitle: '2. 選定單字檢查',
                    btnCheckWord: '檢查單字',
                    valInitPhraseLabel: '搭配詞 - 初始片語',
                    valTargetWordLabel: '搭配詞 - 目標單字/片語',
                    btnValidateCollocation: '驗證搭配詞',
                    contTitle1: '1. 段落續寫與分析',
                    contParagraphLabel: '輸入段落',
                    btnAnalyzeContinuation: '預測下一句並分析',
                    contTitle2: '2. 單句雅思等級預測',
                    bandSentenceLabel: '輸入句子',
                    btnBandPrediction: '預測句子等級',
                    swotTitle: '3. 連貫性與銜接 (C&C) SWOT 分析',
                    swotSubtitle: "評估「前段內容」與「下一段開頭句」之間的邏輯連貫性。<br><strong class='text-teal-300'>v2.9.3 更新：</strong>輸入兩個選項，系統將進行比較並分析最佳選擇。",
                    swotParagraphLabel: '輸入前一段完整內容',
                    swotOption1Label: '下一段開頭句 (選項 1)',
                    swotOption2Label: '下一段開頭句 (選項 2)',
                    btnRunSwot: '比較並執行 SWOT 分析',
                    langBtnText: 'EN',
                    // Dictionary for dynamic strings
                    getPredictions: "取得 6 個預測項目",
                    checkWord: "檢查單字",
                    validatingInput: "1/2 正在驗證輸入...",
                    generatingPredictions: "2/2 正在生成預測...",
                    analyzingPredictions: "2/2 正在分析與檢查...",
                    unexpectedFormat: "收到非預期的回應格式。",
                    errorApiKeyEmpty: "API 金鑰為空。請在上方欄位提供有效的金鑰。",
                    errorEnterPhrase: "請輸入英文片語。",
                    errorEnterSentence: "請輸入句子。",
                    errorEnterParagraph: "請輸入段落。",
                    errorEnterSwot: "請輸入前一段內容與兩個句子選項。",
                    validatingOption: "正在驗證選項 {index}...",
                    comparingOptions: "3/4 正在比較選項...",
                    runningSwot: "4/4 正在執行 SWOT 分析...",
                    analysisComplete: "分析完成",
                    continuationHeader: "預測續寫",
                    predictedBand: "預測等級",
                    predictedNextSentence: "預測下一句",
                    bandPredictionHeader: "雅思寫作等級預測",
                    checkPassed: "驗證通過",
                    ccComparisonHeader: "C&C 銜接連結比較結果",
                    bestOption: "🏆 最佳選項 (選項 {index})",
                    otherOption: "其他選項 (選項 {index})",
                    swotAnalysisHeader: "SWOT 分析報告 (針對選項 {index})",
                    estimatedCcBand: "預估 C&C 等級",
                    overallAssessment: "總體評估",
                    strengths: "優勢 (Strengths)",
                    weaknesses: "劣勢 (Weaknesses)",
                    opportunities: "機會 (Opportunities)",
                    threats: "威脅 (Threats)",
                    none: "無",
                    generationFailed: "分析生成失敗",
                    grammarReportTitle: "GVL 語法驗證報告",
                    correctnessLabel: "正確性",
                    errorsFound: "發現 {count} 個錯誤",
                    clarityLabel: "清晰度",
                    engagementLabel: "參與度/詞彙",
                    deliveryLabel: "語氣與交付",
                    rewritePrompt: "建議改寫",
                    compareSwot: "比較並執行 SWOT 分析",
                    validateCollocation: "驗證搭配詞",
                    predictAnalyze: "預測下一句並分析",
                    predictSentenceBand: "預測句子等級",
                    predictingBand: "2/2 正在預測等級...",
                    // RPG Ranks & Messages
                    rpgRank1: "新手挑戰者",
                    rpgRank2: "見習冒險家",
                    rpgRank3: "探索者",
                    rpgRank4: "挑戰達人",
                    rpgRank5: "精英戰士",
                    rpgRank6: "專家引導者",
                    rpgRank7: "大師創造者",
                    rpgRank8: "宗師煉金師",
                    rpgRank9: "傳奇締造者",
                    rpgRank10: "帝國領袖",
                    backLink: "← 返回 Quest Empire",
                    rpgXpNeeded: "還需 {xp} XP 升級",
                    // Band Summaries
                    band9Cohesion: "連貫性極佳，自然流暢且高度連貫。",
                    band8Cohesion: "結構清晰，銜接順暢，僅有極少數不自然之處。",
                    band7Cohesion: "具備連貫性但略顯生硬；部分銜接詞或指代不夠精確。",
                    band6Cohesion: "具備整體邏輯，但言談銜接偶爾不平衡或重複。",
                    band5Cohesion: "結構鬆散，句子間缺乏自然聯繫或過於機械化。",
                    band9Lexical: "完全自然，搭配強度極高；接近母語表達。",
                    band8Lexical: "流利且靈活，偶有誤用；仍屬高階搭配。",
                    band7Lexical: "可理解且常見，但略顯機械化或重複。",
                    band6Lexical: "自然度適中；意義清晰但搭配不夠道地。",
                    band5Lexical: "不自然或生硬；建議替換。"
                },
                en: {
                    pageTitle: '⚗️ Alchemy Lab - Smart Vocabulary & Collocation System (v2.9.3)',
                    pageSubtitle: 'Integrating Grammar Validation (GVL), Correction (GCE), and Cohesion & Coherence (C&C) Analysis',
                    apiKeyLabel: 'Gemini API Key',
                    apiKeyHint: 'Please paste your own Gemini API key to ensure service availability.',
                    tab1: '1. Word Prediction',
                    tab2: '2. Collocation Validation',
                    tab3: '3. Paragraph Analysis',
                    inputContextLabel: 'Input Context Phrase',
                    wordClassLabel: 'Specify Word Class',
                    optAny: 'Any',
                    optNoun: 'Noun',
                    optVerb: 'Verb',
                    optAdj: 'Adjective',
                    optAdv: 'Adverb',
                    writingModeLabel: 'Writing Mode',
                    optGeneral: 'General',
                    optTask1: 'Data & Visual Report',
                    optTask2: 'Academic Essay',
                    optTech: 'TechWriting',
                    consistencyTitle: 'Consistency Manager',
                    tempLabel: 'Temperature',
                    topPLabel: 'Top-P (Nucleus Sampling)',
                    contextWordsLabel: 'Context Words',
                    scLabel: 'Self-Consistency Iterations',
                    btnGetPredictions: 'Get 6 Predictions',
                    customWordTitle: '2. Custom Word Check',
                    btnCheckWord: 'Check Word',
                    valInitPhraseLabel: 'Collocation - Initial Phrase',
                    valTargetWordLabel: 'Collocation - Target Word/Phrase',
                    btnValidateCollocation: 'Validate Collocation',
                    contTitle1: '1. Paragraph Continuation & Analysis',
                    contParagraphLabel: 'Input Paragraph',
                    btnAnalyzeContinuation: 'Predict Next Sentence & Analyze',
                    contTitle2: '2. Single Sentence Band Prediction',
                    bandSentenceLabel: 'Input Sentence',
                    btnBandPrediction: 'Predict Sentence Band',
                    swotTitle: '3. Cohesion & Coherence (C&C) SWOT Analysis',
                    swotSubtitle: "Evaluates the logical coherence between the 'Previous Paragraph' and the 'Opening Sentence of the next'.<br><strong class='text-teal-300'>v2.9.3 Update:</strong> Enter two options, and the system will compare and analyze the best choice.",
                    swotParagraphLabel: 'Input Full Previous Paragraph',
                    swotOption1Label: 'Next Paragraph Opening (Option 1)',
                    swotOption2Label: 'Next Paragraph Opening (Option 2)',
                    btnRunSwot: 'Compare & Run SWOT Analysis',
                    langBtnText: '中文',
                    // Dictionary for dynamic strings
                    getPredictions: "Get 6 Predictions",
                    checkWord: "Check Word",
                    validatingInput: "1/2 Validating Input...",
                    generatingPredictions: "2/2 Generating Predictions...",
                    analyzingPredictions: "2/2 Checking...",
                    unexpectedFormat: "Received unexpected response format.",
                    errorApiKeyEmpty: "API key is empty. Please provide a valid API key in the field above.",
                    errorEnterPhrase: "Please enter an English phrase.",
                    errorEnterSentence: "Please enter a sentence.",
                    errorEnterParagraph: "Please enter a paragraph.",
                    errorEnterSwot: "Please enter the previous paragraph and both sentence options.",
                    validatingOption: "Validating Option {index}...",
                    comparingOptions: "3/4 Comparing Options...",
                    runningSwot: "4/4 Running SWOT Analysis...",
                    analysisComplete: "Analysis Complete",
                    continuationHeader: "Predicted Continuation",
                    predictedBand: "Predicted Band",
                    predictedNextSentence: "Predicted Next Sentence",
                    bandPredictionHeader: "IELTS Band Prediction",
                    checkPassed: "Check Passed",
                    ccComparisonHeader: "C&C Connection Comparison",
                    bestOption: "🏆 Best Option (Option {index})",
                    otherOption: "Other Option (Option {index})",
                    swotAnalysisHeader: "SWOT Analysis Report (for Option {index})",
                    estimatedCcBand: "Estimated C&C Band",
                    overallAssessment: "Overall Assessment",
                    strengths: "Strengths",
                    weaknesses: "Weaknesses",
                    opportunities: "Opportunities",
                    threats: "Threats",
                    none: "None",
                    generationFailed: "Generation Failed",
                    grammarReportTitle: "GVL Validation Report",
                    correctnessLabel: "Correctness",
                    errorsFound: "{count} errors found",
                    clarityLabel: "Clarity",
                    engagementLabel: "Engagement",
                    deliveryLabel: "Delivery",
                    rewritePrompt: "Rewrite Suggestion",
                    compareSwot: "Compare & Run SWOT Analysis",
                    validateCollocation: "Validate Collocation",
                    predictAnalyze: "Predict Next Sentence & Analyze",
                    predictSentenceBand: "Predict Sentence Band",
                    predictingBand: "2/2 Predicting Band...",
                    // RPG Ranks & Messages
                    rpgRank1: "Novice Challenger",
                    rpgRank2: "Apprentice Adventurer",
                    rpgRank3: "Seeker",
                    rpgRank4: "Challenge Master",
                    rpgRank5: "Elite Warrior",
                    rpgRank6: "Expert Guide",
                    rpgRank7: "Master Creator",
                    rpgRank8: "Grandmaster Alchemist",
                    rpgRank9: "Legend Maker",
                    rpgRank10: "Empire Leader",
                    backLink: "← Back to Quest Empire",
                    rpgXpNeeded: "{xp} XP needed to level up",
                    // Band Summaries
                    band9Cohesion: "Fluent, natural cohesion, extremely high coherence.",
                    band8Cohesion: "Clear structure, smooth cohesion, only occasional minor unnaturalness.",
                    band7Cohesion: "Coherent but slightly mechanical; some connectors or references are imprecise.",
                    band6Cohesion: "Overall logic exists, but discourse cohesion is occasionally unbalanced or repetitive.",
                    band5Cohesion: "Loose structure, lacking natural or overly mechanical links between sentences.",
                    band9Lexical: "Completely natural, very high collocation strength; near-native expression.",
                    band8Lexical: "Fluent and flexible, minor misuse; still high-level collocation.",
                    band7Lexical: "Understandable and common, but slightly mechanical or repetitive.",
                    band6Lexical: "Moderate naturalness; meaning is clear but collocation is not idiomatic.",
                    band5Lexical: "Unnatural or awkward; replacement suggested."
                }
            },

            t: function (key, params = {}) {
                let text = this.translations[this.currentLang][key] || key;
                for (const [k, v] of Object.entries(params)) {
                    text = text.replace(new RegExp(`\\{${k}\\}`, 'g'), v);
                }
                return text;
            },

            setLanguage: function (lang) {
                this.currentLang = lang;
                localStorage.setItem('github_manager_lang', lang);
                this.applyTranslations();
            },

            loadSavedLanguage: function () {
                const savedLang = localStorage.getItem('github_manager_lang');
                if (savedLang && this.translations[savedLang]) {
                    this.currentLang = savedLang;
                }
            },

            applyTranslations: function () {
                try {
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (!key) return;
                        el.innerHTML = this.t(key);
                    });

                    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                        const key = el.getAttribute('data-i18n-placeholder');
                        el.placeholder = this.t(key);
                    });

                    // Update language toggle button text
                    const btnText = document.getElementById('langBtnText');
                    if (btnText) {
                        btnText.innerText = this.currentLang === 'zh' ? 'EN' : '中文';
                    }

                    // Update RPG Status Card
                    if (typeof DevScribeRPG !== 'undefined' && document.getElementById('rpg-status-card')) {
                        try {
                            document.getElementById('rpg-status-card').innerHTML = DevScribeRPG.generateStatusCardHTML();
                        } catch (e) {
                            console.warn('[i18n] Failed to update RPG status card:', e);
                        }
                    }

                    document.documentElement.lang = this.currentLang === 'zh' ? 'zh-Hant' : 'en';
                    console.log(`[i18n] Language set to: ${this.currentLang}`);
                } catch (error) {
                    console.error('[i18n] Error applying translations:', error);
                }
            }
        };

        window.toggleLanguage = function () {
            const newLang = window.i18n.currentLang === 'zh' ? 'en' : 'zh';
            window.i18n.setLanguage(newLang);
        };

        // Initialize i18n
        window.i18n.loadSavedLanguage();
        window.addEventListener('DOMContentLoaded', () => {
            window.i18n.applyTranslations();

            // Sync RPG status
            if (typeof DevScribeRPG !== 'undefined' && document.getElementById('rpg-status-card')) {
                const updateRPG = () => {
                    document.getElementById('rpg-status-card').innerHTML = DevScribeRPG.generateStatusCardHTML();
                };
                window.addEventListener('questempire:action', updateRPG);
            }
        });

        // --- [MODIFICATION] Gemini API Key ---
        // API Key is now read from the 'apiKeyInput' field in the HTML.
        // const apiKey = "AIzaSyAzBdrm2Ma3LWkdo87hC_TZlLPc7cuqNEo"; // Old hard-coded key
        // API URL is now dynamically constructed inside callGeminiAPI().
        // const apiUrl = `...`;
        // --- [MODIFICATION END] ---

        // --- DOM Element References ---
        const tabs = {
            prediction: document.getElementById('tabPrediction'),
            validation: document.getElementById('tabValidation'),
            continuation: document.getElementById('tabContinuation') // v2.8 Add
        };
        const contents = {
            prediction: document.getElementById('predictionContent'),
            validation: document.getElementById('validationContent'),
            continuation: document.getElementById('continuationContent') // v2.8 Add
        };

        // Prediction-related elements
        const predForm = document.getElementById('predictionForm');
        const predInput = document.getElementById('predInput');
        const predPos = document.getElementById('predPos');
        const predTask = document.getElementById('predTask');
        const predTemp = document.getElementById('predTemp');
        const predTopP = document.getElementById('predTopP');
        const predContextLen = document.getElementById('predContextLen'); // T1.4 Get DOM
        const predButton = document.getElementById('predButton');
        const predButtonText = document.getElementById('predButtonText');
        const predLoading = document.getElementById('predLoading');
        const predError = document.getElementById('predError');
        const predictionResults = document.getElementById('predictionResults');
        const igpvlPredError = document.getElementById('igpvlPredError'); // v2.6 IGPVL Add

        // Custom Word-related elements
        const customWordForm = document.getElementById('customWordForm');
        const customWordInput = document.getElementById('customWordInput');
        const customButton = document.getElementById('customButton');
        const customButtonText = document.getElementById('customButtonText');
        const customLoading = document.getElementById('customLoading');
        const customResults = document.getElementById('customResults');
        const igpvlCustomError = document.getElementById('igpvlCustomError'); // v2.6 IGPVL Add

        // Validation-related elements
        const valForm = document.getElementById('validationForm');
        const valInput1 = document.getElementById('valInput1');
        const valInput2 = document.getElementById('valInput2');
        const valButton = document.getElementById('valButton');
        const valButtonText = document.getElementById('valButtonText');
        const valLoading = document.getElementById('valLoading');
        const valError = document.getElementById('valError');
        const validationResults = document.getElementById('validationResults');
        const igpvlValError = document.getElementById('igpvlValError'); // v2.6 IGPVL Add

        // v2.8 Add: Continuation-related elements
        const continuationForm = document.getElementById('continuationForm');
        const contInput = document.getElementById('contInput');
        const contButton = document.getElementById('contButton');
        const contButtonText = document.getElementById('contButtonText');
        const contLoading = document.getElementById('contLoading');
        const igpvlContError = document.getElementById('igpvlContError');
        const contError = document.getElementById('contError');
        const continuationResult = document.getElementById('continuationResult');

        // v2.8 Add: Band Prediction-related elements
        const bandPredictionForm = document.getElementById('bandPredictionForm');
        const bandInput = document.getElementById('bandInput');
        const bandButton = document.getElementById('bandButton');
        const bandButtonText = document.getElementById('bandButtonText');
        const bandLoading = document.getElementById('bandLoading');
        const igpvlBandError = document.getElementById('igpvlBandError');
        const bandError = document.getElementById('bandError');
        const bandPredictionResult = document.getElementById('bandPredictionResult');

        // --- [MODIFICATION START] API Key Input ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        // --- [MODIFICATION END] ---

        // v2.9 Add: SWOT Analysis elements
        const swotForm = document.getElementById('swotForm');
        const swotInputParagraph = document.getElementById('swotInputParagraph');
        // v2.9.3: Rename
        const swotInputSentence1 = document.getElementById('swotInputSentence1');
        // v2.9.3: Add
        const swotInputSentence2 = document.getElementById('swotInputSentence2');
        const swotButton = document.getElementById('swotButton');
        const swotButtonText = document.getElementById('swotButtonText');
        const swotLoading = document.getElementById('swotLoading');
        const igpvlSwotError = document.getElementById('igpvlSwotError');
        const swotError = document.getElementById('swotError');
        const swotResult = document.getElementById('swotResult');

        // T1.8 / T2.8 Fix: Regeneration history
        const regenerationHistory = {};

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Schema ---
        // Schema defined according to user's v2.6 specification
        const igpvlSchema = {
            "type": "OBJECT",
            "description": "Real-time feedback from Input Grammar Pre-Validation Layer (IGPVL)",
            "properties": {
                "input_id": { "type": "STRING", "description": "Unique ID corresponding to the request" },
                "status": { "type": "STRING", "enum": ["passed", "warning", "blocked"], "description": "Validation status" },
                "error_count": { "type": "NUMBER", "description": "Total number of grammar errors detected" },
                "severity": { "type": "STRING", "enum": ["none", "minor", "major"], "description": "Overall error severity" },
                "errors": {
                    "type": "ARRAY",
                    "description": "List of detected errors",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "type": { "type": "STRING", "enum": ["subject_verb_agreement", "tense_error", "article_error", "pronoun_error", "number_agreement", "dangling_modifier", "incomplete_comparison", "double_negative", "inconsistent_tense_shift", "spelling", "contextual_spelling", "capitalization_error", "number_format_error", "hyphenation_error", "end_punctuation", "internal_punctuation", "quotation_marks"], "description": "Error type, must be selected from a predefined list to match the four major check categories." },
                            "message": { "type": "STRING", "description": "Description of the error" },
                            "suggestion": { "type": "STRING", "description": "Grammatically correct suggestion (can be a full sentence or fragment)" },
                            "severity": { "type": "STRING", "enum": ["minor", "major"], "description": "Severity of this error" },
                            "code": { "type": "STRING", "description": "Standard-compliant error code (e.g., 'IGPVL-CORE-XX')" }
                        },
                        "required": ["type", "message", "suggestion", "code"]
                    }
                },
                "recommendation": { "type": "STRING", "description": "Overall recommendation for the user, providing a grammatically correct sentence" },
                "timestamp": { "type": "STRING", "format": "date-time", "description": "Timestamp in ISO 8601 format" }
            },
            "required": ["input_id", "status", "error_count", "severity", "errors", "recommendation", "timestamp"]
        };

        // --- v3.0 GVL (Grammar Validation Layer) Schema ---
        // This is the *original* GVL schema for Tabs 1 & 2.
        // It will be *preserved* to maintain original functionality.
        const grammarValidationSchemaObject = {
            "type": "OBJECT",
            "description": "Detailed analysis results from Grammar Validation Layer v3.0",
            "properties": {
                "correctness": {
                    "type": "OBJECT",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
                            "description": "I. Correctness (Grammar, Spelling, Punctuation). List of all 'Correctness' related grammar, spelling, punctuation errors. Empty array [] means 'Check passed'.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING", "description": "Error type (e.g., 'Subject-Verb Agreement', 'Tense Error', 'Article Error', 'Pronoun Error', 'Number Agreement', 'Dangling Modifier', 'Incomplete Comparison', 'Double Negative', 'Inconsistent Tense Shift', 'General Spelling', 'Contextual Spelling', 'Capitalization Error', 'Number Format Error', 'Hyphenation Error', 'End Punctuation Error', 'Internal Punctuation Misuse - incl. Comma/Semicolon/Colon')" },
                                    "original": { "type": "STRING", "description": "Original incorrect fragment" },
                                    "correction": { "type": "STRING", "description": "Correction suggestion" },
                                    "explanation": { "type": "STRING", "description": "Brief explanation" }
                                },
                                "required": ["type", "original", "correction"]
                            }
                        }
                    },
                    "required": ["errors"]
                },
                "clarity": {
                    "type": "OBJECT",
                    "description": "II. Clarity - Suggestive",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Clarity issues (e.g., 'Run-on Sentence', 'Sentence Fragment', 'Wordiness', 'Fluency')", "items": { "type": "STRING" } },
                        "rewrite_suggestion": { "type": "STRING", "description": "Complete rewrite suggestion for complex sentences (empty string if none)" },
                        "passive_voice_warning": { "type": "BOOLEAN", "description": "Whether passive voice is overused" }
                    },
                    "required": ["feedback", "rewrite_suggestion", "passive_voice_warning"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Engagement issues (e.g., 'Monotonous Vocabulary', 'Repetitive Sentence Structure')", "items": { "type": "STRING" } },
                        "vocab_suggestions": {
                            "type": "ARRAY",
                            "description": "Vocabulary enhancement suggestions (replace dull or overused words)",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "original": { "type": "STRING" },
                                    "suggestion": { "type": "STRING" }
                                },
                                "required": ["original", "suggestion"]
                            }
                        }
                    },
                    "required": ["feedback", "vocab_suggestions"]
                },
                "delivery": {
                    "type": "OBJECT",
                    "description": "IV. Delivery / Tone",
                    "properties": {
                        "detected_tone": { "type": "STRING", "description": "Detected tone" },
                        "formality": { "type": "STRING", "description": "Formality (e.g., 'Formal', 'Informal', 'Colloquial')" },
                        "inclusive_language_warning": { "type": "BOOLEAN", "description": "Whether non-inclusive language is present" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                }
            },
            "required": ["correctness", "clarity", "engagement", "delivery"]
        };

        // --- v2.8 GVL Schema (NEW) ---
        // This is the new schema from the v2.8 spec (Section VIII).
        // It will be used ONLY for the new Continuation Tab (Tab 3).
        const v2_8_Schema = {
            "type": "OBJECT",
            "description": "Full analysis report based on v2.8 specification.",
            "properties": {
                "input_text": { "type": "STRING", "description": "The user's original input text." },
                "correctness": {
                    "type": "OBJECT",
                    "description": "GVL/GCE Layer. Errors MUST be corrected by GCE.",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
                            "description": "List of errors detected by GVL. Must be empty if GCE passed.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "code": { "type": "STRING", "description": "e.g., GVL-NAC-01" },
                                    "message": { "type": "STRING", "description": "Error description." },
                                    "suggestion": { "type": "STRING", "description": "Correction." }
                                },
                                "required": ["code", "message", "suggestion"]
                            }
                        },
                        "validated": { "type": "BOOLEAN", "description": "Must be true if GCE pass." }
                    },
                    "required": ["errors", "validated"]
                },
                "clarity": {
                    "type": "OBJECT",
                    "description": "Clarity Layer.",
                    "properties": {
                        "rewrite_suggestion": { "type": "STRING", "description": "Suggestion for wordiness, fluency, etc." },
                        "fluency_feedback": { "type": "STRING", "description": "Feedback on flow." }
                    },
                    "required": ["rewrite_suggestion", "fluency_feedback"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "description": "Engagement Layer.",
                    "properties": {
                        "vocab_suggestions": {
                            "type": "ARRAY",
                            "description": "Suggestions for dull words.",
                            "items": { "type": "STRING" }
                        },
                        "feedback": { "type": "STRING", "description": "Feedback on repetitive structure." }
                    },
                    "required": ["vocab_suggestions", "feedback"]
                },
                "delivery": {
                    "type": "OBJECT",
                    "description": "Delivery & Tone Layer.",
                    "properties": {
                        "detected_tone": { "type": "STRING", "enum": ["Formal", "Neutral", "Friendly"] },
                        "formality": { "type": "STRING", "description": "Formality level." },
                        "inclusive_language_warning": { "type": "BOOLEAN" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                },
                "continuation": {
                    "type": "OBJECT",
                    "description": "Continuation Module (User Story 3).",
                    "properties": {
                        "predicted_sentence": { "type": "STRING", "description": "Predicted next sentence (must pass GVL/GCE)." },
                        "band_prediction": { "type": "NUMBER", "description": "IELTS Band prediction (e.g., 8.0)." }
                    },
                    "required": ["predicted_sentence", "band_prediction"]
                },
                "validation_result": { "type": "STRING", "enum": ["Passed"], "description": "Must be 'Passed' after GCE." }
            },
            "required": ["input_text", "correctness", "clarity", "engagement", "delivery", "continuation", "validation_result"]
        };

        // v2.8 Add: Schema for *only* Band Prediction
        const bandPredictionSchema = {
            "type": "OBJECT",
            "description": "Band prediction for a single sentence.",
            "properties": {
                "band_prediction": { "type": "NUMBER", "description": "IELTS Band prediction (e.g., 8.0)." },
                "validation_result": { "type": "STRING", "enum": ["Passed"], "description": "Grammar validation result." }
            },
            "required": ["band_prediction", "validation_result"]
        };

        // v2.9 Add: Schema for SWOT Analysis
        const swotSchema = {
            "type": "OBJECT",
            "description": "SWOT analysis of paragraph-to-sentence cohesion based on IELTS Cohesion & Coherence criteria.",
            "properties": {
                "strengths": {
                    "type": "ARRAY",
                    "description": "Strengths (S): Positive cohesion/coherence links.",
                    "items": { "type": "STRING" }
                },
                "weaknesses": {
                    "type": "ARRAY",
                    "description": "Weaknesses (W): Errors or poor links in cohesion/coherence.",
                    "items": { "type": "STRING" }
                },
                "opportunities": {
                    "type": "ARRAY",
                    "description": "Opportunities (O): Specific suggestions for improvement.",
                    "items": { "type": "STRING" }
                },
                "threats": {
                    "type": "ARRAY",
                    "description": "Threats (T): Risks/warnings if weaknesses persist.",
                    "items": { "type": "STRING" }
                },
                "overall_assessment": {
                    "type": "STRING",
                    "description": "A brief summary of the connection's quality."
                },
                "cohesion_band_estimate": {
                    "type": "NUMBER",
                    "description": "Estimated IELTS C&C band score (5.0-9.0) for this specific transition."
                }
            },
            "required": ["strengths", "weaknesses", "opportunities", "threats", "overall_assessment", "cohesion_band_estimate"]
        };

        // v2.9.3 Add: Schema for SWOT Comparison
        const swotComparisonSchema = {
            "type": "OBJECT",
            "description": "Compares two opening sentences for C&C against a paragraph.",
            "properties": {
                "best_option_index": {
                    "type": "NUMBER",
                    "description": "Index of the better sentence (0 for Option 1, 1 for Option 2)."
                },
                "comparison_reason": {
                    "type": "STRING",
                    "description": "Detailed reason why the best option is better, citing C&C principles (e.g., 'Option 2 provides a clearer lexical link ('this issue') to the paragraph's topic...')."
                },
                "worst_option_feedback": {
                    "type": "STRING",
                    "description": "Brief C&C feedback on the weaker option (e.g., 'Option 1 felt abrupt.')"
                }
            },
            "required": ["best_option_index", "comparison_reason", "worst_option_feedback"]
        };


        // --- Core Helper Functions ---

        /**
         * Get the effective API Key from manager or fallback.
         */
        function getSystemApiKey() {
            let key = '';
            if (typeof GeminiKeyManager !== 'undefined') {
                key = GeminiKeyManager.getActiveKey();
                if (key === '__USE_ADMIN_KEY__') {
                    // Try local storage directly as fallback if not handled by manager for client-side
                    key = localStorage.getItem('gemini_api_key');
                }
            }
            return key || localStorage.getItem('gemini_api_key') || '';
        }


        /**
         * T1.4 Fix: Truncate context to the last N words
         * @param {string} text - Full input text
         * @param {number} wordCount - Number of last words to keep
         * @returns {string} - Truncated text
         */
        function truncateContext(text, wordCount) {
            if (!text) return "";
            const words = text.trim().split(/\s+/); // Split by whitespace
            const count = parseInt(wordCount, 10) || 20; // Default 20

            if (words.length <= count) {
                return text.trim(); // No truncation needed
            }

            return words.slice(-count).join(' '); // Take last N words
        }

        /**
         * Get Band commentary based on PPL (Cohesion & Coherence)
         * @param {number} ppl - Perplexity
         * @returns {object} - { band, summary, color }
         */
        function getCohesionBandDetails(ppl) {
            if (ppl <= 20) {
                return { band: 9, summary: window.i18n.t('band9Cohesion'), color: 'bg-indigo-600' };
            } else if (ppl <= 40) {
                return { band: 8, summary: window.i18n.t('band8Cohesion'), color: 'bg-purple-600' };
            } else if (ppl <= 60) {
                return { band: 7, summary: window.i18n.t('band7Cohesion'), color: 'bg-blue-600' };
            } else if (ppl <= 80) {
                return { band: 6, summary: window.i18n.t('band6Cohesion'), color: 'bg-yellow-600' };
            } else {
                return { band: 5, summary: window.i18n.t('band5Cohesion'), color: 'bg-red-600' };
            }
        }

        /**
         * [S_Naturalness v2.1 Revised]
         * Get Band commentary based on S_Naturalness (Lexical Resource)
         * @param {number} s - S_Naturalness score
         * @returns {object} - { band, summary, color }
         */
        function getLexicalBandDetails(s) {
            if (s >= 0.85) {
                return { band: 9, summary: window.i18n.t('band9Lexical'), color: 'bg-indigo-600' };
            } else if (s >= 0.75) {
                return { band: 8, summary: window.i18n.t('band8Lexical'), color: 'bg-purple-600' };
            } else if (s >= 0.60) {
                return { band: 7, summary: window.i18n.t('band7Lexical'), color: 'bg-blue-600' };
            } else if (s >= 0.40) {
                return { band: 6, summary: window.i18n.t('band6Lexical'), color: 'bg-yellow-600' };
            } else {
                // S < 0.40
                return { band: 5, summary: window.i18n.t('band5Lexical'), color: 'bg-red-600' };
            }
        }

        /**
         * Highlight a phrase within an example sentence
         * @param {string} text - The full example sentence
         * @param {string} phraseToHighlight - The phrase to highlight
         * @returns {string} - String containing HTML <span class="highlight">
         */
        function highlight(text, phraseToHighlight) {
            if (!text || !phraseToHighlight) return text;
            // Replace all non-word characters with whitespace to ensure correct word boundary matching
            const cleanedPhrase = phraseToHighlight.trim().replace(/[\W_]+/g, "\\s*");
            // Use regex for case-insensitive replacement
            const regex = new RegExp(`(${cleanedPhrase})`, 'gi');

            // Use match function to preserve original case
            return text.replace(regex, (match, p1) => {
                // p1 is the original matched group, ensure we only highlight this part
                return `<span class="highlight">${match}</span>`;
            });
        }

        /**
         * v3.0: Render HTML report for Grammar Validation Layer (Tabs 1 & 2)
         * @param {object} validation - grammar_validation object
         * @returns {string} - Formatted HTML
         */
        function renderGrammarValidation(validation) {
            if (!validation) {
                return `<div class="text-xs text-red-400">${window.i18n.t('unexpectedFormat')}</div>`;
            }

            let html = '<div class="space-y-2 mt-2 pt-2 border-t border-gray-600 text-xs text-left">';

            const { correctness, clarity, engagement, delivery } = validation;
            html += `<h5 class="font-semibold text-gray-300">${window.i18n.t('grammarReportTitle')}</h5>`;

            if (correctness && correctness.errors && correctness.errors.length > 0) {
                html += `<div class="text-yellow-400">${window.i18n.t('correctnessLabel')}: ${window.i18n.t('errorsFound', { count: correctness.errors.length })}</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                correctness.errors.slice(0, 10).forEach(err => {
                    html += `<li>[${err.type}] <strong>"${err.original}"</strong> &rarr; <strong>"${err.correction}"</strong>`;
                    if (err.description) html += `<br/><span class="text-gray-500 italic pl-4">- ${err.description}</span>`;
                    html += `</li>`;
                });
                html += '</ul>';
            } else {
                html += `<div class="text-green-400">${window.i18n.t('correctnessLabel')}: ${window.i18n.t('checkPassed')}</div>`;
            }

            if (clarity && (clarity.feedback.length > 0 || clarity.rewrite_suggestion || clarity.passive_voice_warning)) {
                html += `<div class="text-blue-300 mt-1">${window.i18n.t('clarityLabel')}:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                clarity.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`);
                if (clarity.passive_voice_warning) html += `<li>${window.i18n.t('passiveVoiceWarning')}</li>`;
                if (clarity.rewrite_suggestion) html += `<li>${window.i18n.t('rewriteSuggestion')}: <span class="text-blue-200">${clarity.rewrite_suggestion}</span></li>`;
                html += '</ul>';
            } else {
                html += `<div class="text-green-400">${window.i18n.t('clarityLabel')}: ${window.i18n.t('checkPassed')}</div>`;
            }

            if (engagement && (engagement.feedback.length > 0 || engagement.vocab_suggestions.length > 0)) {
                html += `<div class="text-purple-300 mt-1">${window.i18n.t('engagementLabel')}:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                engagement.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`);
                engagement.vocab_suggestions.slice(0, 1).forEach(vs => html += `<li>${window.i18n.t('vocabSuggestion')}: ${vs.original} &rarr; ${vs.suggestion}</li>`);
                html += '</ul>';
            }

            if (delivery) {
                html += `<div class="text-gray-300 mt-1">${window.i18n.t('toneLabel')}: ${delivery.detected_tone} | ${window.i18n.t('formalityLabel')}: ${delivery.formality}</div>`;
                if (delivery.inclusive_language_warning) html += `<div class="text-yellow-400">${window.i18n.t('inclusiveLanguageWarning')}</div>`;
            }

            html += '</div>';
            return html;
        }

        function renderV2_8_Validation(result) {
            let html = '<div class="space-y-3 mt-4 pt-4 border-t border-gray-600 text-sm">';
            const { correctness, clarity, engagement, delivery } = result;

            html += `<h5 class="font-semibold text-white">${window.i18n.t('correctnessLabel')}</h5>`;
            if (correctness && correctness.errors.length === 0 && correctness.validated) {
                html += `<p class="text-green-400">${window.i18n.t('grammarCheckPassed')}</p>`;
            } else {
                html += `<p class="text-yellow-400">${window.i18n.t('gvlErrorsFound', { count: correctness.errors.length })}</p>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2 text-xs">';
                correctness.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} &rarr; <strong>${err.suggestion}</strong></li>`;
                });
                html += '</ul>';
            }

            html += `<h5 class="font-semibold text-white mt-3">${window.i18n.t('clarityLabel')}</h5>`;
            html += `<p class="text-gray-300"><strong>${window.i18n.t('fluencyLabel')}:</strong> ${clarity.fluency_feedback || 'N/A'}</p>`;
            if (clarity.rewrite_suggestion) {
                html += `<p class="text-gray-300"><strong>${window.i18n.t('rewriteSuggestion')}:</strong> <span class="text-blue-300">${clarity.rewrite_suggestion}</span></p>`;
            }

            html += `<h5 class="font-semibold text-white mt-3">${window.i18n.t('engagementLabel')}</h5>`;
            html += `<p class="text-gray-300"><strong>${window.i18n.t('engagementLabel')}:</strong> ${engagement.feedback || 'N/A'}</p>`;
            if (engagement.vocab_suggestions && engagement.vocab_suggestions.length > 0) {
                html += `<p class="text-gray-300"><strong>${window.i18n.t('vocabularyLabel')}:</strong> ${window.i18n.t('suggestsReplacing')}: <span class="text-purple-300">${engagement.vocab_suggestions.join(', ')}</span></p>`;
            }

            html += `<h5 class="font-semibold text-white mt-3">${window.i18n.t('toneLabel')}</h5>`;
            let deliveryInfo = `<strong>${window.i18n.t('detectedToneLabel')}:</strong> ${delivery.detected_tone} | <strong>${window.i18n.t('formalityLabel')}:</strong> ${delivery.formality}`;
            if (delivery.inclusive_language_warning) {
                deliveryInfo += ` | <span class="text-yellow-400">${window.i18n.t('inclusiveLanguageWarning')}</span>`;
            }
            html += `<p class="text-gray-300">${deliveryInfo}</p>`;

            html += '</div>';
            return html;
        }


        // --- API Call Logic ---

        /**
         * Call the Gemini API
         * @param {string} userApiKey - [MODIFIED] The API key from the input field
         * @param {string} systemPrompt - System Instruction
         * @param {string} userQuery - User Query
         * @param {object|null} schema - JSON output schema (if needed)
         * @param {number} temperature - Sampling temperature
         * @param {number} topP - Top-P sampling parameter
         * @param {number} maxRetries - Maximum retry attempts
         * @returns {Promise<object>} - API response or error object
         */
        // --- [MODIFICATION START] Added userApiKey parameter ---
        async function callGeminiAPI(userApiKey, systemPrompt, userQuery, schema = null, temperature = 0.7, topP = 0.95, maxRetries = 3) {

            // --- [MODIFICATION] Dynamically build API URL ---
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${userApiKey}`;
            // --- [MODIFICATION END] ---

            // ===============================================
            // 🚨 This is your checkpoint: Print Prompt content for AI
            // ===============================================
            console.log("--- Sending System Prompt to AI ---");
            console.log(systemPrompt);
            console.log("----------------------------------");

            console.log("--- Sending User Query to AI ---");
            console.log(userQuery);
            console.log("-------------------------------");

            // Since your System Prompt is very long, you can print them together
            console.log("--- Full API Request Payload (Debug) ---");

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const generationConfig = {
                temperature: parseFloat(temperature),
                topP: parseFloat(topP),
            };

            if (schema) {
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = schema;
            }
            payload.generationConfig = generationConfig;

            // Print the entire payload object
            console.log(JSON.stringify(payload, null, 2));
            console.log("----------------------------------------------");

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, { // [MODIFIED] Uses dynamic apiUrl
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // [MODIFIED] Improved error handling for 400 (Bad Request), often API key related
                        if (response.status === 400) {
                            const errorData = await response.json();
                            throw new Error(`API request failed (Status 400 - Bad Request). Check API Key or model access. Details: ${errorData?.error?.message || 'No details'}`);
                        }
                        throw new Error(`API request failed, status code: ${response.status}`);
                    }

                    const result = await response.json();

                    const candidate = result.candidates?.[0];

                    if (!candidate || !candidate.content?.parts?.[0]) {
                        // [MODIFIED] Handle safety blocks
                        if (candidate?.finishReason === 'SAFETY') {
                            throw new Error("API call blocked due to safety settings (Finish Reason: SAFETY).");
                        }
                        throw new Error("API returned an invalid response structure or was filtered.");
                    }

                    const part = candidate.content.parts[0];

                    if (schema) {
                        // Handle JSON response
                        const jsonText = part.text;
                        return JSON.parse(jsonText);
                    } else {
                        // Handle plain text response
                        return part.text;
                    }

                } catch (error) {
                    console.error(`API call attempt ${attempt} failed:`, error);
                    if (attempt === maxRetries) {
                        return { isError: true, message: `API request failed: ${error.message}` };
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Logic ---

        /**
         * Execute IGPVL check (Simulates API call)
         * @param {string} userApiKey - [MODIFIED] The API key
         * @param {string} text - The full text to check
         * @param {string} inputId - ID of the calling source
         * @param {string} context - Writing context (e.g., 'academic')
         * @returns {Promise<object>} - Object matching igpvlSchema or an error
         */
        // --- [MODIFICATION START] Added userApiKey parameter ---
        async function validateInputGrammar(userApiKey, text, inputId, context) {

            // v2.6 IGPVL System Prompt
            const systemPrompt = `You are a specialized and strict "Input Grammar Pre-Validation Layer (IGPVL) v2.6".
Your absolute sole task is to analyze the user's input text and return only one valid JSON object according to the v2.6 specification.
You are absolutely forbidden from outputting any additional text, notes, or explanations outside the JSON.

You must perform all four check categories and strictly flag all errors:
1. Core Grammar (IGPVL-CORE-XX): Subject-verb agreement, Tense, Articles, Pronouns, Number agreement.
2. Advanced Grammar (IGPVL-ADV-XX): Dangling modifiers, Incomplete comparisons, Double negatives, Inconsistent tense shifts, Semantic Collocation Errors, improper Subject/Verb pairings, or improper coordination of non-parallel elements (e.g., 'a linear and five-step process').
3. Spelling & Consistency (IGPVL-SPC-XX): Spelling errors, Contextual spelling (e.g., their/there), Capitalization, Number formats, Hyphenation.
4. Punctuation (IGPVL-PUN-XX): Only when the last character of the input is a punctuation mark, check end punctuation, comma/semicolon/colon misuse.
   Mandatory Exception Rule: If the input is judged to be a fragment or phrase (not a complete statement or question), do NOT flag an 'end_punctuation' error.

Rules:
- Maximum strictness check: Flag even minor errors (e.g., 'He go').
- Error count (error_count) must precisely reflect the length of the 'errors' array.
- Validation mechanism (status & severity):
   * error_count = 0: status = 'passed', severity = 'none', recommendation = 'Grammar correct, ready to generate.'
   * 1 <= error_count <= 3: status = 'warning', severity = 'minor', recommendation = 'Detected \${error_count} minor errors. Please review suggestions. Generation is permitted.'
   * error_count > 3: status = 'blocked', severity = 'major', recommendation = 'Detected \${error_count} major errors. Please correct the input and try again.'
- Error codes: 'code' field must follow specifications (e.g., 'IGPVL-CORE-01', 'IGPVL-SPC-01').
- Timestamp: must provide the current UTC time in ISO 8601 format.
- Absolute prohibition: Your response must not contain any text other than the JSON.
- [Language Requirement]: All feedback, messages, and recommendations MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.

Each error object must contain:
{
  "code": string,              // e.g., "IGPVL-CORE-01"
  "category": string,          // one of ["core", "advanced", "spelling", "punctuation"]
  "message": string,           // clear error description
  "span": {                   // error range in user input (character indexes)
    "start": integer,
    "end": integer
  },
  "confidence": number,        // float between 0 and 1, representing confidence level
  "evidence_type": string      // one of ["rules", "case", "embedding"] indicating source of evidence
}

The JSON object must include top-level fields:
{
  "status": string,            // "passed", "warning", "blocked"
  "severity": string,          // "none", "minor", "major"
  "error_count": integer,      // count of errors detected
  "errors": array of error objects,
  "recommendation": string,
  "timestamp": string          // ISO 8601 UTC timestamp, e.g., "2025-11-04T00:00:00Z"
}


{
  "IGPVL-CORE-01": {
    "category": "core",
    "description": "Subject-verb agreement error",
    "example_incorrect": "She go to school.",
    "example_correct": "She goes to school."
  },
  "IGPVL-CORE-02": {
    "category": "core",
    "description": "Incorrect verb tense",
    "example_incorrect": "He eat breakfast yesterday.",
    "example_correct": "He ate breakfast yesterday."
  },
  "IGPVL-ADV-01": {
    "category": "advanced",
    "description": "Dangling modifier",
    "example_incorrect": "Walking down the street, the car almost hit me.",
    "example_correct": "Walking down the street, I almost got hit by a car."
  },
  "IGPVL-ADV-05": {
    "category": "advanced",
    "description": "Semantic collocation or improper coordination error",
    "example_incorrect": "Make a photo. / A linear and five-step process.",
    "example_correct": "Take a photo. / A linear, five-step process."
  },
  "IGPVL-SPC-02": {
    "category": "spelling",
    "description": "Contextual spelling error",
    "example_incorrect": "Their going to the park.",
    "example_correct": "They're going to the park."
  },
  "IGPVL-PUN-01": {
    "category": "punctuation",
    "description": "Missing end punctuation",
    "example_incorrect": "How are you",
    "example_correct": "How are you?"
  }
}

If the first attempt outputs an invalid JSON, rewrite once to valid JSON without changing the error detections or judgments.`;


            const userQuery = `
{
  "input_id": "${inputId}",
  "text": "${text}",
  "context": "${context}",
  "language": "en",
  "validation_mode": "strict"
}
`;
            // Use 0.1 temperature to ensure stability and consistency of IGPVL check
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, igpvlSchema, 0.1, 1.0);
            // --- [MODIFICATION END] ---

            // Ensure timestamp exists (model sometimes forgets)
            if (result && !result.isError && !result.timestamp) {
                result.timestamp = new Date().toISOString();
            }
            return result;
        }

        /**
         * Display IGPVL feedback on the UI
         * @param {HTMLElement} el - The DOM element to display feedback in
         * @param {object} result - The result object from validateInputGrammar
         * @returns {boolean} - Whether the flow was blocked (isBlocked)
         */
        function displayIgpvlFeedback(el, result) {
            el.innerHTML = '';

            if (result.isError) {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                el.innerHTML = `<strong>IGPVL Check Failed:</strong> ${result.message}`;
                return true;
            }

            if (result.status === 'blocked') {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return true;

            } else if (result.status === 'warning') {
                el.className = 'text-sm p-3 rounded-lg bg-yellow-900/50 text-yellow-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return false;

            } else {
                el.className = 'text-sm p-3 rounded-lg bg-green-900/50 text-green-400';
                el.innerHTML = `<p class="font-semibold">${result.recommendation}</p>`;
                return false;
            }
        }


        // --- Prediction Tab Logic (Unchanged) ---

        // v3.0 Update: Use v3.0 Grammar Validation Layer Schema
        const predictionSchema = {
            type: "ARRAY",
            maxItems: 6,
            items: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING", "description": "Predicted next word" },
                    "p_w_n": { "type": "NUMBER", "description": "Conditional probability P(w_n | context), between 0 and 1" },
                    "ppl": { "type": "NUMBER", "description": "Perplexity of the example sentence" },
                    "band": { "type": "NUMBER", "description": "Corresponding IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                    "band_summary": { "type": "STRING", "description": "IELTS examiner-style summary description (based on PPL coherence assessment)" },
                    "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                    "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score (0-100)" },
                    "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
                },
                required: ["word", "p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 Replace
            }
        };

        async function handlePredictionSubmit(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(predError, window.i18n.t('errorApiKeyEmpty'), predLoading, predButton, predButtonText, window.i18n.t('getPredictions'));
                igpvlPredError.innerHTML = '';
                igpvlPredError.className = 'text-sm rounded-lg';
                return;
            }

            const phrase = predInput.value.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlPredError.innerHTML = '';
            igpvlPredError.className = 'text-sm rounded-lg';
            predError.classList.add('hidden'); // Hide old generation errors
            predictionResults.innerHTML = ''; // Clear old results

            if (!phrase) {
                displayError(predError, window.i18n.t('errorEnterPhrase'), predLoading, predButton, predButtonText, window.i18n.t('getPredictions'));
                return;
            }

            displayLoading(predError, predLoading, predButton, predButtonText, window.i18n.t('validatingInput'));

            // --- v2.6 IGPVL Execution ---
            // --- [MODIFICATION START] Pass userApiKey ---
            const igpvlResult = await validateInputGrammar(userApiKey, phrase, 'predInput', 'academic');
            // --- [MODIFICATION END] ---
            const isBlocked = displayIgpvlFeedback(igpvlPredError, igpvlResult);

            if (isBlocked) {
                displayDone(predLoading, predButton, predButtonText, window.i18n.t('getPredictions'));
                return;
            }
            // --- IGPVL End ---

            displayLoading(predError, predLoading, predButton, predButtonText, window.i18n.t('generatingPredictions'));

            // Prepare API request
            const posFilter = predPos.value === 'any' ? 'Any POS' : predPos.value;
            const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            // T1.4 Fix: Read and truncate context
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);

            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
            // Prompt optimization log: https://gemini.google.com/share/c74d88da14dc
            const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to predict the 6 most common and natural next words based on the user's input phrase, adhering to the highest academic standards (IELTS) or the highest clarity standards (Tech Guide).

[Internal Reference: English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.** This reference will be used for the strict check in Rule 8.

Rules:
0. [**POS Constraint & Interpretation**]: The predicted 'predicted_word' must strictly belong to the user-specified Part of Speech (POS) class (e.g., if POS='Adjective', the word must be an adjective). **CRITICAL VERB CONSTRAINT: If the POS is Verb (V), the predicted word MUST be an inflected form or the base form of the verb (e.g., 'begins', 'requires', 'was', 'is'). It must NOT be a Gerund (V-ing), a Participle (V-ing/V-ed) used adjectivally/adverbially, or an Infinitive ('to' + V).** The model must ensure the grammatical function of the predicted word is correct in the generated 'example' sentence.

1.  [**Input Validation & Correction**]: **If the user's input phrase contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all predictions. If the input is correct, return an empty string.

2.  [🔥 **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'POS' and 'Task' context when generating 'example' sentences.
    a.  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".
    b.  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").
    c.  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.
        * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").
        * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').
        * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").

3.  [**Absolute Rule**]: 'All' 'example' sentences you generate 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
4.  For each predicted word, provide 'Conditional Probability P(w_n | context)', 'Concise Example (example)', 'Perplexity (ppl)', and 'IELTS Cohesion & Coherence Band Assessment'.
5.  [PPL-Band Mapping]: PPL 0–20=Band 9, 21–40=Band 8, 41–60=Band 7, 61–80=Band 6, >80=Band 5.
6.  [Key Point] In the example sentence, the predicted word must "closely and uniquely" follow the "last word" of the user's input phrase. If the last character of the user's input phrase is punctuation, the predicted word must "closely and uniquely" follow the punctuation mark, separated by a single space.
7.  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability, and provide a "consistency_score" (0-100) for each generation.

8.  [Grammar Validation Layer (Latest Spec)]: ✨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (🔥 Strictly Reinforced - **Includes syntax and Task compliance errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        * **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions). **CRITICAL CHECK: Must strictly detect commas that incorrectly separate a subject from its verb, a verb from its object, or a preposition from its object** (e.g., 'selection, of the raw cocoons').
        * **(🔥) Task Compliance (General):** Must strictly check for basic violations of **Rule 2** Task style.
            * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
            * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or
overly informal vocabulary. Error 'type' should be "Formality Violation".
            * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".
			
			**(🔥) Task Compliance (Band 8+ Style Hardening):**
            * **Style Error (High - Collocation):** For Task 1 process descriptions, if the phrase \"starts from\" or \"begins at\" is used instead of the more academic and fixed collocation \"begins with\" or \"commences with\", mark as a 'Style/Collocation Error'.
            * **Style Error (High - Parallel/Conciseness):** Detected an incorrect parallel structure in an adjective list, specifically using the conjunction 'and' between two non-coordinate adjectives (e.g., 'a linear and five-step process' should be 'a linear, five-step process'). Mark this as a 'Style/Parallel Error'.
            * **Style Error (Low - Conciseness):** For Task 1 process descriptions referring to general raw materials (e.g., 'silkworm cocoons', 'wheat'), mark the use of the definite article 'the' (e.g., 'the silkworm cocoons') as a 'Style/Conciseness Error' for being unnaturally descriptive where the generic term should be used.
        **(Note: Individual error suggestions are now replaced by the holistic 'rewrite_suggestion' in Rule 8b.)**

    b.  [II. Clarity]: (💡 Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
        * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (🌟 Suggestive Reinforcement)
    Provide "suggestions".
        * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

        * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

10. [Language Requirement]: All feedback, reasoning, and explanations (including band_summary, grammar_validation descriptions, feedback, and rewrite suggestions) MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.

9.  [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "initial_phrase_correction": "STRING", 
  "predictions": [
    {
      "predicted_word": "STRING",
      "P(w_n|context)": "NUMBER",
      "example": "STRING",
      "ppl": "NUMBER",
      "cohesion_band": "NUMBER",
      "consistency_score": "NUMBER",
      "grammar_validation": {
        "correctness": {
          "is_correct": "BOOLEAN", 
          "errors": [
            {
              "type": "STRING", 
              "description": "STRING", 
              
              "priority": "STRING" // Must be one of "Critical", "High", "Low"
            }
          ]
        },
        "clarity": {
          "feedback": "STRING", 
          "rewrite_suggestion": "STRING"
        },
        "engagement": {
          "feedback": "STRING", 
          "vocab_suggestions": "ARRAY<STRING>"
        },
        "delivery": {
   "detected_tone": "STRING",
          "formality": "STRING",
          "inclusive_language_warning": "STRING"
        }
      }
    }
  ]
}
\`\`\`
10. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Input Phrase (Using only last ${contextLen} words): "${truncatedPhrase}"
POS Filter: ${posFilter}
Writing Task: ${taskContext}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            // --- [MODIFICATION START] Pass userApiKey ---
            const results = await callGeminiAPI(userApiKey, systemPrompt, userQuery, predictionSchema, temp, topP);
            // --- [MODIFICATION END] ---

            // ⭐️ Checkpoint: Print the raw API response
            console.log("--- Raw Gemini API Response (results) ---");
            console.log(results);
            console.log("-----------------------------------------");
            displayDone(predLoading, predButton, predButtonText, window.i18n.t('getPredictions'));

            // Process API response
            if (results.isError) {
                displayError(predError, results.message);
            } else if (Array.isArray(results)) {
                displayPredictionResults(results, truncatedPhrase); // T1.4 Fix: Pass truncated phrase

                // 🎮 RPG: Award XP for prediction experiment
                if (typeof DevScribeRPG !== 'undefined') {
                    const rpgResult = DevScribeRPG.recordModuleAction('lab', 'vocab_experiment');
                    if (rpgResult) DevScribeRPG.showXPNotification(rpgResult);
                }
            } else {
                displayError(predError, "Received unexpected response format.");
            }
        }

        ////
        /* * =======================================================================
         * 步驟一：替換舊的 customSchema
         *
         * v3.0: 此 Schema 必須與 systemPrompt (規則 11) 中定義的 JSON 結構完全一致。
         * 注意：我們添加了 PPL_norm, H_norm, TS, SC, FQ, Band，
         * 移除了 p_w_n, ppl, band_summary。
         * =======================================================================
         */
        const customSchema = {
            type: "OBJECT",
            properties: {
                "initial_phrase_correction": { "type": "STRING" },
                "PPL_norm": { "type": "NUMBER" },
                "H_norm": { "type": "NUMBER" },
                "TS": { "type": "NUMBER" },
                "SC": { "type": "NUMBER" },
                "FQ": { "type": "NUMBER" },
                "Band": { "type": "NUMBER" }, // AI 會回傳它計算的 Band
                "example": { "type": "STRING" },
                "consistency_score": { "type": "NUMBER" },
                "benchmark_comparison": {
                    "type": "ARRAY",
                    "items": {
                        "type": "OBJECT", // 這裡定義了它是 OBJECT
                        "properties": {   // 這裡必須定義 OBJECT 裡面的所有屬性
                            "metric": { "type": "STRING" },
                            "score": { "type": "NUMBER" },
                            "nearest_benchmark": { "type": "STRING" },
                            "comparison_description": { "type": "STRING" }
                        },
                        "required": [
                            "metric",
                            "score",
                            "nearest_benchmark",
                            "comparison_description"
                        ]
                    }
                },
                "grammar_validation": grammarValidationSchemaObject // v3.0 Replace (假設此變數在別處已定義)
            },
            required: [
                "initial_phrase_correction",
                "PPL_norm",
                "H_norm",
                "TS",
                "SC",
                "FQ",
                "Band",
                "example",
                "consistency_score",
                "benchmark_comparison", // <--- 新增欄位   
                "grammar_validation"
            ] // v3.0 Replace
        };
        /* * =======================================================================
         * 步驟二：新增此輔助函式 (Helper Function)
         * * v3.0: 根據 FQ 分數在前端計算 Band 和對應的 UI 顏色。
         * 嚴格遵循您提供的 FQ-Band Mapping Table。
         * =======================================================================
         */
        function getBandInfoFromFQ(fq) {
            let band;
            let color;

            if (fq === null || fq === undefined) {
                return { band: 'N/A', color: 'bg-gray-500' };
            }

            if (fq >= 0.85) { // Band 9: FQ 0.85–1.0
                band = 9;
                color = 'bg-blue-600'; // (請自行調整顏色以匹配您的 CSS)
            } else if (fq >= 0.75) { // Band 8: FQ 0.75–0.84
                band = 8;
                color = 'bg-green-600';
            } else if (fq >= 0.65) { // Band 7: FQ 0.65–0.74
                band = 7;
                color = 'bg-yellow-500';
            } else if (fq >= 0.50) { // Band 6: FQ 0.50–0.64
                band = 6;
                color = 'bg-orange-500';
            } else if (fq >= 0.35) { // Band 5: FQ 0.35–0.49
                band = 5;
                color = 'bg-red-600';
            } else { // Band <5: FQ < 0.35
                band = "<5";
                color = 'bg-red-800';
            }

            // 回傳一個包含 band 和 color 的物件
            return { band: band, color: color };
        }

        // --- [START] v3.1 OPTIMIZATION ---
        /**
         * v3.1 (Optimization): Render Benchmark Comparison
         * Renders the benchmark_comparison array into readable HTML.
         */
        function renderBenchmarkComparison(benchmarks) {
            if (!benchmarks || benchmarks.length === 0) {
                return `<p class="text-xs text-gray-500">${window.i18n.t('none')}</p>`;
            }

            const metricNames = {
                "PPL_norm": "Normalized Perplexity (PPL_norm)",
                "H_norm": "Normalized Entropy (H_norm)",
                "TS": "Token Stability (TS)",
                "SC": "Semantic Coherence (SC)"
            };

            let html = '<div class="space-y-3">';

            benchmarks.forEach(item => {
                const metricName = metricNames[item.metric] || item.metric;
                const score = (item.score * 100).toFixed(1);

                html += `
                    <div class="bg-gray-800 p-3 rounded-md border border-gray-700">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-300">${metricName}</span>
                            <span class="text-lg font-bold text-yellow-300">${item.score.toFixed(4)}</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2.5 my-1">
                            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: ${score}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">
                            <strong>${window.i18n.t('benchmarkLog', { benchmark: item.nearest_benchmark })}:</strong> ${item.comparison_description}
                        </p>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }
        // --- [END] v3.1 OPTIMIZATION ---

        /* * =======================================================================
 * 步驟三：替換舊的 handleCustomWordCheck 函式
 *
 * 關鍵修改：
 * 1. (優化) 更新 systemPrompt 規則 4 和 5，
 * a. 根據您提供的指標定義，明確指示 AI 如何計算 PPL, H, TS, SC。
 * b. 移除 AI 計算 "Band" 的冗餘任務。
 * 2. (優化) 更新 systemPrompt 規則 11 (JSON Schema)，
 * =======================================================================
 */
        async function handleCustomWordCheck(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(predError, window.i18n.t('errorApiKeyEmpty'), customLoading, customButton, customButtonText, window.i18n.t('checkWord'));
                igpvlCustomError.innerHTML = '';
                igpvlCustomError.className = 'text-sm rounded-lg';
                return;
            }

            const phrase = predInput.value.trim();
            const customWord = customWordInput.value.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlCustomError.innerHTML = '';
            igpvlCustomError.className = 'text-sm rounded-lg mt-4';
            customResults.innerHTML = ''; // Clear old results

            if (!phrase || !customWord) {
                displayError(predError, window.i18n.t('errorEnterPhrase'), customLoading, customButton, customButtonText, window.i18n.t('checkWord'));
                return;
            }

            displayLoading(predError, customLoading, customButton, customButtonText, window.i18n.t('validatingInput'));

            // --- v2.6 IGPVL Execution (Check context phrase only) ---
            // --- [MODIFICATION START] Pass userApiKey ---
            const igpvlResult = await validateInputGrammar(userApiKey, phrase, 'predInput_custom', 'academic');
            // --- [MODIFICATION END] ---
            const isBlocked = displayIgpvlFeedback(igpvlCustomError, igpvlResult);

            if (isBlocked) {
                displayDone(customLoading, customButton, customButtonText, window.i18n.t('checkWord'));
                return;
            }
            // --- IGPVL End ---

            displayLoading(predError, customLoading, customButton, customButtonText, window.i18n.t('analyzingPredictions'));

            // Prepare API request (single word mode)
            const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);
            const fullPhrase = `${truncatedPhrase} ${customWord}`;

            // ========================================================
            // === 優化 START: systemPrompt 已更新 (規則 4, 5, 6, 12) ===
            // ========================================================
            const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to validate the naturalness of the user's input word "\${customWord}" following the context "\${truncatedPhrase}", strictly adhering to the specified "Task" style.
Rules:
1.  [**Input Validation & Correction**]: **If the user's input context phrase \${truncatedPhrase} contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all example generations. If the input is correct, return an empty string.

2.  [🔥 **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'Task' context when generating 'example' sentences.

    a.  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".

    b.  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").

    c.  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.

        * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").

        * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').

        * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").
		
3.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 11 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 10 below. **This check is mandatory and cannot be skipped or done superficially**.

4.  [**Optimized**] For this "Context-Continuation" pair, provide the following metrics and items:
    * Normalized Perplexity (PPL_norm)
    * Normalized Entropy (H_norm)
    * Token Stability (TS)
    * Semantic Coherence (SC)
    * **Final Fluency Quality Score (FQ)**
    * **Concise Example (example)**
    * **Benchmark Comparison (benchmark_comparison)**     * (Note: "Band" is removed; it will be calculated by the client.)

5.  [**Optimized**] [Calculation Rules & Definitions]:
    **You must calculate the following metrics on a 0.0 to 1.0 scale, where 1.0 is the BEST possible quality.**

    * **PPL_norm (Normalized Perplexity):**
        * Calculate the Perplexity (PPL) of the \`customWord\` given the context.
        * Perplexity measures "confusion"; **lower PPL is better**.
        * Normalize this PPL score to the 0-1 scale, where **1.0 = perfect prediction (low PPL)** and **0.0 = high confusion (high PPL)**.
    * **H_norm (Normalized Entropy):**
        * Calculate the Entropy (H) of the probability distribution *for the next token* after the context.
        * Entropy measures "uncertainty"; **higher H is worse** (more uncertainty).
        * Normalize this H score to the 0-1 scale, where **1.0 = high confidence (low uncertainty)** and **0.0 = high uncertainty (flat distribution)**.
    * **TS (Token Stability):**
        * Assess the stability of the \`customWord\`'s prediction probability when the context is slightly varied.
        * Normalize this to the 0-1 scale, where **1.0 = highly stable prediction** and **0.0 = volatile prediction**.
    * **SC (Semantic Coherence):**
        * Calculate the **Cosine Similarity** between the sentence embedding of the context (\`truncatedPhrase\`) and the \`customWord\` (or the resulting \`example\`).
        * This measures semantic relevance. **1.0 = perfectly coherent** and **0.0 = semantically unrelated**.

    * **FQ Calculation Formula (Use normalized metrics):**
        \`FQ = 0.3 * PPL_norm + 0.2 * H_norm + 0.2 * TS + 0.3 * SC\`
    
    * **(FQ-Band Mapping Table is REMOVED as client will calculate it.)**

6.  [**Optimized**] [Metric Benchmarks (JSON Samples)]:
    **You must first follow these JSON samples as a benchmark guide to calibrate your 0.0-1.0 scoring.** These examples define what different values on the scale represent.
	
\`\`\`json
[
  // --- PPL_norm (Normalized Perplexity) Benchmarks ---
  // 1.0 = Perfect (Low PPL), 0.0 = High Confusion (High PPL)
  {
    "metric": "PPL_norm",
    "feature": "極度流暢 (完美預測)",
    "indicator_value": 0.95,
    "description": "指標為 1.0 表示完美預測 (PPL 趨近於 0)，0.0 表示高度混亂 (PPL 極高)。此值 (0.95) 代表在上下文中，該詞是極度自然、幾乎唯一的接續。",
    "example": { "context": "The opposite of hot is", "word": "cold" }
  },
  {
    "metric": "PPL_norm",
    "feature": "流暢 (常見)",
    "indicator_value": 0.75,
    "description": "一個非常合乎邏輯且常見的用詞，模型對此預測的困惑度很低。",
    "example": { "context": "She opened the door and walked", "word": "inside" }
  },
  {
    "metric": "PPL_norm",
    "feature": "尚可 (合理)",
    "indicator_value": 0.50,
    "description": "一個合理、文法正確的接續，但並非最常見或最流暢的選擇。",
    "example": { "context": "He studied hard for the", "word": "promotion" }
  },
  {
    "metric": "PPL_norm",
    "feature": "生硬 (罕見)",
    "indicator_value": 0.25,
    "description": "文法上可能成立，但在語意或風格上非常罕見，導致模型困惑度偏高。",
    "example": { "context": "Please pass the", "word": "sky" }
  },
  {
    "metric": "PPL_norm",
    "feature": "不通順 (高度混亂)",
    "indicator_value": 0.05,
    "description": "該詞在上下文中顯得格格不入或近乎文法錯誤，模型對此預測的困惑度極高。",
    "example": { "context": "I would like to", "word": "happy" }
  },
  
  // --- H_norm (Normalized Entropy) Benchmarks ---
  // 1.0 = High Confidence (Low Uncertainty), 0.0 = High Uncertainty
  {
    "metric": "H_norm",
    "feature": "高信心 (低不確定性)",
    "indicator_value": 0.90,
    "description": "指標為 1.0 表示高信心 (低熵)，0.0 表示高不確定性 (高熵)。此值 (0.90) 代表模型極度確定此詞為最佳接續，其他選項的機率極低。",
    "example": { "context": "The capital of France is", "word": "Paris" }
  },
  {
    "metric": "H_norm",
    "feature": "有信心",
    "indicator_value": 0.70,
    "description": "模型相當確定，在機率分佈中，此詞的機率顯著高於次要選項。",
    "example": { "context": "She wore a beautiful red", "word": "dress" }
  },
  {
    "metric": "H_norm",
    "feature": "中等信心 (多重選項)",
    "indicator_value": 0.50,
    "description": "模型認為有數個詞彙皆有可能接續，機率分佈較為分散，不確定性中等。",
    "example": { "context": "I am feeling", "word": "hungry" }
  },
  {
    "metric": "H_norm",
    "feature": "不確定 (高)",
    "indicator_value": 0.20,
    "description": "上下文非常模糊或開放，導致模型無法鎖定單一的接續詞，機率分佈廣泛。",
    "example": { "context": "The result of the experiment was", "word": "inconclusive" }
  },
  {
    "metric": "H_norm",
    "feature": "極度不確定 (均勻分佈)",
    "indicator_value": 0.05,
    "description": "上下文幾乎未提供任何線索，模型對下一個詞的預測接近隨機猜測 (高熵)。",
    "example": { "context": "He suddenly said,", "word": "Stop" }
  },

  // --- TS (Token Stability) Benchmarks ---
  // 1.0 = Highly Stable, 0.0 = Volatile
  {
    "metric": "TS",
    "feature": "高度穩定",
    "indicator_value": 0.95,
    "description": "指標為 1.0 表示高度穩定，0.0 表示極不穩定。此值 (0.95) 代表即使上下文稍作同義詞替換或微調，此詞的預測機率依然保持不變。",
    "example": { "context_1": "The dog is very loyal", "context_2": "The canine is very loyal", "word": "and" }
  },
  {
    "metric": "TS",
    "feature": "穩定",
    "indicator_value": 0.75,
    "description": "對上下文的微小變動有抵抗力，預測結果保持一致。",
    "example": { "context_1": "The chart shows a significant increase", "context_2": "The graph displays a major rise", "word": "in" }
  },
  {
    "metric": "TS",
    "feature": "中等穩定",
    "indicator_value": 0.50,
    "description": "當上下文變動較大時，預測結果可能會開始偏移。",
    "example": { "context_1": "Click the 'Submit' button", "context_2": "Press the 'Submit' key", "word": "to" }
  },
  {
    "metric": "TS",
    "feature": "不穩定",
    "indicator_value": 0.25,
    "description": "即使是微小的同義詞替換，也可能導致模型改變預測結果。",
    "example": { "context_1": "He felt sad", "context_2": "He felt blue", "word": "because" }
  },
  {
    "metric": "TS",
    "feature": "極度不穩定",
    "indicator_value": 0.05,
    "description": "預測結果對上下文的擾動極度敏感，預測不可靠。",
    "example": { "context_1": "It's a complex task", "context_2": "It's a hard task", "word": "nonetheless" }
  },

  // --- SC (Semantic Coherence) Benchmarks ---
  // 1.0 = Perfectly Coherent, 0.0 = Unrelated
  {
    "metric": "SC",
    "feature": "完全相關 (語意一致)",
    "indicator_value": 0.98,
    "description": "指標為 1.0 表示語意完美連貫 (餘弦相似度高)，0.0 表示完全無關。此值 (0.98) 代表該詞與上下文的語意向量幾乎一致或完美接續。",
    "example": { "context": "He is a doctor who works at the", "word": "hospital" }
  },
  {
    "metric": "SC",
    "feature": "高度相關 (主題緊密)",
    "indicator_value": 0.80,
    "description": "與上下文的語意主題緊密相關，是合乎邏輯的語意延伸。",
    "example": { "context": "The company's profits soared last", "word": "quarter" }
  },
  {
    "metric": "SC",
    "feature": "主題相關",
    "indicator_value": 0.60,
    "description": "屬於同一主題範疇，但在語意上的連結不如前者緊密。",
    "example": { "context": "We are discussing climate", "word": "policy" }
  },
  {
    "metric": "SC",
    "feature": "弱相關 (語意跳躍)",
    "indicator_value": 0.30,
    "description": "語意上有些許關聯，但連結薄弱，感覺像主題的跳躍或偏離。",
    "example": { "context": "She loves to bake", "word": "computers" }
  },
  {
    "metric": "SC",
    "feature": "語意無關",
    "indicator_value": 0.10,
    "description": "該詞與上下文的語意完全不相關 (餘弦相似度趨近於 0)。",
    "example": { "context": "The cat sat on the", "word": "philosophy" }
  },

  // --- FQ (Final Fluency Quality) Benchmarks (Step 3) ---
  // Calculated: 0.3*PPL_norm + 0.2*H_norm + 0.2*TS + 0.3*SC
  {
    "metric": "FQ",
    "feature": "極佳 (Band 9)",
    "indicator_value": 0.90,
    "description": "綜合所有指標 (PPL, H, TS, SC) 均表現極佳。此詞是完美的選擇。",
    "example": { "context": "The data shows a clear", "word": "trend" }
  },
  {
    "metric": "FQ",
    "feature": "優秀 (Band 8)",
    "indicator_value": 0.80,
    "description": "各項指標均表現良好，流暢度、信心、穩定性、相關性俱佳。",
    "example": { "context": "As illustrated by the graph, the sales figures", "word": "grew" }
  },
  {
    "metric": "FQ",
    "feature": "良好 (Band 7)",
    "indicator_value": 0.70,
    "description": "綜合表現良好，可能有一項指標稍弱，但不影響整體品質。",
    "example": { "context": "The processor is very", "word": "quick" }
  },
  {
    "metric": "FQ",
    "feature": "合格 (Band 6)",
    "indicator_value": 0.55,
    "description": "綜合表現中等。該詞可用，但有更佳選擇。",
    "example": { "context": "We must finish the project before the", "word": "ending" }
  },
  {
    "metric": "FQ",
    "feature": "不佳 (Band 5)",
    "indicator_value": 0.40,
    "description": "多項指標分數偏低，顯示該詞在上下文中不自然或不相關。",
    "example": { "context": "Click the button to make the", "word": "computer" }
  }
]
\`\`\`

7.  **[新規則]** [Benchmark Comparison Generation]:
    For each of the four core metrics (**PPL_norm, H_norm, TS, SC**), you must compare its calculated score to the JSON benchmarks provided in Rule 6. The output must be an array of four JSON objects in the \`benchmark_comparison\` field. Each object must contain:
    * **"metric"**: The name of the metric (e.g., "PPL_norm").
    * **"score"**: The calculated score for this run (e.g., 0.78).
    * **"nearest_benchmark"**: The 'feature' string from the closest benchmark JSON sample (e.g., "流暢 (常見)" or "高度穩定").
    * **"comparison_description"**: A concise, localized description (Chinese) explaining what the score means in the context of the benchmarks (e.g., "該得分 0.78 略高於基準 0.75，屬於高度流暢的範疇。").
	
8. [Key Point] In the example sentence, the validated word \${customWord} must "closely and uniquely" follow the "last word" of the context \${truncatedPhrase}. If the last character of the context is punctuation, the word must "closely and uniquely" follow the punctuation mark, separated by a single space.
9.  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability.
10.  Provide a "consistency_score" (0-100) for each generation, calculated based on semantic similarity, lexical variance, and syntactic stability.
11. [Grammar Validation Layer (Latest Spec)]: ✨ Ultimate Validation Standard

**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (🔥 Strictly Reinforced - **Includes syntax and Task compliance errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
		* **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).
        * **(🔥) Task Compliance:** Must strictly check for violations of **Rule 2** Task style.
            * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
            * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or overly informal vocabulary. Error 'type' should be "Formality Violation".
            * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".

    b.  [II. Clarity]: (💡 Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
        * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.
    c.  [III. Engagement]: (🌟 Suggestive Reinforcement)
    Provide "suggestions".
        * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.
    d.  [IV. Delivery]: (🔥 Task-Reinforced Standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.
    **'formality' and 'detected_tone' assessment must strictly correspond to the Task type specified in Rule 2:**
        * **Task 1:** 'formality' must be rated "Formal (Academic)", 'detected_tone' must be "Objective" or "Neutral".
        * **Task 2:** 'formality' must be rated "Formal" or "Semi-formal", 'detected_tone' must be "Persuasive" or "Analytical".
        * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

14. [Language Requirement]: All feedback, reasoning, metrics descriptions (comparison_description), and explanations MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.

11. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

12. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**
    (Note: Schema updated to match Rule 4 & 5. "Band" is removed.)

\`\`\`json
{
  "initial_phrase_correction": "STRING",
  "PPL_norm": "NUMBER",
  "H_norm": "NUMBER",
  "TS": "NUMBER",
  "SC": "NUMBER",
  "FQ": "NUMBER",
  "example": "STRING",
  "consistency_score": "NUMBER",
  "benchmark_comparison": [ // <--- 【修正點 C】新增陣列結構
        {
            "metric": "STRING",
            "score": "NUMBER",
            "nearest_benchmark": "STRING",
            "comparison_description": "STRING"
        }
        // ... (其他三個指標的物件) ...
    ],
   "grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN",
      "errors": [
        {
          "type": "STRING",
          "description": "STRING",
          "suggestion": "STRING",
          "priority": "STRING"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING",
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING",
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
13. **Output ONLY the requested JSON format object.**`;
            // ======================================================
            // === 優化 END: systemPrompt 已更新 ===
            // ======================================================


            const userQuery = `
Context (Using only last ${contextLen} words): "${truncatedPhrase}"
Custom Word: "${customWord}"
Writing Task: "${taskContext}"
Sampling Params (T=${temp}, TopP=${topP})
`;
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, customSchema, temp, topP);
            // --- [MODIFICATION END] ---

            // Restore UI
            customLoading.classList.add('hidden');
            customButton.disabled = false;
            customButtonText.textContent = "Check Word";

            // ==================================================================
            // === v3.1 OPTIMIZATION START: Reworked custom word result UI ===
            // ==================================================================
            if (result.isError) {
                customResults.innerHTML = `<p class="text-red-400">Validation Failed: ${result.message}</p>`;

            } else if (result.FQ !== undefined) { // v3.0: 檢查 FQ (而不是舊的 band)

                // v3.0: 呼叫新的輔助函式，在前端根據 FQ 計算 Band
                const bandInfo = getBandInfoFromFQ(result.FQ);
                // =======================================================
                // 【新增程式碼】: 輸出 benchmark_comparison 到 Console
                // =======================================================
                console.log("--- Benchmark Comparison Results ---");
                // 使用 console.dir 或 JSON.stringify 以確保輸出格式可讀
                if (result.benchmark_comparison) {
                    console.dir(result.benchmark_comparison);
                } else {
                    console.log("Error: benchmark_comparison field is missing or empty.");
                }
                console.log("------------------------------------");
                // =======================================================

                // v3.1 (Optimization): Reworked custom word result UI
                customResults.innerHTML = `
            <div class="bg-gray-700 p-4 rounded-lg border border-yellow-500/50 space-y-4">
                
                <!-- 1. Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between pb-3 border-b border-gray-600 gap-2">
                    <div>
                        <h4 class="text-lg font-bold text-yellow-300">Custom Word: "${customWord}"</h4>
                        <p class="text-sm text-gray-400 break-all">Context: "...${truncatedPhrase}"</p>
                    </div>
                    <span class="band-tag ${bandInfo.color} text-white text-lg px-4 py-2 flex-shrink-0">Band ${bandInfo.band}</span>
                </div>

                <!-- 2. Main Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- Column 1: Final Score -->
                    <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-1">Final Fluency Quality (FQ)</h5>
                        <p class="text-5xl font-bold text-yellow-300">${result.FQ.toFixed(4)}</p>
                        
                        <details class="w-full mt-3">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Show FQ-Band Mapping</summary>
                            <div class="mt-2 pt-2 border-t border-gray-700 space-y-1 text-xs text-gray-400 text-left">
                                <p><span class="band-tag bg-blue-600 text-white w-12 inline-block text-center mr-1">Band 9</span> FQ 0.85–1.0</p>
                                <p><span class="band-tag bg-green-600 text-white w-12 inline-block text-center mr-1">Band 8</span> FQ 0.75–0.84</p>
                                <p><span class="band-tag bg-yellow-500 text-white w-12 inline-block text-center mr-1">Band 7</span> FQ 0.65–0.74</p>
                                <p><span class="band-tag bg-orange-500 text-white w-12 inline-block text-center mr-1">Band 6</span> FQ 0.50–0.64</p>
                                <p><span class="band-tag bg-red-600 text-white w-12 inline-block text-center mr-1">Band 5</span> FQ 0.35–0.49</p>
                                <p><span class="band-tag bg-red-800 text-white w-12 inline-block text-center mr-1">Band &lt;5</span> FQ &lt; 0.35</p>
                            </div>
                        </details>
                    </div>

                    <!-- Column 2: Component Metrics -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-3">Component Metrics</h5>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between text-gray-300"><span>PPL_norm:</span> <span class="font-medium text-yellow-300">${result.PPL_norm.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>H_norm:</span> <span class="font-medium text-yellow-300">${result.H_norm.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>TS (Stability):</span> <span class="font-medium text-yellow-300">${result.TS.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>SC (Coherence):</span> <span class="font-medium text-yellow-300">${result.SC.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300 pt-2 border-t border-gray-700/50"><span>Consistency:</span> <span class="font-medium text-yellow-300">${result.consistency_score}</span></li>
                        </ul>
                    </div>

                    <!-- Column 3: Benchmark Comparison -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-3">Benchmark Comparison</h5>
                        <!-- This is where the new function's output will go -->
                        ${renderBenchmarkComparison(result.benchmark_comparison)}
                    </div>
                </div>

                <!-- 3. Example & Grammar -->
                <div class="pt-4 border-t border-gray-600">
                    <h5 class="text-sm font-semibold text-gray-400 mb-2">Example Sentence & Grammar Report</h5>
                    <div class="bg-gray-600 p-3 rounded-md text-gray-200">
                        ${highlight(result.example, fullPhrase)}
                    </div>
                    <!-- The renderGrammarValidation function is already defined and works -->
                    ${renderGrammarValidation(result.grammar_validation)}
                </div>
            </div>
        `;
            } else {
                // v3.0: 更新錯誤訊息
                customResults.innerHTML = `<p class="text-red-400">Received unexpected response format (Missing required FQ metric).</p>`;
            }
            // ==================================================================
            // === v3.1 OPTIMIZATION END ===
            // ==================================================================
        }
        ////


        function displayPredictionResults(results, inputPhrase) {
            if (results.length === 0) {
                predictionResults.innerHTML = `<p class="text-gray-400 md:col-span-2 text-center">${window.i18n.t('none')}</p>`;
                return;
            }

            results.forEach((item, index) => {
                const fullPhrase = `${inputPhrase} ${item.word}`;
                const bandInfo = getCohesionBandDetails(item.ppl);
                const consistencyStatus = item.consistency_score >= 85 ? 'Stable' : 'Check';

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">${index + 1}. ${item.word}</h3>
                        <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                    </div>
                    
                    <p class="text-sm text-gray-400">${item.band_summary}</p>

                    <div class="grid grid-cols-2 text-sm text-gray-300 border-b border-gray-700 pb-3">
                        <p><strong>P(wₙ|context):</strong> <span class="text-blue-300">${item.p_w_n.toFixed(4)}</span></p>
                        <p><strong>PPL:</strong> <span class="text-blue-300">${item.ppl.toFixed(2)}</span></p>
                    </div>

                    <div id="example-container-${index}" class="bg-gray-700 p-3 rounded-md text-gray-200">
                        ${highlight(item.example, fullPhrase)}
                    </div>
                    <div id="metrics-container-${index}" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${item.consistency_score} (${consistencyStatus})</div>
                    </div>
                    <div id="grammar-validation-${index}">
                        ${renderGrammarValidation(item.grammar_validation)}
                    </div>
                    
                    <div class="flex gap-2 pt-2">
                        <select id="band-select-${index}" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7">Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="${index}"
                                data-context="${inputPhrase}"
                                data-word="${item.word}"
                                data-type="prediction">
                            <span class="regen-text">🔄 ${window.i18n.currentLang === 'zh' ? '重新生成' : 'Regenerate'}</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>
                `;
                predictionResults.appendChild(card);
            });
        }

        function displayLoading(errorEl, loadingEl, buttonEl, textEl, message) {
            errorEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');
            buttonEl.disabled = true;
            textEl.textContent = message;
        }

        function displayDone(loadingEl, buttonEl, textEl, message) {
            loadingEl.classList.add('hidden');
            buttonEl.disabled = false;
            textEl.textContent = message;
        }

        function displayError(errorEl, message, loadingEl = null, buttonEl = null, textEl = null, buttonMessage = null) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            if (loadingEl) displayDone(loadingEl, buttonEl, textEl, buttonMessage);
        }

        // v3.0: Update regenSchema
        const regenSchema = {
            type: "OBJECT",
            properties: {
                "example": { "type": "STRING", "description": "Newly generated example sentence, <= 25 words" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the new sentence (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["example", "consistency_score", "grammar_validation"] // v3.0 Replace
        };

        // Unified example regeneration logic (Shared by Prediction & Validation)
        async function handleRegeneration(button, band, context, word, type) {
            // --- [MODIFICATION START] Get API Key First ---
            const userApiKey = getSystemApiKey();
            const index = button.dataset.index;
            const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`);

            if (!userApiKey) {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: API key is empty.</span>`;
                // Restore UI in case it's spinning
                const regenText = button.querySelector('.regen-text');
                const regenLoading = button.querySelector('.regen-loading');
                button.disabled = false;
                regenText.classList.remove('hidden');
                regenLoading.classList.add('hidden');
                return;
            }
            // --- [MODIFICATION END] ---

            const fullPhrase = type === 'prediction' ? `${context} ${word}` : context; // Validation case: context is the full phrase

            // const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`); // Moved up
            const regenText = button.querySelector('.regen-text');
            const regenLoading = button.querySelector('.regen-loading');

            // T1.8 Fix: Check if this is an auto-retry
            const isAutoRetry = button.dataset.isAutoRetry === 'true';

            // Set UI to loading
            button.disabled = true;
            regenText.classList.add('hidden');
            regenLoading.classList.remove('hidden');
            // T1.8 Fix: Update loading message
            exampleContainer.innerHTML = `<span class="text-gray-400">Generating Band ${band} example... ${isAutoRetry ? '(Auto-Traceback Retry...)' : '(Self-Consistency 3x)'}</span>`;

            // Get Consistency Manager parameters
            const temp = predTemp.value;
            const topP = predTopP.value;

            // Prepare API request
            const bandRules = `Band ${band} - Vocabulary and Sentence Feature: ${type === 'prediction' ? 'Cohesion & Coherence' : 'Lexical Resource'}.`;

            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to generate a "single, concise (max 25 words)" example sentence based on the user-specified "full collocation phrase" (\${fullPhrase}) and "target Band" (\${band}).

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  **Semantic Consistency (>= 0.9):** The newly generated example must remain highly consistent semantically with the current example, differing only in syntactic structure and lexical choice.
4.  **Band Adherence:** The example must strictly conform to the target Band (\${band}) requirements for grammatical complexity, coherence, and lexical density.
5.  **Complete Collocation:** Ensure the example sentence contains the **complete and corrected** collocation "\${fullPhrase}".
6.  **Continuity:** Ensure the words in the collocation are continuous and not separated by punctuation.
7.  Self-Consistency: Simulate three rounds of Self-Consistency sampling to ensure output stability.
8.  Output a "consistency_score" (0-100), calculated based on semantic similarity, lexical variance, and syntactic stability.

9.  [Grammar Validation Layer (Latest Spec)]: ✨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (🔥 Strictly Reinforced - **Includes syntax errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation (end-of-sentence), Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (💡 Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        -   **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice.
        -   **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. CorrectCness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (🌟 Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

10. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

11. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING", // Correction required by Rule 1
  "example": "STRING",
  "consistency_score": "NUMBER",
  "grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
12. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Full Collocation: "${fullPhrase}"
Target Band: ${band}
Band Rules: ${bandRules}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, regenSchema, temp, topP);
            // --- [MODIFICATION END] ---

            // Restore UI (Restore before T1.8 check to prevent button getting stuck)
            button.disabled = false;
            regenText.classList.remove('hidden');
            regenLoading.classList.add('hidden');

            // Display results
            if (result.isError) {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: ${result.message || 'Unknown error'}</span>`;
            } else if (result.example && result.consistency_score !== undefined && result.grammar_validation) {

                // T1.8 / T2.8 Fix: Store history
                const historyKey = `${type}-${index}`;
                if (!regenerationHistory[historyKey]) {
                    regenerationHistory[historyKey] = [];
                }
                regenerationHistory[historyKey].push(result.consistency_score);
                if (regenerationHistory[historyKey].length > 5) { // Keep last 5
                    regenerationHistory[historyKey].shift();
                }

                // T1.8 / T2.8 Fix: Semantic Traceback simulation
                // If score is low, and this is not an auto-retry
                if (result.consistency_score < 85 && !isAutoRetry) {
                    console.warn(`Semantic Traceback (T1.8) triggered for ${historyKey}. Score: ${result.consistency_score}. Auto-retrying...`);

                    // v3.0 Update: Get metrics container
                    const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div>Consistency: ${result.consistency_score} (<span class="text-yellow-400">Low score! Auto-Traceback Retry...</span>)</div>
                        `;
                    }
                    // v3.0 Update: Get grammar container
                    const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                    if (grammarContainer) {
                        grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                    }


                    // Flag and retry once
                    button.dataset.isAutoRetry = 'true';
                    await handleRegeneration(button, band, context, word, type);

                    // After retry, clear flag and exit
                    button.dataset.isAutoRetry = 'false';
                    return; // Terminate this function to prevent showing low-score result
                }

                // --- Display Normal Result (Score >= 85 or already retried) ---

                // Update example
                exampleContainer.innerHTML = highlight(result.example, fullPhrase);

                // v3.0 Update: Update metrics container
                const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                if (metricsContainer) {
                    const consistencyStatus = result.consistency_score >= 85 ? 'Stable' : 'Check';
                    metricsContainer.innerHTML = `
                        <div>Consistency: ${result.consistency_score} (${consistencyStatus})</div>
                    `;
                }
                // v3.0 Update: Update grammar container
                const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                if (grammarContainer) {
                    grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                }
            } else {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: Received unexpected response format (missing grammar_validation).</span>`;
            }
        }

        // Event delegation for prediction results area (Regeneration)
        predictionResults.addEventListener('click', async function (e) {
            const button = e.target.closest('.regen-button');
            if (!button || button.dataset.type !== 'prediction') return;

            e.preventDefault();
            const index = button.dataset.index;
            // T1.4 Fix: Ensure truncated context is passed
            const context = truncateContext(button.dataset.context, predContextLen.value);
            const word = button.dataset.word;

            const bandSelect = document.getElementById(`band-select-${index}`);
            const band = bandSelect.value;

            await handleRegeneration(button, band, context, word, 'prediction');
        });

        // --- Validation Tab Logic (Unchanged) ---

        // v3.0: Update validationSchema
        const validationSchema = {
            type: "OBJECT",
            properties: {
                "Fpm": { "type": "NUMBER", "description": "Frequency per million words in the corpus" },
                "MI": { "type": "NUMBER", "description": "Mutual Information value" },
                "L_acc_norm": { "type": "NUMBER", "description": "Linguistic accuracy (1.0 = correct; 0.5 = minor error; 0.0 = error)" },
                "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                "grammarCheck": { "type": "STRING", "description": "Brief description of grammar validation result (should align with L_acc_norm)" },
                "spellingSuggestion": { "type": "STRING", "description": "Spelling correction suggestion or alternative collocation (empty string if none)" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the example (0-100)" },
                "example_grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["Fpm", "MI", "L_acc_norm", "example", "grammarCheck", "spellingSuggestion", "consistency_score", "example_grammar_validation"] // v3.0 Replace
        };

        async function handleValidationSubmit(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(valError, window.i18n.t('errorApiKeyEmpty'), valLoading, valButton, valButtonText, window.i18n.t('validateCollocation'));
                igpvlValError.innerHTML = '';
                igpvlValError.className = 'text-sm rounded-lg';
                return;
            }

            const phrase1 = valInput1.value.trim();
            const phrase2 = valInput2.value.trim();
            const fullPhrase = `${phrase1} ${phrase2}`.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlValError.innerHTML = '';
            igpvlValError.className = 'text-sm rounded-lg';
            valError.classList.add('hidden'); // Hide old generation errors
            validationResults.classList.add('hidden');
            validationResults.innerHTML = '';

            if (!phrase1 || !phrase2) {
                displayError(valError, window.i18n.t('errorEnterPhrase'), valLoading, valButton, valButtonText, window.i18n.t('validateCollocation'));
                return;
            }

            displayLoading(valError, valLoading, valButton, valButtonText, window.i18n.t('validatingInput'));

            // --- v2.6 IGPVL Execution ---
            // --- [MODIFICATION START] Pass userApiKey ---
            const igpvlResult = await validateInputGrammar(userApiKey, fullPhrase, 'valInput', 'academic');
            // --- [MODIFICATION END] ---
            const isBlocked = displayIgpvlFeedback(igpvlValError, igpvlResult);

            if (isBlocked) {
                displayDone(valLoading, valButton, valButtonText, window.i18n.t('validateCollocation'));
                return;
            }
            // --- IGPVL End ---

            displayLoading(valError, valLoading, valButton, valButtonText, window.i18n.t('analyzingPredictions'));

            // S_Naturalness v3.0 (User Custom) Revised System Prompt
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to evaluate the naturalness and correctness of the user-provided "full collocation phrase" (\${fullPhrase}) and provide the raw data needed to calculate S_Naturalness.

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 9 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  Provide "Fpm" (Frequency per million words in the corpus).
4.  Provide "MI" (Mutual Information value).
5.  Based on grammatical and morphological correctness, provide "L_acc_norm" (Linguistic accuracy score: 1.0 = Fully correct, 0.5 = Understandable but with minor errors, 0.0 = Severe error).
6.  Provide a "Concise Example (example)" (max 25 words).
7.  Provide a brief result for "Grammar Check (grammarCheck)" (this should align with L_acc_norm).
8.  If the collocation is unnatural or has clear spelling errors, provide an "Alternative Collocation (spellingSuggestion)" or correction; otherwise, return an empty string.
9.  Provide a "consistency_score" (0-100) for the 'example'.

10. [Grammar Validation Layer (Latest Spec)]: ✨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'example_grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (🔥 **Final Unified Reinforcement** - **Includes all structural errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as all syntactic structural errors**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Syntax/Structure:** Dangling/Misplaced modifiers, Inconsistent tense shifts, Incomplete comparisons, Double negatives, Parallel structure errors, **Run-on Sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling (**confused words**), Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (💡 Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **This section no longer handles structural errors.**
        -   **Optimization:** Provide **brevity suggestions (wordiness)**, detect **overuse of passive voice**.
        -   **Full Sentence Rewrite (rewrite_suggestion):** **Must** be provided when needed, and this rewrite should **correct all errors from I. Correctness** and make the meaning clearer and more concise.

    c.  [III. Engagement]: (🌟 Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with **Sentence Variety** or **content repetition**.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

13. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

14. [Language Requirement]: All feedback, reasoning, and explanations (including grammarCheck, and grammar_validation descriptions) MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.

12. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING",
  "Fpm": "NUMBER",
  "MI": "NUMBER",
  "L_acc_norm": "NUMBER",
  "example": "STRING",
  "grammarCheck": "STRING",
  "spellingSuggestion": "STRING",
  "consistency_score": "NUMBER",
  "example_grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
13. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Full Collocation: "${fullPhrase}"
`;

            // Call API (Use Consistency Manager params from Prediction tab)
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, validationSchema, predTemp.value, predTopP.value);
            // --- [MODIFICATION END] ---

            displayDone(valLoading, valButton, valButtonText, window.i18n.t('validateCollocation'));

            // Process API response
            if (result.isError) {
                displayError(valError, result.message);
            } else if (result.Fpm !== undefined && result.MI !== undefined && result.L_acc_norm !== undefined && result.example_grammar_validation !== undefined) {
                // v3.0 Revised: Check for new field
                displayValidationResult(result, fullPhrase);
            } else {
                displayError(valError, window.i18n.t('unexpectedFormat'));
            }
        }

        function displayValidationResult(result, fullPhrase) {
            const { Fpm, MI, L_acc_norm, example, grammarCheck, spellingSuggestion, consistency_score, example_grammar_validation } = result;

            const N_LOG_MIN = 0;
            const N_LOG_MAX = 2.0043213738;
            const M_MIN = 0;
            const M_MAX = 6;
            const W_FPM = 0.4;
            const W_MI = 0.4;
            const W_L_ACC = 0.2;

            const N_Log = Math.log10(Fpm + 1);
            const N_norm = (N_Log - N_LOG_MIN) / (N_LOG_MAX - N_LOG_MIN);
            const M_norm = (MI - M_MIN) / (M_MAX - M_MIN);
            const S_Naturalness = (W_FPM * N_norm) + (W_MI * M_norm) + (W_L_ACC * L_acc_norm);

            const bandInfo = getLexicalBandDetails(S_Naturalness);

            let suggestionHtml = '';
            if (spellingSuggestion && spellingSuggestion.trim() !== '') {
                suggestionHtml = `
                    <div class="mt-4">
                        <h4 class="font-semibold text-yellow-300">Suggestion/Alternative</h4>
                        <p class="text-yellow-400 bg-yellow-900/50 p-3 rounded-md">${spellingSuggestion}</p>
                    </div>
                `;
            }

            const consistencyStatus = consistency_score >= 85 ? 'Stable' : 'Check';

            validationResults.innerHTML = `
                <div class="text-center mb-6 border-b border-gray-700 pb-4">
                    <span class="text-xs font-semibold uppercase text-gray-400">Lexical Resource Band</span>
                    <div class="flex items-center justify-center my-2">
                        <span class="band-tag ${bandInfo.color} text-white text-3xl p-3">Band ${bandInfo.band}</span>
                    </div>
                    <p class="text-gray-300 mt-2 max-w-md mx-auto">${bandInfo.summary}</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-700/50 p-4 rounded-md space-y-3">
                        <h4 class="font-semibold text-gray-300 text-center">S_Naturalness (Naturalness) Calculation Details</h4>
                        <div class="grid grid-cols-3 text-sm text-gray-300 text-center">
                            <p><strong>Fpm (Raw Frequency):</strong> <span class="text-green-300">${Fpm.toFixed(4)}</span></p>
                            <p><strong>MI (Mutual Information):</strong> <span class="text-green-300">${MI.toFixed(3)}</span></p>
                            <p><strong>L_Acc (Accuracy):</strong> <span class="text-green-300">${L_acc_norm.toFixed(1)}</span></p>
                        </div>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-2 text-sm text-gray-300 text-center">
                            <p><strong>N_norm (Frequency Norm.):</strong> <span class="text-blue-300">${N_norm.toFixed(4)}</span> (w: ${W_FPM * 100}%)</p>
                            <p><strong>M_norm (MI Norm.):</strong> <span class="text-blue-300">${M_norm.toFixed(4)}</span> (w: ${W_MI * 100}%)</p>
                        </div>
                        <div class="text-center pt-2">
                            <p class="font-semibold text-gray-300">Final S_Naturalness Score</p>
                            <p class="text-2xl font-bold text-white">${S_Naturalness.toFixed(4)}</p>
                            <p class="text-xs text-gray-400">(${W_FPM}*${N_norm.toFixed(3)} + ${W_MI}*${M_norm.toFixed(3)} + ${W_L_ACC}*${L_acc_norm.toFixed(1)})</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-300">${window.i18n.currentLang === 'zh' ? '語法檢查 (結果)' : 'Grammar Check'}</h4>
                        <p class="text-gray-300">${grammarCheck}</p>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-300">${window.i18n.currentLang === 'zh' ? '範例句 - 可調整等級' : 'Example - Band level can be changed'}</h4>
                        <div id="val-example-container" class="bg-gray-700 p-4 rounded-md text-gray-200 text-lg">
                            ${highlight(example, fullPhrase)}
                        </div>
                    </div>
                    <div id="val-metrics-container" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${consistency_score} (${consistencyStatus})</div>
                    </div>
                    <div id="val-grammar-validation">
                        ${renderGrammarValidation(example_grammar_validation)}
                    </div>

                    <div class="flex gap-2 pt-2">
                        <select id="val-band-select" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7" selected>Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="val"
                                data-context="${fullPhrase}"
                                data-word=""
                                data-type="validation">
                            <span class="regen-text">🔄 ${window.i18n.currentLang === 'zh' ? '重新生成' : 'Regenerate'}</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>

                    ${suggestionHtml}
                </div>
            `;
            validationResults.classList.remove('hidden');

            document.querySelector('#validationResults .regen-button').addEventListener('click', async function (e) {
                e.preventDefault();
                const button = e.currentTarget;
                const band = document.getElementById('val-band-select').value;
                const context = button.dataset.context;
                await handleRegeneration(button, band, context, '', 'validation');
            });
        }

        // --- v2.8 Add: Continuation Tab Logic ---

        /**
         * v2.8: Handle Paragraph Continuation & Full Analysis
         */
        async function handleContinuationSubmit(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(contError, window.i18n.t('errorApiKeyEmpty'), contLoading, contButton, contButtonText, window.i18n.t('predictAnalyze'));
                igpvlContError.innerHTML = '';
                igpvlContError.className = 'text-sm rounded-lg';
                return;
            }

            const paragraph = contInput.value.trim();

            // Clear old messages
            igpvlContError.innerHTML = '';
            igpvlContError.className = 'text-sm rounded-lg';
            contError.classList.add('hidden');
            continuationResult.classList.add('hidden');
            continuationResult.innerHTML = '';

            if (!paragraph) {
                displayError(contError, window.i18n.t('errorEnterParagraph'), contLoading, contButton, contButtonText, window.i18n.t('predictAnalyze'));
                return;
            }

            displayLoading(contError, contLoading, contButton, contButtonText, window.i18n.t('validatingInput'));

            const igpvlResult = await validateInputGrammar(userApiKey, paragraph, 'contInput', 'academic_essay');
            const isBlocked = displayIgpvlFeedback(igpvlContError, igpvlResult);

            if (isBlocked) {
                displayDone(contLoading, contButton, contButtonText, window.i18n.t('predictAnalyze'));
                return;
            }

            displayLoading(contError, contLoading, contButton, contButtonText, window.i18n.t('analyzingPredictions'));

            // --- Define System Prompt based on v2.8 Spec ---
            const systemPrompt = `You are the "IELTS Writing Assistant (v2.8)". Your task is to perform a full analysis on the user's input text and generate a continuation, strictly adhering to the v2.8 specification.

Your process must follow this exact flow:
1.  **Receive Input:** Get the user's text.
2.  **GVL (Grammar Validation Layer):** Perform a "Grammarly Premium-Level" check. You must check ALL categories from the v2.8 spec:
    * Core Grammar (GVL-CG-01 to 04)
    * Advanced Grammar (GVL-AG-01 to 04)
    * Spelling & Consistency (GVL-SP-01 to 04)
    * Punctuation (GVL-PU-01 to 02)
    * Number Agreement (GVL-NAC-01)
3.  **GCE (Grammar Correction Engine):** Automatically correct ALL errors found by GVL.
4.  **Re-Validation:** The corrected text MUST pass GVL again.
5.  **Run Layers:** Using the GCE-corrected text, run the Clarity, Engagement, and Delivery layers.
6.  **Continuation:** Generate a 'predicted_next_sentence' that is cohesive and logically follows the corrected text. This new sentence MUST also pass GVL/GCE.
7.  **Band Mapping:** Provide a 'band_prediction' (e.g., 8.0) for the *user's input*.
8.  **Output JSON:** Return a single JSON object matching the v2.8 (Section VIII) schema.

* All fields in the v2.8 (Section VIII) schema are mandatory.
* [Language Requirement]: All feedback, reasoning, and explanations MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.
`;
            const userQuery = `
Input Text:
"${paragraph}"
`;

            // Call API
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, v2_8_Schema, 0.7, 0.95);

            displayDone(contLoading, contButton, contButtonText, window.i18n.t('predictAnalyze'));

            // Process API response
            if (result.isError) {
                displayError(contError, result.message);
            } else if (result.validation_result === "Passed" && result.continuation) {
                displayContinuationResult(result);
            } else {
                displayError(contError, window.i18n.t('unexpectedFormat'));
                console.error("Unexpected v2.8 response:", result);
            }
        }

        /**
         * v2.8: Handle Single Sentence Band Prediction
         */
        async function handleBandPredictionSubmit(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(bandError, window.i18n.t('errorApiKeyEmpty'), bandLoading, bandButton, bandButtonText, window.i18n.t('predictSentenceBand'));
                igpvlBandError.innerHTML = '';
                igpvlBandError.className = 'text-sm rounded-lg';
                return;
            }

            const sentence = bandInput.value.trim();

            // Clear old messages
            igpvlBandError.innerHTML = '';
            igpvlBandError.className = 'text-sm rounded-lg';
            bandError.classList.add('hidden');
            bandPredictionResult.classList.add('hidden');
            bandPredictionResult.innerHTML = '';

            if (!sentence) {
                displayError(bandError, window.i18n.t('errorEnterSentence'), bandLoading, bandButton, bandButtonText, window.i18n.t('predictSentenceBand'));
                return;
            }

            displayLoading(bandError, bandLoading, bandButton, bandButtonText, window.i18n.t('validatingInput'));

            // --- IGPVL Execution ---
            const igpvlResult = await validateInputGrammar(userApiKey, sentence, 'bandInput', 'academic_sentence');
            const isBlocked = displayIgpvlFeedback(igpvlBandError, igpvlResult);

            if (isBlocked) {
                displayDone(bandLoading, bandButton, bandButtonText, window.i18n.t('predictSentenceBand'));
                return;
            }
            // --- IGPVL End ---

            displayLoading(bandError, bandLoading, bandButton, bandButtonText, window.i18n.t('predictingBand'));

            // --- Define System Prompt based on v2.8 Spec (Task B) ---
            const systemPrompt = `You are the "IELTS Band Mapper (v2.8)". Your task is to analyze the user's single input sentence and predict its IELTS Band score.
1.  Run the GVL/GCE process to ensure the sentence is 100% grammatically correct.
3.  Return a single JSON object matching the 'bandPredictionSchema'.
4.  'validation_result' must be "Passed".
5.  [Language Requirement]: All feedback, reasoning, and explanations MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.
`;
            const userQuery = `Input Sentence: "${sentence}"`;

            // Call API
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, bandPredictionSchema, 0.5, 0.95);

            displayDone(bandLoading, bandButton, bandButtonText, window.i18n.t('predictSentenceBand'));

            // Process API response
            if (result.isError) {
                displayError(bandError, result.message);
            } else if (result.band_prediction) {
                displayBandPredictionResult(result);
            } else {
                displayError(bandError, window.i18n.t('unexpectedFormat'));
            }
        }

        function displayContinuationResult(result) {
            const { continuation } = result;

            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-purple-500/50 space-y-4">
                    <h3 class="text-xl font-bold text-white">${window.i18n.t('analysisComplete')}</h3>
                    
                    <div>
                        <h5 class="font-semibold text-white">${window.i18n.t('continuationHeader')}</h5>
                        <p class="text-gray-400">${window.i18n.t('predictedBand')}: <span class="band-tag bg-purple-600 text-white">Band ${continuation.band_prediction.toFixed(1)}</span></p>
                        <p class="font-semibold text-gray-300 mt-2">${window.i18n.t('predictedNextSentence')}:</p>
                        <div class="bg-gray-600 p-3 rounded-md text-gray-200 mt-1">
                            ${continuation.predicted_sentence}
                        </div>
                    </div>
                    
                    ${renderV2_8_Validation(result)}
                </div>
            `;

            continuationResult.innerHTML = html;
            continuationResult.classList.remove('hidden');
        }

        function displayBandPredictionResult(result) {
            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-indigo-500/50 text-center">
                    <h3 class="text-lg font-semibold text-white">${window.i18n.t('bandPredictionHeader')}</h3>
                    <p class="text-5xl font-bold text-white my-4">${result.band_prediction.toFixed(1)}</p>
                    <span class="band-tag bg-indigo-600 text-white">${window.i18n.t('checkPassed')}: ${result.validation_result}</span>
                </div>
            `;
            bandPredictionResult.innerHTML = html;
            bandPredictionResult.classList.remove('hidden');
        }

        // --- [MODIFICATION START] v2.9.3 SWOT Analysis Logic ---

        /**
         * v2.9.3: Handle Cohesion SWOT Analysis Submit
         */
        async function handleSwotSubmit(e) {
            e.preventDefault();

            const userApiKey = getSystemApiKey();
            if (!userApiKey) {
                displayError(swotError, window.i18n.t('errorApiKeyEmpty'), swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));
                igpvlSwotError.innerHTML = '';
                igpvlSwotError.className = 'text-sm rounded-lg';
                return;
            }

            const paragraph = swotInputParagraph.value.trim();
            const sentence1 = swotInputSentence1.value.trim();
            const sentence2 = swotInputSentence2.value.trim();

            // Clear old messages
            igpvlSwotError.innerHTML = '';
            igpvlSwotError.className = 'text-sm rounded-lg';
            swotError.classList.add('hidden');
            swotResult.classList.add('hidden');
            swotResult.innerHTML = '';

            if (!paragraph || !sentence1 || !sentence2) {
                displayError(swotError, window.i18n.t('errorEnterSwot'), swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));
                return;
            }

            displayLoading(swotError, swotLoading, swotButton, swotButtonText, window.i18n.t('validatingOption', { index: 1 }));
            const igpvlResult1 = await validateInputGrammar(userApiKey, sentence1, 'swotInput1', 'academic_essay_sentence');
            const isBlocked1 = displayIgpvlFeedback(igpvlSwotError, igpvlResult1);

            if (isBlocked1) {
                displayDone(swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));
                return;
            }

            displayLoading(swotError, swotLoading, swotButton, swotButtonText, window.i18n.t('validatingOption', { index: 2 }));
            const igpvlResult2 = await validateInputGrammar(userApiKey, sentence2, 'swotInput2', 'academic_essay_sentence');
            const isBlocked2 = displayIgpvlFeedback(igpvlSwotError, igpvlResult2);

            // Clear feedback after success
            if (!isBlocked1 && !isBlocked2) {
                igpvlSwotError.innerHTML = '';
                igpvlSwotError.className = 'text-sm rounded-lg';
            }

            if (isBlocked2) {
                displayDone(swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));
                return;
            }

            displayLoading(swotError, swotLoading, swotButton, swotButtonText, window.i18n.t('comparingOptions'));

            const comparisonSystemPrompt = `You are an expert IELTS examiner, specializing ONLY in the 'Cohesion and Coherence' (C&C) band descriptors.
Your task is to compare two potential opening sentences (Option 1, Option 2) based on how well they connect to the preceding paragraph.
You MUST decide which one is better based on C&C criteria:
2.  **Conceptual Coherence:** How logically the topic follows (e.g., contrast, addition, result, or abrupt shift).

Return ONLY a valid JSON object matching the requested schema.
[Language Requirement]: The 'reasoning' or any explanation field MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.`;

            const comparisonUserQuery = `
{
  "input_paragraph": "${paragraph}",
  "option_1": "${sentence1}",
  "option_2": "${sentence2}"
}
`;

            const comparisonResult = await callGeminiAPI(userApiKey, comparisonSystemPrompt, comparisonUserQuery, swotComparisonSchema, 0.3, 0.95);

            if (comparisonResult.isError) {
                displayError(swotError, comparisonResult.message, swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));
                return;
            }

            displayLoading(swotError, swotLoading, swotButton, swotButtonText, window.i18n.t('runningSwot'));

            const bestSentenceIndex = comparisonResult.best_option_index;
            const bestSentence = (bestSentenceIndex === 0) ? sentence1 : sentence2;
            const sentences = [sentence1, sentence2]; // For display

            // Use the *original* SWOT system prompt
            const swotSystemPrompt = `You are an expert IELTS examiner, specializing ONLY in the 'Cohesion and Coherence' (C&C) band descriptors.
Your task is to analyze the connection between a given paragraph and the user's proposed opening sentence for the *next* paragraph.
You MUST generate a SWOT analysis based *strictly* on the IELTS C&C criteria.

**Evaluation Criteria:**
1.  **Grammatical Fluency:** How smoothly does the opening sentence follow the paragraph grammatically?
2.  **Textual Cohesion:** How effectively are linking devices used? (e.g., transition words like 'However', 'Furthermore'; pronoun references like 'this', 'it', 'they'). Are references clear?
3.  **Conceptual Coherence:** How logically does the topic of the opening sentence follow from the paragraph? (e.g., Is it a natural contrast, an added point, a result, or an abrupt shift?)

**SWOT Framework (Mandatory):**
* **Strengths (S):** Identify positive C&C links. (e.g., "Good use of 'On the other hand' to signal contrast.")
* **Weaknesses (W):** Identify clear C&C errors. (e.g., "Missing logical connector; the transition is too abrupt.", "Unclear pronoun 'it'; what does 'it' refer to?")
* **Opportunities (O):** Suggest specific improvements for this transition. (e.g., "Consider adding 'In addition,' to clarify this is a new point.", "Replacing 'This' with 'This issue' would strengthen the reference.")
* **Threats (T):** Warn about risks if these weaknesses persist. (e.g., "This abrupt shift, if repeated, will damage the essay's logical flow and lower the C&C score.", "Overusing 'And' as a connector is a Band 5/6 trait.")

**Output:**
You must provide an 'overall_assessment' and a 'cohesion_band_estimate' (from 5.0 to 9.0) for *this specific transition*.
Return ONLY a valid JSON object matching the requested schema.
[Language Requirement]: All feedback, SWOT analysis points, and evaluations MUST be written in ${window.i18n.currentLang === 'zh' ? 'Traditional Chinese (Taiwan)' : 'English'}.
`;
            const swotUserQuery = `
{
  "input_paragraph": "${paragraph}",
  "user_opening_sentence": "${bestSentence}"
}
`;
            const swotAnalysisResult = await callGeminiAPI(userApiKey, swotSystemPrompt, swotUserQuery, swotSchema, 0.5, 0.95);

            displayDone(swotLoading, swotButton, swotButtonText, window.i18n.t('compareSwot'));

            // Process final results
            if (swotAnalysisResult.isError) {
                displayError(swotError, swotAnalysisResult.message);
                // Still show the comparison result if it worked
                displaySwotCombinedResult(comparisonResult, null, sentences);
            } else {
                displaySwotCombinedResult(comparisonResult, swotAnalysisResult, sentences);

                // 🎮 RPG: Award XP for SWOT analysis
                if (typeof DevScribeRPG !== 'undefined') {
                    const rpgResult = DevScribeRPG.recordModuleAction('lab', 'vocab_experiment');
                    if (rpgResult) DevScribeRPG.showXPNotification(rpgResult);
                }
            }
        }

        /**
         * v2.9.3: Display combined results for Comparison and SWOT
         */
        function displaySwotCombinedResult(comparisonResult, swotAnalysisResult, sentences) {

            const { best_option_index, comparison_reason, worst_option_feedback } = comparisonResult;
            const chosenOptionIndex = best_option_index; // 0 or 1
            const weakerOptionIndex = 1 - chosenOptionIndex; // 1 or 0

            // --- Part 1: Comparison Result ---
            // v2.9.3-en: Translated
            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-teal-500/50 space-y-4">
                    <h3 class="text-xl font-bold text-white">${window.i18n.t('ccComparisonHeader')}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Best Option -->
                        <div class="bg-gray-800 p-4 rounded-lg border-2 border-green-500">
                            <h5 class="text-lg font-semibold text-green-400">${window.i18n.t('bestOption', { index: chosenOptionIndex + 1 })}</h5>
                            <p class="text-gray-300 italic my-2">"${sentences[chosenOptionIndex]}"</p>
                            <p class="text-sm text-gray-400">${comparison_reason}</p>
                        </div>
                        
                        <!-- Weaker Option -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                            <h5 class="text-lg font-semibold text-yellow-400">${window.i18n.t('otherOption', { index: weakerOptionIndex + 1 })}</h5>
                            <p class="text-gray-300 italic my-2">"${sentences[weakerOptionIndex]}"</p>
                            <p class="text-sm text-gray-400">${worst_option_feedback}</p>
                        </div>
                    </div>
                </div>
            `;

            // --- Part 2: SWOT Analysis Result (if successful) ---
            if (swotAnalysisResult && swotAnalysisResult.strengths) {
                const { strengths, weaknesses, opportunities, threats, overall_assessment, cohesion_band_estimate } = swotAnalysisResult;

                const renderList = (items, color) => {
                    if (!items || items.length === 0) {
                        return `<li class="text-gray-400">${window.i18n.t('none')}</li>`;
                    }
                    return items.map(item => `<li class="text-${color}-300">${item}</li>`).join('');
                };

                const getBandColor = (band) => {
                    if (band >= 8.0) return 'bg-indigo-600';
                    if (band >= 7.0) return 'bg-blue-600';
                    if (band >= 6.0) return 'bg-yellow-600';
                    return 'bg-red-600';
                };

                // v2.9.3-en: Translated
                html += `
                    <div class="bg-gray-700 p-5 rounded-lg border border-teal-500/50 space-y-4 mt-6">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-3">
                            <h3 class="text-xl font-bold text-white">${window.i18n.t('swotAnalysisHeader', { index: chosenOptionIndex + 1 })}</h3>
                            <span class="band-tag ${getBandColor(cohesion_band_estimate)} text-white">${window.i18n.t('estimatedCcBand')}: ${cohesion_band_estimate.toFixed(1)}</span>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="font-semibold text-white">${window.i18n.t('overallAssessment')}</h5>
                            <p class="text-gray-300 text-sm">${overall_assessment}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Strengths -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-green-400">${window.i18n.t('strengths')}</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(strengths, 'green')}
                                </ul>
                            </div>
                            
                            <!-- Weaknesses -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-red-400">${window.i18n.t('weaknesses')}</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(weaknesses, 'red')}
                                </ul>
                            </div>

                            <!-- Opportunities -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-blue-400">${window.i18n.t('opportunities')}</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(opportunities, 'blue')}
                                </ul>
                            </div>

                            <!-- Threats -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-yellow-400">${window.i18n.t('threats')}</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(threats, 'yellow')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else if (swotAnalysisResult && swotAnalysisResult.isError) {
                html += `<div class="bg-red-900/50 text-red-400 p-4 rounded-lg mt-6">${window.i18n.t('generationFailed')}: ${swotAnalysisResult.message}</div>`;
            }

            swotResult.innerHTML = html;
            swotResult.classList.remove('hidden');
        }

        // --- [MODIFICATION END] v2.9.3 SWOT Analysis Logic ---


        // --- Tab Switching Logic ---
        function switchTab(activeTab) {
            // v2.8 Update: Handle 3 tabs
            const allTabs = [tabs.prediction, tabs.validation, tabs.continuation];
            const allContents = [contents.prediction, contents.validation, contents.continuation];

            allTabs.forEach(tab => {
                tab.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tab.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
            });

            allContents.forEach(content => {
                content.classList.add('hidden');
            });

            const activeTabEl = tabs[activeTab];
            const activeContentEl = contents[activeTab];

            if (activeTabEl && activeContentEl) {
                activeTabEl.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                activeTabEl.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                activeContentEl.classList.remove('hidden');
            }
        }

        // --- Initial Event Bindings ---
        tabs.prediction.addEventListener('click', () => switchTab('prediction'));
        tabs.validation.addEventListener('click', () => switchTab('validation'));
        tabs.continuation.addEventListener('click', () => switchTab('continuation')); // v2.8 Add

        predForm.addEventListener('submit', handlePredictionSubmit);
        customWordForm.addEventListener('submit', handleCustomWordCheck); // Bind custom word form
        valForm.addEventListener('submit', handleValidationSubmit);

        // v2.8 Add
        continuationForm.addEventListener('submit', handleContinuationSubmit);
        bandPredictionForm.addEventListener('submit', handleBandPredictionSubmit);

        // v2.9 Add (v2.9.3 logic is handled here)
        swotForm.addEventListener('submit', handleSwotSubmit);

        // Select first tab by default
        switchTab('prediction');

        // v2.9.3: Version note
        console.log("IELTS Writing Assistant v2.9.3_en (UI Optimized v3.1) loaded.");

    </script>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const updateKeyStatus = async () => {
                const currentLang = window.i18n?.currentLang === 'zh' ? 'zh' : 'en';
                GeminiKeyManager.setLang(currentLang);
                await GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
            };

            // Initial load with slight delay
            setTimeout(updateKeyStatus, 500);

            // Hook into existing toggleLanguage
            const originalToggleLanguage = window.toggleLanguage;
            if (typeof originalToggleLanguage === 'function') {
                window.toggleLanguage = function () {
                    originalToggleLanguage();
                    setTimeout(updateKeyStatus, 100);
                };
            }
        });
    </script>
</body>

</html>