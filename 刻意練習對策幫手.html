<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing 刻意練習幫手 (AI 驅動版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        /* 繼承 RPG Hub 風格 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F0F1A 0%, #1A1A2E 50%, #0F0F1A 100%);
            min-height: 100vh;
            color: #E2E8F0;
        }

        .title-glow {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899, #F59E0B, #10B981, #6366F1);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleShimmer 5s linear infinite;
        }

        @keyframes titleShimmer {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 300% 50%;
            }
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #4B5563;
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.1);
        }

        .input-dark {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .input-dark:focus {
            border-color: #6366F1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Specific Styles */
        .xp-bar-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 3px;
        }

        .xp-bar {
            height: 8px;
            border-radius: 10px;
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899);
            width: 0%;
            transition: width 0.5s ease;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #94A3B8;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            margin-bottom: 20px;
        }

        .back-link:hover {
            color: #6366F1;
        }

        /* Markdown Styles for Result */
        #generation-result h2 {
            color: #818CF8;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        #generation-result h3 {
            color: #A5B4FC;
            font-size: 1.25em;
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        #generation-result strong {
            color: #E2E8F0;
            font-weight: bold;
        }

        #generation-result em {
            color: #94A3B8;
            font-style: italic;
        }

        #generation-result ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        #generation-result li {
            margin-bottom: 0.25em;
        }

        #generation-result p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
    </style>
    <!-- Dev-Scribe RPG Engine -->
    <script src="DevScribeRPG.js"></script>
</head>

<body class="p-4 md:p-8">
    <!-- Gemini API Key Status Container -->
    <div class="fixed top-4 right-4 z-50">
        <div class="glass-card flex items-center gap-4 p-4 text-left shadow-2xl">
            <div class="flex-1 flex items-center gap-3">
                <label class="block text-xs font-bold text-indigo-400 tracking-wider">GEMINI AI</label>
                <span id="gemini-key-status-container" class="text-xs"></span>
            </div>
            <div class="text-xs text-gray-500 hidden md:block border-l border-gray-700 pl-3">
                <i class="fas fa-shield-alt text-green-400"></i> Local Key
            </div>
        </div>
    </div>

    <!-- Language Toggle -->
    <div class="fixed bottom-6 right-6 z-50">
        <button id="langToggleBtn" type="button" onclick="toggleLanguage()"
            class="bg-slate-700/80 hover:bg-slate-600 backdrop-blur-md text-gray-300 text-sm py-2 px-4 rounded-full border border-slate-600 shadow-2xl transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
            </svg>
            <span id="langBtnText">EN</span>
        </button>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Back Link -->
        <a href="rpg-hub.html" class="back-link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span data-i18n="backToHome">返回主頁</span>
        </a>

        <header class="text-center mb-8">
            <h1 class="title-glow text-3xl md:text-5xl font-black mb-2 tracking-wider" data-i18n="pageTitle">IELTS
                刻意練習幫手</h1>
            <p class="text-gray-400 text-sm md:text-base" data-i18n="pageSubtitle">透過 AI 分析多篇寫作，提供精準的個人化刻意練習策略</p>
        </header>

        <!-- Player Status Card -->
        <section class="glass-card p-4 md:p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <!-- Rank Icon -->
                <div class="text-center min-w-[100px]">
                    <div id="rank-icon" class="text-5xl mb-2">🌱</div>
                    <div id="rank-title" class="text-sm font-bold text-indigo-400">新手</div>
                    <div class="text-xs text-gray-500">Lv.<span id="player-level">1</span></div>
                </div>

                <!-- Stats -->
                <div class="flex-1 w-full">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-xs text-gray-400" data-i18n="statusXP">經驗值</span>
                            <div class="text-xl font-bold text-yellow-400 font-['Orbitron']"><span
                                    id="total-xp">0</span> XP</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400" data-i18n="statusTokens">代幣</span>
                            <div class="text-xl font-bold text-amber-400 font-['Orbitron']"><span
                                    id="total-tokens">0</span></div>
                        </div>
                    </div>
                    <!-- XP Bar -->
                    <div class="xp-bar-container mb-2">
                        <div class="xp-bar" id="xp-bar"></div>
                    </div>
                    <div class="text-right text-xs text-gray-500">
                        <span data-i18n="nextLevel">下個等級</span>: <span id="xp-needed" class="text-indigo-400">100</span>
                        XP
                    </div>
                </div>

                <!-- Simple Stats -->
                <div class="hidden md:flex gap-4 text-center">
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <div class="text-lg font-bold text-purple-400" id="analysis-count">0</div>
                        <div class="text-xs text-gray-500" data-i18n="statAnalysis">已分析</div>
                    </div>
                </div>
            </div>
        </section>

        <main class="space-y-6">
            <!-- Step 1 -->
            <section class="glass-card p-6">
                <h2 class="text-xl font-bold text-indigo-400 mb-4 flex items-center gap-2">
                    <span
                        class="bg-indigo-500/20 text-indigo-400 w-8 h-8 rounded-full flex items-center justify-center text-sm border border-indigo-500/30">1</span>
                    <span data-i18n="step1Title">輸入寫作內容或上傳檔案</span>
                </h2>

                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-grow">
                        <textarea id="prompt-input" rows="6" class="input-dark w-full p-4 resize-none text-sm"
                            data-i18n-placeholder="inputPlaceholder" placeholder="在此輸入您的分析指令或直接貼上寫作內容..."></textarea>
                    </div>

                    <div class="flex-shrink-0 md:w-64 space-y-3">
                        <input type="file" id="file-input" accept=".md" class="hidden" multiple>
                        <label for="file-input"
                            class="block w-full text-center px-4 py-3 bg-slate-700 hover:bg-slate-600 text-gray-300 font-medium rounded-lg border border-slate-600 cursor-pointer transition text-sm">
                            <span data-i18n="uploadBtn">📂 上傳 Markdown (.md)</span>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="uploadNote">支援多選</div>
                        </label>

                        <button id="generate-btn" class="btn-primary w-full py-3 shadow-lg shadow-indigo-500/20"
                            disabled>
                            <span data-i18n="analyzeBtn">✨ 開始分析與建議</span>
                        </button>
                    </div>
                </div>

                <!-- File List Display -->
                <div id="file-list-display"
                    class="mt-4 p-3 bg-black/20 border border-white/5 rounded-lg text-gray-400 text-sm min-h-[40px] flex items-center">
                    <span data-i18n="noFile">未選擇檔案</span>
                </div>
            </section>

            <!-- Step 2 -->
            <section class="glass-card p-6 min-h-[300px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-indigo-400 flex items-center gap-2">
                        <span
                            class="bg-indigo-500/20 text-indigo-400 w-8 h-8 rounded-full flex items-center justify-center text-sm border border-indigo-500/30">2</span>
                        <span data-i18n="step2Title">AI 分析結果</span>
                    </h2>
                    <div class="flex gap-2">
                        <button id="copy-chart-btn" class="btn-secondary text-xs" disabled
                            data-i18n="copyBtn">複製結果</button>
                        <button id="export-md-btn" class="btn-secondary text-xs" disabled data-i18n="exportBtn">導出
                            .md</button>
                    </div>
                </div>

                <div id="generation-result"
                    class="bg-black/30 rounded-xl p-6 border border-white/5 text-gray-300 text-sm leading-relaxed min-h-[200px]">
                    <p class="text-gray-500 italic text-center py-10" data-i18n="waitingResult">分析結果將顯示在此處...</p>
                </div>
            </section>

            <!-- Hidden System Prompt -->
            <details class="glass-card p-4">
                <summary class="text-gray-500 cursor-pointer text-sm hover:text-indigo-400 transition"
                    data-i18n="showSystemPrompt">顯示系統提示詞 (System Prompt)</summary>
                <div class="mt-4">
                    <pre id="generation-logic"
                        class="bg-black/50 text-green-400/80 p-4 rounded-lg text-xs overflow-x-auto font-mono border border-white/5 whitespace-pre-wrap">
您是一位專精於雅思 (IELTS) 寫作教學和分析的 AI 導師。
您的任務是根據使用者上傳的一篇或多篇 Markdown 寫作文件，對其進行全面分析並提供客製化的「刻意練習」建議。
分析必須涵蓋以下四個關鍵方面：

1.  **任務達成/回應 (Task Achievement/Response)**：
    * 內容是否切題？
    * 論點是否充分展開？
    * 是否有遺漏任何關鍵要求？
2.  **連貫性與銜接 (Coherence and Cohesion)**：
    * 文章結構是否清晰？
    * 段落內和段落間的邏輯連接是否自然？
    * 銜接詞的使用是否多樣且正確？
3.  **詞彙資源 (Lexical Resource)**：
    * 詞彙是否豐富、精確且自然？
    * 是否有頻繁的重複或錯誤的同義詞替換？
    * 是否有高級詞彙或片語的適當運用？
4.  **語法廣度與準確度 (Grammatical Range and Accuracy)**：
    * 是否有使用多樣的句型？
    * 語法錯誤是否影響理解？

根據分析結果，請在文件結尾提供**三項**針對性的「刻意練習」建議，每項建議都必須具備明確的目標、方法和衡量標準。
請以繁體中文 (或英文，視使用者語言而定) 的 Markdown 格式輸出分析報告。
</pre>
                </div>
            </details>

        </main>

        <footer class="text-center py-8 mt-4 border-t border-gray-800 text-gray-500 text-sm">
            © 2026 Quest Empire - Deliberate Practice Helper
        </footer>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // I18n Data
        const translations = {
            zh: {
                backToHome: "返回主頁",
                pageTitle: "IELTS 刻意練習幫手",
                pageSubtitle: "透過 AI 分析多篇寫作，提供精準的個人化刻意練習策略",
                statusXP: "經驗值",
                statusTokens: "代幣",
                nextLevel: "下個等級",
                statAnalysis: "已分析",
                step1Title: "輸入寫作內容或上傳檔案",
                inputPlaceholder: "在此輸入您的分析指令或直接貼上寫作內容...",
                uploadBtn: "📂 上傳 Markdown (.md)",
                uploadNote: "支援多選 / 拖曳",
                analyzeBtn: "✨ 開始分析與建議",
                noFile: "未選擇檔案",
                step2Title: "AI 分析結果",
                copyBtn: "複製結果",
                exportBtn: "導出 .md",
                waitingResult: "AI 分析結果將顯示在此處...",
                showSystemPrompt: "顯示系統提示詞 (System Prompt)",
                loading: "正在讀取...",
                rpgRank1: "新手挑戰者",
                rpgRank2: "見習冒險家",
                rpgRank3: "探索者",
                rpgRank4: "挑戰達人",
                rpgRank5: "精英戰士",
                rpgRank6: "專家引導者",
                rpgRank7: "大師創造者",
                rpgRank8: "宗師煉金師",
                rpgRank9: "傳奇締造者",
                rpgRank10: "帝國領袖"
            },
            en: {
                backToHome: "Back to Home",
                pageTitle: "Deliberate Practice Helper",
                pageSubtitle: "AI-powered analysis for personalized IELTS writing strategy",
                statusXP: "XP",
                statusTokens: "Tokens",
                nextLevel: "Next Lvl",
                statAnalysis: "Analyses",
                step1Title: "Input Writing or Upload Files",
                inputPlaceholder: "Enter your analysis prompt or paste writing content here...",
                uploadBtn: "📂 Upload Markdown (.md)",
                uploadNote: "Multi-select supported",
                analyzeBtn: "✨ Start Analysis",
                noFile: "No file selected",
                step2Title: "AI Analysis Result",
                copyBtn: "Copy Result",
                exportBtn: "Export .md",
                waitingResult: "Analysis result will appear here...",
                showSystemPrompt: "Show System Prompt",
                loading: "Loading...",
                rpgRank1: "Novice Challenger",
                rpgRank2: "Apprentice Adventurer",
                rpgRank3: "Explorer",
                rpgRank4: "Challenge Expert",
                rpgRank5: "Elite Warrior",
                rpgRank6: "Specialist Guide",
                rpgRank7: "Master Creator",
                rpgRank8: "Grandmaster Alchemist",
                rpgRank9: "Legendary Architect",
                rpgRank10: "Empire Leader"
            }
        };

        window.currentLang = 'zh';

        window.toggleLanguage = function () {
            window.currentLang = window.currentLang === 'zh' ? 'en' : 'zh';
            updateLanguage();
            updatePlayerStatus();
        };

        function updateLanguage() {
            const t = translations[window.currentLang];
            document.getElementById('langBtnText').textContent = window.currentLang.toUpperCase();

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
        }

        // Initialize Logic
        window.addEventListener('load', () => {
            // Setup Firebase
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) userId = user.uid;
                    else userId = `anon-${crypto.randomUUID()}`;
                    isAuthReady = true;
                    checkGenerateButton();
                });
                if (initialAuthToken) signInWithCustomToken(auth, initialAuthToken).catch(console.error);
                else signInAnonymously(auth).catch(console.error);
            } else {
                isAuthReady = true;
                userId = 'local-user';
            }

            // Sync Player Status
            updatePlayerStatus();
            if (typeof DevScribeRPG !== 'undefined') {
                window.addEventListener('questempire:action', updatePlayerStatus);
            }

            // Set Initial Lang
            updateLanguage();
        });

        function updatePlayerStatus() {
            if (typeof DevScribeRPG !== 'undefined') {
                const state = DevScribeRPG.getState();
                const level = state.level || 1;

                document.getElementById('total-xp').textContent = state.totalXP;
                document.getElementById('total-tokens').textContent = state.tokens;
                document.getElementById('player-level').textContent = level;

                // Rank Title Localization
                const t = translations[window.currentLang];
                const rankKey = 'rpgRank' + level;
                document.getElementById('rank-title').textContent = t[rankKey] || "Novice";

                // Rank Icon
                const rankData = DevScribeRPG.RANKS.find(r => r.level === level);
                if (rankData) {
                    document.getElementById('rank-icon').textContent = rankData.icon;
                }

                // XP Bar
                const progressData = DevScribeRPG.getProgressToNextLevel(state.totalXP);
                document.getElementById('xp-bar').style.width = `${progressData.progress}%`;
                document.getElementById('xp-needed').textContent = progressData.xpNeeded;
            }
        }

        // --- Core Logic ---
        const promptInput = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const generateBtn = document.getElementById('generate-btn');
        const generationResult = document.getElementById('generation-result');
        const fileListDisplay = document.getElementById('file-list-display');
        let uploadedFileContent = "";
        let rawMarkdownResult = "";

        function checkGenerateButton() {
            const hasContent = promptInput.value.trim().length > 0 || uploadedFileContent.length > 0;
            generateBtn.disabled = !(hasContent && isAuthReady);
        }

        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length === 0) return;

            fileListDisplay.innerHTML = `<span class="animate-pulse">Loading ${files.length} files...</span>`;
            const contents = [];
            const names = [];

            for (const file of files) {
                if (file.name.endsWith('.md')) {
                    names.push(file.name);
                    const text = await file.text();
                    contents.push(text);
                }
            }

            if (contents.length > 0) {
                uploadedFileContent = contents.join('\n\n---\n\n');
                fileListDisplay.innerHTML = `<span class="text-green-400">✓ Loaded: ${names.join(', ')}</span>`;
                promptInput.disabled = true;
                promptInput.value = `[System] Loaded ${contents.length} file(s) for analysis.`;
            } else {
                fileListDisplay.innerHTML = `<span class="text-red-400">No valid .md files found</span>`;
            }
            checkGenerateButton();
        });

        promptInput.addEventListener('input', checkGenerateButton);

        generateBtn.addEventListener('click', async () => {
            const userQuery = uploadedFileContent ?
                "請分析以下多個 Markdown 檔案內容，針對主題、結構、一致性及寫作風格進行評估，並提供3個刻意練習建議:\n\n" + uploadedFileContent :
                promptInput.value;

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner inline-block mr-2 text-xl">◐</span> Analyzing...';
            generationResult.innerHTML = '<div class="text-center py-8"><div class="spinner text-indigo-500 text-4xl mb-4 inline-block">◐</div><p>AI is thinking...</p></div>';

            const systemPrompt = document.getElementById('generation-logic').textContent.trim();
            if (typeof GeminiKeyManager !== 'undefined') {
                await GeminiKeyManager.checkQuotaAndAlert();
            }
            // Use key from manager (returns '__USE_ADMIN_KEY__' or actual key)
            let apiKey = GeminiKeyManager.getActiveKey();
            if (apiKey === '__USE_ADMIN_KEY__') {
                // If it's a backend proxy setup, we might need a different URL or mechanism.
                // But for now, let's assume if it's Client-Side, the user MUST provide a key.
                // If not provided, we alert them.
                const userKey = localStorage.getItem('gemini_api_key');
                if (!userKey) {
                    alert(translations[window.currentLang].apiKeyPlaceholder || "Please set your Gemini API Key first.");
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = translations[window.currentLang].analyzeBtn;
                    generationResult.innerHTML = '';
                    return;
                }
                apiKey = userKey;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No result generated.";

                rawMarkdownResult = text;
                generationResult.innerHTML = parseMarkdown(text);

                document.getElementById('copy-chart-btn').disabled = false;
                document.getElementById('export-md-btn').disabled = false;

                // Award XP
                if (typeof DevScribeRPG !== 'undefined') {
                    DevScribeRPG.recordModuleAction('training', 'practice_analysis');
                    updatePlayerStatus();
                }

            } catch (err) {
                generationResult.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = window.currentLang === 'zh' ? '✨ 重新分析' : '✨ Re-analyze';
            }
        });

        // Utils
        function parseMarkdown(text) {
            return text
                .replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg text-indigo-300 mt-4">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl text-indigo-400 mt-6 border-b border-white/10 pb-2">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/\n/g, '<br>');
        }

        document.getElementById('copy-chart-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(rawMarkdownResult);
            const btn = document.getElementById('copy-chart-btn');
            const original = btn.textContent;
            btn.textContent = '✓ Copied';
            setTimeout(() => btn.textContent = original, 2000);
        });

        document.getElementById('export-md-btn').addEventListener('click', () => {
            const blob = new Blob([rawMarkdownResult], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analysis_report.md';
            a.click();
            URL.revokeObjectURL(url);
        });

    </script>

    <!-- Gemini Key Manager -->
    <script src="modules/gemini-key-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const updateKeyStatus = async () => {
                const currentLang = window.currentLang === 'en' ? 'en' : 'zh';
                GeminiKeyManager.setLang(currentLang);
                await GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
            };

            setTimeout(updateKeyStatus, 500);

            // Hook into existing toggleLanguage
            const originalToggleLang = window.toggleLanguage;
            if (typeof originalToggleLang === 'function') {
                window.toggleLanguage = function () {
                    originalToggleLang();
                    const newLang = window.currentLang === 'en' ? 'en' : 'zh';
                    GeminiKeyManager.setLang(newLang);
                    GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
                };
            }
        });
    </script>
</body>

</html>