<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing åˆ»æ„ç·´ç¿’å¹«æ‰‹ (AI é©…å‹•ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        /* ç¹¼æ‰¿ RPG Hub é¢¨æ ¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F0F1A 0%, #1A1A2E 50%, #0F0F1A 100%);
            min-height: 100vh;
            color: #E2E8F0;
        }

        .title-glow {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899, #F59E0B, #10B981, #6366F1);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleShimmer 5s linear infinite;
        }

        @keyframes titleShimmer {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 300% 50%;
            }
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #4B5563;
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.1);
        }

        .input-dark {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .input-dark:focus {
            border-color: #6366F1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Specific Styles */
        .xp-bar-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 3px;
        }

        .xp-bar {
            height: 8px;
            border-radius: 10px;
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899);
            width: 0%;
            transition: width 0.5s ease;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #94A3B8;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            margin-bottom: 20px;
        }

        .back-link:hover {
            color: #6366F1;
        }

        /* Markdown Styles for Result */
        #generation-result h2 {
            color: #818CF8;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        #generation-result h3 {
            color: #A5B4FC;
            font-size: 1.25em;
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        #generation-result strong {
            color: #E2E8F0;
            font-weight: bold;
        }

        #generation-result em {
            color: #94A3B8;
            font-style: italic;
        }

        #generation-result ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        #generation-result li {
            margin-bottom: 0.25em;
        }

        #generation-result p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
    </style>
    <!-- Dev-Scribe RPG Engine -->
    <script src="DevScribeRPG.js"></script>
</head>

<body class="p-4 md:p-8">

    <!-- Language Toggle -->
    <div class="fixed bottom-6 right-6 z-50">
        <button id="langToggleBtn" type="button" onclick="toggleLanguage()"
            class="bg-slate-700/80 hover:bg-slate-600 backdrop-blur-md text-gray-300 text-sm py-2 px-4 rounded-full border border-slate-600 shadow-2xl transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
            </svg>
            <span id="langBtnText">EN</span>
        </button>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Back Link -->
        <a href="rpg-hub.html" class="back-link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span data-i18n="backToHome">è¿”å›ä¸»é </span>
        </a>

        <header class="text-center mb-8">
            <h1 class="title-glow text-3xl md:text-5xl font-black mb-2 tracking-wider" data-i18n="pageTitle">IELTS
                åˆ»æ„ç·´ç¿’å¹«æ‰‹</h1>
            <p class="text-gray-400 text-sm md:text-base" data-i18n="pageSubtitle">é€é AI åˆ†æå¤šç¯‡å¯«ä½œï¼Œæä¾›ç²¾æº–çš„å€‹äººåŒ–åˆ»æ„ç·´ç¿’ç­–ç•¥</p>
        </header>

        <!-- Player Status Card -->
        <section class="glass-card p-4 md:p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <!-- Rank Icon -->
                <div class="text-center min-w-[100px]">
                    <div id="rank-icon" class="text-5xl mb-2">ğŸŒ±</div>
                    <div id="rank-title" class="text-sm font-bold text-indigo-400">æ–°æ‰‹</div>
                    <div class="text-xs text-gray-500">Lv.<span id="player-level">1</span></div>
                </div>

                <!-- Stats -->
                <div class="flex-1 w-full">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-xs text-gray-400" data-i18n="statusXP">ç¶“é©—å€¼</span>
                            <div class="text-xl font-bold text-yellow-400 font-['Orbitron']"><span
                                    id="total-xp">0</span> XP</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400" data-i18n="statusTokens">ä»£å¹£</span>
                            <div class="text-xl font-bold text-amber-400 font-['Orbitron']"><span
                                    id="total-tokens">0</span></div>
                        </div>
                    </div>
                    <!-- XP Bar -->
                    <div class="xp-bar-container mb-2">
                        <div class="xp-bar" id="xp-bar"></div>
                    </div>
                    <div class="text-right text-xs text-gray-500">
                        <span data-i18n="nextLevel">ä¸‹å€‹ç­‰ç´š</span>: <span id="xp-needed" class="text-indigo-400">100</span>
                        XP
                    </div>
                </div>

                <!-- Simple Stats -->
                <div class="hidden md:flex gap-4 text-center">
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <div class="text-lg font-bold text-purple-400" id="analysis-count">0</div>
                        <div class="text-xs text-gray-500" data-i18n="statAnalysis">å·²åˆ†æ</div>
                    </div>
                </div>
            </div>
        </section>

        <main class="space-y-6">
            <!-- Step 1 -->
            <section class="glass-card p-6">
                <h2 class="text-xl font-bold text-indigo-400 mb-4 flex items-center gap-2">
                    <span
                        class="bg-indigo-500/20 text-indigo-400 w-8 h-8 rounded-full flex items-center justify-center text-sm border border-indigo-500/30">1</span>
                    <span data-i18n="step1Title">è¼¸å…¥å¯«ä½œå…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ</span>
                </h2>

                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-grow">
                        <textarea id="prompt-input" rows="6" class="input-dark w-full p-4 resize-none text-sm"
                            data-i18n-placeholder="inputPlaceholder" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„åˆ†ææŒ‡ä»¤æˆ–ç›´æ¥è²¼ä¸Šå¯«ä½œå…§å®¹..."></textarea>
                    </div>

                    <div class="flex-shrink-0 md:w-64 space-y-3">
                        <input type="file" id="file-input" accept=".md" class="hidden" multiple>
                        <label for="file-input"
                            class="block w-full text-center px-4 py-3 bg-slate-700 hover:bg-slate-600 text-gray-300 font-medium rounded-lg border border-slate-600 cursor-pointer transition text-sm">
                            <span data-i18n="uploadBtn">ğŸ“‚ ä¸Šå‚³ Markdown (.md)</span>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="uploadNote">æ”¯æ´å¤šé¸</div>
                        </label>

                        <button id="generate-btn" class="btn-primary w-full py-3 shadow-lg shadow-indigo-500/20"
                            disabled>
                            <span data-i18n="analyzeBtn">âœ¨ é–‹å§‹åˆ†æèˆ‡å»ºè­°</span>
                        </button>
                    </div>
                </div>

                <!-- File List Display -->
                <div id="file-list-display"
                    class="mt-4 p-3 bg-black/20 border border-white/5 rounded-lg text-gray-400 text-sm min-h-[40px] flex items-center">
                    <span data-i18n="noFile">æœªé¸æ“‡æª”æ¡ˆ</span>
                </div>
            </section>

            <!-- Step 2 -->
            <section class="glass-card p-6 min-h-[300px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-indigo-400 flex items-center gap-2">
                        <span
                            class="bg-indigo-500/20 text-indigo-400 w-8 h-8 rounded-full flex items-center justify-center text-sm border border-indigo-500/30">2</span>
                        <span data-i18n="step2Title">AI åˆ†æçµæœ</span>
                    </h2>
                    <div class="flex gap-2">
                        <button id="copy-chart-btn" class="btn-secondary text-xs" disabled
                            data-i18n="copyBtn">è¤‡è£½çµæœ</button>
                        <button id="export-md-btn" class="btn-secondary text-xs" disabled data-i18n="exportBtn">å°å‡º
                            .md</button>
                    </div>
                </div>

                <div id="generation-result"
                    class="bg-black/30 rounded-xl p-6 border border-white/5 text-gray-300 text-sm leading-relaxed min-h-[200px]">
                    <p class="text-gray-500 italic text-center py-10" data-i18n="waitingResult">åˆ†æçµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•...</p>
                </div>
            </section>

            <!-- Hidden System Prompt -->
            <details class="glass-card p-4">
                <summary class="text-gray-500 cursor-pointer text-sm hover:text-indigo-400 transition"
                    data-i18n="showSystemPrompt">é¡¯ç¤ºç³»çµ±æç¤ºè© (System Prompt)</summary>
                <div class="mt-4">
                    <pre id="generation-logic"
                        class="bg-black/50 text-green-400/80 p-4 rounded-lg text-xs overflow-x-auto font-mono border border-white/5 whitespace-pre-wrap">
æ‚¨æ˜¯ä¸€ä½å°ˆç²¾æ–¼é›…æ€ (IELTS) å¯«ä½œæ•™å­¸å’Œåˆ†æçš„ AI å°å¸«ã€‚
æ‚¨çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…ä¸Šå‚³çš„ä¸€ç¯‡æˆ–å¤šç¯‡ Markdown å¯«ä½œæ–‡ä»¶ï¼Œå°å…¶é€²è¡Œå…¨é¢åˆ†æä¸¦æä¾›å®¢è£½åŒ–çš„ã€Œåˆ»æ„ç·´ç¿’ã€å»ºè­°ã€‚
åˆ†æå¿…é ˆæ¶µè“‹ä»¥ä¸‹å››å€‹é—œéµæ–¹é¢ï¼š

1.  **ä»»å‹™é”æˆ/å›æ‡‰ (Task Achievement/Response)**ï¼š
    * å…§å®¹æ˜¯å¦åˆ‡é¡Œï¼Ÿ
    * è«–é»æ˜¯å¦å……åˆ†å±•é–‹ï¼Ÿ
    * æ˜¯å¦æœ‰éºæ¼ä»»ä½•é—œéµè¦æ±‚ï¼Ÿ
2.  **é€£è²«æ€§èˆ‡éŠœæ¥ (Coherence and Cohesion)**ï¼š
    * æ–‡ç« çµæ§‹æ˜¯å¦æ¸…æ™°ï¼Ÿ
    * æ®µè½å…§å’Œæ®µè½é–“çš„é‚è¼¯é€£æ¥æ˜¯å¦è‡ªç„¶ï¼Ÿ
    * éŠœæ¥è©çš„ä½¿ç”¨æ˜¯å¦å¤šæ¨£ä¸”æ­£ç¢ºï¼Ÿ
3.  **è©å½™è³‡æº (Lexical Resource)**ï¼š
    * è©å½™æ˜¯å¦è±å¯Œã€ç²¾ç¢ºä¸”è‡ªç„¶ï¼Ÿ
    * æ˜¯å¦æœ‰é »ç¹çš„é‡è¤‡æˆ–éŒ¯èª¤çš„åŒç¾©è©æ›¿æ›ï¼Ÿ
    * æ˜¯å¦æœ‰é«˜ç´šè©å½™æˆ–ç‰‡èªçš„é©ç•¶é‹ç”¨ï¼Ÿ
4.  **èªæ³•å»£åº¦èˆ‡æº–ç¢ºåº¦ (Grammatical Range and Accuracy)**ï¼š
    * æ˜¯å¦æœ‰ä½¿ç”¨å¤šæ¨£çš„å¥å‹ï¼Ÿ
    * èªæ³•éŒ¯èª¤æ˜¯å¦å½±éŸ¿ç†è§£ï¼Ÿ

æ ¹æ“šåˆ†æçµæœï¼Œè«‹åœ¨æ–‡ä»¶çµå°¾æä¾›**ä¸‰é …**é‡å°æ€§çš„ã€Œåˆ»æ„ç·´ç¿’ã€å»ºè­°ï¼Œæ¯é …å»ºè­°éƒ½å¿…é ˆå…·å‚™æ˜ç¢ºçš„ç›®æ¨™ã€æ–¹æ³•å’Œè¡¡é‡æ¨™æº–ã€‚
è«‹ä»¥ç¹é«”ä¸­æ–‡ (æˆ–è‹±æ–‡ï¼Œè¦–ä½¿ç”¨è€…èªè¨€è€Œå®š) çš„ Markdown æ ¼å¼è¼¸å‡ºåˆ†æå ±å‘Šã€‚
</pre>
                </div>
            </details>

        </main>

        <footer class="text-center py-8 mt-4 border-t border-gray-800 text-gray-500 text-sm">
            Â© 2026 Quest Empire - Deliberate Practice Helper
        </footer>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // I18n Data
        const translations = {
            zh: {
                backToHome: "è¿”å›ä¸»é ",
                pageTitle: "IELTS åˆ»æ„ç·´ç¿’å¹«æ‰‹",
                pageSubtitle: "é€é AI åˆ†æå¤šç¯‡å¯«ä½œï¼Œæä¾›ç²¾æº–çš„å€‹äººåŒ–åˆ»æ„ç·´ç¿’ç­–ç•¥",
                statusXP: "ç¶“é©—å€¼",
                statusTokens: "ä»£å¹£",
                nextLevel: "ä¸‹å€‹ç­‰ç´š",
                statAnalysis: "å·²åˆ†æ",
                step1Title: "è¼¸å…¥å¯«ä½œå…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ",
                inputPlaceholder: "åœ¨æ­¤è¼¸å…¥æ‚¨çš„åˆ†ææŒ‡ä»¤æˆ–ç›´æ¥è²¼ä¸Šå¯«ä½œå…§å®¹...",
                uploadBtn: "ğŸ“‚ ä¸Šå‚³ Markdown (.md)",
                uploadNote: "æ”¯æ´å¤šé¸ / æ‹–æ›³",
                analyzeBtn: "âœ¨ é–‹å§‹åˆ†æèˆ‡å»ºè­°",
                noFile: "æœªé¸æ“‡æª”æ¡ˆ",
                step2Title: "AI åˆ†æçµæœ",
                copyBtn: "è¤‡è£½çµæœ",
                exportBtn: "å°å‡º .md",
                waitingResult: "AI åˆ†æçµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•...",
                showSystemPrompt: "é¡¯ç¤ºç³»çµ±æç¤ºè© (System Prompt)",
                loading: "æ­£åœ¨è®€å–...",
                rpgRank1: "æ–°æ‰‹æŒ‘æˆ°è€…",
                rpgRank2: "è¦‹ç¿’å†’éšªå®¶",
                rpgRank3: "æ¢ç´¢è€…",
                rpgRank4: "æŒ‘æˆ°é”äºº",
                rpgRank5: "ç²¾è‹±æˆ°å£«",
                rpgRank6: "å°ˆå®¶å¼•å°è€…",
                rpgRank7: "å¤§å¸«å‰µé€ è€…",
                rpgRank8: "å®—å¸«ç…‰é‡‘å¸«",
                rpgRank9: "å‚³å¥‡ç· é€ è€…",
                rpgRank10: "å¸åœ‹é ˜è¢–"
            },
            en: {
                backToHome: "Back to Home",
                pageTitle: "Deliberate Practice Helper",
                pageSubtitle: "AI-powered analysis for personalized IELTS writing strategy",
                statusXP: "XP",
                statusTokens: "Tokens",
                nextLevel: "Next Lvl",
                statAnalysis: "Analyses",
                step1Title: "Input Writing or Upload Files",
                inputPlaceholder: "Enter your analysis prompt or paste writing content here...",
                uploadBtn: "ğŸ“‚ Upload Markdown (.md)",
                uploadNote: "Multi-select supported",
                analyzeBtn: "âœ¨ Start Analysis",
                noFile: "No file selected",
                step2Title: "AI Analysis Result",
                copyBtn: "Copy Result",
                exportBtn: "Export .md",
                waitingResult: "Analysis result will appear here...",
                showSystemPrompt: "Show System Prompt",
                loading: "Loading...",
                rpgRank1: "Novice Challenger",
                rpgRank2: "Apprentice Adventurer",
                rpgRank3: "Explorer",
                rpgRank4: "Challenge Expert",
                rpgRank5: "Elite Warrior",
                rpgRank6: "Specialist Guide",
                rpgRank7: "Master Creator",
                rpgRank8: "Grandmaster Alchemist",
                rpgRank9: "Legendary Architect",
                rpgRank10: "Empire Leader"
            }
        };

        window.currentLang = 'zh';

        window.toggleLanguage = function () {
            window.currentLang = window.currentLang === 'zh' ? 'en' : 'zh';
            updateLanguage();
            updatePlayerStatus();
        };

        function updateLanguage() {
            const t = translations[window.currentLang];
            document.getElementById('langBtnText').textContent = window.currentLang.toUpperCase();

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
        }

        // Initialize Logic
        window.addEventListener('load', () => {
            // Setup Firebase
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) userId = user.uid;
                    else userId = `anon-${crypto.randomUUID()}`;
                    isAuthReady = true;
                    checkGenerateButton();
                });
                if (initialAuthToken) signInWithCustomToken(auth, initialAuthToken).catch(console.error);
                else signInAnonymously(auth).catch(console.error);
            } else {
                isAuthReady = true;
                userId = 'local-user';
            }

            // Sync Player Status
            updatePlayerStatus();

            // Set Initial Lang
            updateLanguage();
        });

        function updatePlayerStatus() {
            if (typeof DevScribeRPG !== 'undefined') {
                const state = DevScribeRPG.getState();
                const level = state.level || 1;

                document.getElementById('total-xp').textContent = state.totalXP;
                document.getElementById('total-tokens').textContent = state.tokens;
                document.getElementById('player-level').textContent = level;

                // Rank Title Localization
                const t = translations[window.currentLang];
                const rankKey = 'rpgRank' + level;
                document.getElementById('rank-title').textContent = t[rankKey] || "Novice";

                // Rank Icon
                const rankData = DevScribeRPG.RANKS.find(r => r.level === level);
                if (rankData) {
                    document.getElementById('rank-icon').textContent = rankData.icon;
                }

                // XP Bar
                const progressData = DevScribeRPG.getProgressToNextLevel(state.totalXP);
                document.getElementById('xp-bar').style.width = `${progressData.progress}%`;
                document.getElementById('xp-needed').textContent = progressData.xpNeeded;
            }
        }

        // --- Core Logic ---
        const promptInput = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const generateBtn = document.getElementById('generate-btn');
        const generationResult = document.getElementById('generation-result');
        const fileListDisplay = document.getElementById('file-list-display');
        let uploadedFileContent = "";
        let rawMarkdownResult = "";

        function checkGenerateButton() {
            const hasContent = promptInput.value.trim().length > 0 || uploadedFileContent.length > 0;
            generateBtn.disabled = !(hasContent && isAuthReady);
        }

        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length === 0) return;

            fileListDisplay.innerHTML = `<span class="animate-pulse">Loading ${files.length} files...</span>`;
            const contents = [];
            const names = [];

            for (const file of files) {
                if (file.name.endsWith('.md')) {
                    names.push(file.name);
                    const text = await file.text();
                    contents.push(text);
                }
            }

            if (contents.length > 0) {
                uploadedFileContent = contents.join('\n\n---\n\n');
                fileListDisplay.innerHTML = `<span class="text-green-400">âœ“ Loaded: ${names.join(', ')}</span>`;
                promptInput.disabled = true;
                promptInput.value = `[System] Loaded ${contents.length} file(s) for analysis.`;
            } else {
                fileListDisplay.innerHTML = `<span class="text-red-400">No valid .md files found</span>`;
            }
            checkGenerateButton();
        });

        promptInput.addEventListener('input', checkGenerateButton);

        generateBtn.addEventListener('click', async () => {
            const userQuery = uploadedFileContent ?
                "è«‹åˆ†æä»¥ä¸‹å¤šå€‹ Markdown æª”æ¡ˆå…§å®¹ï¼Œé‡å°ä¸»é¡Œã€çµæ§‹ã€ä¸€è‡´æ€§åŠå¯«ä½œé¢¨æ ¼é€²è¡Œè©•ä¼°ï¼Œä¸¦æä¾›3å€‹åˆ»æ„ç·´ç¿’å»ºè­°:\n\n" + uploadedFileContent :
                promptInput.value;

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner inline-block mr-2 text-xl">â—</span> Analyzing...';
            generationResult.innerHTML = '<div class="text-center py-8"><div class="spinner text-indigo-500 text-4xl mb-4 inline-block">â—</div><p>AI is thinking...</p></div>';

            const systemPrompt = document.getElementById('generation-logic').textContent.trim();
            const apiKey = "AIzaSyAG5d8eUpB3QcE5kTXt-2w0VJbOklMh__c"; // Note: In prod use backend proxy

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No result generated.";

                rawMarkdownResult = text;
                generationResult.innerHTML = parseMarkdown(text);

                document.getElementById('copy-chart-btn').disabled = false;
                document.getElementById('export-md-btn').disabled = false;

                // Award XP
                if (typeof DevScribeRPG !== 'undefined') {
                    DevScribeRPG.recordModuleAction('training', 'practice_analysis');
                    updatePlayerStatus();
                }

            } catch (err) {
                generationResult.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = window.currentLang === 'zh' ? 'âœ¨ é‡æ–°åˆ†æ' : 'âœ¨ Re-analyze';
            }
        });

        // Utils
        function parseMarkdown(text) {
            return text
                .replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg text-indigo-300 mt-4">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl text-indigo-400 mt-6 border-b border-white/10 pb-2">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/\n/g, '<br>');
        }

        document.getElementById('copy-chart-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(rawMarkdownResult);
            const btn = document.getElementById('copy-chart-btn');
            const original = btn.textContent;
            btn.textContent = 'âœ“ Copied';
            setTimeout(() => btn.textContent = original, 2000);
        });

        document.getElementById('export-md-btn').addEventListener('click', () => {
            const blob = new Blob([rawMarkdownResult], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analysis_report.md';
            a.click();
            URL.revokeObjectURL(url);
        });

    </script>
</body>

</html>