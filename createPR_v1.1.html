<!DOCTYPE html>
<html lang="zh-TW" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pull Request å¿«é€Ÿç”¢ç”Ÿå™¨ (v1.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1A202C, #2D3748);
            /* æ·±è—ç°è‰²æ¼¸è®ŠèƒŒæ™¯ */
            min-height: 100vh;
            padding: 2rem 1rem;
            transition: background-color 0.3s;
        }

        /* æ·±è‰²æ¨¡å¼å°ˆç”¨æ¨£å¼ */
        .dark .bg-card {
            background-color: #2D3748;
            /* å¡ç‰‡èƒŒæ™¯ */
            border: 1px solid #4A5568;
        }

        .dark .text-primary {
            color: #CBD5E0;
        }

        .dark input,
        .dark textarea {
            background-color: #4A5568;
            border-color: #6B7280;
            color: #E2E8F0;
        }

        .dark input:focus,
        .dark textarea:focus {
            border-color: #63B3ED;
            box-shadow: 0 0 0 1px #63B3ED;
        }

        .dark .input-label {
            color: #A0AEC0;
        }

        /* ä¸»è¦æŒ‰éˆ•æ¼¸è®Š */
        .btn-primary {
            background: linear-gradient(90deg, #667EEA, #6B46C1);
            /* è—ç´«æ¼¸è®Š */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #5A67D8, #553C9A);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:disabled {
            background: #4A5568;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Gemini AI æŒ‰éˆ• */
        .btn-ai {
            background-color: #38A169;
            /* ç¶ è‰² */
            transition: background-color 0.2s;
        }

        .btn-ai:hover {
            background-color: #2F855A;
        }

        /* Log è¼¸å‡ºå€å¡Š */
        #logContainer {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #1A202C;
            border: 1px solid #4A5568;
            font-family: monospace;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* æ‹–æ”¾å€åŸŸæ¨£å¼ */
        .drop-zone {
            border: 2px dashed #6B7280;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #63B3ED;
            background-color: #3A4452;
        }

        @media (min-width: 768px) {
            body {
                padding: 4rem 1rem;
            }

            body {
                padding: 4rem 1rem;
            }
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    </style>
    <!-- Dev-Scribe RPG Engine -->
    <script src="DevScribeRPG.js"></script>
</head>

<body class="text-primary">
    <div id="app" class="max-w-3xl mx-auto space-y-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-white text-center" data-i18n="pageTitle">
                ğŸ° å†’éšªè€…å…¬æœƒ - GitHub PR è‡ªå‹•åŒ–å·¥å…· (v1.1)
            </h1>
            <div class="text-center">
                <a href="rpg-hub.html"
                    class="inline-flex items-center mt-4 px-4 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600 rounded-full text-indigo-400 hover:text-indigo-300 text-sm transition"
                    data-i18n="backLink">
                    â† è¿”å› Quest Empire
                </a>
                <!-- Gemini Status -->
                <!-- API Key Status (Synced Style) -->
                <div class="glass-card flex items-center gap-4 max-w-lg mx-auto mt-4 px-6 py-4 text-left">
                    <div class="flex-1 flex items-center gap-3">
                        <label class="block text-xs font-bold text-indigo-400 tracking-wider">GEMINI AI</label>
                        <span id="gemini-key-status-container" class="text-sm"></span>
                    </div>
                    <div class="text-xs text-gray-500 hidden md:block">
                        <i class="fas fa-shield-alt text-green-400"></i> <span data-i18n="keySafe">Key åƒ…ä¿å­˜åœ¨æœ¬åœ°</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- èªè¨€åˆ‡æ›æŒ‰éˆ• (å›ºå®šä½ç½®ï¼Œé¿å…è“‹åˆ°å­—) -->
        <div class="fixed bottom-6 right-6 z-50">
            <button id="langToggleBtn" type="button" onclick="toggleLanguage()"
                class="bg-slate-700/80 hover:bg-slate-600 backdrop-blur-md text-gray-300 text-sm py-2 px-4 rounded-full border border-slate-600 shadow-2xl transition flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
                <span id="langBtnText">EN</span>
            </button>
        </div>

        <!-- RPG Status Card -->
        <div id="rpg-status-card" class="mb-6"></div>

        <!-- Ritual Gate Warning -->
        <div id="ritual-gate-warning"
            class="hidden bg-red-900/50 border border-red-600 text-red-300 p-4 rounded-xl mb-6">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸ”’</span>
                <div>
                    <div class="font-semibold" data-i18n="ritualIncomplete">æ ¡æº–å„€å¼æœªå®Œæˆ</div>
                    <p class="text-sm" data-i18n="ritualHint">åœ¨æäº¤ä»»å‹™ä¹‹å‰ï¼Œè«‹å…ˆå®Œæˆã€Œå‡ç´šå„€å¼ç¥­å£‡ã€çš„æ ¡æº–æµç¨‹ã€‚</p>
                </div>
                <a href="proof-writing-dashboard_v1.2.1.html"
                    class="ml-auto px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white text-sm font-medium transition-colors"
                    data-i18n="goToRitualAltar">
                    å‰å¾€å„€å¼ç¥­å£‡ â†’
                </a>
            </div>
        </div>

        <!-- èªè­‰èˆ‡å€‰åº« -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2" data-i18n="authAndRepo">èªè­‰èˆ‡ç›®æ¨™å€‰åº«</h2>
            <p class="text-sm text-yellow-400 p-2 rounded-lg bg-yellow-900/50" data-i18n="securityWarning">
                âš ï¸ **å®‰å…¨è­¦å‘Šï¼š** è«‹å‹¿åˆ†äº«æ‚¨çš„å€‹äººå­˜å–æ¬Šæ– (PAT)ã€‚æœ¬å·¥å…·åªåœ¨ç€è¦½å™¨æœ¬åœ°ä½¿ç”¨æ‚¨çš„æ¬Šæ–é€²è¡Œ API å‘¼å«ã€‚
            </p>
            <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <label for="token" class="input-label block mb-1" data-i18n="githubToken">GitHub PAT æ¬Šæ– (å¿…éœ€)</label>
                    <input type="password" id="token" value="" data-i18n-placeholder="placeholderToken"
                        placeholder="ghp_..." class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <div class="flex-1">
                    <label for="repoFullName" class="input-label block mb-1" data-i18n="repoName">å€‰åº«åç¨±
                        (Owner/Repo)</label>
                    <input type="text" id="repoFullName" value="charliejimi/IELTSWritingTask1"
                        data-i18n-placeholder="placeholderRepo" placeholder="e.g. owner/repository-name"
                        class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
            </div>
        </div>

        <!-- åˆ†æ”¯è³‡è¨Š -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2" data-i18n="branchSettings">åˆ†æ”¯è¨­å®š</h2>
            <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <label for="baseBranch" class="input-label block mb-1" data-i18n="baseBranch">ç›®æ¨™åˆ†æ”¯ (Base
                        Branch)</label>
                    <input type="text" id="baseBranch" value="master" data-i18n-placeholder="placeholderBaseBranch"
                        placeholder="e.g. main" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <div class="flex-1">
                    <label for="newBranch" class="input-label block mb-1" data-i18n="sourceBranch">ä¾†æºåˆ†æ”¯ (Source
                        Branch)</label>
                    <input type="text" id="newBranch" value="modifications"
                        data-i18n-placeholder="placeholderSourceBranch" placeholder="e.g. feat/add-new-feature"
                        class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
            </div>
            <div class="flex items-center pt-2">
                <input type="checkbox" id="deleteBranch" checked
                    class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                <label for="deleteBranch" class="input-label" data-i18n="deleteBranchAfterMerge">æˆåŠŸåˆä½µå¾Œåˆªé™¤ä¾†æºåˆ†æ”¯
                    (å¯é¸)</label>
            </div>
        </div>

        <!-- æª”æ¡ˆè®Šæ›´ (å‹•æ…‹å€å¡Š) -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                <h2 class="text-xl font-semibold" data-i18n="fileChanges">æª”æ¡ˆè®Šæ›´ (Commit)</h2>
                <button onclick="addFileBlock()"
                    class="text-sm font-medium px-3 py-1 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition"
                    data-i18n="addAnotherFile">+ æ–°å¢å¦ä¸€å€‹æª”æ¡ˆ</button>
            </div>
            <div id="filesContainer" class="space-y-6">
                <!-- é è¨­æª”æ¡ˆå€å¡Šå°‡ç”± JS è¼‰å…¥ -->
            </div>
        </div>

        <!-- Pull Request è³‡è¨Š -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2" data-i18n="prInfo">Pull Request è³‡è¨Š</h2>

            <div class="flex justify-between items-end">
                <div class="flex-1 pr-4">
                    <label for="prTitle" class="input-label block mb-1" data-i18n="prTitle">PR æ¨™é¡Œ</label>
                    <input type="text" id="prTitle" data-i18n-placeholder="placeholderPrTitle"
                        placeholder="e.g. Fix: ä¿®æ­£ç™»å…¥é‚è¼¯" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <button id="btnGenerateTitle" onclick="generatePRTitle()"
                    class="btn-ai text-white text-sm font-medium px-4 py-2 rounded-lg whitespace-nowrap"
                    data-i18n="generatePRTitle">
                    âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æ¨™é¡Œ
                </button>
            </div>

            <div class="flex justify-between items-end">
                <div class="flex-1 pr-4">
                    <label for="prBody" class="input-label block mb-1" data-i18n="prDesc">PR æè¿° (æ”¯æ´ Markdown)</label>
                    <textarea id="prBody" rows="5" data-i18n-placeholder="placeholderPrDesc" placeholder="è©³ç´°æè¿°è®Šæ›´å…§å®¹..."
                        class="w-full p-2 rounded-lg border focus:outline-none"></textarea>
                </div>
                <button id="btnGenerateDesc" onclick="generatePRDescription()"
                    class="btn-ai text-white text-sm font-medium px-4 py-2 rounded-lg whitespace-nowrap"
                    data-i18n="generatePRDesc">
                    âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æè¿°
                </button>
            </div>

            <div>
                <label for="issueNumber" class="input-label block mb-1" data-i18n="linkedIssue">é€£å‹• Issue è™Ÿç¢¼ (å¯é¸)</label>
                <input type="text" id="issueNumber" data-i18n-placeholder="placeholderIssue"
                    placeholder="e.g. 123 (å°‡è‡ªå‹•åŠ å…¥ Closes #123)" class="w-full p-2 rounded-lg border focus:outline-none">
            </div>

            <div class="pt-4">
                <button id="mainActionButton" onclick="createPullRequest()"
                    class="btn-primary text-white w-full py-3 rounded-lg text-lg font-semibold flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M7 21v-4a2 2 0 1 1 4 0v4" />
                        <path d="M17 21v-8a2 2 0 1 1 4 0v8" />
                        <path
                            d="M7 3h2v2H7zM15 3h2v2h-2zM4 14V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8M10 17v-4a2 2 0 1 1 4 0v4" />
                    </svg>
                    <span data-i18n="mainActionBtn">å»ºç«‹ã€è‡ªå‹•åˆä½µä¸¦æ¸…ç† Pull Request (7 æ­¥é©Ÿ)</span>
                </button>
            </div>
        </div>

        <!-- æ—¥èªŒèˆ‡çµæœè¼¸å‡º -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2" data-i18n="logAndResults">æ—¥èªŒèˆ‡åŸ·è¡Œçµæœ</h2>
            <div id="logContainer" class="rounded-lg">
                <!-- Log messages here -->
            </div>
            <div id="resultBox" class="p-4 rounded-lg hidden">
                <!-- Final result/link here -->
            </div>
        </div>
    </div>

    <script>
        // --- Internationalization (i18n) System ---
        const i18n = {
            currentLang: 'zh',
            translations: {
                zh: {
                    // Page Title
                    pageTitle: 'ğŸ° å†’éšªè€…å…¬æœƒ - GitHub PR è‡ªå‹•åŒ–å·¥å…· (v1.1)',

                    // Ritual Gate
                    ritualIncomplete: 'æ ¡æº–å„€å¼æœªå®Œæˆ',
                    ritualHint: 'åœ¨æäº¤ä»»å‹™ä¹‹å‰ï¼Œè«‹å…ˆå®Œæˆã€Œå‡ç´šå„€å¼ç¥­å£‡ã€çš„æ ¡æº–æµç¨‹ã€‚',
                    goToRitualAltar: 'å‰å¾€å„€å¼ç¥­å£‡ â†’',

                    // Auth & Repository
                    authAndRepo: 'èªè­‰èˆ‡ç›®æ¨™å€‰åº«',
                    securityWarning: 'âš ï¸ **å®‰å…¨è­¦å‘Šï¼š** è«‹å‹¿åˆ†äº«æ‚¨çš„å€‹äººå­˜å–æ¬Šæ– (PAT)ã€‚æœ¬å·¥å…·åªåœ¨ç€è¦½å™¨æœ¬åœ°ä½¿ç”¨æ‚¨çš„æ¬Šæ–é€²è¡Œ API å‘¼å«ã€‚',
                    githubToken: 'GitHub PAT æ¬Šæ– (å¿…éœ€)',
                    repoName: 'å€‰åº«åç¨± (Owner/Repo)',

                    // Branch Settings
                    branchSettings: 'åˆ†æ”¯è¨­å®š',
                    baseBranch: 'ç›®æ¨™åˆ†æ”¯ (Base Branch)',
                    sourceBranch: 'ä¾†æºåˆ†æ”¯ (Source Branch)',
                    deleteBranchAfterMerge: 'æˆåŠŸåˆä½µå¾Œåˆªé™¤ä¾†æºåˆ†æ”¯ (å¯é¸)',

                    // File Changes
                    fileChanges: 'æª”æ¡ˆè®Šæ›´ (Commit)',
                    addAnotherFile: '+ æ–°å¢å¦ä¸€å€‹æª”æ¡ˆ',
                    fileBlockTitle: 'æª”æ¡ˆ #{index} è®Šæ›´',
                    deleteBlock: 'åˆªé™¤',
                    dropZoneHint: 'å°‡æª”æ¡ˆæ‹–æ”¾åˆ°æ­¤è™•ï¼Œè‡ªå‹•å¡«å…¥è·¯å¾‘èˆ‡å…§å®¹',
                    filePath: 'æª”æ¡ˆè·¯å¾‘ (e.g. src/file.js)',
                    commitMessage: 'æäº¤è¨Šæ¯ (Commit Message)',
                    fileContent: 'æª”æ¡ˆå…§å®¹ (UTF-8)',

                    // PR Info
                    prInfo: 'Pull Request è³‡è¨Š',
                    prTitle: 'PR æ¨™é¡Œ',
                    prDesc: 'PR æè¿° (æ”¯æ´ Markdown)',
                    generatePRTitle: 'âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æ¨™é¡Œ',
                    generatePRDesc: 'âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æè¿°',
                    linkedIssue: 'é€£å‹• Issue è™Ÿç¢¼ (å¯é¸)',
                    mainActionBtn: 'å»ºç«‹ã€è‡ªå‹•åˆä½µä¸¦æ¸…ç† Pull Request (7 æ­¥é©Ÿ)',

                    // Log
                    logAndResults: 'æ—¥èªŒèˆ‡åŸ·è¡Œçµæœ',

                    // Log Messages
                    logInfo: '[INFO]',
                    logSuccess: '[SUCCESS]',
                    logError: '[ERROR]',
                    logWarn: '[WARN]',

                    // Error Messages
                    errorMissingFields: 'éŒ¯èª¤ï¼šPAT æ¬Šæ–ã€å€‰åº«åç¨±ã€ä¾†æºåˆ†æ”¯ã€ç›®æ¨™åˆ†æ”¯å’Œ PR æ¨™é¡Œéƒ½æ˜¯å¿…éœ€çš„ã€‚è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½ã€‚',
                    errorNoFiles: 'éŒ¯èª¤ï¼šè‡³å°‘éœ€è¦ä¸€å€‹æª”æ¡ˆè®Šæ›´ã€‚',
                    errorFileMissing: 'éŒ¯èª¤ï¼šæª”æ¡ˆ #{index} çš„è·¯å¾‘ã€å…§å®¹å’Œæäº¤è¨Šæ¯éƒ½æ˜¯å¿…éœ€çš„ã€‚',

                    // Action Messages
                    callingGeminiTitle: 'æ­£åœ¨å‘¼å« Gemini AI ç”¢ç”Ÿ PR æ¨™é¡Œ...',
                    callingGeminiDesc: 'æ­£åœ¨å‘¼å« Gemini AI ç”¢ç”Ÿ PR æè¿°...',
                    titleGenerated: 'PR æ¨™é¡Œå·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ã€‚',
                    descGenerated: 'PR æè¿°å·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ã€‚',
                    needCommitFirst: 'è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å€‹æª”æ¡ˆçš„ã€Œæäº¤è¨Šæ¯ (Commit Message)ã€',
                    generateTitleFailed: 'ç”¢ç”Ÿ PR æ¨™é¡Œå¤±æ•—: {error}',
                    generateDescFailed: 'ç”¢ç”Ÿ PR æè¿°å¤±æ•—: {error}',
                    fileReadSuccess: 'æª”æ¡ˆ {name} (å¤§å°: {size} bytes) å…§å®¹å·²è®€å–ä¸¦å¡«å…¥ã€‚',
                    fileReadFailed: 'è®€å–æª”æ¡ˆ {name} å¤±æ•—: {error}',

                    // Step Messages
                    step1: '[1/7] æ­£åœ¨å–å¾—åŸºç¤åˆ†æ”¯ ({branch}) çš„æœ€æ–° SHA...',
                    step1Success: 'åŸºç¤ SHA å–å¾—æˆåŠŸ: {sha}',
                    step2: '[2/7] æ­£åœ¨å˜—è©¦å»ºç«‹æ–°åˆ†æ”¯ ({branch})...',
                    step2Exists: 'åˆ†æ”¯ refs/heads/{branch} å·²å­˜åœ¨ã€‚è·³éå»ºç«‹æ­¥é©Ÿï¼Œç¹¼çºŒä½¿ç”¨ç¾æœ‰åˆ†æ”¯ã€‚',
                    step2Success: 'æ–°åˆ†æ”¯ refs/heads/{branch} å»ºç«‹æˆåŠŸã€‚',
                    step3: '[3/7] æ­£åœ¨æäº¤ {count} å€‹æª”æ¡ˆè®Šæ›´...',
                    step3Processing: '   > è™•ç†æª”æ¡ˆ: {path}',
                    step3FileExists: '   > æª”æ¡ˆå·²å­˜åœ¨ (SHA: {sha})ï¼Œå°‡åŸ·è¡Œ **æ›´æ–°** æ“ä½œã€‚',
                    step3FileNew: '   > æª”æ¡ˆä¸å­˜åœ¨ï¼Œå°‡åŸ·è¡Œ **æ–°å¢** æ“ä½œã€‚',
                    step3FileSuccess: '   > æª”æ¡ˆ {path} æäº¤æˆåŠŸã€‚',
                    step4: '[4/7] æ­£åœ¨å»ºç«‹ Pull Request...',
                    step4IssueLink: '   > å·²è‡ªå‹•åŠ å…¥é€£å‹• Issue é—œéµå­—: {link}',
                    step4Success: 'PR å»ºç«‹æˆåŠŸï¼ç·¨è™Ÿ #{number}ï¼Œé€£çµ: {url}',
                    step5: '[5/7] æ­£åœ¨è¼ªè©¢ PR ç‹€æ…‹ï¼Œç­‰å¾…å¯åˆä½µ... (æœ€å¤š 10 æ¬¡)',
                    step5Mergeable: 'PR å·²æº–å‚™å¥½åˆä½µ (Mergeable: true)ã€‚',
                    step5NotMergeable: 'PR é¡¯ç¤ºä¸å¯åˆä½µ (Mergeable: false)ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•ä¿®å¾©è¡çªæˆ–ç­‰å¾… CIã€‚ä¸­æ­¢è‡ªå‹•åˆä½µã€‚',
                    step5Computing: 'PR ç‹€æ…‹ä»åœ¨è¨ˆç®—ä¸­... (ç¬¬ {attempt}/{max} æ¬¡å˜—è©¦)',
                    step5MaxPolls: 'é”åˆ°æœ€å¤§è¼ªè©¢æ¬¡æ•¸ï¼ŒPR ä»æœªé¡¯ç¤ºç‚ºå¯åˆä½µã€‚ä¸­æ­¢è‡ªå‹•åˆä½µï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ PRã€‚',
                    step6: '[6/7] æ­£åœ¨åŸ·è¡Œè‡ªå‹• **Squash åˆä½µ**...',
                    step6Success: 'PR åˆä½µæˆåŠŸï¼Commit SHA: {sha}',
                    step7: '[7/7] æ­£åœ¨å˜—è©¦åˆªé™¤ä¾†æºåˆ†æ”¯ ({branch})...',
                    step7Success: 'ä¾†æºåˆ†æ”¯ {branch} åˆªé™¤æˆåŠŸã€‚',
                    step7Protected: 'åˆªé™¤åˆ†æ”¯å¤±æ•— (422 Unprocessable Entity)ï¼Œå¯èƒ½æ˜¯åˆ†æ”¯å·²è¢«é–å®šæˆ–ä¿è­·ã€‚',
                    step7NotFound: 'ä¾†æºåˆ†æ”¯ {branch} å·²ç¶“ä¸å­˜åœ¨ã€‚',
                    step7Failed: 'åˆªé™¤ä¾†æºåˆ†æ”¯å¤±æ•—ã€‚ç‹€æ…‹: {status} {statusText}',
                    step7Skip: '[7/7] ç•¥éåˆªé™¤ä¾†æºåˆ†æ”¯æ­¥é©Ÿ (ä¾è¨­å®š)ã€‚',

                    // Final Messages
                    flowComplete: 'ğŸ‰ PR è‡ªå‹•åŒ–æµç¨‹å·²æˆåŠŸå®Œæˆï¼',
                    allChangesMerged: 'æ‰€æœ‰è®Šæ›´å·²åˆä½µåˆ° {branch}ã€‚',
                    viewPR: 'é»æ­¤æŸ¥çœ‹ Pull Request #{number}',
                    rpgXpEarned: 'ğŸ® RPG: ç²å¾— +{xp} XPï¼({combo}x é€£æ“Š)',
                    flowFailed: 'ğŸš¨ æµç¨‹å¤±æ•—ï¼š',
                    checkPR: 'è«‹æª¢æŸ¥æ¬Šæ–ã€å€‰åº«åç¨±ã€åˆ†æ”¯åç¨±æˆ– PR #{number} çš„ç‹€æ…‹ã€‚',

                    // API Retry
                    apiCallFailed: 'API å‘¼å«å¤±æ•— ({status} {statusText})ï¼Œå°‡åœ¨ {delay} ç§’å¾Œé‡è©¦...',
                    networkError: 'ç¶²è·¯éŒ¯èª¤: {error}ï¼Œå°‡åœ¨ {delay} ç§’å¾Œé‡è©¦...',
                    geminiRetry: 'Gemini API å‘¼å«å¤±æ•—ï¼Œå°‡åœ¨ {delay} ç§’å¾Œé‡è©¦...',
                    geminiNetworkError: 'Gemini API ç¶²è·¯éŒ¯èª¤: {error}ï¼Œå°‡åœ¨ {delay} ç§’å¾Œé‡è©¦...',

                    // Placeholders
                    placeholderToken: 'ghp_...',
                    placeholderRepo: 'ä¾‹å¦‚ï¼šowner/repository-name',
                    placeholderBaseBranch: 'ä¾‹å¦‚ï¼šmain',
                    placeholderSourceBranch: 'ä¾‹å¦‚ï¼šfeat/add-new-feature',
                    placeholderPrTitle: 'ä¾‹å¦‚ï¼šFix: ä¿®æ­£ç™»å…¥é‚è¼¯',
                    placeholderPrDesc: 'è©³ç´°æè¿°è®Šæ›´å…§å®¹...',
                    placeholderIssue: 'ä¾‹å¦‚ï¼š123 (å°‡è‡ªå‹•åŠ å…¥ Closes #123)',
                    placeholderFilePath: 'æª”æ¡ˆåœ¨å€‰åº«ä¸­çš„å®Œæ•´è·¯å¾‘',
                    placeholderCommitMsg: 'ä¾‹å¦‚ï¼šfeat: å¢åŠ æ–°çš„è¨­å®šæª”',
                    placeholderFileContent: 'æª”æ¡ˆçš„å®Œæ•´å…§å®¹ï¼ˆæ”¯æ´ UTF-8 ç·¨ç¢¼ï¼‰',

                    // Default Values for first file block
                    defaultCommitMsg: 'docs: æ›´æ–°èªªæ˜æ–‡ä»¶',
                    defaultFileContent: '## GitHub PR è‡ªå‹•ç”¢ç”Ÿå™¨\n\né€™ä»½æ–‡ä»¶ç”±è‡ªå‹•åŒ–å·¥å…·ç”Ÿæˆã€‚',

                    // RPG Ranks (DevScribeRPG) - èˆ‡ä¸»ç•«é¢ä¸€è‡´
                    rpgRank1: 'æ–°æ‰‹æŒ‘æˆ°è€…',
                    rpgRank2: 'è¦‹ç¿’å†’éšªå®¶',
                    rpgRank3: 'æ¢ç´¢è€…',
                    rpgRank4: 'æŒ‘æˆ°é”äºº',
                    rpgRank5: 'ç²¾è‹±æˆ°å£«',
                    rpgRank6: 'å°ˆå®¶å¼•å°è€…',
                    rpgRank7: 'å¤§å¸«å‰µé€ è€…',
                    rpgRank8: 'å®—å¸«ç…‰é‡‘å¸«',
                    rpgRank9: 'å‚³å¥‡ç· é€ è€…',
                    rpgRank10: 'å¸åœ‹é ˜è¢–',
                    rpgXpNeeded: 'é‚„éœ€ {xp} XP å‡ç´š',
                    backLink: 'â† è¿”å› Quest Empire'
                },
                en: {
                    // Page Title
                    pageTitle: 'ğŸ° Adventurer Guild - GitHub PR Automation Tool (v1.1)',

                    // Ritual Gate
                    ritualIncomplete: 'Calibration Ritual Incomplete',
                    ritualHint: 'Please complete the "Upgrade Ritual Altar" calibration process before submitting tasks.',
                    goToRitualAltar: 'Go to Ritual Altar â†’',

                    // Auth & Repository
                    authAndRepo: 'Authentication & Target Repository',
                    securityWarning: 'âš ï¸ **Security Warning:** Do not share your Personal Access Token (PAT). This tool only uses your token locally in the browser for API calls.',
                    githubToken: 'GitHub PAT Token (Required)',
                    repoName: 'Repository Name (Owner/Repo)',

                    // Branch Settings
                    branchSettings: 'Branch Settings',
                    baseBranch: 'Target Branch (Base Branch)',
                    sourceBranch: 'Source Branch',
                    deleteBranchAfterMerge: 'Delete source branch after merge (Optional)',

                    // File Changes
                    fileChanges: 'File Changes (Commit)',
                    addAnotherFile: '+ Add Another File',
                    fileBlockTitle: 'File #{index} Changes',
                    deleteBlock: 'Delete',
                    dropZoneHint: 'Drop file here to auto-fill path and content',
                    filePath: 'File Path (e.g. src/file.js)',
                    commitMessage: 'Commit Message',
                    fileContent: 'File Content (UTF-8)',

                    // PR Info
                    prInfo: 'Pull Request Information',
                    prTitle: 'PR Title',
                    prDesc: 'PR Description (Markdown supported)',
                    generatePRTitle: 'âœ¨ Generate PR Title',
                    generatePRDesc: 'âœ¨ Generate PR Description',
                    linkedIssue: 'Linked Issue Number (Optional)',
                    mainActionBtn: 'Create, Auto-Merge & Cleanup Pull Request (7 Steps)',

                    // Log
                    logAndResults: 'Logs & Execution Results',

                    // Log Messages
                    logInfo: '[INFO]',
                    logSuccess: '[SUCCESS]',
                    logError: '[ERROR]',
                    logWarn: '[WARN]',

                    // Error Messages
                    errorMissingFields: 'Error: PAT Token, Repository Name, Source Branch, Base Branch and PR Title are all required. Please check all fields.',
                    errorNoFiles: 'Error: At least one file change is required.',
                    errorFileMissing: 'Error: File #{index} path, content and commit message are all required.',

                    // Action Messages
                    callingGeminiTitle: 'Calling Gemini AI to generate PR title...',
                    callingGeminiDesc: 'Calling Gemini AI to generate PR description...',
                    titleGenerated: 'PR title generated and filled successfully.',
                    descGenerated: 'PR description generated and filled successfully.',
                    needCommitFirst: 'Please enter at least one "Commit Message" first',
                    generateTitleFailed: 'Failed to generate PR title: {error}',
                    generateDescFailed: 'Failed to generate PR description: {error}',
                    fileReadSuccess: 'File {name} (size: {size} bytes) content read and filled.',
                    fileReadFailed: 'Failed to read file {name}: {error}',

                    // Step Messages
                    step1: '[1/7] Getting latest SHA from base branch ({branch})...',
                    step1Success: 'Base SHA retrieved: {sha}',
                    step2: '[2/7] Attempting to create new branch ({branch})...',
                    step2Exists: 'Branch refs/heads/{branch} already exists. Skipping creation, using existing branch.',
                    step2Success: 'New branch refs/heads/{branch} created successfully.',
                    step3: '[3/7] Committing {count} file changes...',
                    step3Processing: '   > Processing file: {path}',
                    step3FileExists: '   > File exists (SHA: {sha}), will perform **update** operation.',
                    step3FileNew: '   > File does not exist, will perform **create** operation.',
                    step3FileSuccess: '   > File {path} committed successfully.',
                    step4: '[4/7] Creating Pull Request...',
                    step4IssueLink: '   > Auto-added issue link keyword: {link}',
                    step4Success: 'PR created! Number #{number}, Link: {url}',
                    step5: '[5/7] Polling PR status, waiting for mergeable... (max 10 times)',
                    step5Mergeable: 'PR is ready to merge (Mergeable: true).',
                    step5NotMergeable: 'PR shows not mergeable (Mergeable: false), may need manual conflict resolution or wait for CI. Aborting auto-merge.',
                    step5Computing: 'PR status still computing... (attempt {attempt}/{max})',
                    step5MaxPolls: 'Max polling reached, PR still not mergeable. Aborting auto-merge, please check PR manually.',
                    step6: '[6/7] Performing auto **Squash Merge**...',
                    step6Success: 'PR merged successfully! Commit SHA: {sha}',
                    step7: '[7/7] Attempting to delete source branch ({branch})...',
                    step7Success: 'Source branch {branch} deleted.',
                    step7Protected: 'Delete branch failed (422 Unprocessable Entity), branch may be locked or protected.',
                    step7NotFound: 'Source branch {branch} no longer exists.',
                    step7Failed: 'Failed to delete source branch. Status: {status} {statusText}',
                    step7Skip: '[7/7] Skipping source branch deletion (per settings).',

                    // Final Messages
                    flowComplete: 'ğŸ‰ PR automation flow completed successfully!',
                    allChangesMerged: 'All changes merged to {branch}.',
                    viewPR: 'Click to view Pull Request #{number}',
                    rpgXpEarned: 'ğŸ® RPG: Earned +{xp} XP! ({combo}x combo)',
                    flowFailed: 'ğŸš¨ Flow Failed:',
                    checkPR: 'Please check token, repository name, branch name or PR #{number} status.',

                    // API Retry
                    apiCallFailed: 'API call failed ({status} {statusText}), retrying in {delay} seconds...',
                    networkError: 'Network error: {error}, retrying in {delay} seconds...',
                    geminiRetry: 'Gemini API call failed, retrying in {delay} seconds...',
                    geminiNetworkError: 'Gemini API network error: {error}, retrying in {delay} seconds...',
                    fileReadSuccess: 'File {name} (Size: {size} bytes) read and filled.',
                    fileReadFailed: 'Failed to read file {name}: {error}',

                    // Placeholders
                    placeholderToken: 'ghp_...',
                    placeholderRepo: 'e.g., owner/repository-name',
                    placeholderBaseBranch: 'e.g., main',
                    placeholderSourceBranch: 'e.g., feat/add-new-feature',
                    placeholderPrTitle: 'e.g., Fix: Update login logic',
                    placeholderPrDesc: 'Describe your changes in detail...',
                    placeholderIssue: 'e.g., 123 (will add Closes #123)',
                    placeholderFilePath: 'Full path in repository',
                    placeholderCommitMsg: 'e.g., feat: add new config file',
                    placeholderFileContent: 'Complete file content (UTF-8 encoded)',

                    // Default Values for first file block
                    defaultCommitMsg: 'docs: update documentation',
                    defaultFileContent: '## GitHub PR Generator\n\nThis document was generated by the automation tool.',

                    // RPG Ranks (DevScribeRPG) - Consistent with main screen
                    rpgRank1: 'Novice Challenger',
                    rpgRank2: 'Apprentice Adventurer',
                    rpgRank3: 'Explorer',
                    rpgRank4: 'Challenge Master',
                    rpgRank5: 'Elite Warrior',
                    rpgRank6: 'Expert Guide',
                    rpgRank7: 'Master Creator',
                    rpgRank8: 'Grandmaster Alchemist',
                    rpgRank9: 'Legendary Founder',
                    rpgRank10: 'Empire Leader',
                    rpgXpNeeded: 'Need {xp} XP to level up',
                    backLink: 'â† Back to Quest Empire'
                }
            },

            t: function (key, params = {}) {
                let text = this.translations[this.currentLang][key] || key;
                // Replace placeholders like {name} with actual values
                for (const [k, v] of Object.entries(params)) {
                    text = text.replace(new RegExp(`\\{${k}\\}`, 'g'), v);
                }
                return text;
            },

            setLanguage: function (lang) {
                this.currentLang = lang;
                // èˆ‡ä¸»ç•«é¢ä½¿ç”¨ç›¸åŒçš„ localStorage key ä»¥ä¾¿èªè¨€è¨­å®šåœ¨ä¸åŒé é¢é–“å…±äº«
                localStorage.setItem('github_manager_lang', lang);
                this.applyTranslations();
            },

            loadSavedLanguage: function () {
                // èˆ‡ä¸»ç•«é¢ä½¿ç”¨ç›¸åŒçš„ localStorage key ä»¥ä¾¿èªè¨€è¨­å®šåœ¨ä¸åŒé é¢é–“å…±äº«
                const savedLang = localStorage.getItem('github_manager_lang');
                if (savedLang && this.translations[savedLang]) {
                    this.currentLang = savedLang;
                }
            },

            applyTranslations: function () {
                try {
                    console.log('[i18n] Applying translations for:', this.currentLang);

                    // 1. Update all elements with data-i18n attribute
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (!key) return;

                        // Parse params if they exist (for dynamic logs/results)
                        let params = {};
                        if (el.dataset.i18nParams) {
                            try { params = JSON.parse(el.dataset.i18nParams); } catch (e) { }
                        }

                        const translation = this.t(key, params);

                        if ((el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') && (el.type === 'text' || el.type === 'password' || el.type === 'search' || el.tagName === 'TEXTAREA')) {
                            // If it has data-i18n, it might be the placeholder we want to translate
                            // or the value? Standard i18n usually maps data-i18n to textContent.
                            // But for inputs, we often want placeholder.
                            // To be safe, we check if it has data-i18n-placeholder for placeholder.
                            // If it only has data-i18n, we treat it as innerHTML unless it's an input.
                            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                                // Prefer data-i18n-placeholder if exists, otherwise use data-i18n for placeholder if it's an input
                                el.placeholder = translation;
                            } else {
                                el.innerHTML = translation;
                            }
                        } else if (el.classList.contains('log-entry')) {
                            // Specialized update for log entries
                            const classes = Array.from(el.classList);
                            const level = ['info', 'success', 'error', 'warn'].find(l => classes.includes(l)) || 'info';
                            const levelTagKey = 'log' + level.charAt(0).toUpperCase() + level.slice(1);
                            const levelTag = this.t(levelTagKey);
                            el.innerHTML = `<span class="font-bold mr-2">${levelTag}</span> ${translation}`;
                        } else {
                            el.innerHTML = translation;
                        }
                    });

                    // 2. Update all elements with data-i18n-placeholder attribute
                    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                        const key = el.getAttribute('data-i18n-placeholder');
                        el.placeholder = this.t(key);
                    });

                    // 2.5. Update all elements with data-i18n-value attribute (only if value is still a default)
                    document.querySelectorAll('[data-i18n-value]').forEach(el => {
                        const key = el.getAttribute('data-i18n-value');
                        // Get all possible default values from both languages
                        const zhValue = this.translations.zh[key];
                        const enValue = this.translations.en[key];
                        const currentValue = el.value;

                        // Only update if the current value matches a known default value
                        // (meaning user hasn't manually changed it)
                        if (currentValue === zhValue || currentValue === enValue || currentValue === '') {
                            el.value = this.t(key);
                        }
                    });

                    // 3. Update page title
                    const titleBase = this.t('pageTitle').replace(/^[ğŸ°\s]+/, '');
                    document.title = titleBase;

                    // 4. Update language toggle button
                    const langBtn = document.getElementById('langToggleBtn');
                    if (langBtn) {
                        const btnText = document.getElementById('langBtnText');
                        if (btnText) {
                            btnText.innerText = this.currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
                        }
                    }

                    // 5. Update RPG Status Card
                    if (typeof DevScribeRPG !== 'undefined' && document.getElementById('rpg-status-card')) {
                        try {
                            document.getElementById('rpg-status-card').innerHTML = DevScribeRPG.generateStatusCardHTML();
                        } catch (e) {
                            console.warn('[i18n] Failed to update RPG status card:', e);
                        }
                    }

                    console.log('[i18n] Translations applied successfully');
                } catch (error) {
                    console.error('[i18n] Error in applyTranslations:', error);
                }
            }
        };
        // Expose i18n for external scripts
        window.i18n = i18n;

        function toggleLanguage() {
            console.log('[i18n] Toggle language clicked. Current:', i18n.currentLang);
            const newLang = i18n.currentLang === 'zh' ? 'en' : 'zh';
            console.log('[i18n] Switching to:', newLang);
            i18n.setLanguage(newLang);
        }

        const API_BASE = 'https://api.github.com';
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`; // API Key is read from environment

        let fileBlockCounter = 0;
        let isProcessing = false;

        /**
         * å¯«å…¥æ—¥èªŒè¨Šæ¯åˆ°æ—¥èªŒå®¹å™¨
         * @param {string} messageOrKey - è¦è¨˜éŒ„çš„è¨Šæ¯æˆ–ç¿»è­¯ Key
         * @param {string} level - è¨Šæ¯ç´šåˆ¥ ('info', 'success', 'error', 'warn')
         * @param {object} params - ç¿»è­¯åƒæ•¸
         */
        function logMessage(messageOrKey, level = 'info', params = {}) {
            const logContainer = document.getElementById('logContainer');
            const colorMap = {
                info: 'text-gray-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warn: 'text-yellow-400',
            };

            const logEntry = document.createElement('div');
            logEntry.className = colorMap[level];

            // å˜—è©¦ç¿»è­¯
            const translated = i18n.translations[i18n.currentLang][messageOrKey]
                ? i18n.t(messageOrKey, params)
                : messageOrKey;

            const levelTagKey = 'log' + level.charAt(0).toUpperCase() + level.slice(1);
            const levelTag = i18n.t(levelTagKey);

            // å„²å­˜ä¸­ç¹¼è³‡æ–™ä»¥ä¾¿å³æ™‚åˆ‡æ›
            logEntry.dataset.i18n = messageOrKey;
            if (Object.keys(params).length > 0) logEntry.dataset.i18nParams = JSON.stringify(params);

            logEntry.innerHTML = `<span class="font-bold mr-2">${levelTag}</span> ${translated}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // ä¿æŒæ»¾å‹•åˆ°åº•éƒ¨
        }

        /**
         * é¡¯ç¤ºæœ€çµ‚çµæœè¨Šæ¯
         * @param {string} messageOrKey - æœ€çµ‚çµæœ HTML/Text æˆ–ç¿»è­¯ Key
         * @param {boolean} isSuccess - æ˜¯å¦æˆåŠŸ
         * @param {object} params - ç¿»è­¯åƒæ•¸
         */
        function showResult(messageOrKey, isSuccess, params = {}) {
            const resultBox = document.getElementById('resultBox');
            resultBox.className = `p-4 rounded-lg mt-4 ${isSuccess ? 'bg-green-900/50 border border-green-700' : 'bg-red-900/50 border border-red-700'}`;

            const translated = i18n.translations[i18n.currentLang][messageOrKey]
                ? i18n.t(messageOrKey, params)
                : messageOrKey;

            resultBox.dataset.i18n = messageOrKey;
            if (Object.keys(params).length > 0) resultBox.dataset.i18nParams = JSON.stringify(params);

            resultBox.innerHTML = translated;
            resultBox.style.display = 'block';
        }

        /**
         * æª¢æŸ¥è¼¸å…¥çš„å¿…è¦æ¬„ä½æ˜¯å¦å¡«å¯«
         * @returns {boolean}
         */
        function validateInputs() {
            const token = document.getElementById('token').value.trim();
            const repoFullName = document.getElementById('repoFullName').value.trim();
            const newBranch = document.getElementById('newBranch').value.trim();
            const prTitle = document.getElementById('prTitle').value.trim();
            const baseBranch = document.getElementById('baseBranch').value.trim();

            if (!token || !repoFullName || !newBranch || !prTitle || !baseBranch) {
                showResult('errorMissingFields', false);
                return false;
            }

            const fileBlocks = document.querySelectorAll('.file-block');
            if (fileBlocks.length === 0) {
                showResult('errorNoFiles', false);
                return false;
            }

            for (const block of fileBlocks) {
                const path = block.querySelector('.file-path').value.trim();
                const content = block.querySelector('.file-content').value;
                const commitMessage = block.querySelector('.commit-message').value.trim();
                if (!path || !content || !commitMessage) {
                    showResult('errorFileMissing', false, { index: block.dataset.index });
                    return false;
                }
            }

            return true;
        }

        /**
         * å¸¶æœ‰æŒ‡æ•¸é€€é¿å’Œé‡è©¦æ©Ÿåˆ¶çš„ GitHub API å‘¼å«å™¨ (æœ€å¤š 5 æ¬¡)
         * @param {string} url - API URL
         * @param {string} method - HTTP æ–¹æ³• (GET, POST, PUT, DELETE)
         * @param {string} token - GitHub PAT
         * @param {object} payload - JSON payload
         * @param {number} maxRetries - æœ€å¤§é‡è©¦æ¬¡æ•¸
         * @returns {Promise<Response>}
         */
        async function callApiWithRetry(url, method, token, payload = null, maxRetries = 5) {
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: headers,
                        body: payload ? JSON.stringify(payload) : null,
                    });

                    // æˆåŠŸæˆ– 404/409 (é 5xx éŒ¯èª¤) ç›´æ¥è¿”å›
                    if (response.ok || response.status === 404 || response.status === 409) {
                        return response;
                    }

                    // è™•ç† 403 Rate Limit æˆ– 5xx ä¼ºæœå™¨éŒ¯èª¤ï¼Œå˜—è©¦é‡è©¦
                    if (response.status === 403 || response.status >= 500) {
                        // æŒ‡æ•¸é€€é¿å»¶é²
                        const delay = Math.pow(2, i) * 1000;
                        logMessage('apiCallFailed', 'warn', { status: response.status, statusText: response.statusText, delay: delay / 1000 });
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // é€²å…¥ä¸‹ä¸€å€‹é‡è©¦å¾ªç’°
                    }

                    // å…¶ä»–éé‡è©¦éŒ¯èª¤ (å¦‚ 400 Bad Request, 401 Bad Credentials)
                    return response;

                } catch (error) {
                    // ç¶²è·¯éŒ¯èª¤
                    const delay = Math.pow(2, i) * 1000;
                    logMessage('networkError', 'error', { error: error.message, delay: delay / 1000 });
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            throw new Error(`API å‘¼å« ${url} å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ ${maxRetries}ã€‚`);
        }

        /**
         * å‘¼å« Gemini API é€²è¡Œ PR æ¨™é¡Œæˆ–æè¿°ç”Ÿæˆ
         * @param {string} systemPrompt - ç³»çµ±æç¤ºè©
         * @param {string} userQuery - ä½¿ç”¨è€…è¼¸å…¥çš„å…§å®¹ (ä¾†è‡ª Commit Messages)
         * @returns {Promise<string>} - è¿”å›ç”Ÿæˆçš„æ–‡æœ¬
         */
        async function callGeminiApi(systemPrompt, userQuery) {
            const btnTitle = document.getElementById('btnGenerateTitle');
            const btnDesc = document.getElementById('btnGenerateDesc');

            // ç”±æ–¼ API Key æ˜¯åœ¨ Canvas ç’°å¢ƒä¸­æä¾›çš„ï¼Œé€™è£¡ç•™ç©º
            const apiKey = "AIzaSyAG5d8eUpB3QcE5kTXt-2w0VJbOklMh__c";
            const apiUrl = `${GEMINI_API_URL}${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let resultText = '';
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // ç¦ç”¨æŒ‰éˆ•
                    btnTitle.disabled = true;
                    btnDesc.disabled = true;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok && result.candidates && result.candidates.length > 0) {
                        resultText = result.candidates[0].content?.parts?.[0]?.text || '';
                        if (resultText) return resultText;
                    }

                    // è™•ç†éŒ¯èª¤æˆ–ç„¡æ•ˆéŸ¿æ‡‰ï¼Œé€²è¡Œé‡è©¦
                    const delay = Math.pow(2, i) * 1000;
                    logMessage('geminiRetry', 'warn', { delay: delay / 1000 });
                    await new Promise(resolve => setTimeout(resolve, delay));

                } catch (error) {
                    const delay = Math.pow(2, i) * 1000;
                    logMessage('geminiNetworkError', 'error', { error: error.message, delay: delay / 1000 });
                    await new Promise(resolve => setTimeout(resolve, delay));
                } finally {
                    // åœ¨æœ€å¾Œä¸€æ¬¡å˜—è©¦å¾Œæˆ–æˆåŠŸå¾Œé‡æ–°å•Ÿç”¨æŒ‰éˆ•
                    if (i === maxRetries - 1 || resultText) {
                        btnTitle.disabled = false;
                        btnDesc.disabled = false;
                    }
                }
            }

            throw new Error('ç„¡æ³•å¾ Gemini å–å¾—æœ‰æ•ˆçš„æ¨™é¡Œ/æè¿°ã€‚è«‹æ‰‹å‹•è¼¸å…¥ã€‚');
        }

        /**
         * ç”¢ç”Ÿ PR æ¨™é¡Œ
         */
        async function generatePRTitle() {
            // Check Quota Before Starting
            if (typeof GeminiKeyManager !== 'undefined' && !GeminiKeyManager.checkQuotaAndAlert()) {
                return;
            }

            const commitMessages = Array.from(document.querySelectorAll('.commit-message'))
                .map(el => el.value.trim())
                .filter(msg => msg.length > 0);

            if (commitMessages.length === 0) {
                logMessage('needCommitFirst', 'warn');
                return;
            }

            const prompt = `åŸºæ–¼ä»¥ä¸‹æäº¤è¨Šæ¯ï¼Œç”Ÿæˆä¸€å€‹ç°¡æ½”ã€å–®è¡Œã€ä¸è¶…é 72 å€‹å­—å…ƒçš„ GitHub Pull Request æ¨™é¡Œã€‚åªè¼¸å‡ºæ¨™é¡Œæœ¬èº«ï¼Œä¸è¦åŒ…å«ä»»ä½•å‰ç¶´æˆ–è§£é‡‹ã€‚\n\næäº¤è¨Šæ¯:\n${commitMessages.join('\n')}`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ GitHub é–‹ç™¼è€…ã€‚è«‹æ ¹æ“šæäº¤è¨Šæ¯ï¼Œä»¥æœ€ç°¡æ½”ä¸”ç¬¦åˆè¦ç¯„çš„é¢¨æ ¼ç”Ÿæˆä¸€å€‹ PR æ¨™é¡Œã€‚";

            try {
                logMessage('callingGeminiTitle');
                const title = await callGeminiApi(systemPrompt, prompt);
                document.getElementById('prTitle').value = title.trim();
                logMessage('titleGenerated', 'success');
            } catch (error) {
                logMessage('generateTitleFailed', 'error', { error: error.message });
            }
        }

        /**
         * ç”¢ç”Ÿ PR æè¿°
         */
        async function generatePRDescription() {
            // Check Quota Before Starting
            if (typeof GeminiKeyManager !== 'undefined' && !GeminiKeyManager.checkQuotaAndAlert()) {
                return;
            }

            const commitMessages = Array.from(document.querySelectorAll('.commit-message'))
                .map(el => el.value.trim())
                .filter(msg => msg.length > 0);

            if (commitMessages.length === 0) {
                logMessage('needCommitFirst', 'warn');
                return;
            }

            const prompt = `åŸºæ–¼ä»¥ä¸‹æäº¤è¨Šæ¯ï¼Œç”Ÿæˆä¸€å€‹çµæ§‹åŒ–çš„ GitHub Pull Request æè¿°ã€‚ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å…©å€‹é ‚ç´šæ¨™é¡Œï¼š\n1. **è®Šæ›´æ‘˜è¦** (Summary of Changes): ç°¡è¦èªªæ˜é€™æ¬¡ PR çš„ç›®çš„å’Œä¸»è¦è®Šæ›´ã€‚\n2. **è©³ç´°è®Šæ›´** (Detailed Changes): ä»¥ Markdown æ¸…å–®åˆ—å‡ºæ‰€æœ‰æäº¤è¨Šæ¯çš„è¦é»ã€‚\n\næäº¤è¨Šæ¯:\n${commitMessages.join('\n')}`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ GitHub é–‹ç™¼è€…ã€‚è«‹æ ¹æ“šæäº¤è¨Šæ¯ï¼Œç”Ÿæˆçµæ§‹åŒ–ä¸”æ˜“æ–¼é–±è®€çš„ Markdown æ ¼å¼ PR æè¿°ã€‚";

            try {
                logMessage('callingGeminiDesc');
                const description = await callGeminiApi(systemPrompt, prompt);
                document.getElementById('prBody').value = description.trim();
                logMessage('descGenerated', 'success');
            } catch (error) {
                logMessage('generateDescFailed', 'error', { error: error.message });
            }
        }

        /**
         * è™•ç†æ‹–æ”¾æª”æ¡ˆä¸Šå‚³
         * @param {DragEvent} e - æ‹–æ”¾äº‹ä»¶ç‰©ä»¶
         * @param {HTMLElement} block - æª”æ¡ˆå€å¡Šçš„å®¹å™¨å…ƒç´ 
         */
        function handleFileDrop(e, block) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (!file) return;

            const filePathInput = block.querySelector('.file-path');
            const fileContentTextarea = block.querySelector('.file-content');

            // 1. è‡ªå‹•å¡«å…¥æª”æ¡ˆåç¨±ä½œç‚ºè·¯å¾‘
            filePathInput.value = file.name;

            // 2. è®€å–æª”æ¡ˆå…§å®¹
            const reader = new FileReader();
            reader.onload = function (e) {
                fileContentTextarea.value = e.target.result;
                logMessage('fileReadSuccess', 'info', { name: file.name, size: file.size });
            };
            reader.onerror = function (error) {
                logMessage('fileReadFailed', 'error', { name: file.name, error: error });
            };
            reader.readAsText(file);
        }

        /**
         * å‹•æ…‹æ–°å¢æª”æ¡ˆè®Šæ›´å€å¡Š
         * @param {string} defaultPath - é è¨­æª”æ¡ˆè·¯å¾‘
         * @param {string} defaultContent - é è¨­æª”æ¡ˆå…§å®¹
         * @param {string} defaultCommit - é è¨­æäº¤è¨Šæ¯
         */
        function addFileBlock(defaultPath = '', defaultContent = '', defaultCommit = '') {
            fileBlockCounter++;
            const index = fileBlockCounter;
            const container = document.getElementById('filesContainer');

            const block = document.createElement('div');
            block.className = 'file-block bg-gray-700/50 p-4 rounded-lg space-y-3';
            block.dataset.index = index;

            block.innerHTML = `
                <div class="flex justify-between items-center border-b border-gray-500 pb-2">
                    <h3 class="text-lg font-medium" data-i18n="fileBlockTitle" data-i18n-params='{"index": ${index}}'>${i18n.t('fileBlockTitle', { index: index })}</h3>
                    <button onclick="removeFileBlock(this)" class="text-red-400 hover:text-red-500 text-sm font-medium" data-i18n="deleteBlock">${i18n.t('deleteBlock')}</button>
                </div>

                <div class="drop-zone rounded-lg" 
                    ondragover="event.preventDefault(); this.classList.add('drag-over');"
                    ondragleave="this.classList.remove('drag-over');"
                    ondrop="handleFileDrop(event, this.closest('.file-block'));"
                    data-i18n="dropZoneHint">
                    ${i18n.t('dropZoneHint')}
                </div>

                <div>
                    <label class="input-label block mb-1 text-sm" data-i18n="filePath">${i18n.t('filePath')}</label>
                    <input type="text" value="${defaultPath}" class="file-path w-full p-2 rounded-lg border focus:outline-none" data-i18n-placeholder="placeholderFilePath" placeholder="${i18n.t('placeholderFilePath')}">
                </div>
                
                <div>
                    <label class="input-label block mb-1 text-sm" data-i18n="commitMessage">${i18n.t('commitMessage')}</label>
                    <input type="text" value="${defaultCommit}" class="commit-message w-full p-2 rounded-lg border focus:outline-none" data-i18n-placeholder="placeholderCommitMsg" placeholder="${i18n.t('placeholderCommitMsg')}">
                </div>

                <div>
                    <label class="input-label block mb-1 text-sm" data-i18n="fileContent">${i18n.t('fileContent')}</label>
                    <textarea rows="6" class="file-content w-full p-2 rounded-lg border focus:outline-none" data-i18n-placeholder="placeholderFileContent" placeholder="${i18n.t('placeholderFileContent')}">${defaultContent}</textarea>
                </div>
            `;
            container.appendChild(block);

            // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼Œå¦‚æœæ²’æœ‰è¨­å®šé è¨­å€¼ï¼Œçµ¦äºˆä¸€äº›å»ºè­°
            if (fileBlockCounter === 1 && !defaultPath) {
                const filePathInput = block.querySelector('.file-path');
                const commitMsgInput = block.querySelector('.commit-message');
                const fileContentTextarea = block.querySelector('.file-content');

                filePathInput.value = 'docs/README.md';

                // ç‚ºé è¨­å€¼è¨­å®š data-i18n-value å±¬æ€§ï¼Œä»¥ä¾¿èªè¨€åˆ‡æ›æ™‚è‡ªå‹•æ›´æ–°
                commitMsgInput.value = i18n.t('defaultCommitMsg');
                commitMsgInput.setAttribute('data-i18n-value', 'defaultCommitMsg');

                fileContentTextarea.value = i18n.t('defaultFileContent');
                fileContentTextarea.setAttribute('data-i18n-value', 'defaultFileContent');
            }

            // ç¢ºä¿æ–°å¢çš„å€å¡Šå¥—ç”¨æ­£ç¢ºçš„ç¿»è­¯ï¼ˆåŒ…å« placeholderï¼‰
            i18n.applyTranslations();
        }

        /**
         * åˆªé™¤æª”æ¡ˆå€å¡Š
         * @param {HTMLElement} button - è§¸ç™¼åˆªé™¤çš„æŒ‰éˆ•å…ƒç´ 
         */
        function removeFileBlock(button) {
            const block = button.closest('.file-block');
            block.remove();
        }

        /**
         * ä¸»åŸ·è¡Œå‡½æ•¸ï¼šå»ºç«‹ PR ä¸¦è‡ªå‹•åˆä½µ
         */
        async function createPullRequest() {
            if (isProcessing) return;
            if (!validateInputs()) return;

            // ğŸ® RPG: Check Ritual Gate
            if (typeof DevScribeRPG !== 'undefined' && !DevScribeRPG.requireRitualForSubmission()) {
                return; // Blocked by ritual gate
            }

            isProcessing = true;
            document.getElementById('mainActionButton').disabled = true;
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('resultBox').style.display = 'none';

            const token = document.getElementById('token').value.trim();
            const repoFullName = document.getElementById('repoFullName').value.trim();
            const baseBranch = document.getElementById('baseBranch').value.trim();
            const newBranch = document.getElementById('newBranch').value.trim();
            const prTitle = document.getElementById('prTitle').value.trim();
            let prBody = document.getElementById('prBody').value;
            const issueNumber = document.getElementById('issueNumber').value.trim();
            const deleteBranchAfterMerge = document.getElementById('deleteBranch').checked;

            const [owner, repo] = repoFullName.split('/');

            // æ”¶é›†æª”æ¡ˆè®Šæ›´è³‡è¨Š
            const fileChanges = Array.from(document.querySelectorAll('.file-block')).map(block => ({
                path: block.querySelector('.file-path').value.trim(),
                content: block.querySelector('.file-content').value,
                commitMessage: block.querySelector('.commit-message').value.trim(),
            }));

            let baseBranchSHA = null;
            let prNumber = null;

            try {
                // =========================================================================
                // Step 1/7: å–å¾—åŸºç¤ SHA
                // =========================================================================
                logMessage('step1', 'info', { branch: baseBranch });
                const refUrl = `${API_BASE}/repos/${owner}/${repo}/git/ref/heads/${baseBranch}`;
                let response = await callApiWithRetry(refUrl, 'GET', token);

                if (!response.ok) {
                    throw new Error(`ç„¡æ³•å–å¾—åŸºç¤åˆ†æ”¯ SHAã€‚ç‹€æ…‹: ${response.status} ${response.statusText}`);
                }
                const baseRefData = await response.json();
                baseBranchSHA = baseRefData.object.sha;
                logMessage('step1Success', 'info', { sha: baseBranchSHA });

                // =========================================================================
                // Step 2/7: å»ºç«‹æ–°åˆ†æ”¯
                // =========================================================================
                logMessage('step2', 'info', { branch: newBranch });
                const newRefUrl = `${API_BASE}/repos/${owner}/${repo}/git/refs`;
                const newRefPayload = {
                    ref: `refs/heads/${newBranch}`,
                    sha: baseBranchSHA
                };
                response = await callApiWithRetry(newRefUrl, 'POST', token, newRefPayload);

                if (response.status === 422) { // 422 Unprocessable Entity - å¯èƒ½æ˜¯åˆ†æ”¯å·²å­˜åœ¨
                    logMessage('step2Exists', 'warn', { branch: newBranch });
                } else if (!response.ok) {
                    throw new Error(`å»ºç«‹åˆ†æ”¯å¤±æ•—ã€‚ç‹€æ…‹: ${response.status} ${response.statusText}`);
                } else {
                    logMessage('step2Success', 'success', { branch: newBranch });
                }

                // =========================================================================
                // Step 3/7: æäº¤æª”æ¡ˆè®Šæ›´
                // =========================================================================
                logMessage('step3', 'info', { count: fileChanges.length });

                for (const change of fileChanges) {
                    logMessage('step3Processing', 'info', { path: change.path });
                    const contentUrl = `${API_BASE}/repos/${owner}/${repo}/contents/${change.path}`;

                    // 1. å˜—è©¦å–å¾—ç¾æœ‰æª”æ¡ˆ SHA (ç”¨æ–¼æ›´æ–°)
                    let existingSHA = null;
                    const getFileResponse = await callApiWithRetry(`${contentUrl}?ref=${newBranch}`, 'GET', token);

                    if (getFileResponse.ok) {
                        const fileData = await getFileResponse.json();
                        existingSHA = fileData.sha;
                        logMessage('step3FileExists', 'info', { sha: existingSHA });
                    } else if (getFileResponse.status === 404) {
                        logMessage('step3FileNew', 'info');
                    } else {
                        throw new Error(`å˜—è©¦å–å¾—æª”æ¡ˆ ${change.path} è³‡è¨Šå¤±æ•—ã€‚ç‹€æ…‹: ${getFileResponse.status}`);
                    }

                    // 2. æäº¤ PUT è«‹æ±‚
                    const putPayload = {
                        message: change.commitMessage,
                        content: btoa(unescape(encodeURIComponent(change.content))), // ç¢ºä¿ UTF-8 æ­£ç¢ºç·¨ç¢¼
                        branch: newBranch,
                        sha: existingSHA // åƒ…åœ¨æ›´æ–°æ™‚æä¾› SHA
                    };

                    const putResponse = await callApiWithRetry(contentUrl, 'PUT', token, putPayload);
                    if (!putResponse.ok) {
                        const errorData = await putResponse.json();
                        throw new Error(`æäº¤æª”æ¡ˆ ${change.path} å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                    logMessage('step3FileSuccess', 'success', { path: change.path });
                }

                // =========================================================================
                // Step 4/7: å»ºç«‹ PR
                // =========================================================================
                logMessage('step4', 'info');

                // è™•ç† Issue è™Ÿç¢¼é€£å‹•
                if (issueNumber) {
                    const issueLink = `Closes #${issueNumber}\n\n`;
                    prBody = issueLink + prBody;
                    logMessage('step4IssueLink', 'info', { link: issueNumber });
                }

                const prUrl = `${API_BASE}/repos/${owner}/${repo}/pulls`;
                const prPayload = {
                    title: prTitle,
                    body: prBody,
                    head: newBranch,
                    base: baseBranch
                };

                response = await callApiWithRetry(prUrl, 'POST', token, prPayload);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`å»ºç«‹ PR å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                const prData = await response.json();
                prNumber = prData.number;
                logMessage('step4Success', 'success', { number: prNumber, url: prData.html_url });

                // =========================================================================
                // Step 5/7: ç­‰å¾… PR ç‹€æ…‹è®Šç‚ºå¯åˆä½µ (Mergeable)
                // =========================================================================
                logMessage('step5', 'info');
                let prStatusUrl = `${API_BASE}/repos/${owner}/${repo}/pulls/${prNumber}`;

                const MAX_POLLS = 10;
                let mergeable = false;

                for (let i = 0; i < MAX_POLLS; i++) {
                    // ä½¿ç”¨æ™‚é–“æˆ³åŸ·è¡Œ Cache-Busting
                    const cacheBustingUrl = `${prStatusUrl}?_=${new Date().getTime()}`;
                    response = await callApiWithRetry(cacheBustingUrl, 'GET', token);

                    if (!response.ok) {
                        throw new Error(`è¼ªè©¢ PR ç‹€æ…‹å¤±æ•—ã€‚ç‹€æ…‹: ${response.status}`);
                    }

                    const statusData = await response.json();

                    if (statusData.mergeable === true) {
                        mergeable = true;
                        logMessage('step5Mergeable', 'success');
                        break;
                    } else if (statusData.mergeable === false) {
                        logMessage('step5NotMergeable', 'warn');
                        break;
                    } else { // mergeable === null, ç‹€æ…‹ä»åœ¨è¨ˆç®—ä¸­
                        logMessage('step5Computing', 'info', { attempt: i + 1, max: MAX_POLLS });
                        if (i < MAX_POLLS - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2000)); // é–“éš” 2 ç§’
                        }
                    }
                }

                if (!mergeable) {
                    logMessage('step5MaxPolls', 'warn');
                    return; // çµæŸåŸ·è¡Œ
                }

                // =========================================================================
                // Step 6/7: è‡ªå‹•åˆä½µ PR
                // =========================================================================
                logMessage('step6', 'info');
                const mergeUrl = `${API_BASE}/repos/${owner}/${repo}/pulls/${prNumber}/merge`;
                const mergePayload = {
                    commit_title: prTitle, // ä½¿ç”¨ PR æ¨™é¡Œä½œç‚º Squash Commit æ¨™é¡Œ
                    commit_message: prBody,
                    merge_method: 'squash'
                };

                response = await callApiWithRetry(mergeUrl, 'PUT', token, mergePayload);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`è‡ªå‹•åˆä½µ PR å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }

                const mergeData = await response.json();
                logMessage('step6Success', 'success', { sha: mergeData.sha });

                // =========================================================================
                // Step 7/7: åˆªé™¤ä¾†æºåˆ†æ”¯ (å¯é¸)
                // =========================================================================
                if (deleteBranchAfterMerge) {
                    logMessage('step7', 'info', { branch: newBranch });
                    const deleteRefUrl = `${API_BASE}/repos/${owner}/${repo}/git/refs/heads/${newBranch}`;
                    response = await callApiWithRetry(deleteRefUrl, 'DELETE', token);

                    if (response.ok) {
                        logMessage('step7Success', 'success', { branch: newBranch });
                    } else if (response.status === 422) {
                        logMessage('step7Protected', 'warn');
                    } else if (response.status === 404) {
                        logMessage('step7NotFound', 'warn', { branch: newBranch });
                    } else {
                        logMessage('step7Failed', 'error', { status: response.status, statusText: response.statusText });
                    }
                } else {
                    logMessage('step7Skip', 'info');
                }

                // æœ€çµ‚æˆåŠŸè¨Šæ¯ (ä½¿ç”¨ data-i18n å±¬æ€§ä»¥ä¾¿éš¨æ™‚åˆ‡æ›èªè¨€)
                const finalSuccessHTML = `
                    <div class="flex items-center space-x-2">
                        <svg class="w-6 h-6 text-green-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v5c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h11"/></svg>
                        <span class="text-lg font-bold" data-i18n="flowComplete"></span>
                    </div>
                    <p class="mt-2" data-i18n="allChangesMerged" data-i18n-params='{"branch":"${baseBranch}"}'></p>
                    <a href="${prData.html_url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 font-medium underline" data-i18n="viewPR" data-i18n-params='{"number":"${prNumber}"}'></a>
                `;
                showResult(finalSuccessHTML, true);
                i18n.applyTranslations(); // ç«‹å³å¥—ç”¨ç¿»è­¯ä»¥å¡«å……å‰›å‰›æ’å…¥çš„ data-i18n å…ƒç´ 

                // ğŸ® RPG: Award XP for successful PR submission
                if (typeof DevScribeRPG !== 'undefined') {
                    const result = DevScribeRPG.recordModuleAction('guild', 'pr_merged');
                    if (result) {
                        DevScribeRPG.showXPNotification(result);
                        // Reset ritual status after successful submission
                        DevScribeRPG.setRitualCompleted(false);
                        logMessage('rpgXpEarned', 'success', { xp: result.earnedXP, combo: result.currentCombo });
                    }
                }

            } catch (error) {
                logMessage('flowFailed', 'error', { error: error.message });
                showResult('flowFailed', false, { error: error.message, number: prNumber || '???' });
                const errorBox = document.getElementById('resultBox');
                errorBox.innerHTML += `<div class="mt-2 text-sm opacity-80" data-i18n="checkPR" data-i18n-params='{"number":"${prNumber || '???'}"}'></div>`;
                i18n.applyTranslations(); // ç«‹å³å¥—ç”¨ç¿»è­¯
            } finally {
                isProcessing = false;
                document.getElementById('mainActionButton').disabled = false;
            }
        }

        async function fetchTokenFromServer() {
            try {
                const response = await fetch('/api/config/github-token');
                const data = await response.json();
                if (data.token) {
                    document.getElementById('token').value = data.token;
                    console.log('GitHub Token loaded from Render environment.');
                }
            } catch (err) {
                console.warn('Could not fetch token from server, falling back to local storage.');
            }
        }

        // è¼‰å…¥æ™‚è‡ªå‹•æ–°å¢ä¸€å€‹æª”æ¡ˆå€å¡Š
        window.onload = async function () {
            // Initialize i18n
            i18n.loadSavedLanguage();
            i18n.applyTranslations();

            // Load saved settings
            const savedToken = localStorage.getItem('github_pat_token');
            const savedRepo = localStorage.getItem('github_repo_full_name');
            if (savedToken) document.getElementById('token').value = savedToken;
            if (savedRepo) document.getElementById('repoFullName').value = savedRepo;

            // Try to fetch from Render (overwrites localStorage if found)
            await fetchTokenFromServer();

            addFileBlock();

            // ğŸ® RPG: Initialize UI
            if (typeof DevScribeRPG !== 'undefined') {
                // Show status card
                document.getElementById('rpg-status-card').innerHTML = DevScribeRPG.generateStatusCardHTML();

                // Check ritual gate
                const warning = document.getElementById('ritual-gate-warning');
                if (!DevScribeRPG.isRitualCompleted()) {
                    warning.classList.remove('hidden');
                } else {
                    warning.classList.add('hidden');
                }
            }
        };

    </script>

    <!-- Gemini Key Manager -->
    <script src="modules/gemini-key-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const updateKeyStatus = async () => {
                const currentLang = window.i18n?.currentLang === 'zh' ? 'zh' : 'en';
                GeminiKeyManager.setLang(currentLang);
                await GeminiKeyManager.renderStatusUI('#gemini-key-status-container');
            };

            // Initial load with slight delay to ensure i18n
            setTimeout(updateKeyStatus, 500);

            // Hook into existing toggleLanguage if accessible
            const originalToggleLanguage = window.toggleLanguage;
            if (typeof originalToggleLanguage === 'function') {
                window.toggleLanguage = function () {
                    originalToggleLanguage();
                    setTimeout(updateKeyStatus, 100);
                };
            }
        });
    </script>
</body>

</html>