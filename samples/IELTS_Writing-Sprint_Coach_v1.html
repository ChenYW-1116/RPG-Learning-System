<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">IELTS Writing Coach</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* PUT ALL YOUR CUSTOM CSS HERE */
        .timer-font {
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
        }

        .dark-mode-transition {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .omission-mark {
            background-color: #fecaca;
            /* red-200 */
            color: #b91c1c;
            /* red-700 */
            text-decoration: underline;
            font-weight: 500;
            padding: 1px 2px;
            border-radius: 3px;
        }

        /* Card style mimicry */
        .app-card {
            background-color: #fff;
            border-radius: 1rem;
            /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* shadow-lg */
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
            padding: 1.5rem;
            /* p-6 */
        }

        .dark .app-card {
            background-color: #1f2937;
            /* gray-800 */
            border-color: #374151;
            /* gray-700 */
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 dark-mode-transition">
    <!-- PUT YOUR HTML UI COMPONENTS HERE -->

    <div id="app" class="min-h-screen">
        <!-- Navigation -->
        <nav id="navbar"
            class="sticky top-0 z-40 bg-white/90 backdrop-blur-sm shadow-md dark:bg-gray-900/90 dark:border-gray-700 dark-mode-transition border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" data-i18n="nav_title">IELTS
                            Coach</h1>
                    </div>
                    <div class="flex items-center">
                        <div id="tabs" class="hidden sm:ml-6 sm:flex sm:space-x-4">
                            <button data-tab="sprint"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_sprint">5-Day Sprint</button>
                            <button data-tab="blind"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_blind">Blind Write-back</button>
                            <button data-tab="tools"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_tools">AI Tools</button>
                            <button data-tab="report"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_report">Progress Report</button>
                        </div>
                        <button id="settings-btn"
                            class="ml-4 p-2 rounded-full text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-300 transition duration-150">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div id="content-container">
                <!-- Content injected here -->
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full dark-mode-transition">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold leading-6 text-gray-900 dark:text-gray-100 mb-4"
                            data-i18n="settings_title">Application Settings</h3>

                        <div class="space-y-4">
                            <!-- Language Selector -->
                            <div>
                                <label for="language-select"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                    data-i18n="settings_language">Language</label>
                                <select id="language-select"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                                    <option value="en">English</option>
                                    <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                                </select>
                            </div>

                            <!-- Dark Mode Toggle -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"
                                    data-i18n="settings_dark_mode">Dark Mode</span>
                                <button id="dark-mode-toggle"
                                    class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-gray-200 dark:bg-indigo-600">
                                    <span
                                        class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 translate-x-0 dark:translate-x-5"></span>
                                </button>
                            </div>

                            <!-- API Key Input -->
                            <div>
                                <label for="api-key-input"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gemini API
                                    Key</label>
                                <input type="password" id="api-key-input"
                                    class="mt-1 block w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="AIzaSy...">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Model:
                                    gemini-2.5-flash-preview-04-17</p>
                            </div>

                            <!-- Danger Zone -->
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-md font-semibold text-red-600 mb-2" data-i18n="settings_danger">Danger
                                    Zone</h4>
                                <button id="clear-data-btn"
                                    class="w-full bg-red-100 text-red-700 font-semibold py-2 rounded-lg hover:bg-red-200 transition duration-150"
                                    data-i18n="settings_clear_data">Clear All Local Data</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl">
                        <button type="button" id="close-settings-btn"
                            class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm active:scale-95"
                            data-i18n="settings_close">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2">
            <!-- Toasts will appear here -->
        </div>

        <!-- Global Loading Indicator -->
        <div id="global-loader"
            class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl flex flex-col items-center space-y-4">
                <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p id="loader-message" class="text-gray-700 dark:text-gray-200 font-medium">Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // PUT ALL YOUR JAVASCRIPT LOGIC HERE
        // DATA, STATE, FUNCTIONS, EVENTS - EVERYTHING

        const STORAGE_KEY = 'IELTS_COACH_STATE_V2';
        const SPRINT_DURATION_SECONDS = 900; // 15 minutes

        // --- I18N Data ---
        const I18N = {
            en: {
                app_title: "IELTS Writing Coach",
                nav_title: "IELTS Coach",
                tab_sprint: "5-Day Sprint",
                tab_blind: "Blind Write-back",
                tab_tools: "AI Tools",
                tab_report: "Progress Report",
                settings_title: "Application Settings",
                settings_language: "Language",
                settings_dark_mode: "Dark Mode",
                settings_danger: "Danger Zone",
                settings_clear_data: "Clear All Local Data",
                settings_close: "Close",
                sprint_header: "IELTS 5-Day Verb Sprint",
                sprint_task_title: "Daily Task",
                sprint_topic: "Topic:",
                sprint_verbs: "Mandatory Verbs:",
                sprint_status_ready: "Ready",
                sprint_status_running: "Sprinting",
                sprint_status_paused: "Paused",
                sprint_status_finished: "Time Up",
                sprint_start: "Start Verb Sprint (15:00)",
                sprint_pause: "Pause",
                sprint_resume: "Resume",
                sprint_submit: "Submit Essay for Analysis",
                sprint_word_count: "Word Count",
                sprint_passive_mock: "Passive Ratio (Mock)",
                sprint_feedback_title: "AI Analysis Results",
                sprint_feedback_score: "Estimated Band Score",
                sprint_feedback_passive_ratio: "Precise Passive Ratio",
                sprint_feedback_passive_sentences: "Passive Sentences Identified",
                sprint_feedback_advanced_verbs: "Advanced Verbs Used",
                sprint_feedback_reset: "Start New Sprint Tomorrow",
                blind_header: "Blind Write-back System",
                blind_source_title: "Original Essay Source",
                blind_reveal: "Click to reveal and grade",
                blind_write_title: "Your Blind Rewrite",
                blind_grade: "Grade My Rewrite",
                blind_omission_rate: "Omission Rate",
                blind_diagnosis: "AI Diagnosis",
                blind_pass: "Excellent (Omission < 2%)",
                blind_fail: "Needs Improvement",
                tools_header: "Advanced AI Writing Tools",
                tool_inspiration_title: "AI Inspiration Generator",
                tool_inspiration_prompt: "Essay Topic:",
                tool_inspiration_generate: "Generate Inspiration",
                tool_analyzer_title: "AI Essay Analyzer",
                tool_analyzer_prompt: "Paste your essay here:",
                tool_analyzer_analyze: "Analyze Essay",
                tool_rewriter_title: "Band 9 Rewriter",
                tool_rewriter_prompt: "Paste your essay for Band 9 rewrite:",
                tool_rewriter_rewrite: "Rewrite to Band 9",
                report_header: "Progress Report & Bottlenecks",
                report_bottleneck_title: "Bottleneck Index (Mock)",
                report_bottleneck_score: "Composite Weakness Score",
                report_bottleneck_advice: "AI Improvement Advice",
                report_history_title: "Recent Sprint History (Last 10)",
                report_history_date: "Date",
                report_history_omission: "Omission Rate",
                report_history_passive: "Passive Ratio",
                report_history_score: "Score",
                toast_copied: "Copied to clipboard!",
                toast_error: "Error: ",
                toast_processing: "Processing...",
                toast_api_error: "API Error. Check key or network.",
                toast_sprint_submit_fail: "Please use all 6 mandatory verbs before submitting.",
                toast_sprint_finished: "Time is up! Essay locked.",
                toast_blind_no_source: "No previous successful sprint found to load.",
            },
            zh: {
                app_title: "ÈõÖÊÄùÂØ´‰ΩúË°ùÂà∫ÊïôÁ∑¥",
                nav_title: "ÈõÖÊÄùÊïôÁ∑¥",
                tab_sprint: "5Êó•ÂãïË©ûË°ùÂà∫",
                tab_blind: "Áõ≤ÂØ´ÂõûË≠Ø",
                tab_tools: "AI ËºîÂä©Â∑•ÂÖ∑",
                tab_report: "ÈÄ≤Â∫¶Â†±Âëä",
                settings_title: "ÊáâÁî®Á®ãÂºèË®≠ÂÆö",
                settings_language: "Ë™ûË®Ä",
                settings_dark_mode: "Ê∑±Ëâ≤Ê®°Âºè",
                settings_danger: "Âç±Èö™ÂçÄÂüü",
                settings_clear_data: "Ê∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∏Êìö",
                settings_close: "ÈóúÈñâ",
                sprint_header: "ÈõÖÊÄù 5 Êó•ÂãïË©ûË°ùÂà∫Á≥ªÁµ±",
                sprint_task_title: "ÊØèÊó•‰ªªÂãô",
                sprint_topic: "‰∏ªÈ°åÔºö",
                sprint_verbs: "ÂøÖÁî®ÂãïË©ûÔºö",
                sprint_status_ready: "Ê∫ñÂÇô‰∏≠",
                sprint_status_running: "Ë°ùÂà∫‰∏≠",
                sprint_status_paused: "Â∑≤Êö´ÂÅú",
                sprint_status_finished: "ÊôÇÈñìÂà∞",
                sprint_start: "ÈñãÂßãÂãïË©ûË°ùÂà∫ (15:00)",
                sprint_pause: "Êö´ÂÅú",
                sprint_resume: "ÁπºÁ∫å",
                sprint_submit: "Êèê‰∫§‰ΩúÊñáÈÄ≤Ë°åÂàÜÊûê",
                sprint_word_count: "Â≠óÊï∏Áµ±Ë®à",
                sprint_passive_mock: "Ë¢´ÂãïË™ûÊÖãÊØî‰æã (Ê®°Êì¨)",
                sprint_feedback_title: "AI ÂàÜÊûêÁµêÊûú",
                sprint_feedback_score: "È†ê‰º∞ÈõÖÊÄùÂàÜÊï∏",
                sprint_feedback_passive_ratio: "Á≤æÁ¢∫Ë¢´ÂãïË™ûÊÖãÊØî‰æã",
                sprint_feedback_passive_sentences: "Ë≠òÂà•ÁöÑË¢´ÂãïÂè•",
                sprint_feedback_advanced_verbs: "‰ΩøÁî®ÁöÑÈ´òÁ¥öÂãïË©û",
                sprint_feedback_reset: "ÊòéÊó•ÈñãÂßãÊñ∞ÁöÑË°ùÂà∫",
                blind_header: "Áõ≤ÂØ´ÂõûË≠ØÁ≥ªÁµ±",
                blind_source_title: "ÂéüÊñá‰æÜÊ∫ê",
                blind_reveal: "ÈªûÊìäÊè≠Á§∫‰∏¶Ë©ïÂàÜ",
                blind_write_title: "ÊÇ®ÁöÑÁõ≤ÂØ´ÂõûË≠Ø",
                blind_grade: "Ë©ï‰º∞ÊàëÁöÑÂõûÂØ´",
                blind_omission_rate: "ÈÅ∫ÊºèÁéá",
                blind_diagnosis: "AI Ë®∫Êñ∑",
                blind_pass: "ÂÑ™ÁßÄ (ÈÅ∫ÊºèÁéá < 2%)",
                blind_fail: "ÈúÄË¶ÅÊîπÈÄ≤",
                tools_header: "È´òÁ¥ö AI ÂØ´‰ΩúÂ∑•ÂÖ∑",
                tool_inspiration_title: "AI ÈùàÊÑüÂä©Êâã",
                tool_inspiration_prompt: "‰ΩúÊñá‰∏ªÈ°åÔºö",
                tool_inspiration_generate: "ÁîüÊàêÈùàÊÑü",
                tool_analyzer_title: "AI ÊñáÁ´†ÂàÜÊûêÂô®",
                tool_analyzer_prompt: "Ë≤º‰∏äÊÇ®ÁöÑ‰ΩúÊñáÔºö",
                tool_analyzer_analyze: "ÂàÜÊûê‰ΩúÊñá",
                tool_rewriter_title: "Band 9 È´òÁ¥öÊîπÂØ´Âô®",
                tool_rewriter_prompt: "Ë≤º‰∏äÊÇ®ÁöÑ‰ΩúÊñáÈÄ≤Ë°å Band 9 ÊîπÂØ´Ôºö",
                tool_rewriter_rewrite: "ÊîπÂØ´Êàê Band 9 ÁØÑÊñá",
                report_header: "ÈÄ≤Â∫¶Â†±ÂëäËàáÁì∂È†∏ÂàÜÊûê",
                report_bottleneck_title: "Áì∂È†∏ÊåáÊï∏ (Ê®°Êì¨)",
                report_bottleneck_score: "Á∂úÂêàÂº±ÈªûÂàÜÊï∏",
                report_bottleneck_advice: "AI ÊèêÂçáÂª∫Ë≠∞",
                report_history_title: "ËøëÊúüË°ùÂà∫Ê≠∑Âè≤ (ÊúÄËøë 10 Ê¨°)",
                report_history_date: "Êó•Êúü",
                report_history_omission: "ÈÅ∫ÊºèÁéá",
                report_history_passive: "Ë¢´ÂãïÊØî‰æã",
                report_history_score: "ÂàÜÊï∏",
                toast_copied: "Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ",
                toast_error: "ÈåØË™§Ôºö",
                toast_processing: "ËôïÁêÜ‰∏≠...",
                toast_api_error: "API ÈåØË™§„ÄÇË´ãÊ™¢Êü• Key ÊàñÁ∂≤Ë∑Ø„ÄÇ",
                toast_sprint_submit_fail: "Êèê‰∫§ÂâçË´ãÁ¢∫‰øù‰ΩøÁî®‰∫ÜÊâÄÊúâ 6 ÂÄãÂøÖÁî®ÂãïË©û„ÄÇ",
                toast_sprint_finished: "ÊôÇÈñìÂà∞ÔºÅ‰ΩúÊñáÂ∑≤ÈéñÂÆö„ÄÇ",
                toast_blind_no_source: "Êâæ‰∏çÂà∞‰∏äÊ¨°ÊàêÂäüÁöÑË°ùÂà∫‰ΩúÊñá‰ΩúÁÇ∫ÂéüÊñá„ÄÇ",
            }
        };

        // --- Core State and Persistence ---
        let app = {
            state: {
                language: 'zh',
                darkMode: false,
                currentTab: 'sprint',
                apiKey: '',
                isProcessing: false,

                // US-1 Sprint State
                sprint: {
                    timer: SPRINT_DURATION_SECONDS,
                    status: 'ready', // ready, running, paused, finished
                    intervalId: null,
                    taskDate: null,
                    topic: '',
                    mandatoryVerbs: [],
                    essay: '',
                    wordCount: 0,
                    passiveRatioMock: '0.0%',
                    analysisResult: null,
                },

                // US-2 Blind Write State
                blind: {
                    sourceEssay: '',
                    rewriteEssay: '',
                    omissionRate: null,
                    isRevealed: false,
                    diagnosis: null,
                },

                // US-4 History - Pre-populated with sample data for demo
                history: [
                    { date: '2026-02-04', words: 287, passiveRatio: '8.5%', score: 7.0, omissionRate: 1.8, essay: 'Sample essay content...' },
                    { date: '2026-02-03', words: 265, passiveRatio: '7.2%', score: 6.5, omissionRate: 3.2, essay: 'Another sample...' },
                    { date: '2026-02-02', words: 301, passiveRatio: '9.1%', score: 7.5, omissionRate: 1.5, essay: 'Yet another sample...' }
                ],
            },

            // --- Utility Functions ---
            saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(app.state));
            },

            loadState() {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    // Merge loaded state, ensuring structure integrity
                    app.state = {
                        ...app.state,
                        ...loadedState,
                        sprint: { ...app.state.sprint, ...loadedState.sprint },
                        blind: { ...app.state.blind, ...loadedState.blind },
                    };
                    // Ensure history is an array
                    if (!Array.isArray(app.state.history)) {
                        app.state.history = [];
                    }
                }
            },

            // --- UI Functions ---
            applyTranslations() {
                const lang = app.state.language;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (I18N[lang] && I18N[lang][key]) {
                        el.textContent = I18N[lang][key];
                    }
                });
                // Update specific buttons/placeholders
                document.getElementById('sprint-start-btn').textContent = I18N[lang].sprint_start;
                document.title = I18N[lang].app_title;
                app.updateUI(); // Re-render dynamic content like timer
            },

            toggleDarkMode(isDark) {
                app.state.darkMode = isDark === undefined ? !app.state.darkMode : isDark;
                if (app.state.darkMode) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('dark-mode-toggle').classList.add('bg-indigo-600');
                    document.getElementById('dark-mode-toggle').classList.remove('bg-gray-200');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('dark-mode-toggle').classList.remove('bg-indigo-600');
                    document.getElementById('dark-mode-toggle').classList.add('bg-gray-200');
                }
                app.saveState();
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');

                let bgColor, textColor;
                if (type === 'error') {
                    bgColor = 'bg-red-500'; textColor = 'text-white';
                } else if (type === 'success') {
                    bgColor = 'bg-green-500'; textColor = 'text-white';
                } else {
                    bgColor = 'bg-blue-500'; textColor = 'text-white';
                }

                toast.className = `p-4 rounded-lg shadow-xl ${bgColor} ${textColor} font-medium transition-all duration-300 transform translate-x-full opacity-0`;
                toast.textContent = message;

                container.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },

            async performAction(action, ...args) {
                if (app.state.isProcessing) return;
                app.state.isProcessing = true;

                // Show global loader
                const loader = document.getElementById('global-loader');
                const loaderMsg = document.getElementById('loader-message');
                if (loader) {
                    loader.classList.remove('hidden');
                    if (loaderMsg) loaderMsg.textContent = I18N[app.state.language].toast_processing;
                }
                app.updateUI();

                try {
                    await action(...args);
                } catch (error) {
                    console.error("Action failed:", error);
                    app.showToast(`${I18N[app.state.language].toast_error} ${error.message || 'Unknown error'}`, 'error');
                } finally {
                    app.state.isProcessing = false;
                    // Hide global loader
                    if (loader) loader.classList.add('hidden');
                    app.updateUI();
                }
            },

            // --- Rendering and Routing ---

            switchTab(tabName) {
                app.state.currentTab = tabName;
                app.saveState();
                app.renderContent();
            },

            renderContent() {
                const container = document.getElementById('content-container');
                const tabs = document.querySelectorAll('.tab-btn');

                tabs.forEach(btn => {
                    const isActive = btn.dataset.tab === app.state.currentTab;
                    btn.classList.toggle('border-indigo-600', isActive);
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('dark:text-indigo-400', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                });

                // Render specific tab content
                if (app.state.currentTab === 'sprint') {
                    container.innerHTML = app.renderSprintUI();
                    app.initSprintListeners();
                    app.generateDailyTask();
                } else if (app.state.currentTab === 'blind') {
                    container.innerHTML = app.renderBlindWriteUI();
                    app.initBlindWriteListeners();
                    app.loadBlindWriteSource();
                } else if (app.state.currentTab === 'tools') {
                    container.innerHTML = app.renderAIToolsUI();
                    app.initAIToolsListeners();
                } else if (app.state.currentTab === 'report') {
                    container.innerHTML = app.renderProgressReportUI();
                    app.renderHistoryTable();
                    app.renderRadarChart();
                }
                app.updateUI();
            },

            updateUI() {
                // Global UI updates (e.g., locking buttons)
                const processing = app.state.isProcessing;
                document.querySelectorAll('button').forEach(btn => {
                    if (btn.id !== 'settings-btn' && btn.id !== 'close-settings-btn' && btn.id !== 'dark-mode-toggle') {
                        if (processing && !btn.classList.contains('disabled:opacity-50')) {
                            btn.setAttribute('disabled', 'true');
                            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${I18N[app.state.language].toast_processing}`;
                        } else if (!processing && btn.hasAttribute('disabled')) {
                            btn.removeAttribute('disabled');
                            // Restore original button text (simple approach for this SPA)
                            if (btn.dataset.originalText) {
                                btn.textContent = btn.dataset.originalText;
                            }
                        }
                        if (!btn.dataset.originalText && !processing) {
                            btn.dataset.originalText = btn.textContent;
                        }
                    }
                });

                // Tab-specific updates
                if (app.state.currentTab === 'sprint') {
                    app.updateSprintUI();
                } else if (app.state.currentTab === 'blind') {
                    app.updateBlindWriteUI();
                }
            },
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ü§ñ REAL GEMINI API WRAPPER (T009, T015)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const GEMINI_CONFIG = {
            model: 'gemini-2.5-flash-preview-09-2025',
            endpoint: 'https://generativelanguage.googleapis.com/v1beta/models',
            maxOutputTokens: 8192,
            temperature: 0.7
        };

        class GeminiAPIWrapper {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.retryDelays = [1000, 2000, 4000];
            }

            // Real Gemini API call with exponential backoff
            async call(prompt, structuredOutput = false, systemPrompt = '') {
                if (!this.apiKey || this.apiKey.length < 10) {
                    console.warn('[GeminiAPI] No valid API key, using mock response');
                    return this._mockResponse(prompt, structuredOutput);
                }

                const url = `${GEMINI_CONFIG.endpoint}/${GEMINI_CONFIG.model}:generateContent?key=${this.apiKey}`;

                let lastError = null;
                for (let i = 0; i < this.retryDelays.length; i++) {
                    try {
                        console.log(`[GeminiAPI] Attempt ${i + 1}: Calling ${GEMINI_CONFIG.model}`);

                        const requestBody = {
                            contents: [{
                                role: 'user',
                                parts: [{ text: systemPrompt ? `${systemPrompt}\n\n${prompt}` : prompt }]
                            }],
                            generationConfig: {
                                temperature: GEMINI_CONFIG.temperature,
                                maxOutputTokens: GEMINI_CONFIG.maxOutputTokens,
                                responseMimeType: structuredOutput ? 'application/json' : 'text/plain'
                            }
                        };

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                        }

                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                        console.log(`[GeminiAPI] Success: ${text.length} chars received`);

                        if (structuredOutput) {
                            try {
                                // Try to parse JSON from response
                                const jsonMatch = text.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    return JSON.parse(jsonMatch[0]);
                                }
                            } catch (parseError) {
                                console.warn('[GeminiAPI] JSON parse failed, returning raw text');
                            }
                        }

                        return text;

                    } catch (error) {
                        lastError = error;
                        console.warn(`[GeminiAPI] Attempt ${i + 1} failed:`, error.message);

                        if (i < this.retryDelays.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, this.retryDelays[i]));
                        }
                    }
                }

                console.error('[GeminiAPI] All retries failed, using mock response');
                return this._mockResponse(prompt, structuredOutput);
            }

            // Mock response fallback when API fails
            _mockResponse(prompt, structuredOutput) {
                let result;
                if (prompt.includes("Analyze Essay") || prompt.includes("ÂàÜÊûê")) {
                    result = {
                        score: (6.0 + Math.random() * 2.5).toFixed(1),
                        precisePassiveRatio: `${(Math.random() * 5 + 5).toFixed(1)}%`,
                        passiveSentences: ["It is believed that...", "The study was conducted by...", "This phenomenon can be attributed to..."],
                        advancedVerbs: [
                            { verb: "elucidate", meaning: "clarify" },
                            { verb: "mitigate", meaning: "reduce severity" },
                            { verb: "exacerbate", meaning: "make worse" }
                        ]
                    };
                } else if (prompt.includes("Inspiration") || prompt.includes("ÈùàÊÑü")) {
                    result = {
                        positive: ["Boosts efficiency and productivity", "Enables global connectivity", "Democratizes access to information"],
                        negative: ["Risk of job displacement", "Privacy and security concerns", "Widening digital divide"],
                        vocabulary: ["paradigm shift", "disseminate", "ubiquitous", "confluence", "exacerbate", "ameliorate"]
                    };
                } else if (prompt.includes("Blind Write") || prompt.includes("Áõ≤ÂØ´") || prompt.includes("Diagnosis")) {
                    result = "Êï¥È´îÁµêÊßãÂÆåÊï¥Ôºå‰ΩÜÈÉ®ÂàÜÈ´òÁ¥öË©ûÂΩôÂ¶Ç'ubiquitous'Âíå'mitigate'ÊúâÈÅ∫Êºè„ÄÇÂª∫Ë≠∞Âä†Âº∑Ë™ûÁæ©Áõ∏ÈóúÁöÑË©ûÂΩôË®òÊÜ∂Ë®ìÁ∑¥„ÄÇ";
                } else if (prompt.includes("Band 9") || prompt.includes("Rewriter") || prompt.includes("ÊîπÂØ´")) {
                    result = "The rapid proliferation of digital technologies has fundamentally reshaped the educational paradigm, necessitating a critical re-evaluation of traditional pedagogical methodologies. This transformation, while presenting unprecedented opportunities for knowledge dissemination, simultaneously engenders a myriad of challenges that warrant careful consideration. [Mock Band 9 Rewrite]";
                } else {
                    result = "[Mock Response] AI analysis completed successfully.";
                }

                if (structuredOutput && typeof result === 'object') {
                    return result;
                }
                return typeof result === 'string' ? result : JSON.stringify(result, null, 2);
            }
        }

        const api = new GeminiAPIWrapper(app.state.apiKey);

        // --- US-1: Sprint System Logic ---

        const MOCK_VERBS = ["articulate", "elucidate", "underscore", "mitigate", "exacerbate", "stipulate", "convey", "denote", "foster", "hinder", "catalyze", "diminish", "transcend", "bolster", "reiterate", "delineate", "substantiate"];
        const MOCK_TOPICS = [
            "The role of technology in modern education, focusing on its impact on critical thinking skills.",
            "The necessity of international cooperation to address climate change vs. national economic interests.",
            "Should governments impose higher taxes on unhealthy food and beverages to combat obesity?",
            "The influence of social media on political engagement and democratic processes.",
            "Analyzing the benefits and drawbacks of remote work on productivity and work-life balance."
        ];

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        app.generateDailyTask = function () {
            const today = getTodayDateString();
            const s = app.state.sprint;

            if (s.taskDate === today && s.mandatoryVerbs.length > 0) {
                // Task already generated for today
                app.updateSprintUI();
                return;
            }

            // 1. Select 6 unique verbs, prioritizing unused ones (Mock: simple random selection)
            const availableVerbs = [...MOCK_VERBS];
            const selectedVerbs = [];
            for (let i = 0; i < 6; i++) {
                const index = Math.floor(Math.random() * availableVerbs.length);
                selectedVerbs.push({
                    verb: availableVerbs.splice(index, 1)[0],
                    used: false
                });
            }

            // 2. Select a random topic
            const topic = MOCK_TOPICS[Math.floor(Math.random() * MOCK_TOPICS.length)];

            // Reset sprint state
            app.state.sprint = {
                timer: SPRINT_DURATION_SECONDS,
                status: 'ready',
                intervalId: null,
                taskDate: today,
                topic: topic,
                mandatoryVerbs: selectedVerbs,
                essay: '',
                wordCount: 0,
                passiveRatioMock: '0.0%',
                analysisResult: null,
            };
            app.saveState();
            app.updateSprintUI();
        };

        app.formatTime = function (seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        };

        app.startTimer = function () {
            if (app.state.sprint.status === 'running') return;

            app.state.sprint.status = 'running';
            app.state.sprint.intervalId = setInterval(app.updateTimer, 1000);
            app.saveState();
            app.updateSprintUI();
        };

        app.pauseTimer = function () {
            clearInterval(app.state.sprint.intervalId);
            app.state.sprint.status = 'paused';
            app.state.sprint.intervalId = null;
            app.saveState();
            app.updateSprintUI();
        };

        app.updateTimer = function () {
            if (app.state.sprint.timer <= 0) {
                clearInterval(app.state.sprint.intervalId);
                app.state.sprint.status = 'finished';
                app.showToast(I18N[app.state.language].toast_sprint_finished, 'info');
                app.saveState();
            } else {
                app.state.sprint.timer--;
            }
            app.updateSprintUI();
        };

        app.checkVerbUsage = function (essayText) {
            const s = app.state.sprint;
            const words = essayText.toLowerCase().match(/\b\w+\b/g) || [];
            s.wordCount = words.length;

            // Mock Passive Ratio (simple simulation based on length)
            const passiveMockValue = Math.min(15, words.length / 20).toFixed(1);
            s.passiveRatioMock = `${passiveMockValue}%`;

            // Check mandatory verbs
            s.mandatoryVerbs = s.mandatoryVerbs.map(v => {
                const regex = new RegExp(`\\b${v.verb}\\b`, 'i');
                return { ...v, used: regex.test(essayText) };
            });

            s.essay = essayText;
            app.saveState();
            app.updateSprintUI();
        };

        app.handleSprintSubmission = async function () {
            const s = app.state.sprint;
            const lang = app.state.language;

            if (s.status !== 'finished' && s.timer > 0) {
                app.pauseTimer();
            }

            const allUsed = s.mandatoryVerbs.every(v => v.used);
            if (!allUsed) {
                app.showToast(I18N[lang].toast_sprint_submit_fail, 'error');
                return;
            }

            await app.performAction(async () => {
                // 1. Simulate AI Analysis (T009, T015)
                const prompt = `Analyze Essay: ${s.essay}`;
                const analysis = await api.call(prompt, true);

                // 2. Update state with real analysis
                s.analysisResult = analysis;

                // 3. Save to history
                app.state.history.unshift({
                    date: getTodayDateString(),
                    words: s.wordCount,
                    passiveRatio: analysis.precisePassiveRatio,
                    score: parseFloat(analysis.score),
                    omissionRate: null, // Omission rate is calculated in US-2
                    essay: s.essay,
                });

                // Keep only the last 10 records
                app.state.history = app.state.history.slice(0, 10);

                app.saveState();
                app.updateSprintUI();
                app.showToast("Analysis complete! Results saved.", 'success');
            });
        };

        app.renderSprintUI = function () {
            const s = app.state.sprint;
            const lang = app.state.language;
            const timeFormatted = app.formatTime(s.timer);
            const statusText = I18N[lang][`sprint_status_${s.status}`];
            const timerColor = s.timer <= 60 && s.status === 'running' ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-100';
            const isLocked = s.status === 'finished' || s.analysisResult !== null;

            let buttonHTML;
            if (s.status === 'running') {
                buttonHTML = `<button id="sprint-pause-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 dark-mode-transition" data-i18n="sprint_pause">${I18N[lang].sprint_pause}</button>`;
            } else if (s.status === 'paused') {
                buttonHTML = `<button id="sprint-resume-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 dark-mode-transition" data-i18n="sprint_resume">${I18N[lang].sprint_resume}</button>`;
            } else if (s.status === 'ready') {
                buttonHTML = `<button id="sprint-start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 dark-mode-transition" data-i18n="sprint_start">${I18N[lang].sprint_start}</button>`;
            } else { // finished or analyzed
                buttonHTML = `<button disabled class="w-full bg-gray-400 text-white font-semibold py-2.5 px-5 rounded-lg" data-i18n="sprint_feedback_reset">${I18N[lang].sprint_feedback_reset}</button>`;
            }

            // Verb List Rendering
            const verbListHTML = s.mandatoryVerbs.map(v => `
                <li class="flex items-center justify-between p-2 rounded-lg ${v.used ? 'bg-green-50 dark:bg-green-900/50' : 'bg-gray-50 dark:bg-gray-700'} transition duration-150">
                    <span class="font-medium ${v.used ? 'text-green-700 dark:text-green-300 line-through' : 'text-gray-800 dark:text-gray-200'}">${v.verb}</span>
                    <span class="text-lg">${v.used ? '‚úÖ' : '‚¨ú'}</span>
                </li>
            `).join('');

            // AI Analysis Results Display
            let analysisHTML = '';
            if (s.analysisResult) {
                const res = s.analysisResult;
                analysisHTML = `
                    <div class="app-card mt-6">
                        <h3 class="text-xl font-bold text-indigo-600 mb-4" data-i18n="sprint_feedback_title">${I18N[lang].sprint_feedback_title}</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                                <p class="text-xs text-blue-600 dark:text-blue-300" data-i18n="sprint_feedback_score">${I18N[lang].sprint_feedback_score}</p>
                                <p class="text-2xl font-extrabold text-blue-800 dark:text-blue-100">${res.score}</p>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                                <p class="text-xs text-blue-600 dark:text-blue-300" data-i18n="sprint_feedback_passive_ratio">${I18N[lang].sprint_feedback_passive_ratio}</p>
                                <p class="text-2xl font-extrabold text-blue-800 dark:text-blue-100">${res.precisePassiveRatio}</p>
                            </div>
                        </div>
                        <div class="mt-4 space-y-3">
                            <div>
                                <p class="font-semibold text-gray-700 dark:text-gray-300" data-i18n="sprint_feedback_passive_sentences">${I18N[lang].sprint_feedback_passive_sentences} (${res.passiveSentences.length}):</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 italic">${res.passiveSentences.join('; ')}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 dark:text-gray-300" data-i18n="sprint_feedback_advanced_verbs">${I18N[lang].sprint_feedback_advanced_verbs} (${res.advancedVerbs.length}):</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${res.advancedVerbs.map(v => `${v.verb} (${v.meaning})`).join(', ')}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <h2 class="text-3xl font-bold mb-8 text-gray-900 dark:text-gray-100" data-i18n="sprint_header">${I18N[lang].sprint_header}</h2>
                <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                    <!-- Left Column: Timer and Task -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="app-card text-center">
                            <p class="text-sm font-semibold text-indigo-600 dark:text-indigo-400" id="timer-status">${statusText}</p>
                            <div class="my-4">
                                <span class="timer-font text-7xl font-extrabold ${timerColor}" id="timer-display">${timeFormatted}</span>
                            </div>
                            <div class="flex space-x-2 mt-4" id="timer-controls">
                                ${buttonHTML}
                            </div>
                        </div>

                        <div class="app-card">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-gray-200 dark:border-gray-700" data-i18n="sprint_task_title">${I18N[lang].sprint_task_title} (${s.taskDate})</h3>
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="sprint_topic">${I18N[lang].sprint_topic}</p>
                            <p class="mt-1 text-lg font-bold text-indigo-700 dark:text-indigo-300">${s.topic}</p>
                            
                            <h4 class="mt-4 text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="sprint_verbs">${I18N[lang].sprint_verbs}</h4>
                            <ul id="verb-list" class="mt-2 space-y-1">
                                ${verbListHTML}
                            </ul>
                        </div>
                        
                        <div class="app-card grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs font-medium text-gray-500 dark:text-gray-400" data-i18n="sprint_word_count">${I18N[lang].sprint_word_count}</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100" id="word-count">${s.wordCount}</p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-500 dark:text-gray-400" data-i18n="sprint_passive_mock">${I18N[lang].sprint_passive_mock}</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100" id="passive-ratio-mock">${s.passiveRatioMock}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Writing Editor and Results -->
                    <div class="lg:col-span-2 mt-8 lg:mt-0">
                        <div class="app-card">
                            <textarea id="essay-input" rows="18" placeholder="Start writing your essay here..."
                                class="w-full p-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                                ${isLocked ? 'disabled' : ''}>${s.essay}</textarea>
                            
                            <div class="mt-4">
                                ${s.analysisResult ?
                    `<button disabled class="w-full bg-green-600 text-white font-semibold py-2.5 rounded-lg opacity-70" data-i18n="sprint_submit">${I18N[lang].sprint_submit} (Analyzed)</button>` :
                    `<button id="sprint-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg active:scale-95 disabled:bg-gray-400 dark-mode-transition" ${isLocked ? 'disabled' : ''} data-i18n="sprint_submit">${I18N[lang].sprint_submit}</button>`
                }
                            </div>
                        </div>
                        ${analysisHTML}
                    </div>
                </div>
            `;
        };

        app.updateSprintUI = function () {
            const s = app.state.sprint;
            const lang = app.state.language;

            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = app.formatTime(s.timer);
                timerDisplay.className = `timer-font text-7xl font-extrabold ${s.timer <= 60 && s.status === 'running' ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-100'}`;
            }

            const statusEl = document.getElementById('timer-status');
            if (statusEl) {
                statusEl.textContent = I18N[lang][`sprint_status_${s.status}`];
            }

            const essayInput = document.getElementById('essay-input');
            const submitBtn = document.getElementById('sprint-submit-btn');
            const isLocked = s.status === 'finished' || s.analysisResult !== null;

            if (essayInput) {
                essayInput.value = s.essay;
                essayInput.disabled = isLocked;
            }
            if (submitBtn) {
                submitBtn.disabled = isLocked;
            }

            // Update realtime feedback
            document.getElementById('word-count').textContent = s.wordCount;
            document.getElementById('passive-ratio-mock').textContent = s.passiveRatioMock;

            // Update verb list
            const verbListEl = document.getElementById('verb-list');
            if (verbListEl) {
                verbListEl.innerHTML = s.mandatoryVerbs.map(v => `
                    <li class="flex items-center justify-between p-2 rounded-lg ${v.used ? 'bg-green-50 dark:bg-green-900/50' : 'bg-gray-50 dark:bg-gray-700'} transition duration-150">
                        <span class="font-medium ${v.used ? 'text-green-700 dark:text-green-300 line-through' : 'text-gray-800 dark:text-gray-200'}">${v.verb}</span>
                        <span class="text-lg">${v.used ? '‚úÖ' : '‚¨ú'}</span>
                    </li>
                `).join('');
            }

            app.updateUI();
        };

        app.initSprintListeners = function () {
            document.getElementById('essay-input')?.addEventListener('input', (e) => {
                app.checkVerbUsage(e.target.value);
            });
            document.getElementById('sprint-start-btn')?.addEventListener('click', app.startTimer);
            document.getElementById('sprint-pause-btn')?.addEventListener('click', app.pauseTimer);
            document.getElementById('sprint-resume-btn')?.addEventListener('click', app.startTimer);
            document.getElementById('sprint-submit-btn')?.addEventListener('click', () => app.performAction(app.handleSprintSubmission));
        };

        // --- US-2: Blind Write-back System Logic ---

        app.loadBlindWriteSource = function () {
            const lastSuccessfulSprint = app.state.history.find(h => h.essay && h.score);
            if (lastSuccessfulSprint) {
                app.state.blind.sourceEssay = lastSuccessfulSprint.essay;
            } else {
                app.state.blind.sourceEssay = I18N[app.state.language].toast_blind_no_source;
            }
            // Reset UI state
            app.state.blind.isRevealed = false;
            app.state.blind.omissionRate = null;
            app.state.blind.rewriteEssay = '';
            app.state.blind.diagnosis = null;
            app.saveState();
            app.updateBlindWriteUI();
        };

        app.calculateOmissionPercentage = function (originalText, userText) {
            const originalWords = originalText.toLowerCase().match(/\b\w+\b/g) || [];
            const userWords = userText.toLowerCase().match(/\b\w+\b/g) || [];

            if (originalWords.length === 0) return { percentage: 0, markedHtml: userText };

            let omissionCount = 0;
            let markedHtml = '';
            let userIndex = 0;

            // Simplified word-level comparison (not a full Levenshtein, just marking words missing or mismatched)
            for (let i = 0; i < originalWords.length; i++) {
                const originalWord = originalWords[i];
                let found = false;

                // Look ahead a few words in the user text to allow for minor reordering/insertions
                for (let j = userIndex; j < Math.min(userWords.length, userIndex + 5); j++) {
                    if (userWords[j] === originalWord) {
                        // Match found, skip the matched words in user text
                        userIndex = j + 1;
                        found = true;
                        break;
                    }
                }

                if (!found) {
                    omissionCount++;
                    // Find the word in the original text (case-sensitive for display)
                    const regex = new RegExp(`\\b${originalWord}\\b`, 'i');
                    const match = originalText.match(regex);
                    if (match) {
                        markedHtml += `<span class="omission-mark">${match[0]}</span> `;
                    } else {
                        markedHtml += `<span class="omission-mark">${originalWord}</span> `;
                    }
                } else {
                    // Simple, non-marked word (very crude reconstruction)
                    markedHtml += originalWord + ' ';
                }
            }

            const percentage = (omissionCount / originalWords.length) * 100;
            return { percentage: percentage, markedHtml: markedHtml.trim() };
        };

        app.gradeBlindWrite = async function () {
            const b = app.state.blind;
            if (!b.sourceEssay || b.sourceEssay === I18N[app.state.language].toast_blind_no_source) {
                app.showToast(I18N[app.state.language].toast_blind_no_source, 'error');
                return;
            }

            if (!b.isRevealed) {
                b.isRevealed = true;
                app.updateBlindWriteUI();
                return;
            }

            await app.performAction(async () => {
                const result = app.calculateOmissionPercentage(b.sourceEssay, b.rewriteEssay);
                b.omissionRate = result.percentage.toFixed(2);

                // Simulate AI Diagnosis
                const prompt = `Blind Write Diagnosis: Original: ${b.sourceEssay.substring(0, 100)}... | Rewrite: ${b.rewriteEssay.substring(0, 100)}...`;
                b.diagnosis = await api.call(prompt);

                // Update history with omission rate
                if (app.state.history.length > 0) {
                    app.state.history[0].omissionRate = parseFloat(b.omissionRate);
                }

                app.saveState();
                app.updateBlindWriteUI();
                app.showToast("Grading complete!", 'success');
            });
        };

        app.renderBlindWriteUI = function () {
            const b = app.state.blind;
            const lang = app.state.language;

            let sourceContent;
            if (b.isRevealed) {
                const omissionResult = b.omissionRate !== null ? app.calculateOmissionPercentage(b.sourceEssay, b.rewriteEssay) : { markedHtml: b.sourceEssay };
                sourceContent = `<div class="whitespace-pre-wrap text-gray-800 dark:text-gray-200">${omissionResult.markedHtml}</div>`;
            } else {
                sourceContent = `
                    <div class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-95 rounded-xl transition duration-500">
                        <button id="reveal-btn" class="text-white text-lg font-semibold bg-indigo-600 hover:bg-indigo-700 py-3 px-6 rounded-lg shadow-xl active:scale-95" data-i18n="blind_reveal">${I18N[lang].blind_reveal}</button>
                    </div>
                    <div class="text-gray-800 dark:text-gray-200 opacity-5 whitespace-pre-wrap">${b.sourceEssay}</div>
                `;
            }

            let resultHTML = '';
            if (b.omissionRate !== null) {
                const isPass = parseFloat(b.omissionRate) < 2.0;
                const statusClass = isPass ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300';

                resultHTML = `
                    <div class="app-card mt-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xl font-bold" data-i18n="blind_omission_rate">${I18N[lang].blind_omission_rate}</h4>
                            <span class="text-3xl font-extrabold ${isPass ? 'text-green-600' : 'text-red-600'}">${b.omissionRate}%</span>
                        </div>
                        <div class="p-3 rounded-lg ${statusClass} text-center font-semibold">
                            ${isPass ? I18N[lang].blind_pass : I18N[lang].blind_fail}
                        </div>
                        <h4 class="mt-4 font-bold text-gray-700 dark:text-gray-300" data-i18n="blind_diagnosis">${I18N[lang].blind_diagnosis} (Mock AI)</h4>
                        <p class="mt-1 text-sm italic text-gray-600 dark:text-gray-400">${b.diagnosis || '... awaiting diagnosis ...'}</p>
                    </div>
                `;
            }

            return `
                <h2 class="text-3xl font-bold mb-8 text-gray-900 dark:text-gray-100" data-i18n="blind_header">${I18N[lang].blind_header}</h2>
                <div class="lg:grid lg:grid-cols-2 lg:gap-8">
                    <!-- Left Column: Source Essay -->
                    <div class="lg:col-span-1">
                        <div class="app-card min-h-[400px]">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-gray-200 dark:border-gray-700" data-i18n="blind_source_title">${I18N[lang].blind_source_title}</h3>
                            <div class="relative min-h-[300px] p-2 overflow-auto text-sm">
                                ${sourceContent}
                            </div>
                        </div>
                        ${resultHTML}
                    </div>

                    <!-- Right Column: Rewrite Input -->
                    <div class="lg:col-span-1 mt-8 lg:mt-0">
                        <div class="app-card">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2 border-gray-200 dark:border-gray-700" data-i18n="blind_write_title">${I18N[lang].blind_write_title}</h3>
                            <textarea id="rewrite-input" rows="18" placeholder="Write the essay from memory here..."
                                class="w-full p-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 resize-none">${b.rewriteEssay}</textarea>
                            
                            <div class="mt-4">
                                <button id="grade-rewrite-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg active:scale-95 dark-mode-transition" data-i18n="blind_grade">${I18N[lang].blind_grade}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        app.updateBlindWriteUI = function () {
            const b = app.state.blind;
            const rewriteInput = document.getElementById('rewrite-input');
            if (rewriteInput) {
                rewriteInput.value = b.rewriteEssay;
            }
            // Re-render the whole content to handle reveal/omission marking logic
            if (app.state.currentTab === 'blind') {
                document.getElementById('content-container').innerHTML = app.renderBlindWriteUI();
                app.initBlindWriteListeners();
            }
            app.updateUI();
        };

        app.initBlindWriteListeners = function () {
            document.getElementById('rewrite-input')?.addEventListener('input', (e) => {
                app.state.blind.rewriteEssay = e.target.value;
                app.saveState();
            });
            document.getElementById('grade-rewrite-btn')?.addEventListener('click', () => app.performAction(app.gradeBlindWrite));
            document.getElementById('reveal-btn')?.addEventListener('click', () => {
                app.state.blind.isRevealed = true;
                app.updateBlindWriteUI();
            });
        };

        // --- US-3: AI Tools Logic ---

        app.handleAITool = async function (toolType) {
            const inputId = `${toolType}-input`;
            const outputId = `${toolType}-output`;
            const inputEl = document.getElementById(inputId);
            const outputEl = document.getElementById(outputId);
            const input = inputEl ? inputEl.value.trim() : '';

            if (!input) {
                app.showToast("Input cannot be empty.", 'error');
                return;
            }

            let prompt = '';
            let isStructured = false;

            switch (toolType) {
                case 'inspiration':
                    prompt = `Inspiration Generator: Topic: ${input}`;
                    isStructured = true;
                    break;
                case 'analyzer':
                    prompt = `Analyze Essay: ${input}`;
                    isStructured = true;
                    break;
                case 'rewriter':
                    prompt = `Band 9 Rewriter: Rewrite this essay: ${input}`;
                    isStructured = false;
                    break;
            }

            await app.performAction(async () => {
                const result = await api.call(prompt, isStructured);

                let outputHtml = '';
                if (isStructured) {
                    if (toolType === 'inspiration') {
                        outputHtml = `
                            <h4 class="font-semibold text-indigo-600">Positive Arguments:</h4>
                            <ul class="list-disc list-inside ml-4">${result.positive.map(p => `<li>${p}</li>`).join('')}</ul>
                            <h4 class="font-semibold text-indigo-600 mt-3">Negative Arguments:</h4>
                            <ul class="list-disc list-inside ml-4">${result.negative.map(n => `<li>${n}</li>`).join('')}</ul>
                            <h4 class="font-semibold text-indigo-600 mt-3">Academic Vocabulary:</h4>
                            <p>${result.vocabulary.join(', ')}</p>
                        `;
                    } else if (toolType === 'analyzer') {
                        outputHtml = `
                            <p class="text-2xl font-bold text-blue-600">Score: ${result.score}</p>
                            <p>Passive Ratio: ${result.precisePassiveRatio}</p>
                            <h4 class="font-semibold mt-3">Passive Sentences:</h4>
                            <ul class="list-disc list-inside ml-4">${result.passiveSentences.map(s => `<li>${s}</li>`).join('')}</ul>
                            <h4 class="font-semibold mt-3">Advanced Verbs:</h4>
                            <ul class="list-disc list-inside ml-4">${result.advancedVerbs.map(v => `<li>${v.verb} (${v.meaning})</li>`).join('')}</ul>
                        `;
                    }
                } else {
                    outputHtml = `<pre class="whitespace-pre-wrap text-sm">${result}</pre>`;
                }

                outputEl.innerHTML = outputHtml;
                app.showToast("AI task completed.", 'success');
            });
        };

        app.renderAIToolsUI = function () {
            const lang = app.state.language;

            const toolCard = (id, titleKey, promptKey, btnKey, isTextarea = true, isGradient = false) => `
                <div class="app-card ${isGradient ? 'bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800' : ''}" id="ai-tool-${id}">
                    <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-4" data-i18n="${titleKey}">${I18N[lang][titleKey]}</h3>
                    
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="${promptKey}">${I18N[lang][promptKey]}</label>
                    ${isTextarea ?
                    `<textarea id="${id}-input" data-ai-input="true" rows="5" class="ai-input-area w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Enter your text here..."></textarea>` :
                    `<input type="text" id="${id}-input" data-ai-input="true" class="ai-input-area w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter topic here...">`
                }
                    
                    <button data-tool-id="${id}" class="tool-run-btn ai-action-btn w-full mt-3 font-semibold py-2 rounded-lg transition duration-150 active:scale-95
                        ${id === 'inspiration' ? 'bg-blue-600 hover:bg-blue-700 text-white' :
                    id === 'analyzer' ? 'bg-blue-50 border border-blue-200 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-300' :
                        'bg-indigo-50 border border-indigo-200 text-indigo-700 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:border-indigo-700 dark:text-indigo-300'}"
                        data-i18n="${btnKey}">${I18N[lang][btnKey]}</button>
                    
                    <div id="${id}-output" data-ai-output="true" class="ai-result-area mt-6 p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg min-h-[100px] bg-white dark:bg-gray-700/50 text-gray-800 dark:text-gray-200">
                        <p class="text-gray-400 dark:text-gray-500 text-sm italic">AI results will appear here...</p>
                    </div>
                </div>
            `;

            return `
                <h2 class="text-3xl font-bold mb-8 text-gray-900 dark:text-gray-100" data-i18n="tools_header">${I18N[lang].tools_header}</h2>
                <div class="grid lg:grid-cols-3 gap-8">
                    ${toolCard('inspiration', 'tool_inspiration_title', 'tool_inspiration_prompt', 'tool_inspiration_generate', false, true)}
                    ${toolCard('analyzer', 'tool_analyzer_title', 'tool_analyzer_prompt', 'tool_analyzer_analyze')}
                    ${toolCard('rewriter', 'tool_rewriter_title', 'tool_rewriter_prompt', 'tool_rewriter_rewrite')}
                </div>
            `;
        };

        app.initAIToolsListeners = function () {
            document.querySelectorAll('.tool-run-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const toolId = e.currentTarget.dataset.toolId;
                    app.handleAITool(toolId);
                });
            });
        };

        // --- US-4: Progress Report Logic ---

        app.calculateBottleneckIndex = function () {
            const history = app.state.history.filter(h => h.omissionRate !== null && h.passiveRatio);
            if (history.length === 0) return { score: 0, advice: [] };

            let totalWeakness = 0;
            let passiveScores = [];
            let omissionScores = [];

            history.forEach(h => {
                const passiveNum = parseFloat(h.passiveRatio); // e.g., 8.5
                const omissionNum = h.omissionRate; // e.g., 5.2

                // Passive weakness: Target 10%. Lower is worse. Max weakness at 0%.
                const passiveWeakness = Math.max(0, 10 - passiveNum) * 0.5;

                // Omission weakness: Target 2%. Higher is worse. 
                const omissionWeakness = Math.max(0, omissionNum - 2) * 1.5;

                totalWeakness += passiveWeakness + omissionWeakness;
                passiveScores.push(passiveNum);
                omissionScores.push(omissionNum);
            });

            const avgPassive = passiveScores.reduce((a, b) => a + b, 0) / passiveScores.length;
            const avgOmission = omissionScores.reduce((a, b) => a + b, 0) / omissionScores.length;

            const bottleneckScore = (totalWeakness / history.length).toFixed(1);

            let advice = [];
            if (avgPassive < 7) {
                advice.push("Increase structural complexity by using more varied sentence structures and subordinate clauses.");
            }
            if (avgOmission > 3) {
                advice.push("Focus on vocabulary retention. Use the Blind Write-back system daily.");
            }
            if (parseFloat(bottleneckScore) > 5) {
                advice.push("Your current method shows high volatility. Try focusing on one weakness area per week.");
            }

            return { score: bottleneckScore, advice: advice.length > 0 ? advice : ["Maintain current momentum. Focus on increasing average word count."], passive: avgPassive, omission: avgOmission };
        };

        app.renderHistoryTable = function () {
            const lang = app.state.language;
            const history = app.state.history;
            const tableBody = document.getElementById('history-table-body');

            if (!tableBody) return;

            if (history.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No history records yet.</td></tr>`;
                return;
            }

            tableBody.innerHTML = history.map(h => {
                const omissionDisplay = h.omissionRate !== null ? `${h.omissionRate}%` : 'N/A';
                const omissionClass = h.omissionRate !== null && h.omissionRate > 2 ? 'text-red-600 font-semibold' : 'text-green-600';

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition duration-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${h.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${h.score || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm ${omissionClass}">${omissionDisplay}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${h.passiveRatio || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        };

        app.renderRadarChart = function () {
            const chartContainer = document.getElementById('radar-chart-container');
            if (!chartContainer) return;

            const { passive, omission } = app.calculateBottleneckIndex();

            // Normalize values for a 0-10 scale radar chart
            // Passive: Target 10 (good). Range 0-15. 
            // Omission: Target 0 (good). Range 0-10.
            const passiveNormalized = Math.min(10, passive || 0);
            const omissionNormalized = 10 - Math.min(10, omission || 0); // Invert: 10 is good, 0 is bad.

            // Mock 4 axes: Vocabulary (Omission), Structure (Passive), Cohesion (Mock 7), Task Response (Mock 8)
            const V = omissionNormalized;
            const S = passiveNormalized;
            const C = 7;
            const T = 8;

            const size = 300;
            const center = size / 2;
            const radius = size / 2 - 20;

            // Convert polar coordinates (angle, value) to Cartesian (x, y)
            const angleToPoint = (angle, value) => {
                const a = angle * (Math.PI / 180);
                const r = (value / 10) * radius;
                return {
                    x: center + r * Math.cos(a),
                    y: center + r * Math.sin(a)
                };
            };

            // Points for 4 axes (0 deg = right, 90 deg = top)
            // T=45, S=135, V=225, C=315 (Starting from top-right, counter-clockwise)
            const points = [
                angleToPoint(45, T), // Task Response (T)
                angleToPoint(135, S), // Structure (S)
                angleToPoint(225, V), // Vocabulary (V)
                angleToPoint(315, C)  // Cohesion (C)
            ];

            const pointString = points.map(p => `${p.x},${p.y}`).join(' ');

            const svg = `
                <svg viewBox="0 0 ${size} ${size}" class="w-full h-full">
                    <!-- Grid Lines (Mock) -->
                    <g stroke="#e5e7eb" stroke-width="1" fill="none" class="dark:stroke-gray-700">
                        <circle cx="${center}" cy="${center}" r="${radius * 0.25}" />
                        <circle cx="${center}" cy="${center}" r="${radius * 0.5}" />
                        <circle cx="${center}" cy="${center}" r="${radius * 0.75}" />
                        <circle cx="${center}" cy="${center}" r="${radius}" />
                        <line x1="${center}" y1="${center}" x2="${points[0].x}" y2="${points[0].y}" />
                        <line x1="${center}" y1="${center}" x2="${points[1].x}" y2="${points[1].y}" />
                        <line x1="${center}" y1="${center}" x2="${points[2].x}" y2="${points[2].y}" />
                        <line x1="${center}" y1="${center}" x2="${points[3].x}" y2="${points[3].y}" />
                    </g>

                    <!-- Data Polygon -->
                    <polygon points="${pointString}" fill="#4f46e5" fill-opacity="0.6" stroke="#4f46e5" stroke-width="2" />
                    
                    <!-- Labels -->
                    <text x="${angleToPoint(45, 10).x + 5}" y="${angleToPoint(45, 10).y}" font-size="12" fill="#1f2937" class="dark:fill-gray-100">Task Response</text>
                    <text x="${angleToPoint(135, 10).x - 5}" y="${angleToPoint(135, 10).y}" text-anchor="end" font-size="12" fill="#1f2937" class="dark:fill-gray-100">Structure</text>
                    <text x="${angleToPoint(225, 10).x - 5}" y="${angleToPoint(225, 10).y + 15}" text-anchor="end" font-size="12" fill="#1f2937" class="dark:fill-gray-100">Vocabulary</text>
                    <text x="${angleToPoint(315, 10).x + 5}" y="${angleToPoint(315, 10).y + 15}" font-size="12" fill="#1f2937" class="dark:fill-gray-100">Cohesion</text>
                </svg>
            `;
            chartContainer.innerHTML = svg;
        };

        app.renderProgressReportUI = function () {
            const lang = app.state.language;
            const { score, advice } = app.calculateBottleneckIndex();

            const adviceHTML = advice.map(a => `
                <li class="flex items-start">
                    <svg class="flex-shrink-0 w-5 h-5 text-indigo-500 mt-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    <p class="ml-3 text-sm text-gray-700 dark:text-gray-300">${a}</p>
                </li>
            `).join('');

            return `
                <h2 class="text-3xl font-bold mb-8 text-gray-900 dark:text-gray-100" data-i18n="report_header">${I18N[lang].report_header}</h2>
                <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                    <!-- Left/Center Column: Chart and Bottleneck -->
                    <div class="lg:col-span-2 space-y-8">
                        <div class="app-card">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">IELTS Skill Radar</h3>
                            <div id="radar-chart-container" class="w-full h-[300px] flex items-center justify-center">
                                <!-- SVG Radar Chart will be injected here -->
                            </div>
                        </div>

                        <div class="app-card">
                            <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-4 border-b pb-2 border-gray-200 dark:border-gray-700" data-i18n="report_bottleneck_title">${I18N[lang].report_bottleneck_title}</h3>
                            <div class="flex items-baseline mb-4">
                                <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mr-2" data-i18n="report_bottleneck_score">${I18N[lang].report_bottleneck_score}:</p>
                                <span class="text-4xl font-extrabold text-red-700 dark:text-red-300">${score}</span>
                            </div>
                            
                            <h4 class="font-bold text-gray-700 dark:text-gray-300 mt-4 mb-2" data-i18n="report_bottleneck_advice">${I18N[lang].report_bottleneck_advice} (Mock AI):</h4>
                            <ul class="space-y-3">
                                ${adviceHTML}
                            </ul>
                        </div>
                    </div>

                    <!-- Right Column: History Table -->
                    <div class="lg:col-span-1 mt-8 lg:mt-0">
                        <div class="app-card">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700" data-i18n="report_history_title">${I18N[lang].report_history_title}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-800">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="report_history_date">${I18N[lang].report_history_date}</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="report_history_score">${I18N[lang].report_history_score}</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="report_history_omission">${I18N[lang].report_history_omission}</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="report_history_passive">${I18N[lang].report_history_passive}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <!-- History rows injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };


        // --- Initialization and Event Setup ---

        function init() {
            app.loadState();

            // Apply dark mode immediately
            app.toggleDarkMode(app.state.darkMode);

            // Initialize API Key input
            document.getElementById('api-key-input').value = app.state.apiKey;
            document.getElementById('language-select').value = app.state.language;

            // Setup Navigation Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => app.switchTab(e.target.dataset.tab));
            });

            // Setup Settings Modal with backdrop click to close
            const settingsModal = document.getElementById('settings-modal');
            document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
            document.getElementById('close-settings-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));

            // Close modal when clicking on backdrop
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal || e.target.classList.contains('bg-opacity-75')) {
                    settingsModal.classList.add('hidden');
                }
            });

            // Settings Listeners
            document.getElementById('dark-mode-toggle').addEventListener('click', () => app.toggleDarkMode());
            document.getElementById('language-select').addEventListener('change', (e) => {
                app.state.language = e.target.value;
                app.saveState();
                app.applyTranslations();
                app.renderContent(); // Rerender content after language change
            });
            document.getElementById('api-key-input').addEventListener('input', (e) => {
                app.state.apiKey = e.target.value;
                api.apiKey = e.target.value;
                app.saveState();
            });
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if (confirm(I18N[app.state.language].settings_clear_data + '? Are you sure?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                }
            });

            // Initial render
            app.applyTranslations();
            app.renderContent();

            // Resume timer if running
            if (app.state.sprint.status === 'running' && app.state.sprint.timer > 0) {
                app.startTimer();
            }
        }

        document.addEventListener("DOMContentLoaded", init);

        // Standardized Test Hook
        window.injectTestRunner = function (runner) {
            // Allow external tools to access the app instance
            runner.app = app;
            console.log("üß™ Test Runner Hook Injected");
        };
    </script>
</body>

</html>