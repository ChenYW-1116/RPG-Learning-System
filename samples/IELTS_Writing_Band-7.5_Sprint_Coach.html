<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS å¯«ä½œ Band-7.5 è¡åˆºæ•™ç·´</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* PUT ALL YOUR CUSTOM CSS HERE */
        .card {
            background-color: #fff;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
            /* border-gray-100 */
            padding: 1.5rem;
            /* p-6 */
        }

        .timer-svg circle {
            transition: stroke-dashoffset 0.35s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .active-tab {
            border-bottom-width: 2px;
            border-color: #4f46e5;
            /* indigo-600 */
            color: #4f46e5;
            /* indigo-600 */
        }

        .devtools-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.95);
            color: white;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- DevTools Security Warning (T010) -->
    <div id="devtools-warning" class="devtools-warning">
        ğŸš¨ å®‰å…¨è­¦å‘Šï¼šæª¢æ¸¬åˆ°é–‹ç™¼è€…å·¥å…·é–‹å•Ÿã€‚æ‰€æœ‰è‰ç¨¿æ•¸æ“šå·²æ¸…é™¤ã€‚è«‹é—œé–‰ DevTools ä»¥ç¹¼çºŒã€‚
    </div>

    <!-- Toast Notification Area -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be injected here -->
    </div>

    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-bold text-indigo-700">IELTS 7.5 è¡åˆºæ•™ç·´</h1>
            <div class="flex items-center space-x-4">
                <button id="settings-btn" class="text-gray-500 hover:text-indigo-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex space-x-4 border-b mb-6">
            <button data-tab="dashboard"
                class="tab-btn text-lg font-medium py-2 px-4 transition active-tab">å„€è¡¨æ¿</button>
            <button data-tab="sprint" class="tab-btn text-lg font-medium py-2 px-4 transition">å‹•è©è¡åˆº (US-1)</button>
            <button data-tab="blind" class="tab-btn text-lg font-medium py-2 px-4 transition">ç›²å¯«å›è­¯ (US-2)</button>
            <button data-tab="mock" class="tab-btn text-lg font-medium py-2 px-4 transition">æ¨¡æ“¬è€ƒè©¦ (US-3)</button>
        </nav>

        <!-- Main Content Area -->
        <div id="content-area">

            <!-- 1. Dashboard View -->
            <div id="view-dashboard" class="tab-content space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Progress Card (T005) -->
                    <div class="card lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 text-indigo-700">8 å¤©è¡åˆºé€²åº¦è¿½è¹¤ (Day 1 - Day 8)</h2>
                        <div id="progress-grid" class="grid grid-cols-4 sm:grid-cols-8 gap-3">
                            <!-- Progress items injected here -->
                        </div>
                        <p class="mt-4 text-sm text-gray-500">ç•¶å‰ç›®æ¨™æ—¥æ•¸: <span id="current-day-display"
                                class="font-bold text-indigo-600">Day 1</span></p>
                    </div>

                    <!-- Bottleneck Index (T016) -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 text-indigo-700">ç“¶é ¸æŒ‡æ•¸ (BI) å ±å‘Š</h2>
                        <div id="bi-score-display" class="text-4xl font-extrabold text-center mb-4">--</div>
                        <p class="text-center text-gray-500 mb-4">æœ€çµ‚æ¨¡æ“¬è€ƒè©¦çµæœ</p>

                        <!-- Score Breakdown (Simulated Bar Chart) -->
                        <div id="score-breakdown-chart" class="h-32 w-full">
                            <!-- SVG Chart injected here -->
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span>TR</span><span>CC</span><span>LR</span><span>GRA</span>
                        </div>
                    </div>
                </div>

                <!-- AI Coach Advice (T017) -->
                <div class="card bg-yellow-50 border-yellow-200">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-700">AI æ•™ç·´å»ºè­° (Gemini æ¨¡æ“¬)</h2>
                    <p id="ai-advice" class="text-gray-700 italic">
                        å®Œæˆæ¨¡æ“¬è€ƒè©¦å¾Œï¼ŒAI æ•™ç·´å°‡æ ¹æ“šæ‚¨çš„ BI åˆ†æ•¸æä¾›å€‹äººåŒ–åˆ†æå’Œæ”¹é€²å»ºè­°ã€‚
                    </p>
                </div>
            </div>

            <!-- 2. Sprint Training View (US-1) -->
            <div id="view-sprint" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-bold text-indigo-700">å‹•è©è¡åˆºè¨“ç·´ (15 åˆ†é˜)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Timer and Goals -->
                    <div class="card lg:col-span-1 flex flex-col items-center justify-center space-y-4">
                        <div id="timer-container" class="w-32 h-32 relative">
                            <!-- SVG Timer (T006) -->
                            <svg class="timer-svg w-full h-full" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="5"></circle>
                                <circle id="timer-progress" cx="50" cy="50" r="45" fill="none" stroke="#4f46e5"
                                    stroke-width="5" stroke-linecap="round" stroke-dasharray="282.7"
                                    stroke-dashoffset="282.7"></circle>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="sprint-time" class="text-2xl font-bold text-gray-800">15:00</span>
                                <span id="sprint-status" class="text-sm text-gray-500">å¾…å‘½</span>
                            </div>
                        </div>
                        <button id="start-sprint-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition">
                            é–‹å§‹ 15 åˆ†é˜è¡åˆº
                        </button>
                    </div>

                    <!-- Goals and Metrics -->
                    <div class="card lg:col-span-2 space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">æœ¬æ¬¡è¡åˆºç›®æ¨™ (SC001)</h3>
                        <div class="space-y-3">
                            <p class="flex justify-between items-center">
                                <span class="font-medium">ç›®æ¨™æ™‚é–“:</span>
                                <span class="text-indigo-600 font-bold">15 åˆ†é˜å…§å®Œæˆ</span>
                            </p>
                            <p class="flex justify-between items-center">
                                <span class="font-medium">è¢«å‹•èªæ…‹æ¯”ä¾‹ (T008):</span>
                                <span id="passive-ratio-target" class="font-bold text-red-600">â‰¥ 30%</span>
                            </p>
                        </div>

                        <!-- Academic Verbs (T007) -->
                        <div class="p-4 border rounded bg-gray-50">
                            <h4 class="font-semibold mb-2">ç›®æ¨™å­¸è¡“å‹•è© (6 å€‹):</h4>
                            <div id="academic-verbs" class="flex flex-wrap gap-2">
                                <!-- Verbs injected here -->
                            </div>
                        </div>

                        <p class="text-sm text-gray-500">
                            <span id="passive-ratio-current" class="font-bold text-red-600">ç•¶å‰è¢«å‹•èªæ…‹æ¯”ä¾‹: 0.00%</span>
                        </p>
                    </div>
                </div>

                <!-- Writing Area -->
                <div class="card">
                    <textarea id="sprint-draft" rows="12"
                        class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="è«‹åœ¨æ­¤è™•é–‹å§‹æ‚¨çš„ IELTS å¯«ä½œ Task 2 è¡åˆº..."></textarea>
                    <div class="flex justify-end mt-4">
                        <button id="submit-sprint-btn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition disabled:bg-gray-400"
                            disabled>
                            æäº¤è¡åˆºçµæœ (T009)
                        </button>
                    </div>
                </div>

                <!-- Web Lock Warning (A2 Fix) -->
                <div id="web-lock-warning"
                    class="p-3 bg-yellow-100 border border-yellow-300 rounded text-sm text-yellow-800 hidden">
                    âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´ Web Lock APIã€‚ç‚ºç¢ºä¿è¨ˆæ™‚æº–ç¢ºï¼Œè«‹å‹¿åœ¨è¡åˆºæœŸé–“åˆ‡æ›åˆ†é æˆ–æœ€å°åŒ–è¦–çª—ã€‚
                </div>
            </div>

            <!-- 3. Blind Translation View (US-2) -->
            <div id="view-blind" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-bold text-indigo-700">ç›²å¯«å›è­¯ç·´ç¿’</h2>

                <!-- Input Area -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">1. è²¼ä¸Šè‹±æ–‡åŸæ–‡</h3>
                    <div class="relative">
                        <textarea id="blind-original" rows="8"
                            class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none bg-transparent"
                            placeholder="è²¼ä¸Šæ‚¨è¦ç·´ç¿’å›è­¯çš„è‹±æ–‡åŸæ–‡..."></textarea>
                        <!-- Masking Layer (T010) -->
                        <div id="blind-mask"
                            class="absolute inset-0 bg-gray-900 bg-opacity-90 rounded-lg hidden flex items-center justify-center">
                            <span class="text-white text-xl font-bold">åŸæ–‡å·²é®è”½ï¼Œè«‹é–‹å§‹å›è­¯</span>
                        </div>
                    </div>
                    <div class="flex justify-end mt-3">
                        <button id="toggle-mask-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded active:scale-95 transition">
                            é®è”½åŸæ–‡ (T010)
                        </button>
                    </div>
                </div>

                <!-- Translation and Metrics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-3">2. è¼¸å…¥ä¸­æ–‡ç¿»è­¯</h3>
                        <textarea id="blind-translation" rows="6"
                            class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="è¼¸å…¥æ‚¨çš„ä¸­æ–‡ç¿»è­¯..."></textarea>
                        <div class="flex space-x-3 mt-3">
                            <button id="start-recording-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded active:scale-95 transition flex-grow">
                                ğŸ¤ é–‹å§‹éŒ„éŸ³ (T011 æ¨¡æ“¬)
                            </button>
                            <button id="stop-recording-btn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded active:scale-95 transition flex-grow"
                                disabled>
                                åœæ­¢éŒ„éŸ³
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-lg font-semibold mb-3">3. å›è­¯èˆ‡æ¯”å°</h3>
                        <button id="perform-retranslation-btn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition w-full mb-4">
                            åŸ·è¡Œå›è­¯èˆ‡æ¯”å° (T012)
                        </button>

                        <div id="omission-result" class="p-4 border rounded" style="display: none;">
                            <p class="text-sm font-medium mb-2">éºæ¼ç‡ç›®æ¨™ (SC002): <span class="font-bold text-green-600">â‰¤
                                    3%</span></p>
                            <p class="text-2xl font-bold flex justify-between items-center">
                                éºæ¼ç‡: <span id="omission-rate-display" class="text-red-600">--</span>
                            </p>
                            <p id="omission-feedback" class="mt-2 text-sm italic text-gray-700">
                                <!-- Feedback text -->
                            </p>
                        </div>

                        <div id="simulated-retranslation" class="mt-4 p-3 bg-gray-50 border rounded text-sm hidden">
                            <h4 class="font-semibold mb-1">æ¨¡æ“¬å›è­¯æ–‡æœ¬ (DeepL):</h4>
                            <p id="retranslated-text" class="text-gray-700 italic"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Mock Exam View (US-3) -->
            <div id="view-mock" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-bold text-indigo-700">æ¨¡æ“¬è€ƒè©¦ (Task 2)</h2>

                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-lg font-semibold">è€ƒè©¦å‰©é¤˜æ™‚é–“ (FR007): <span id="mock-time"
                                class="text-red-600 font-bold">40:00</span></h3>
                        <button id="start-mock-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded active:scale-95 transition">
                            é–‹å§‹è€ƒè©¦
                        </button>
                    </div>

                    <div class="p-4 bg-gray-50 border rounded mb-4">
                        <h4 class="font-semibold mb-2">IELTS Task 2 æç¤º:</h4>
                        <p class="text-gray-700 italic">
                            Some people believe that the best way to improve public health is by increasing the number
                            of sports facilities. Others, however, believe that this is not enough and that other
                            measures are required. Discuss both these views and give your own opinion.
                        </p>
                    </div>

                    <textarea id="mock-draft" rows="15"
                        class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="è«‹åœ¨æ­¤è™•å¯«ä½œæ‚¨çš„æ¨¡æ“¬è€ƒè©¦æ–‡ç« ... (å…§å®¹æœƒè‡ªå‹•å„²å­˜ T014)"></textarea>

                    <div class="flex justify-between items-center mt-4">
                        <p class="text-sm text-gray-500">å­—æ•¸: <span id="mock-word-count">0</span></p>
                        <button id="submit-mock-btn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition disabled:bg-gray-400"
                            disabled>
                            æäº¤ä¸¦è©•åˆ† (T015)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (T004) -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white max-w-md w-full p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">ç³»çµ±è¨­å®šèˆ‡ API å¯†é‘°</h2>

            <div class="space-y-4">
                <div>
                    <label for="gemini-key" class="block text-sm font-medium text-gray-700">Gemini API Key (AI
                        æ•™ç·´)</label>
                    <input type="password" id="gemini-key"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">æœªæä¾›å¯†é‘°æ™‚ï¼Œå°‡ä½¿ç”¨æœ¬åœ°æ¨¡æ“¬è©•åˆ†ã€‚</p>
                </div>
                <div>
                    <label for="deepl-key" class="block text-sm font-medium text-gray-700">DeepL API Key (å›è­¯æ¯”å°)</label>
                    <input type="password" id="deepl-key"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Spelling Toggle (T021) -->
                <div class="flex items-center justify-between pt-2 border-t">
                    <span class="text-sm font-medium text-gray-700">æ‹¼å¯«ç¿’æ…£ (T021)</span>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="spelling" value="british" id="spelling-british"
                                class="form-radio text-indigo-600" checked>
                            <span class="ml-2 text-sm">è‹±å¼</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="spelling" value="american" id="spelling-american"
                                class="form-radio text-indigo-600">
                            <span class="ml-2 text-sm">ç¾å¼</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-settings-btn"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    å–æ¶ˆ
                </button>
                <button id="save-settings-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg active:scale-95 transition">
                    å„²å­˜è¨­å®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // PUT ALL YOUR JAVASCRIPT LOGIC HERE
        // DATA, STATE, FUNCTIONS, EVENTS - EVERYTHING

        // --- 1. Global Constants and Data ---
        const STORAGE_KEY = 'ieltsCoachState_v1';
        const CIRCUMFERENCE = 2 * Math.PI * 45; // For SVG Timer (r=45)

        const ACADEMIC_VERBS_POOL = [
            "analyze", "assess", "contribute", "demonstrate", "derive", "establish",
            "examine", "facilitate", "illustrate", "imply", "indicate", "interpret",
            "justify", "maintain", "obtain", "perceive", "predict", "propose",
            "reflect", "reinforce", "replicate", "resolve", "suggest", "synthesize",
            "undertake", "validate", "vary", "yield", "conceptualize", "differentiate"
        ];

        const PASSIVE_RATIO_TARGET = 0.30;
        const OMISSION_RATE_TARGET = 0.03;

        // --- 2. Utility Functions and UI Components ---

        /**
         * Toast Notification System
         */
        class Toast {
            static show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');

                let bgColor, icon;
                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-500';
                        icon = 'âœ…';
                        break;
                    case 'error':
                        bgColor = 'bg-red-500';
                        icon = 'âŒ';
                        break;
                    case 'warning':
                        bgColor = 'bg-yellow-500';
                        icon = 'âš ï¸';
                        break;
                    case 'info':
                    default:
                        bgColor = 'bg-indigo-500';
                        icon = 'â„¹ï¸';
                        break;
                }

                toast.className = `p-4 rounded-lg shadow-lg text-white ${bgColor} transition-all transform translate-y-2 opacity-0`;
                toast.innerHTML = `<div class="flex items-center space-x-2">${icon}<span>${message}</span></div>`;

                container.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-y-2', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-2', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        /**
         * Action Wrapper for Loading States (Pillar 2)
         */
        async function performAction(buttonId, actionFn, loadingText = 'â³ è™•ç†ä¸­...') {
            const button = document.getElementById(buttonId);
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = loadingText;

            try {
                await actionFn();
            } catch (error) {
                Toast.show(`æ“ä½œå¤±æ•—: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        /**
         * Simple Word Counter
         */
        function countWords(text) {
            if (!text) return 0;
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        /**
         * Heuristic Passive Voice Detector (T008)
         */
        function calculatePassiveRatio(text) {
            if (!text) return 0;
            const words = countWords(text);
            if (words === 0) return 0;

            // Simple regex to find common passive structures: [to be verb] + [past participle]
            // This is a simulation/heuristic, not a perfect NLP solution.
            const passiveRegex = /\b(is|are|was|were|be|been|being)\s+([a-z]+ed|known|done|seen|taken|given)\b/gi;
            const matches = text.match(passiveRegex);

            const passiveCount = matches ? matches.length : 0;

            // Assume each match represents a passive clause, which might be 3-5 words long.
            // We estimate the ratio based on the number of passive constructions found.
            return Math.min(1, passiveCount * 4 / words);
        }

        // --- 3. Data Service (API Simulation) ---

        class DataService {
            constructor(app) {
                this.app = app;
            }

            // T007: Select 6 random academic verbs
            selectAcademicVerbs() {
                const shuffled = ACADEMIC_VERBS_POOL.sort(() => 0.5 - Math.random());
                return shuffled.slice(0, 6);
            }

            // T012: Simulate DeepL Re-translation and Omission Rate
            async simulateReTranslation(originalText, chineseTranslation) {
                await new Promise(resolve => setTimeout(resolve, 800)); // Simulate API latency

                const originalWords = countWords(originalText);
                const translationLength = chineseTranslation.length;

                // Heuristic: Longer Chinese translation implies more detail, leading to better re-translation.
                // If the Chinese translation is too short (e.g., < 10% of original word count), simulate high omission.
                if (translationLength < originalWords * 2) {
                    const omissionRate = Math.min(0.5, 0.1 + Math.random() * 0.1); // High omission
                    const retranslatedText = "The re-translation was incomplete due to missing context in the Chinese version.";
                    return { omissionRate, retranslatedText };
                }

                // Simulate successful re-translation (low omission)
                const omissionRate = Math.random() * 0.02 + 0.01; // 1% to 3%

                // Simulate re-translated text based on original
                const retranslatedText = originalText.substring(0, Math.floor(originalText.length * (1 - omissionRate))) + "... (minor omissions)";

                return { omissionRate, retranslatedText };
            }

            // T015: Simulate AI Scoring
            async simulateAIScoring(essayText) {
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate AI processing time

                const wordCount = countWords(essayText);
                let baseScore = 6.0;

                if (wordCount < 250) {
                    baseScore = 5.0;
                } else if (wordCount > 300) {
                    baseScore = 7.0;
                }

                // Simulate random variation around the base score
                const TR = Math.round((baseScore + Math.random() * 1.5 - 0.5) * 2) / 2; // Task Response
                const CC = Math.round((baseScore + Math.random() * 1.5 - 0.5) * 2) / 2; // Coherence and Cohesion
                const LR = Math.round((baseScore + Math.random() * 1.5 - 0.5) * 2) / 2; // Lexical Resource
                const GRA = Math.round((baseScore + Math.random() * 1.5 - 0.5) * 2) / 2; // Grammatical Range and Accuracy

                // BI Calculation (T015): Weighted average, emphasizing the lowest score as the bottleneck
                const scores = [TR, CC, LR, GRA];
                const minScore = Math.min(...scores);

                // Weighting: 40% minimum score, 60% average score
                const averageScore = scores.reduce((a, b) => a + b, 0) / 4;
                const biScore = (minScore * 0.4 + averageScore * 0.6);

                return {
                    TR: Math.min(9.0, Math.max(5.0, TR)),
                    CC: Math.min(9.0, Math.max(5.0, CC)),
                    LR: Math.min(9.0, Math.max(5.0, LR)),
                    GRA: Math.min(9.0, Math.max(5.0, GRA)),
                    BI: Math.round(biScore * 2) / 2 // Round to nearest 0.5
                };
            }

            // T017: Simulate AI Coach Advice
            async getAICoachAdvice(biReport) {
                await new Promise(resolve => setTimeout(resolve, 500));

                const lowestScore = Math.min(biReport.TR, biReport.CC, biReport.LR, biReport.GRA);
                let advice = "æ‚¨çš„è¡¨ç¾ç©©å®šï¼Œè«‹ç¹¼çºŒä¿æŒï¼";

                if (lowestScore === biReport.TR) {
                    advice = `æ‚¨çš„ç“¶é ¸åœ¨ä»»å‹™å›æ‡‰ (TR: ${biReport.TR})ã€‚è«‹ç¢ºä¿æ–‡ç« å®Œå…¨å›æ‡‰äº†æç¤ºçš„æ‰€æœ‰éƒ¨åˆ†ï¼Œä¸¦æ¸…æ™°è¡¨é”æ‚¨çš„ç«‹å ´ã€‚ç·´ç¿’å¯©é¡Œå’Œåˆ—å¤§ç¶±ã€‚`;
                } else if (lowestScore === biReport.CC) {
                    advice = `æ‚¨çš„ç“¶é ¸åœ¨é€£è²«èˆ‡éŠœæ¥ (CC: ${biReport.CC})ã€‚è«‹åŠ å¼·ä½¿ç”¨é€£æ¥è©ã€æŒ‡ä»£è©ï¼Œä¸¦ç¢ºä¿æ®µè½ä¸»é¡Œå¥æ¸…æ™°ï¼Œé‚è¼¯æµæš¢ã€‚`;
                } else if (lowestScore === biReport.LR) {
                    advice = `æ‚¨çš„ç“¶é ¸åœ¨è©å½™è³‡æº (LR: ${biReport.LR})ã€‚è«‹æ“´å±•æ‚¨çš„å­¸è¡“è©å½™åº«ï¼Œä¸¦å˜—è©¦ä½¿ç”¨æ›´ç²¾ç¢ºã€æ›´å°‘è¦‹çš„è©å½™ï¼Œé¿å…é‡è¤‡ã€‚`;
                } else if (lowestScore === biReport.GRA) {
                    advice = `æ‚¨çš„ç“¶é ¸åœ¨èªæ³•æº–ç¢ºæ€§ (GRA: ${biReport.GRA})ã€‚è«‹å°ˆæ³¨æ–¼æ¸›å°‘åŸºæœ¬èªæ³•éŒ¯èª¤ï¼Œä¸¦ç·´ç¿’ä½¿ç”¨è¤‡é›œå¥å¼ï¼ˆå¦‚å¾å¥ã€å€’è£å¥ï¼‰ä¾†æé«˜åˆ†æ•¸ã€‚`;
                }

                return advice;
            }
        }

        // --- 4. Manager Classes ---

        class BaseManager {
            constructor(app) {
                this.app = app;
            }
        }

        class DashboardManager extends BaseManager {
            render() {
                this.renderProgressGrid();
                this.renderBIReport();
            }

            renderProgressGrid() {
                const grid = document.getElementById('progress-grid');
                grid.innerHTML = '';
                const progress = this.app.state.progress;
                const currentDay = this.app.state.currentDay;

                for (let i = 1; i <= 8; i++) {
                    const dayKey = `Day ${i}`;
                    const status = progress[dayKey] || 'PENDING';

                    let bgColor, icon;
                    if (status === 'SUCCESS') {
                        bgColor = 'bg-green-600';
                        icon = 'âœ…';
                    } else if (status === 'FAIL') {
                        bgColor = 'bg-red-600';
                        icon = 'âŒ';
                    } else {
                        bgColor = 'bg-gray-300';
                        icon = 'â³';
                    }

                    const isCurrent = i === currentDay;
                    const borderClass = isCurrent ? 'ring-4 ring-indigo-300' : '';

                    const item = document.createElement('div');
                    item.className = `flex flex-col items-center justify-center p-2 rounded-lg text-white font-bold transition ${bgColor} ${borderClass}`;
                    item.innerHTML = `
                        <span class="text-xs">Day ${i}</span>
                        <span class="text-xl">${icon}</span>
                    `;
                    grid.appendChild(item);
                }
                document.getElementById('current-day-display').textContent = `Day ${currentDay}`;
            }

            renderBIReport() {
                const report = this.app.state.biReport;
                const biDisplay = document.getElementById('bi-score-display');
                const adviceDisplay = document.getElementById('ai-advice');
                const chartContainer = document.getElementById('score-breakdown-chart');
                chartContainer.innerHTML = '';

                if (report.BI === 0) {
                    biDisplay.textContent = 'N/A';
                    adviceDisplay.textContent = 'å®Œæˆæ¨¡æ“¬è€ƒè©¦å¾Œï¼ŒAI æ•™ç·´å°‡æ ¹æ“šæ‚¨çš„ BI åˆ†æ•¸æä¾›å€‹äººåŒ–åˆ†æå’Œæ”¹é€²å»ºè­°ã€‚';
                    return;
                }

                biDisplay.textContent = report.BI.toFixed(1);
                adviceDisplay.textContent = report.advice;

                // T016: Simulated Bar Chart SVG
                const scores = [
                    { label: 'TR', score: report.TR },
                    { label: 'CC', score: report.CC },
                    { label: 'LR', score: report.LR },
                    { label: 'GRA', score: report.GRA }
                ];

                const maxScore = 9.0;
                const barWidth = 20;
                let svgContent = `<svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full">`;

                scores.forEach((item, index) => {
                    const height = (item.score / maxScore) * 80; // Scale to 80% height
                    const y = 100 - height;
                    const x = 5 + index * 25;
                    const color = item.score >= 7.0 ? '#10b981' : (item.score >= 6.0 ? '#f59e0b' : '#ef4444'); // Green, Yellow, Red

                    svgContent += `
                        <rect x="${x}" y="${y}" width="${barWidth}" height="${height}" fill="${color}" rx="2" ry="2"></rect>
                        <text x="${x + barWidth / 2}" y="${y - 5}" text-anchor="middle" font-size="10" fill="#4b5563">${item.score.toFixed(1)}</text>
                    `;
                });

                svgContent += `</svg>`;
                chartContainer.innerHTML = svgContent;
            }
        }

        class SprintManager extends BaseManager {
            constructor(app) {
                super(app);
                this.timerInterval = null;
                this.timeRemaining = 0; // seconds
                this.totalTime = 15 * 60; // 15 minutes
            }

            init() {
                document.getElementById('start-sprint-btn').addEventListener('click', () => this.startSprint());
                document.getElementById('submit-sprint-btn').addEventListener('click', () => this.submitSprint());
                document.getElementById('sprint-draft').addEventListener('input', () => this.updateMetrics());

                // Check for Web Lock API support (A2 Fix)
                if (typeof navigator.locks === 'undefined') {
                    document.getElementById('web-lock-warning').classList.remove('hidden');
                }

                this.renderGoals();
                this.updateMetrics();
                this.updateTimerDisplay();
            }

            renderGoals() {
                const verbs = this.app.dataService.selectAcademicVerbs();
                this.app.state.sprint.academicVerbs = verbs;
                this.app.saveState();

                const container = document.getElementById('academic-verbs');
                container.innerHTML = verbs.map(v =>
                    `<span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-sm font-medium rounded-full">${v}</span>`
                ).join('');
            }

            updateMetrics() {
                const text = document.getElementById('sprint-draft').value;
                const ratio = calculatePassiveRatio(text);
                const ratioDisplay = document.getElementById('passive-ratio-current');

                ratioDisplay.textContent = `ç•¶å‰è¢«å‹•èªæ…‹æ¯”ä¾‹: ${(ratio * 100).toFixed(2)}%`;

                if (ratio >= PASSIVE_RATIO_TARGET) {
                    ratioDisplay.classList.remove('text-red-600');
                    ratioDisplay.classList.add('text-green-600');
                } else {
                    ratioDisplay.classList.remove('text-green-600');
                    ratioDisplay.classList.add('text-red-600');
                }
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                document.getElementById('sprint-time').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Update SVG progress (T006)
                const offset = CIRCUMFERENCE * (this.timeRemaining / this.totalTime);
                document.getElementById('timer-progress').style.strokeDashoffset = offset;
            }

            startTimer() {
                this.timeRemaining = this.totalTime;
                document.getElementById('sprint-status').textContent = 'é€²è¡Œä¸­...';
                document.getElementById('start-sprint-btn').disabled = true;
                document.getElementById('submit-sprint-btn').disabled = false;

                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();

                    if (this.timeRemaining <= 0) {
                        this.stopTimer(false); // Time's up
                    }
                }, 1000);
            }

            stopTimer(submitted = true) {
                clearInterval(this.timerInterval);
                document.getElementById('start-sprint-btn').disabled = false;
                document.getElementById('submit-sprint-btn').disabled = true;

                if (submitted) {
                    document.getElementById('sprint-status').textContent = 'å·²æäº¤';
                } else {
                    document.getElementById('sprint-status').textContent = 'æ™‚é–“çµæŸ';
                    Toast.show('è¡åˆºæ™‚é–“çµæŸï¼Œæäº¤æŒ‰éˆ•å·²é–å®šã€‚', 'warning');
                }
            }

            startSprint() {
                if (this.timerInterval) return;

                // Reset state and UI
                document.getElementById('sprint-draft').value = '';
                this.renderGoals();
                this.updateMetrics();

                this.startTimer();
                Toast.show('15åˆ†é˜å‹•è©è¡åˆºé–‹å§‹ï¼', 'success');
            }

            async submitSprint() {
                if (this.timeRemaining <= 0) {
                    Toast.show('æäº¤å¤±æ•—ï¼šæ™‚é–“å·²çµæŸã€‚', 'error');
                    return;
                }

                const essayText = document.getElementById('sprint-draft').value;
                const passiveRatio = calculatePassiveRatio(essayText);

                const timePassed = this.totalTime - this.timeRemaining;
                const timeSuccess = timePassed <= this.totalTime;
                const ratioSuccess = passiveRatio >= PASSIVE_RATIO_TARGET;

                this.stopTimer(true);

                if (timeSuccess && ratioSuccess) {
                    Toast.show(`è¡åˆºæˆåŠŸï¼è¢«å‹•èªæ…‹æ¯”ä¾‹ ${(passiveRatio * 100).toFixed(2)}% é”æ¨™ã€‚`, 'success');
                    this.app.updateProgress('SUCCESS');
                } else {
                    let failReason = [];
                    if (!timeSuccess) failReason.push('è¶…æ™‚');
                    if (!ratioSuccess) failReason.push(`è¢«å‹•èªæ…‹æ¯”ä¾‹ (${(passiveRatio * 100).toFixed(2)}%) æœªé”æ¨™ (30%)`);

                    Toast.show(`è¡åˆºå¤±æ•— (${failReason.join(', ')}).`, 'error');
                    this.app.updateProgress('FAIL');
                }

                this.app.dashboardManager.render();
                this.app.switchTab('dashboard');
            }
        }

        class BlindManager extends BaseManager {
            init() {
                document.getElementById('toggle-mask-btn').addEventListener('click', () => this.toggleMask());
                document.getElementById('perform-retranslation-btn').addEventListener('click', () => this.handleRetranslation());
                document.getElementById('start-recording-btn').addEventListener('click', () => this.startRecording());
                document.getElementById('stop-recording-btn').addEventListener('click', () => this.stopRecording());
            }

            toggleMask() {
                const mask = document.getElementById('blind-mask');
                const btn = document.getElementById('toggle-mask-btn');

                if (mask.classList.contains('hidden')) {
                    mask.classList.remove('hidden');
                    btn.textContent = 'é¡¯ç¤ºåŸæ–‡';
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-green-600');
                } else {
                    mask.classList.add('hidden');
                    btn.textContent = 'é®è”½åŸæ–‡ (T010)';
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-red-600');
                }
            }

            startRecording() {
                Toast.show('ğŸ¤ èªéŸ³éŒ„è£½æ¨¡æ“¬é–‹å§‹...', 'info');
                document.getElementById('start-recording-btn').disabled = true;
                document.getElementById('stop-recording-btn').disabled = false;
            }

            stopRecording() {
                Toast.show('âœ… èªéŸ³è½‰æ–‡å­—å®Œæˆ (æ¨¡æ“¬è¼¸å…¥åˆ°ç¿»è­¯å€)', 'success');
                document.getElementById('start-recording-btn').disabled = false;
                document.getElementById('stop-recording-btn').disabled = true;
                // Simulate injecting text
                document.getElementById('blind-translation').value = "é€™æ˜¯ä¸€å€‹æ¨¡æ“¬çš„ä¸­æ–‡ç¿»è­¯ï¼Œç”±èªéŸ³è½‰æ–‡å­—åŠŸèƒ½ç”¢ç”Ÿã€‚å®ƒé€šå¸¸æ¯”æ‰‹å‹•è¼¸å…¥æ›´æµæš¢ï¼Œä½†å¯èƒ½åŒ…å«ä¸€äº›èªæ³•éŒ¯èª¤ã€‚";
            }

            async handleRetranslation() {
                await performAction('perform-retranslation-btn', async () => {
                    const originalText = document.getElementById('blind-original').value.trim();
                    const chineseTranslation = document.getElementById('blind-translation').value.trim();

                    if (!originalText || !chineseTranslation) {
                        throw new Error("è«‹è¼¸å…¥åŸæ–‡å’Œä¸­æ–‡ç¿»è­¯ã€‚");
                    }

                    const { omissionRate, retranslatedText } = await this.app.dataService.simulateReTranslation(originalText, chineseTranslation);

                    this.renderResult(omissionRate, retranslatedText);
                }, 'â³ DeepL å›è­¯ä¸­...');
            }

            renderResult(omissionRate, retranslatedText) {
                const resultDiv = document.getElementById('omission-result');
                const rateDisplay = document.getElementById('omission-rate-display');
                const feedback = document.getElementById('omission-feedback');
                const retranslationDiv = document.getElementById('simulated-retranslation');
                const retranslationText = document.getElementById('retranslated-text');

                resultDiv.style.display = 'block';
                retranslationDiv.classList.remove('hidden');
                retranslationText.textContent = retranslatedText;

                const isSuccess = omissionRate <= OMISSION_RATE_TARGET;
                const ratePercentage = (omissionRate * 100).toFixed(2) + '%';

                rateDisplay.textContent = ratePercentage;

                // Dynamic styling (T013)
                resultDiv.classList.remove('bg-yellow-50', 'bg-green-50', 'border-yellow-300', 'border-green-300');
                rateDisplay.classList.remove('text-red-600', 'text-green-600');

                if (isSuccess) {
                    resultDiv.classList.add('bg-green-50', 'border-green-300');
                    rateDisplay.classList.add('text-green-600');
                    feedback.textContent = `æ­å–œï¼éºæ¼ç‡ ${ratePercentage} é ä½æ–¼ 3% ç›®æ¨™ã€‚æ‚¨çš„è¨˜æ†¶å’Œç¿»è­¯èƒ½åŠ›éå¸¸å„ªç§€ã€‚`;
                    Toast.show('ç›²å¯«å›è­¯æˆåŠŸé”æ¨™ï¼', 'success');
                } else {
                    resultDiv.classList.add('bg-yellow-50', 'border-yellow-300');
                    rateDisplay.classList.add('text-red-600');
                    feedback.textContent = `éºæ¼ç‡ ${ratePercentage} åé«˜ã€‚è«‹ä»”ç´°æ¯”å°åŸæ–‡ï¼ŒåŠ å¼·å°é—œéµè©å½™å’Œå¥å‹çš„è¨˜æ†¶ã€‚`;
                    Toast.show('ç›²å¯«å›è­¯æœªé”æ¨™ï¼Œè«‹åŠ å¼·ç·´ç¿’ã€‚', 'warning');
                }
            }
        }

        class MockManager extends BaseManager {
            constructor(app) {
                super(app);
                this.timerInterval = null;
                this.timeRemaining = 0;
                this.totalTime = 40 * 60; // 40 minutes
            }

            init() {
                document.getElementById('start-mock-btn').addEventListener('click', () => this.startMock());
                document.getElementById('submit-mock-btn').addEventListener('click', () => this.submitMock());
                document.getElementById('mock-draft').addEventListener('input', () => this.handleInput());

                this.loadDraft();
                this.updateTimerDisplay();
            }

            loadDraft() {
                const draft = this.app.state.drafts.mock;
                document.getElementById('mock-draft').value = draft;
                this.updateWordCount(draft);
            }

            handleInput() {
                const text = document.getElementById('mock-draft').value;
                this.updateWordCount(text);
                this.app.state.drafts.mock = text;
                this.app.saveState(); // T014: Auto-save
            }

            updateWordCount(text) {
                const count = countWords(text);
                document.getElementById('mock-word-count').textContent = count;
                document.getElementById('submit-mock-btn').disabled = count < 250;
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                document.getElementById('mock-time').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            startTimer() {
                this.timeRemaining = this.totalTime;
                document.getElementById('start-mock-btn').disabled = true;
                document.getElementById('submit-mock-btn').disabled = false;
                document.getElementById('mock-draft').disabled = false;

                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();

                    if (this.timeRemaining <= 0) {
                        this.stopTimer(false); // Time's up
                    }
                }, 1000);
            }

            stopTimer(submitted = true) {
                clearInterval(this.timerInterval);
                document.getElementById('start-mock-btn').disabled = false;
                document.getElementById('submit-mock-btn').disabled = true;
                document.getElementById('mock-draft').disabled = true;

                if (!submitted) {
                    Toast.show('æ¨¡æ“¬è€ƒè©¦æ™‚é–“çµæŸï¼Œæ–‡ç« å·²è‡ªå‹•æäº¤è©•åˆ†ã€‚', 'warning');
                    this.submitMock(true); // Auto-submit on timeout
                }
            }

            startMock() {
                if (this.timerInterval) return;
                this.startTimer();
                Toast.show('40åˆ†é˜æ¨¡æ“¬è€ƒè©¦é–‹å§‹ï¼', 'success');
            }

            async submitMock(autoSubmit = false) {
                await performAction('submit-mock-btn', async () => {
                    this.stopTimer(true);
                    const essayText = document.getElementById('mock-draft').value;

                    if (countWords(essayText) < 250) {
                        throw new Error("å­—æ•¸ä¸è¶³ 250 å­—ï¼Œç„¡æ³•è©•åˆ†ã€‚");
                    }

                    Toast.show('æ­£åœ¨æ¨¡æ“¬ AI è©•åˆ†ï¼Œè«‹ç¨å€™...', 'info', 2000);
                    const report = await this.app.dataService.simulateAIScoring(essayText);
                    const advice = await this.app.dataService.getAICoachAdvice(report);

                    this.app.state.biReport = { ...report, advice };
                    this.app.saveState();

                    Toast.show(`æ¨¡æ“¬è©•åˆ†å®Œæˆï¼BI åˆ†æ•¸: ${report.BI.toFixed(1)}`, 'success');
                    this.app.dashboardManager.render();
                    this.app.switchTab('dashboard');
                }, 'â³ AI è©•åˆ†ä¸­ (T015)...');
            }
        }

        class SettingsManager extends BaseManager {
            init() {
                document.getElementById('settings-btn').addEventListener('click', () => this.openModal());
                document.getElementById('close-settings-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('save-settings-btn').addEventListener('click', () => this.saveSettings());

                this.loadSettingsToModal();
                this.setupDevToolsDetection();
            }

            openModal() {
                this.loadSettingsToModal();
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('settings-modal').classList.add('flex');
            }

            closeModal() {
                document.getElementById('settings-modal').classList.add('hidden');
                document.getElementById('settings-modal').classList.remove('flex');
            }

            loadSettingsToModal() {
                const settings = this.app.state.settings;
                document.getElementById('gemini-key').value = settings.geminiKey;
                document.getElementById('deepl-key').value = settings.deeplKey;

                document.getElementById(`spelling-${settings.spelling}`).checked = true;
            }

            saveSettings() {
                this.app.state.settings.geminiKey = document.getElementById('gemini-key').value;
                this.app.state.settings.deeplKey = document.getElementById('deepl-key').value;
                this.app.state.settings.spelling = document.querySelector('input[name="spelling"]:checked').value;

                this.app.saveState();
                this.closeModal();
                Toast.show('è¨­å®šå·²å„²å­˜ã€‚', 'info');
            }

            // T010: DevTools Detection (Security Hardening)
            setupDevToolsDetection() {
                const warningDiv = document.getElementById('devtools-warning');
                let devtoolsOpen = false;

                const checkDevTools = () => {
                    const threshold = 160; // Arbitrary threshold for console log time difference
                    const t1 = performance.now();
                    debugger; // This line often triggers DevTools pause
                    const t2 = performance.now();

                    if (t2 - t1 > threshold) {
                        if (!devtoolsOpen) {
                            devtoolsOpen = true;
                            this.handleDevToolsOpen();
                        }
                    } else {
                        devtoolsOpen = false;
                        warningDiv.style.display = 'none';
                    }
                };

                // Use a combination of checks
                setInterval(checkDevTools, 1000);
                window.addEventListener('resize', checkDevTools);
            }

            handleDevToolsOpen() {
                const warningDiv = document.getElementById('devtools-warning');
                warningDiv.style.display = 'flex';

                // Clear all drafts and state to prevent cheating (T010)
                this.app.state.drafts = { sprint: '', mock: '' };
                this.app.saveState();

                // Reload UI to reflect cleared drafts
                document.getElementById('sprint-draft').value = '';
                document.getElementById('mock-draft').value = '';

                Toast.show('å®‰å…¨ç³»çµ±è§¸ç™¼ï¼šè‰ç¨¿å·²æ¸…é™¤ã€‚', 'error', 5000);
            }
        }

        // --- 5. Main Application Class ---

        class IELTSCoachApp {
            constructor() {
                this.defaultState = {
                    currentDay: 1,
                    progress: {}, // { 'Day 1': 'SUCCESS', 'Day 2': 'PENDING', ... }
                    drafts: {
                        sprint: '',
                        mock: ''
                    },
                    settings: {
                        geminiKey: '',
                        deeplKey: '',
                        spelling: 'british'
                    },
                    biReport: {
                        TR: 0, CC: 0, LR: 0, GRA: 0, BI: 0, advice: ''
                    }
                };
                this.state = this.loadState();

                this.dataService = new DataService(this);
                this.dashboardManager = new DashboardManager(this);
                this.sprintManager = new SprintManager(this);
                this.blindManager = new BlindManager(this);
                this.mockManager = new MockManager(this);
                this.settingsManager = new SettingsManager(this);

                this.activeTab = 'dashboard';
            }

            loadState() {
                try {
                    const storedState = localStorage.getItem(STORAGE_KEY);
                    if (storedState) {
                        const parsedState = JSON.parse(storedState);
                        // Merge stored state with defaults to ensure new properties exist
                        return { ...this.defaultState, ...parsedState };
                    }
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                }
                return this.defaultState;
            }

            saveState() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            }

            init() {
                this.setupEventListeners();
                this.dashboardManager.render();
                this.sprintManager.init();
                this.blindManager.init();
                this.mockManager.init();
                this.settingsManager.init();
                this.switchTab(this.activeTab);

                // Inject test runner if available (T019)
                if (window.injectTestRunner) {
                    window.injectTestRunner(this);
                }
            }

            setupEventListeners() {
                document.querySelectorAll('.tab-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tab = e.target.getAttribute('data-tab');
                        this.switchTab(tab);
                    });
                });
            }

            switchTab(tabName) {
                this.activeTab = tabName;

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`view-${tabName}`).classList.remove('hidden');

                document.querySelectorAll('.tab-btn').forEach(button => {
                    button.classList.remove('active-tab');
                    button.classList.remove('text-indigo-600');
                    if (button.getAttribute('data-tab') === tabName) {
                        button.classList.add('active-tab');
                    }
                });

                // Re-render relevant components on switch
                if (tabName === 'dashboard') {
                    this.dashboardManager.render();
                } else if (tabName === 'sprint') {
                    this.sprintManager.renderGoals();
                    this.sprintManager.updateMetrics();
                } else if (tabName === 'mock') {
                    this.mockManager.loadDraft();
                }
            }

            updateProgress(status) {
                const dayKey = `Day ${this.state.currentDay}`;
                this.state.progress[dayKey] = status;

                if (status === 'SUCCESS' && this.state.currentDay < 8) {
                    this.state.currentDay++;
                }
                this.saveState();
            }
        }

        // --- 6. Initialization ---
        const app = new IELTSCoachApp();
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // --- 7. E2E Test System Injection (T019) ---
        window.injectTestRunner = function (runner) {
            console.log("ğŸ§ª E2E Test Runner Injected.");
            // Expose app instance to runner
            runner.app = app;
        };
    </script>
</body>

</html>