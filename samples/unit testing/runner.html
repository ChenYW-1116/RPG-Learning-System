<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Prompt Unit Test Runner (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 p-8 h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col gap-6">

        <!-- Header -->
        <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
            <h1 class="text-xl font-bold text-gray-800">ğŸ§ª Phase 2 Prompt Unit Test</h1>
            <div class="flex gap-2">
                <input type="password" id="api-key" class="border p-2 rounded text-sm w-64"
                    placeholder="Paste Gemini API Key Here...">
                <button onclick="runTest()"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">ğŸš€ Run
                    Test</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-2 gap-6 flex-grow min-h-0">

            <!-- Left: Inputs -->
            <div class="flex flex-col gap-4">
                <div class="bg-white p-4 rounded-lg shadow-sm flex-grow flex flex-col">
                    <label class="font-bold text-gray-700 mb-2">Input Spec (Reverse Spec)</label>
                    <textarea id="spec-input"
                        class="w-full flex-grow border p-3 rounded font-mono text-xs bg-gray-50 focus:ring-2 ring-indigo-500 outline-none resize-none"></textarea>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm h-1/3 flex flex-col">
                    <label class="font-bold text-gray-700 mb-2">Logs</label>
                    <div id="logs"
                        class="w-full flex-grow border p-3 rounded font-mono text-xs bg-black text-green-400 overflow-y-auto">
                    </div>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-gray-700">Result Preview</label>
                    <button onclick="downloadHtml()" id="btn-download"
                        class="text-xs bg-gray-200 px-2 py-1 rounded hidden">Download HTML</button>
                </div>
                <iframe id="preview-frame" class="w-full flex-grow border rounded bg-white"></iframe>
            </div>

        </div>
    </div>

    <script>
        // Load default spec
        const defaultSpec = `çµæ§‹åŒ–å¯«ä½œè¨“ç·´èˆ‡æ•ˆèƒ½è¿½è¹¤ç³»çµ±åŠŸèƒ½æè¿°

ç¨‹å¼éœ€æ±‚æè¿°

é€™æ˜¯ä¸€å€‹å°ˆæ¥­ç´šçš„ç¶²é æ‡‰ç”¨ç¨‹å¼ï¼Œæ—¨åœ¨æä¾›çµæ§‹åŒ–å¯«ä½œè¨“ç·´å’Œæ•ˆèƒ½æ•¸æ“šè¿½è¹¤ã€‚æ‡‰ç”¨ç¨‹å¼æ¡ç”¨ç°¡æ½”çš„æ·ºè‰²ä¸»é¡Œé…åˆé›è—è‰²ï¼ˆIndigoï¼‰ä½œç‚ºä¸»è¦å¼·èª¿è‰²ï¼Œä¸¦åˆ©ç”¨ Tailwind CSS å¯¦ç¾å¿«é€ŸéŸ¿æ‡‰å¼ä½ˆå±€å’Œç¾ä»£åŒ–çš„ç”¨æˆ¶ä»‹é¢ã€‚

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

æœ¬ç³»çµ±åŒ…å«ä¸‰å€‹ä¸»è¦åŠŸèƒ½æ¨¡çµ„ï¼Œé€šéå°èˆªæ¬„é€²è¡Œåˆ‡æ›ï¼šå‹•è©è¡åˆºã€ç›²å¯«å›è­¯ã€æ•ˆèƒ½å„€è¡¨æ¿ã€‚

ğŸ“ åœ‹éš›åŒ–èˆ‡é€šç”¨åŠŸèƒ½ (I18N)

*   **å¤šèªè¨€æ”¯æ´ï¼š** å…§å»ºç¹é«”ä¸­æ–‡ (zh-TW) å’Œè‹±æ–‡ (en) å…©ç¨®èªè¨€çš„ç¿»è­¯è³‡æºåº«ã€‚
*   **åˆ‡æ›æ©Ÿåˆ¶ï¼š** é€šéè¨­å®šæ¨¡æ…‹è¦–çª—ä¸­çš„ä¸‹æ‹‰é¸å–® (#lang-switcher) é€²è¡Œèªè¨€åˆ‡æ›ã€‚
*   **æ¨™ç±¤ç¶å®šï¼š** æ‰€æœ‰å¯ç¿»è­¯çš„ UI å…ƒç´ å‡ä½¿ç”¨ data-i18n å±¬æ€§èˆ‡ JavaScript ä¸­çš„ translations ç‰©ä»¶é€²è¡Œç¶å®šã€‚
*   **é€šçŸ¥ä¸­å¿ƒ (Toast)ï¼š** é é¢å³ä¸‹è§’å›ºå®šé¡¯ç¤ºé€šçŸ¥è¨Šæ¯ï¼ˆæˆåŠŸã€éŒ¯èª¤ã€è™•ç†ä¸­ã€é›¢ç·šæ¨¡å¼ç­‰ï¼‰ã€‚

â±ï¸ æ¨¡çµ„ä¸€ï¼šå‹•è©è¡åˆº (Verb Sprint)

*   **ç›®æ¨™è¨­å®šï¼š** é è¨­ç›®æ¨™ç‚º 15 åˆ†é˜å…§ä½¿ç”¨è‡³å°‘ 6 å€‹æ–°å‹•è©ï¼Œä¸”è¢«å‹•èªæ…‹æ¯”ä¾‹ â‰¥ 30%ã€‚
*   **è¨ˆæ™‚å™¨æ§åˆ¶ï¼š**
    *   é¡¯ç¤ºå™¨ï¼šå¤§å‹å­—é«”é¡¯ç¤ºå‰©é¤˜æ™‚é–“ï¼ˆé è¨­ 15:00ï¼‰ã€‚
    *   æ“ä½œæŒ‰éˆ•ï¼šæä¾›ã€Œé–‹å§‹è¡åˆºã€ï¼ˆç¶ è‰²ï¼‰ã€**ã€Œæš«åœã€**ï¼ˆé»ƒè‰²ï¼‰ã€**ã€Œé‡è¨­ã€**ï¼ˆç´…è‰²ï¼‰ä¸‰ç¨®æ§åˆ¶ã€‚
*   **å‹•è©è¿½è¹¤ï¼š**
    *   è¼¸å…¥ä»‹é¢ï¼šå¤šè¡Œæ–‡å­—è¼¸å…¥æ¡†ï¼Œç”¨æ–¼è¼¸å…¥ä½¿ç”¨çš„å‹•è©æ¸…å–®ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰ã€‚
    *   å³æ™‚ç‹€æ…‹ï¼šé¡¯ç¤ºã€Œæ‰€éœ€æ–°å‹•è©æ•¸é‡ã€ï¼ˆé è¨­ 6ï¼‰å’Œã€Œè¢«å‹•èªæ…‹é è¦½ã€ï¼ˆé è¨­ 0.0%ï¼‰ã€‚
*   **æ•¸æ“šæ•´åˆ (Grammarly)ï¼š**
    *   è¼¸å…¥ä»‹é¢ï¼šæä¾›ä¸€å€‹æ–‡å­—æ¡†ç”¨æ–¼è²¼ä¸Š Grammarly è¼¸å‡ºçš„ JSON æ ¼å¼çµæœã€‚
    *   è™•ç†åŠŸèƒ½ï¼šæŒ‰éˆ•ç”¨æ–¼ã€Œå®Œæˆæ¯”å°ä¸¦è¨ˆç®—éºæ¼ç‡ã€ï¼Œè™•ç† JSON æ•¸æ“šä»¥è¨ˆç®—æœ€çµ‚çš„è¢«å‹•èªæ…‹æ¯”ä¾‹ã€‚

ğŸ“š æ¨¡çµ„äºŒï¼šç›²å¯«å›è­¯ (Blind Retranslation)

*   **ä¸‰æ¬„è¼¸å…¥ï¼š** æ¡ç”¨ä¸‰æ¬„ä½ˆå±€ï¼Œåˆ†åˆ¥ç”¨æ–¼è¼¸å…¥ï¼š
    1.  åŸå§‹è‹±æ–‡ (Original English)
    2.  ä¸­æ–‡å£è­¯/ç­†è¨˜ (Chinese Interpretation/Notes)
    3.  å›è­¯è‹±æ–‡ (Retranslated English)
*   **éš±è—æ©Ÿåˆ¶ï¼š** æä¾›ã€Œåˆ‡æ›éš±è—/é¡¯ç¤ºåŸå§‹æ–‡æœ¬ã€æŒ‰éˆ•ï¼Œç”¨æ–¼åœ¨è¨“ç·´éç¨‹ä¸­éš±è—åŸå§‹è‹±æ–‡æ–‡æœ¬ï¼ˆç¨‹å¼ç¢¼æš—ç¤ºå°‡å°æ‡‰è¼¸å…¥æ¡†æ‡‰ç”¨æ¨¡ç³Šæˆ–éš±è—æ•ˆæœï¼‰ã€‚
*   **æ•ˆèƒ½æŒ‡æ¨™ï¼š** é¡¯ç¤ºã€Œæ•¸æ“šéºæ¼ç‡ (OR)ã€ï¼ˆé è¨­ 0.0%ï¼‰ã€‚
*   **è¨ˆç®—åŠŸèƒ½ï¼š** ã€Œå®Œæˆæ¯”å°ä¸¦è¨ˆç®—éºæ¼ç‡ã€æŒ‰éˆ•ï¼Œç”¨æ–¼è§¸ç™¼å›è­¯æ–‡æœ¬èˆ‡åŸå§‹æ–‡æœ¬çš„æ¯”è¼ƒç®—æ³•ã€‚

ğŸ“ˆ æ¨¡çµ„ä¸‰ï¼šæ•ˆèƒ½å„€è¡¨æ¿ (Dashboard)

*   **æ•¸æ“šéŒ„å…¥ï¼š** æä¾›æ‰‹å‹•éŒ„å…¥æ¨¡æ“¬æ¸¬é©—æˆç¸¾çš„è¡¨å–®ï¼ŒåŒ…æ‹¬ï¼š
    *   æ—¥æœŸ (Date Picker)
    *   Band Score (æ•¸å­—è¼¸å…¥ï¼Œæ­¥é€² 0.5)
    *   Grammarly Issue Count (GIC) (æ•´æ•¸è¼¸å…¥)
    *   Omission Rate (OR) (æ•¸å­—è¼¸å…¥ï¼Œæ­¥é€² 0.1)
    *   æäº¤æŒ‰éˆ•ï¼ˆç¶ è‰²ï¼‰ã€‚
*   **è¶¨å‹¢åœ–è¡¨ï¼š**
    *   æ¨™é¡Œï¼šç“¶é ¸æŒ‡æ•¸ (BI) è¶¨å‹¢åœ–ã€‚
    *   å®¹å™¨ï¼šé ç•™ç©ºé–“ (#bi-chart-container) ä¾›æœªä¾†æ¸²æŸ“åœ–è¡¨ï¼ˆç¨‹å¼ç¢¼è¨»é‡‹æŒ‡å‡ºå°‡æ¸²æŸ“ç°¡å–®çš„ SVG åœ–è¡¨ï¼‰ã€‚
    *   ç›®æ¨™æç¤ºï¼šæç¤º BI < 0.02 ç‚ºç›®æ¨™ç´…ç·šã€‚
    *   **ç‰¹åˆ¥è¦æ±‚**ï¼šé›–ç„¶åŸå§‹ Spec èªªé ç•™ç©ºé–“ï¼Œä½† Phase 2 è¦æ±‚å¿…é ˆå¯¦ä½œ SVG æ¸²æŸ“é‚è¼¯ï¼Œä¸èƒ½ç•™ç™½ã€‚

âš™ï¸ è¨­å®šèˆ‡å‚™ä»½ (Settings Modal)

*   **è§¸ç™¼æ–¹å¼ï¼š** å°èˆªæ¬„å³å´çš„é½’è¼ªåœ–æ¨™æŒ‰éˆ•ã€‚
*   **API é‡‘é‘°ï¼š** è¼¸å…¥æ¬„ä½ç”¨æ–¼è¼¸å…¥ AI API é‡‘é‘°ï¼ˆä½¿ç”¨ password é¡å‹ï¼Œä¸¦è¨»æ˜ Base64 åŠ å¯†ï¼‰ã€‚
*   **èªè¨€åˆ‡æ›ï¼š** ä¸‹æ‹‰é¸å–®ç”¨æ–¼é¸æ“‡èªè¨€ã€‚
*   **æ•¸æ“šç®¡ç†ï¼š** æä¾›ã€Œå„²å­˜è¨­å®šã€ï¼ˆé›è—è‰²ï¼‰å’Œã€Œæ¸…é™¤æ‰€æœ‰è³‡æ–™ã€ï¼ˆç´…è‰²ï¼‰æŒ‰éˆ•ã€‚`;

        document.getElementById('spec-input').value = defaultSpec;

        // Auto-load key from localStorage if available
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) document.getElementById('api-key').value = savedKey;

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'error') div.classList.add('text-red-400');
            if (type === 'success') div.classList.add('text-green-400', 'font-bold');
            document.getElementById('logs').appendChild(div);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        let generatedHtml = "";

        async function runTest() {
            const key = document.getElementById('api-key').value.trim();
            const spec = document.getElementById('spec-input').value.trim();

            if (!key) { alert('Please enter API Key'); return; }
            if (!spec) { alert('Spec is empty'); return; }

            // Save key for convenience
            localStorage.setItem('gemini_api_key', key);

            // ---------------------------------------------------------
            // CONFIGURATION
            // ---------------------------------------------------------
            const LLM_MODEL = 'gemini-2.5-flash-preview-09-2025';
            const SYSTEM_PROMPT = "You are an Elite Full-Stack Engineer specializing in high-performance, self-contained Micro-Applications. You build complex logic within single artifacts.";

            log(`ğŸš€ Starting Phase 2 Test (Model: ${LLM_MODEL})`);
            log(`Spec Length: ${spec.length} chars`);

            // ---------------------------------------------------------
            // STRUCTURAL PROMPT (FORCE INLINING)
            // ---------------------------------------------------------
            const phase2Prompt = `You are a World-Class UI/UX Engineer specialized in Single-File Executables.
            
            Your goal is to implement the SPECIFICATION below into a **SINGLE, SELF-CONTAINED HTML FILE**.
            
            --- ğŸ—ï¸ STRICT FILE STRUCTURE (MANDATORY) ---
            You MUST follow this exact structure. DO NOT create separate files.
            
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <!-- Tailwind CDN -->
                <script src="https://cdn.tailwindcss.com"><\/script>
                <!-- Fonts -->
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; }
                    /* PUT ALL YOUR CUSTOM CSS HERE */
                </style>
            </head>
            <body class="bg-gray-50 text-gray-800">
                <!-- PUT YOUR HTML UI COMPONENTS HERE -->
            
                <script>
                    // PUT ALL YOUR JAVASCRIPT LOGIC HERE
                    // DATA, STATE, FUNCTIONS, EVENTS - EVERYTHING
                <\/script>
            </body>
            </html>
            
            --- ğŸ¨ VISUAL VISUAL REFERENCE (MIMIC THIS EXACTLY) ---
            1. **Colors**: Primary 'bg-indigo-600', Background 'bg-gray-50'.
            2. **Cards**: class="bg-white rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-gray-100 p-6"
            3. **Buttons**: class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95"
            4. **Charts**: Use raw <svg> logic inside the script. NO PLACEHOLDERS.
            
            --- FUNCTIONAL REQUIREMENTS ---
            1. **No External Requests**: Except for Tailwind/Fonts CDN.
            2. **Full Logic**: Implement the complete chart rendering and state management in the <script> block.
            
            --- SPECIFICATION ---
            ${spec || "Implement a full Writing Training System..."}
            
            --- EXECUTION ---
            GENERATE THE HTML CODE NOW. USE THE STRUCTURE ABOVE.`;

            let fullContent = "";
            let isComplete = false;
            let retryCount = 0;
            const maxRetries = 3;

            try {
                let currentPrompt = phase2Prompt;

                while (!isComplete && retryCount < maxRetries) {
                    if (retryCount > 0) {
                        log(`â³ Response truncated, requesting continuation (${retryCount}/${maxRetries})...`, 'warn');
                        const lastChars = fullContent.slice(-500).replace(/\n/g, ' ');
                        currentPrompt = `The previous output was truncated.
Please CONTINUE generating the HTML code EXACTLY from where it stopped.

The last part was:
"...${lastChars}"

INSTRUCTIONS:
1. Do NOT repeat the last part.
2. Start immediately with the next character.
3. Output ONLY the remaining code.`;
                    }

                    // Direct Native Payload
                    const payload = {
                        contents: [{
                            parts: [{ text: currentPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 16383
                        }
                    };

                    // Add System Instruction
                    if (retryCount === 0) {
                        payload.system_instruction = {
                            parts: [{ text: SYSTEM_PROMPT }]
                        };
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        throw new Error(`API Error: ${response.status} - ${errText}`);
                    }

                    const data = await response.json();
                    let chunk = "";

                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        chunk = data.candidates[0].content.parts[0].text;
                    }

                    if (!chunk) throw new Error("No content received from API");

                    // Clean chunk
                    if (retryCount > 0) {
                        chunk = chunk.replace(/^```html\s*/i, '').replace(/^```\s*/i, '');
                    }

                    fullContent += chunk;

                    // Check for completion
                    if (fullContent.includes('</html>')) {
                        isComplete = true;
                        log('âœ… Complete HTML detected.', 'success');
                    } else {
                        retryCount++;
                    }
                }

                // -----------------------------------------------------
                // PARSE CONTENT
                // -----------------------------------------------------

                // Clean Markup
                let cleanCode = fullContent.replace(/<think>[\s\S]*?<\/think>/gi, '');
                const htmlMatch = cleanCode.match(/<!DOCTYPE html>[\s\S]*?<\/html>/i) || cleanCode.match(/<html[\s\S]*?<\/html>/i);

                if (htmlMatch) {
                    generatedHtml = htmlMatch[0].replace(/```html/g, '').replace(/```/g, '').trim();
                    log('âœ… HTML Extracted successfully!', 'success');
                    log(`Size: ${generatedHtml.length} bytes`);

                    // Render to Iframe
                    const iframe = document.getElementById('preview-frame');
                    iframe.srcdoc = generatedHtml;

                    document.getElementById('btn-download').classList.remove('hidden');
                } else {
                    log('âš ï¸ Could not find <!DOCTYPE html> in response.', 'error');
                    console.log(fullContent);
                }

            } catch (e) {
                log(`âŒ Error: ${e.message}`, 'error');
                console.error(e);
            }
        }

        function downloadHtml() {
            if (!generatedHtml) return;
            const blob = new Blob([generatedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'phase2_test_result.html';
            a.click();
        }
    </script>
</body>

</html>