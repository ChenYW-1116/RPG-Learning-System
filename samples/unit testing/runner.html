<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Prompt Unit Test Runner (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 p-8 h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col gap-6">

        <!-- Header -->
        <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
            <h1 class="text-xl font-bold text-gray-800">🧪 Phase 2 Prompt Unit Test</h1>
            <div class="flex gap-2">
                <input type="password" id="api-key" class="border p-2 rounded text-sm w-64"
                    placeholder="Paste Gemini API Key Here...">
                <button onclick="runTest()"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">🚀 Run
                    Test</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-2 gap-6 flex-grow min-h-0">

            <!-- Left: Inputs -->
            <div class="flex flex-col gap-4">
                <div class="bg-white p-4 rounded-lg shadow-sm flex-grow flex flex-col">
                    <label class="font-bold text-gray-700 mb-2">Input Spec (Reverse Spec)</label>
                    <textarea id="spec-input"
                        class="w-full flex-grow border p-3 rounded font-mono text-xs bg-gray-50 focus:ring-2 ring-indigo-500 outline-none resize-none"></textarea>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm h-1/3 flex flex-col">
                    <label class="font-bold text-gray-700 mb-2">Logs</label>
                    <div id="logs"
                        class="w-full flex-grow border p-3 rounded font-mono text-xs bg-black text-green-400 overflow-y-auto">
                    </div>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-gray-700">Result Preview</label>
                    <button onclick="downloadHtml()" id="btn-download"
                        class="text-xs bg-gray-200 px-2 py-1 rounded hidden">Download HTML</button>
                </div>
                <iframe id="preview-frame" class="w-full flex-grow border rounded bg-white"></iframe>
            </div>

        </div>
    </div>

    <script>
        // Load default spec
        const defaultSpec = `結構化寫作訓練與效能追蹤系統功能描述

程式需求描述

這是一個專業級的網頁應用程式，旨在提供結構化寫作訓練和效能數據追蹤。應用程式採用簡潔的淺色主題配合靛藍色（Indigo）作為主要強調色，並利用 Tailwind CSS 實現快速響應式佈局和現代化的用戶介面。

🎯 核心功能需求

本系統包含三個主要功能模組，通過導航欄進行切換：動詞衝刺、盲寫回譯、效能儀表板。

📝 國際化與通用功能 (I18N)

*   **多語言支援：** 內建繁體中文 (zh-TW) 和英文 (en) 兩種語言的翻譯資源庫。
*   **切換機制：** 通過設定模態視窗中的下拉選單 (#lang-switcher) 進行語言切換。
*   **標籤綁定：** 所有可翻譯的 UI 元素均使用 data-i18n 屬性與 JavaScript 中的 translations 物件進行綁定。
*   **通知中心 (Toast)：** 頁面右下角固定顯示通知訊息（成功、錯誤、處理中、離線模式等）。

⏱️ 模組一：動詞衝刺 (Verb Sprint)

*   **目標設定：** 預設目標為 15 分鐘內使用至少 6 個新動詞，且被動語態比例 ≥ 30%。
*   **計時器控制：**
    *   顯示器：大型字體顯示剩餘時間（預設 15:00）。
    *   操作按鈕：提供「開始衝刺」（綠色）、**「暫停」**（黃色）、**「重設」**（紅色）三種控制。
*   **動詞追蹤：**
    *   輸入介面：多行文字輸入框，用於輸入使用的動詞清單（每行一個）。
    *   即時狀態：顯示「所需新動詞數量」（預設 6）和「被動語態預覽」（預設 0.0%）。
*   **數據整合 (Grammarly)：**
    *   輸入介面：提供一個文字框用於貼上 Grammarly 輸出的 JSON 格式結果。
    *   處理功能：按鈕用於「完成比對並計算遺漏率」，處理 JSON 數據以計算最終的被動語態比例。

📚 模組二：盲寫回譯 (Blind Retranslation)

*   **三欄輸入：** 採用三欄佈局，分別用於輸入：
    1.  原始英文 (Original English)
    2.  中文口譯/筆記 (Chinese Interpretation/Notes)
    3.  回譯英文 (Retranslated English)
*   **隱藏機制：** 提供「切換隱藏/顯示原始文本」按鈕，用於在訓練過程中隱藏原始英文文本（程式碼暗示將對應輸入框應用模糊或隱藏效果）。
*   **效能指標：** 顯示「數據遺漏率 (OR)」（預設 0.0%）。
*   **計算功能：** 「完成比對並計算遺漏率」按鈕，用於觸發回譯文本與原始文本的比較算法。

📈 模組三：效能儀表板 (Dashboard)

*   **數據錄入：** 提供手動錄入模擬測驗成績的表單，包括：
    *   日期 (Date Picker)
    *   Band Score (數字輸入，步進 0.5)
    *   Grammarly Issue Count (GIC) (整數輸入)
    *   Omission Rate (OR) (數字輸入，步進 0.1)
    *   提交按鈕（綠色）。
*   **趨勢圖表：**
    *   標題：瓶頸指數 (BI) 趨勢圖。
    *   容器：預留空間 (#bi-chart-container) 供未來渲染圖表（程式碼註釋指出將渲染簡單的 SVG 圖表）。
    *   目標提示：提示 BI < 0.02 為目標紅線。
    *   **特別要求**：雖然原始 Spec 說預留空間，但 Phase 2 要求必須實作 SVG 渲染邏輯，不能留白。

⚙️ 設定與備份 (Settings Modal)

*   **觸發方式：** 導航欄右側的齒輪圖標按鈕。
*   **API 金鑰：** 輸入欄位用於輸入 AI API 金鑰（使用 password 類型，並註明 Base64 加密）。
*   **語言切換：** 下拉選單用於選擇語言。
*   **數據管理：** 提供「儲存設定」（靛藍色）和「清除所有資料」（紅色）按鈕。`;

        document.getElementById('spec-input').value = defaultSpec;

        // Auto-load key from localStorage if available
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) document.getElementById('api-key').value = savedKey;

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'error') div.classList.add('text-red-400');
            if (type === 'success') div.classList.add('text-green-400', 'font-bold');
            document.getElementById('logs').appendChild(div);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        let generatedHtml = "";

        async function runTest() {
            const key = document.getElementById('api-key').value.trim();
            const spec = document.getElementById('spec-input').value.trim();

            if (!key) { alert('Please enter API Key'); return; }
            if (!spec) { alert('Spec is empty'); return; }

            // Save key for convenience
            localStorage.setItem('gemini_api_key', key);

            // ---------------------------------------------------------
            // CONFIGURATION
            // ---------------------------------------------------------
            const LLM_MODEL = 'gemini-3-flash-preview';
            const SYSTEM_PROMPT = "You are an Elite Full-Stack Engineer specializing in high-performance, self-contained Micro-Applications. You build complex logic within single artifacts.";

            log(`🚀 Starting Phase 2 Test (Model: ${LLM_MODEL})`);
            log(`Spec Length: ${spec.length} chars`);

            // ---------------------------------------------------------
            // STRUCTURAL PROMPT (FORCE INLINING)
            // ---------------------------------------------------------
            const phase2Prompt = `You are a World-Class UI/UX Engineer specialized in Single-File Executables.
            
            Your goal is to implement the SPECIFICATION below into a **SINGLE, SELF-CONTAINED HTML FILE**.
            
            --- 🏗️ STRICT FILE STRUCTURE (MANDATORY) ---
            You MUST follow this exact structure. DO NOT create separate files.
            
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <!-- Tailwind CDN -->
                <script src="https://cdn.tailwindcss.com"><\/script>
                <!-- Fonts -->
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; }
                    /* PUT ALL YOUR CUSTOM CSS HERE */
                </style>
            </head>
            <body class="bg-gray-50 text-gray-800">
                <!-- PUT YOUR HTML UI COMPONENTS HERE -->
            
                <script>
                    // PUT ALL YOUR JAVASCRIPT LOGIC HERE
                    // DATA, STATE, FUNCTIONS, EVENTS - EVERYTHING
                <\/script>
            </body>
            </html>
            
            --- 🎨 VISUAL VISUAL REFERENCE (MIMIC THIS EXACTLY) ---
            1. **Colors**: Primary 'bg-indigo-600', Background 'bg-gray-50'.
            2. **Cards**: class="bg-white rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-gray-100 p-6"
            3. **Buttons**: class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95"
            4. **Charts**: Use raw <svg> logic inside the script. NO PLACEHOLDERS.
            
            --- FUNCTIONAL REQUIREMENTS ---
            1. **No External Requests**: Except for Tailwind/Fonts CDN.
            2. **Full Logic**: Implement the complete chart rendering and state management in the <script> block.
            
            --- SPECIFICATION ---
            ${spec || "Implement a full Writing Training System..."}
            
            --- EXECUTION ---
            GENERATE THE HTML CODE NOW. USE THE STRUCTURE ABOVE.`;

            let fullContent = "";
            let isComplete = false;
            let retryCount = 0;
            const maxRetries = 3;

            try {
                let currentPrompt = phase2Prompt;

                while (!isComplete && retryCount < maxRetries) {
                    if (retryCount > 0) {
                        log(`⏳ Response truncated, requesting continuation (${retryCount}/${maxRetries})...`, 'warn');
                        const lastChars = fullContent.slice(-500).replace(/\n/g, ' ');
                        currentPrompt = `The previous output was truncated.
Please CONTINUE generating the HTML code EXACTLY from where it stopped.

The last part was:
"...${lastChars}"

INSTRUCTIONS:
1. Do NOT repeat the last part.
2. Start immediately with the next character.
3. Output ONLY the remaining code.`;
                    }

                    // Direct Native Payload
                    const payload = {
                        contents: [{
                            parts: [{ text: currentPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 16383
                        }
                    };

                    // Add System Instruction
                    if (retryCount === 0) {
                        payload.system_instruction = {
                            parts: [{ text: SYSTEM_PROMPT }]
                        };
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        throw new Error(`API Error: ${response.status} - ${errText}`);
                    }

                    const data = await response.json();
                    let chunk = "";

                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        chunk = data.candidates[0].content.parts[0].text;
                    }

                    if (!chunk) throw new Error("No content received from API");

                    // Clean chunk
                    if (retryCount > 0) {
                        chunk = chunk.replace(/^```html\s*/i, '').replace(/^```\s*/i, '');
                    }

                    fullContent += chunk;

                    // Check for completion
                    if (fullContent.includes('</html>')) {
                        isComplete = true;
                        log('✅ Complete HTML detected.', 'success');
                    } else {
                        retryCount++;
                    }
                }

                // -----------------------------------------------------
                // PARSE CONTENT
                // -----------------------------------------------------

                // Clean Markup
                let cleanCode = fullContent.replace(/<think>[\s\S]*?<\/think>/gi, '');
                const htmlMatch = cleanCode.match(/<!DOCTYPE html>[\s\S]*?<\/html>/i) || cleanCode.match(/<html[\s\S]*?<\/html>/i);

                if (htmlMatch) {
                    generatedHtml = htmlMatch[0].replace(/```html/g, '').replace(/```/g, '').trim();
                    log('✅ HTML Extracted successfully!', 'success');
                    log(`Size: ${generatedHtml.length} bytes`);

                    // Render to Iframe
                    const iframe = document.getElementById('preview-frame');
                    iframe.srcdoc = generatedHtml;

                    document.getElementById('btn-download').classList.remove('hidden');
                } else {
                    log('⚠️ Could not find <!DOCTYPE html> in response.', 'error');
                    console.log(fullContent);
                }

            } catch (e) {
                log(`❌ Error: ${e.message}`, 'error');
                console.error(e);
            }
        }

        function downloadHtml() {
            if (!generatedHtml) return;
            const blob = new Blob([generatedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'phase2_test_result.html';
            a.click();
        }
    </script>
</body>

</html>