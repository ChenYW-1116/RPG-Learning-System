<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS 寫作衝刺教練 | Single-File Micro-App</title>
    <!-- PWA Preparation (T001) -->
    <meta name="theme-color" content="#4f46e5"> 
    <!-- Tailwind CDN (T002) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* PUT ALL YOUR CUSTOM CSS HERE */
        .blind-mask {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
            transition: filter 0.3s ease;
        }
        .omitted {
            background-color: #fecaca; /* Red-200 */
            color: #b91c1c; /* Red-700 */
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            display: inline;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 1.5em;
            height: 1.5em;
            animation: spinner 0.6s linear infinite;
        }
        .card {
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 8px 30px rgba(0,0,0,0.04);
            border: 1px solid #f3f4f6; /* border-gray-100 */
            padding: 1.5rem; /* p-6 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    
    <!-- Settings Modal (Hidden by Default) -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300" onclick="app.handlers.closeSettings(event)">
        <div class="bg-white max-w-md w-full rounded-xl p-6 shadow-2xl transform transition-all duration-300" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-indigo-700 mb-4" data-i18n="settings_title">設定</h3>
            
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700" data-i18n="settings_api_key">AI 服務 API Key (T005)</label>
                    <input type="text" id="api-key-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="sk-..." oninput="app.handlers.updateSetting('apiKey', this.value)">
                    <p class="mt-1 text-xs text-gray-500" data-i18n="settings_api_key_desc">用於 AI 診斷和分析。留空則使用本地模擬。</p>
                </div>

                <div>
                    <label for="target-score-input" class="block text-sm font-medium text-gray-700" data-i18n="settings_target_score">目標寫作分數 (A2 Fix)</label>
                    <input type="number" step="0.5" min="5.0" max="9.0" id="target-score-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" oninput="app.handlers.updateSetting('targetScore', parseFloat(this.value))">
                </div>

                <div>
                    <label for="language-select" class="block text-sm font-medium text-gray-700" data-i18n="settings_language">語言 (T016)</label>
                    <select id="language-select" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="app.handlers.changeLanguage(this.value)">
                        <option value="zh-TW">繁體中文</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="app.handlers.closeSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition duration-150" data-i18n="settings_close">關閉</button>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- Header and Navigation -->
        <header class="sticky top-0 z-40 bg-white rounded-xl shadow-md mb-6">
            <div class="flex justify-between items-center p-4">
                <h1 class="text-2xl font-bold text-indigo-700">IELTS 衝刺教練</h1>
                <div class="flex items-center space-x-4">
                    <span id="day-counter" class="text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded-full">Day 1</span>
                    <button onclick="app.handlers.openSettings()" class="text-gray-500 hover:text-indigo-600 transition" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <nav class="flex border-t border-gray-100">
                <button onclick="app.router.navigate('dashboard')" id="nav-dashboard" class="flex-1 py-3 text-center text-sm font-medium transition duration-150 border-b-2 border-transparent hover:bg-gray-50 text-gray-600" data-i18n="nav_dashboard">儀表板</button>
                <button onclick="app.router.navigate('writing')" id="nav-writing" class="flex-1 py-3 text-center text-sm font-medium transition duration-150 border-b-2 border-transparent hover:bg-gray-50 text-gray-600" data-i18n="nav_writing">流程圖盲寫</button>
                <button onclick="app.router.navigate('review')" id="nav-review" class="flex-1 py-3 text-center text-sm font-medium transition duration-150 border-b-2 border-transparent hover:bg-gray-50 text-gray-600" data-i18n="nav_review">回譯與診斷</button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main id="app-content" class="space-y-6">
            <!-- Content will be injected here by JavaScript -->
        </main>
        
        <!-- Toast Notification Area -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // PUT ALL YOUR JAVASCRIPT LOGIC HERE
        // DATA, STATE, FUNCTIONS, EVENTS - EVERYTHING

        // --- T016: Internationalization Dictionary ---
        const i18n = {
            'zh-TW': {
                nav_dashboard: '儀表板',
                nav_writing: '流程圖盲寫',
                nav_review: '回譯與診斷',
                settings_title: '設定',
                settings_api_key: 'AI 服務 API Key (T005)',
                settings_api_key_desc: '用於 AI 診斷和分析。留空則使用本地模擬。',
                settings_target_score: '目標寫作分數',
                settings_language: '語言 (T016)',
                settings_close: '關閉',
                dashboard_title: '寫作表現儀表板',
                dashboard_target_score: '目標分數',
                dashboard_current_score: '預估分數',
                dashboard_bottleneck_index: '瓶頸指數 (T013)',
                dashboard_bottleneck_desc: '0.000 (無瓶頸) 到 1.000 (嚴重瓶頸)',
                dashboard_analysis_title: '寫作分析趨勢',
                dashboard_analysis_passive_ratio: '被動句比例',
                dashboard_analysis_omission_rate: '回譯遺漏率',
                dashboard_ai_tools_title: 'AI 輔助工具',
                dashboard_ai_inspiration: 'AI 寫作靈感助手',
                dashboard_ai_rewriter: 'AI 高階改寫',
                dashboard_history_title: '訓練歷史記錄 (T014)',
                dashboard_history_date: '日期',
                dashboard_history_score: '分數',
                dashboard_history_passive: '被動句%',
                dashboard_history_omission: '遺漏率%',
                dashboard_history_bottleneck: '瓶頸指數',
                dashboard_export_csv: '匯出為 CSV',
                writing_title: 'IELTS Task 1 流程圖盲寫',
                writing_flowchart_desc: '當日流程圖 (T006)',
                writing_timer: '剩餘時間 (T007)',
                writing_blind_mode: '盲寫模式 (T010)',
                writing_blind_mode_toggle: '啟用盲寫模式',
                writing_blind_mode_desc: '啟用後，流程圖和您的寫作將被模糊化。',
                writing_temp_view: '暫時查看 (3s)',
                writing_word_count: '字數統計',
                writing_verb_check_title: '流程動詞檢查 (T009)',
                writing_verb_check_missing: '缺少關鍵動詞:',
                writing_submit: '提交寫作並診斷',
                writing_placeholder: '請在這裡開始您的 Task 1 寫作...',
                review_title: '語音回譯與 AI 診斷',
                review_step1: '步驟 1: 語音回譯 (T011)',
                review_step1_desc: '請朗讀您剛才寫的作文，系統將模擬轉錄。',
                review_start_recording: '開始錄音',
                review_stop_recording: '停止並轉錄',
                review_transcribed_text: '轉錄結果',
                review_step2: '步驟 2: 差異分析 (T012)',
                review_omission_rate: '遺漏率',
                review_omission_desc: '轉錄結果中遺漏的詞彙會高亮顯示。',
                review_step3: '步驟 3: AI 診斷 (T008)',
                review_diagnosis_title: 'AI 盲寫表現診斷',
                review_diagnosis_placeholder: '請先完成寫作和回譯步驟以獲得診斷結果。',
                review_diagnosis_passive: '被動句比例',
                review_diagnosis_score: '預估分數',
                review_diagnosis_vocab: '進階詞彙使用',
                review_diagnosis_feedback: 'AI 性能反饋',
                toast_timer_warning: '計時器：剩餘不足 60 秒！',
                toast_timer_ended: '計時結束！寫作已自動提交。',
                toast_submission_success: '寫作提交成功！請前往「回譯與診斷」頁面。',
                toast_submission_fail: '提交失敗：寫作內容不能為空。',
                toast_api_error: 'API 服務錯誤。正在使用本地模擬分析。',
                toast_transcription_start: '模擬錄音開始...',
                toast_transcription_end: '模擬轉錄完成。',
                toast_copied: '內容已複製到剪貼簿。',
            },
            'en': {
                nav_dashboard: 'Dashboard',
                nav_writing: 'Flowchart Writing',
                nav_review: 'Review & Diagnosis',
                settings_title: 'Settings',
                settings_api_key: 'AI Service API Key (T005)',
                settings_api_key_desc: 'Used for AI diagnosis and analysis. Leave blank for local simulation.',
                settings_target_score: 'Target Writing Score',
                settings_language: 'Language (T016)',
                settings_close: 'Close',
                dashboard_title: 'Writing Performance Dashboard',
                dashboard_target_score: 'Target Score',
                dashboard_current_score: 'Estimated Score',
                dashboard_bottleneck_index: 'Bottleneck Index (T013)',
                dashboard_bottleneck_desc: '0.000 (No bottleneck) to 1.000 (Severe bottleneck)',
                dashboard_analysis_title: 'Writing Analysis Trends',
                dashboard_analysis_passive_ratio: 'Passive Ratio',
                dashboard_analysis_omission_rate: 'Omission Rate',
                dashboard_ai_tools_title: 'AI Auxiliary Tools',
                dashboard_ai_inspiration: 'AI Inspiration Generator',
                dashboard_ai_rewriter: 'AI Advanced Rewriter',
                dashboard_history_title: 'Training History (T014)',
                dashboard_history_date: 'Date',
                dashboard_history_score: 'Score',
                dashboard_history_passive: 'Passive %',
                dashboard_history_omission: 'Omission %',
                dashboard_history_bottleneck: 'Bottleneck Index',
                dashboard_export_csv: 'Export to CSV',
                writing_title: 'IELTS Task 1 Flowchart Blind Writing',
                writing_flowchart_desc: 'Flowchart for the Day (T006)',
                writing_timer: 'Time Remaining (T007)',
                writing_blind_mode: 'Blind Writing Mode (T010)',
                writing_blind_mode_toggle: 'Enable Blind Mode',
                writing_blind_mode_desc: 'Flowchart and your writing will be blurred.',
                writing_temp_view: 'Temporary View (3s)',
                writing_word_count: 'Word Count',
                writing_verb_check_title: 'Process Verb Check (T009)',
                writing_verb_check_missing: 'Missing Key Verbs:',
                writing_submit: 'Submit Writing & Diagnose',
                writing_placeholder: 'Start your Task 1 writing here...',
                review_title: 'Voice Retranslation & AI Diagnosis',
                review_step1: 'Step 1: Voice Retranslation (T011)',
                review_step1_desc: 'Read your essay aloud; the system will simulate transcription.',
                review_start_recording: 'Start Recording',
                review_stop_recording: 'Stop & Transcribe',
                review_transcribed_text: 'Transcription Result',
                review_step2: 'Step 2: Difference Analysis (T012)',
                review_omission_rate: 'Omission Rate',
                review_omission_desc: 'Omitted words in the transcription are highlighted.',
                review_step3: 'Step 3: AI Diagnosis (T008)',
                review_diagnosis_title: 'AI Blind Write Performance Diagnosis',
                review_diagnosis_placeholder: 'Complete writing and retranslation steps for diagnosis.',
                review_diagnosis_passive: 'Passive Ratio',
                review_diagnosis_score: 'Estimated Score',
                review_diagnosis_vocab: 'Advanced Vocabulary Usage',
                review_diagnosis_feedback: 'AI Performance Feedback',
                toast_timer_warning: 'Timer: Less than 60 seconds remaining!',
                toast_timer_ended: 'Time is up! Writing automatically submitted.',
                toast_submission_success: 'Writing submitted successfully! Proceed to "Review & Diagnosis".',
                toast_submission_fail: 'Submission failed: Writing content cannot be empty.',
                toast_api_error: 'API service error. Using local simulation analysis.',
                toast_transcription_start: 'Simulated recording started...',
                toast_transcription_end: 'Simulated transcription complete.',
                toast_copied: 'Content copied to clipboard.',
            }
        };

        // --- Application State and Persistence (T015) ---
        const defaultState = {
            currentView: 'dashboard',
            language: 'zh-TW',
            apiKey: '',
            targetScore: 7.5,
            currentDay: 1,
            writing: {
                draft: '',
                isBlindMode: true, // Default to true as per specification context
                timer: 900, // 15 minutes in seconds
                isRunning: false,
                wordCount: 0,
                missingVerbs: [],
                timerInterval: null,
            },
            review: {
                originalText: '',
                transcribedText: '',
                comparisonHtml: '',
                omissionRate: 0,
                diagnosis: {
                    passiveRatio: 0,
                    estimatedScore: 0,
                    vocabUsage: 'N/A',
                    feedback: '',
                },
            },
            history: [], // { date, passiveRatio, omissionRate, score, bottleneckIndex }
        };

        let app = {
            state: JSON.parse(JSON.stringify(defaultState)),
            router: {},
            handlers: {},
            utils: {},
            ui: {},
            data: {},
        };

        // --- Data Mockups ---
        app.data.flowchartVerbs = ['initiates', 'commences', 'transforms', 'culminates', 'recycles', 'enters', 'exits', 'passes', 'converts', 'is heated'];
        app.data.flowchartSVG = `
            <svg viewBox="0 0 500 300" class="w-full h-auto bg-gray-50 rounded-lg p-4 border border-gray-200">
                <style>
                    .node { fill: #e0f2fe; stroke: #3b82f6; stroke-width: 2; }
                    .text { font-family: Inter, sans-serif; font-size: 14px; fill: #1e40af; }
                    .arrow { stroke: #1e40af; stroke-width: 2; marker-end: url(#arrowhead); }
                </style>
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#1e40af" />
                    </marker>
                </defs>

                <!-- Nodes -->
                <rect x="50" y="50" width="100" height="50" class="node" rx="8"/>
                <text x="100" y="80" text-anchor="middle" class="text">Step 1: Raw Material</text>

                <rect x="200" y="50" width="100" height="50" class="node" rx="8"/>
                <text x="250" y="80" text-anchor="middle" class="text">Step 2: Heating</text>

                <rect x="350" y="50" width="100" height="50" class="node" rx="8"/>
                <text x="400" y="80" text-anchor="middle" class="text">Step 3: Cooling</text>

                <rect x="200" y="200" width="100" height="50" class="node" rx="8"/>
                <text x="250" y="230" text-anchor="middle" class="text">Step 4: Final Product</text>

                <!-- Arrows -->
                <line x1="150" y1="75" x2="200" y2="75" class="arrow" />
                <line x1="300" y1="75" x2="350" y2="75" class="arrow" />
                <polyline points="400,100 400,150 250,150 250,200" class="arrow" fill="none"/>
                <line x1="250" y1="250" x2="250" y2="250" class="arrow" />
            </svg>
        `;

        // --- Utility Functions ---

        app.utils.saveState = () => {
            try {
                localStorage.setItem('ieltsCoachState', JSON.stringify(app.state));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        };

        app.utils.loadState = () => {
            try {
                const persistedState = localStorage.getItem('ieltsCoachState');
                if (persistedState) {
                    const loadedState = JSON.parse(persistedState);
                    // Merge loaded state, prioritizing current structure
                    app.state = { ...defaultState, ...loadedState };
                    
                    // Restore draft (Offline draft recovery)
                    if (app.state.writing.draft) {
                        app.utils.showToast(app.utils.i18n('toast_draft_restored', 'Draft restored.'), 'info');
                    }

                    // Ensure timer interval is cleared on load
                    if (app.state.writing.timerInterval) {
                        clearInterval(app.state.writing.timerInterval);
                        app.state.writing.timerInterval = null;
                        app.state.writing.isRunning = false;
                    }

                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                app.state = JSON.parse(JSON.stringify(defaultState));
            }
        };

        app.utils.i18n = (key, fallback = key) => {
            return i18n[app.state.language]?.[key] || fallback;
        };
        
        app.utils.translateUI = () => {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = app.utils.i18n(key, el.textContent);
            });
            // Update placeholder specifically
            const textarea = document.getElementById('writing-textarea');
            if (textarea) {
                textarea.placeholder = app.utils.i18n('writing_placeholder', 'Start your Task 1 writing here...');
            }
            document.getElementById('day-counter').textContent = `Day ${app.state.currentDay}`;
        };

        app.utils.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const colorMap = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg text-white shadow-lg transition-opacity duration-300 ${colorMap[type]}`;
            toast.textContent = message;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        app.utils.calculatePassiveRatioLocal = (text) => {
            if (!text) return 0;
            const sentences = text.match(/[^.!?]+/g) || [];
            if (sentences.length === 0) return 0;

            const passiveRegex = /(is|are|was|were|be|been|being)\s+(a|an|the|of|in|to|for|with|on|at|from|by)?\s*\w+ed\b/gi;
            let passiveCount = 0;

            sentences.forEach(s => {
                if (s.match(passiveRegex)) {
                    passiveCount++;
                }
            });

            // Simulated result based on length and complexity
            const complexityFactor = Math.min(1, text.split(/\s+/).length / 200);
            const baseRatio = Math.random() * 0.15 + 0.15; // 15% to 30%
            
            return Math.min(0.40, baseRatio + (passiveCount / sentences.length) * 0.1 * complexityFactor);
        };

        // Simulated API Wrapper (T005)
        app.utils.GeminiAPIWrapper = {
            call: async (prompt, data) => {
                // Simulate network delay and stability (T005)
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));

                // Simulate API Key failure 10% of the time, or if key is empty
                if (!app.state.apiKey || Math.random() < 0.1) {
                    app.utils.showToast(app.utils.i18n('toast_api_error'), 'error');
                    return app.utils.GeminiAPIWrapper.localFallback(data);
                }

                // Simulate successful AI analysis (T008)
                const passiveRatio = app.utils.calculatePassiveRatioLocal(data.writing);
                const omissionRate = data.omissionRate || 0.15;
                const baseScore = 7.0 - (omissionRate * 2); // Omission affects score
                const estimatedScore = Math.max(5.0, Math.round(baseScore * 2) / 2); // Round to nearest 0.5

                return {
                    passiveRatio: parseFloat(passiveRatio.toFixed(3)),
                    estimatedScore: estimatedScore,
                    vocabUsage: estimatedScore >= 7.0 ? 'Excellent (Band 7+)' : 'Good (Band 6)',
                    feedback: `Based on your ${data.wordCount} words and ${data.omissionRate * 100}% omission rate, your estimated score is ${estimatedScore}. Focus on maintaining structural integrity during recall.`,
                };
            },
            localFallback: (data) => {
                const passiveRatio = app.utils.calculatePassiveRatioLocal(data.writing);
                const omissionRate = data.omissionRate || 0.20;
                const estimatedScore = Math.max(5.0, Math.round((6.5 - (omissionRate * 1.5)) * 2) / 2);

                return {
                    passiveRatio: parseFloat(passiveRatio.toFixed(3)),
                    estimatedScore: estimatedScore,
                    vocabUsage: 'Adequate (Local Estimate)',
                    feedback: 'Local analysis suggests focusing on sentence variation and reducing recall errors.',
                };
            }
        };

        // --- Bottleneck Index Calculation (T013, B2 Fix) ---
        app.utils.calculateBottleneckIndex = (score, target, passiveRatio, omissionRate) => {
            const w1_TA = 0.35; // Task Achievement
            const w2_CC = 0.25; // Coherence and Cohesion
            const w3_LR = 0.25; // Lexical Resource
            const w4_GRA = 0.15; // Grammatical Range and Accuracy

            // 1. TA/GRA Gap (Based on Score difference)
            const scoreGap = Math.max(0, target - score) / 3; // Max gap is 3.0 (9.0 to 6.0)

            // 2. CC Gap (Based on Omission Rate - proxy for structural recall/coherence)
            const ccGap = Math.min(1, omissionRate * 3); // 33% omission -> 1.0 gap

            // 3. LR Gap (Simulated based on score, higher score -> lower gap)
            const lrGap = Math.max(0, (9 - score) / 4); 

            // 4. GRA Gap (Based on passive ratio target 30%)
            const passiveTarget = 0.30;
            const graGap = Math.min(1, Math.abs(passiveTarget - passiveRatio) * 3);

            const bottleneck = (
                w1_TA * scoreGap +
                w2_CC * ccGap +
                w3_LR * lrGap +
                w4_GRA * graGap
            );

            return parseFloat(Math.min(1.0, bottleneck).toFixed(3));
        };

        // --- UI Rendering Functions ---

        app.ui.renderBottleneckChart = (history) => {
            const data = history.slice(-5); // Last 5 entries
            if (data.length === 0) {
                return `<div class="text-center py-10 text-gray-500" data-i18n="dashboard_no_data">No history data available.</div>`;
            }

            const maxIndex = 1.0;
            const barHeight = 20;
            const svgHeight = data.length * (barHeight + 10) + 50;

            let svgContent = `<svg viewBox="0 0 400 ${svgHeight}" xmlns="http://www.w3.org/2000/svg" class="w-full">`;
            svgContent += `<text x="5" y="20" font-weight="bold" fill="#1f2937">${app.utils.i18n('dashboard_bottleneck_index')}</text>`;

            data.forEach((entry, index) => {
                const y = 40 + index * (barHeight + 10);
                const width = (entry.bottleneckIndex / maxIndex) * 350;
                const dateLabel = new Date(entry.date).toLocaleDateString(app.state.language);

                // Background track
                svgContent += `<rect x="50" y="${y}" width="350" height="${barHeight}" fill="#e5e7eb" rx="4" />`;
                
                // Actual bar
                svgContent += `<rect x="50" y="${y}" width="${width}" height="${barHeight}" fill="#4f46e5" rx="4" />`;
                
                // Label (Date)
                svgContent += `<text x="5" y="${y + barHeight / 2 + 5}" font-size="12" fill="#4b5563">${dateLabel}</text>`;
                
                // Value
                svgContent += `<text x="${width + 55}" y="${y + barHeight / 2 + 5}" font-size="12" font-weight="bold" fill="#1f2937">${entry.bottleneckIndex.toFixed(3)}</text>`;
            });

            svgContent += `</svg>`;
            return svgContent;
        };

        // --- Router and View Rendering ---

        app.router.navigate = (view) => {
            app.state.currentView = view;
            app.utils.saveState();
            app.router.renderView();
        };

        app.router.renderView = () => {
            const contentDiv = document.getElementById('app-content');
            let html = '';

            // Update navigation tabs
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            document.getElementById(`nav-${app.state.currentView}`).classList.add('border-indigo-600', 'text-indigo-600');
            document.getElementById(`nav-${app.state.currentView}`).classList.remove('border-transparent', 'text-gray-600');

            if (app.state.currentView === 'dashboard') {
                html = app.ui.renderDashboard();
            } else if (app.state.currentView === 'writing') {
                html = app.ui.renderWriting();
            } else if (app.state.currentView === 'review') {
                html = app.ui.renderReview();
            }

            contentDiv.innerHTML = html;
            app.utils.translateUI(); // Re-translate dynamic content
            
            // Post-render setup for specific views
            if (app.state.currentView === 'writing') {
                app.handlers.updateWritingUI();
                app.handlers.toggleBlindMode(app.state.writing.isBlindMode);
                app.handlers.updateTimerUI();
                if (app.state.writing.isRunning) {
                    app.handlers.startTimer();
                }
            }
            if (app.state.currentView === 'dashboard') {
                document.getElementById('bottleneck-chart').innerHTML = app.ui.renderBottleneckChart(app.state.history);
            }
        };

        // --- UI Templates ---

        app.ui.renderDashboard = () => {
            const latest = app.state.history[app.state.history.length - 1] || { score: 0, passiveRatio: 0, omissionRate: 0, bottleneckIndex: 0 };
            
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6" data-i18n="dashboard_title">寫作表現儀表板</h2>

                <!-- Metrics Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    
                    <!-- Target Score Card -->
                    <div class="card bg-green-600 text-white p-6 shadow-lg">
                        <p class="text-sm font-medium opacity-80" data-i18n="dashboard_target_score">目標分數</p>
                        <p class="text-4xl font-extrabold mt-1">${app.state.targetScore.toFixed(1)}</p>
                    </div>

                    <!-- Estimated Score Card -->
                    <div class="card bg-white text-gray-800 p-6 border border-gray-200">
                        <p class="text-sm font-medium text-gray-500" data-i18n="dashboard_current_score">預估分數 (最新)</p>
                        <p class="text-4xl font-extrabold mt-1 text-indigo-600">${latest.score.toFixed(1)}</p>
                    </div>

                    <!-- Bottleneck Index Card -->
                    <div class="card bg-white text-gray-800 p-6 border border-gray-200">
                        <p class="text-sm font-medium text-gray-500" data-i18n="dashboard_bottleneck_index">瓶頸指數</p>
                        <p class="text-4xl font-extrabold mt-1 text-red-600">${latest.bottleneckIndex.toFixed(3)}</p>
                        <p class="text-xs mt-1 text-gray-500" data-i18n="dashboard_bottleneck_desc">0.000 (無瓶頸) 到 1.000 (嚴重瓶頸)</p>
                    </div>
                </div>

                <!-- Bottleneck Chart and AI Tools -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Bottleneck Chart (T013) -->
                    <div class="card lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700" data-i18n="dashboard_analysis_title">寫作分析趨勢</h3>
                        <div id="bottleneck-chart" class="h-64">
                            <!-- SVG Chart injected here -->
                        </div>
                    </div>

                    <!-- AI Tools (Simulated) -->
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-3" data-i18n="dashboard_ai_tools_title">AI 輔助工具</h3>
                            <p class="text-sm opacity-90 mb-4">即時獲取高分觀點和改寫建議。</p>
                            
                            <button class="w-full bg-white text-indigo-700 font-semibold py-2 rounded-lg hover:bg-gray-100 transition mb-2" onclick="app.handlers.simulateAITool('inspiration')" data-i18n="dashboard_ai_inspiration">
                                AI 寫作靈感助手
                            </button>
                            <button class="w-full bg-indigo-50 text-indigo-700 font-semibold py-2 rounded-lg border border-indigo-200 hover:bg-indigo-100 transition" onclick="app.handlers.simulateAITool('rewriter')" data-i18n="dashboard_ai_rewriter">
                                AI 高階改寫
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Table (T014) -->
                <div class="card mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-indigo-700" data-i18n="dashboard_history_title">訓練歷史記錄</h3>
                        <button onclick="app.handlers.exportCSV()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1.5 px-3 rounded-lg text-sm transition" data-i18n="dashboard_export_csv">
                            匯出為 CSV
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="dashboard_history_date">日期</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="dashboard_history_score">分數</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="dashboard_history_passive">被動句%</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="dashboard_history_omission">遺漏率%</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="dashboard_history_bottleneck">瓶頸指數</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${app.state.history.map(entry => `
                                    <tr>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(entry.date).toLocaleDateString(app.state.language)}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">${entry.score.toFixed(1)}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${(entry.passiveRatio * 100).toFixed(1)}%</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${(entry.omissionRate * 100).toFixed(1)}%</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600">${entry.bottleneckIndex.toFixed(3)}</td>
                                    </tr>
                                `).reverse().join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        app.ui.renderWriting = () => {
            const { draft, isBlindMode, wordCount, missingVerbs } = app.state.writing;
            const timerDisplay = app.utils.formatTime(app.state.writing.timer);
            const blindClass = isBlindMode ? 'blind-mask' : '';

            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6" data-i18n="writing_title">IELTS Task 1 流程圖盲寫</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Flowchart and Timer Column -->
                    <div class="lg:col-span-1 space-y-6">
                        
                        <!-- Timer Card (T007) -->
                        <div class="card p-5 bg-indigo-600 text-white shadow-lg">
                            <p class="text-sm font-medium opacity-80" data-i18n="writing_timer">剩餘時間</p>
                            <div id="timer-display" class="text-5xl font-extrabold mt-1">${timerDisplay}</div>
                        </div>

                        <!-- Flowchart Display (T006) -->
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2 text-indigo-700" data-i18n="writing_flowchart_desc">當日流程圖</h3>
                            <div id="flowchart-container" class="${blindClass} transition duration-300">
                                ${app.data.flowchartSVG}
                            </div>
                            <button id="temp-view-btn" onclick="app.handlers.tempView()" class="mt-3 w-full bg-gray-100 text-gray-700 font-medium py-2 rounded-lg hover:bg-gray-200 transition text-sm ${isBlindMode ? '' : 'hidden'}" data-i18n="writing_temp_view">
                                暫時查看 (3s)
                            </button>
                        </div>
                    </div>

                    <!-- Writing Area Column -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- Blind Mode Toggle (T010) -->
                        <div class="card p-4 flex justify-between items-center bg-yellow-50 border-yellow-200">
                            <div>
                                <h3 class="text-lg font-semibold text-yellow-800" data-i18n="writing_blind_mode">盲寫模式</h3>
                                <p class="text-sm text-yellow-700" data-i18n="writing_blind_mode_desc">啟用後，流程圖和您的寫作將被模糊化。</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="blind-mode-toggle" class="sr-only peer" ${isBlindMode ? 'checked' : ''} onchange="app.handlers.toggleBlindMode(this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>

                        <!-- Textarea and Controls -->
                        <div class="card p-0">
                            <textarea id="writing-textarea" 
                                class="w-full h-80 p-4 text-lg border-none focus:ring-0 rounded-t-xl resize-none ${blindClass}" 
                                placeholder="${app.utils.i18n('writing_placeholder')}" 
                                oninput="app.handlers.handleWritingInput(this.value)"
                            >${draft}</textarea>
                            
                            <div class="p-4 border-t border-gray-100 flex justify-between items-center">
                                <div class="text-sm font-medium text-gray-600">
                                    <span data-i18n="writing_word_count">字數統計</span>: <span id="word-count">${wordCount}</span>
                                </div>
                                <button onclick="app.handlers.submitWriting()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition duration-150" data-i18n="writing_submit">
                                    提交寫作並診斷
                                </button>
                            </div>
                        </div>

                        <!-- Verb Check Warning (T009) -->
                        <div id="verb-check-warning" class="card p-4 bg-red-100 text-red-800 border-red-300 ${missingVerbs.length > 0 ? '' : 'hidden'}">
                            <p class="font-semibold mb-1" data-i18n="writing_verb_check_title">流程動詞檢查警告</p>
                            <p class="text-sm" data-i18n="writing_verb_check_missing">缺少關鍵動詞</p>: <span id="missing-verbs-list" class="font-mono text-red-900">${missingVerbs.join(', ')}</span>
                        </div>
                    </div>
                </div>
            `;
        };

        app.ui.renderReview = () => {
            const { originalText, comparisonHtml, omissionRate } = app.state.review;
            const { passiveRatio, estimatedScore, vocabUsage, feedback } = app.state.review.diagnosis;
            
            const isAnalyzed = estimatedScore > 0;
            const omissionRateDisplay = (omissionRate * 100).toFixed(1) + '%';
            
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6" data-i18n="review_title">語音回譯與 AI 診斷</h2>

                <!-- Step 1: Transcription (T011) -->
                <div class="card space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700" data-i18n="review_step1">步驟 1: 語音回譯</h3>
                    <p class="text-gray-600 text-sm" data-i18n="review_step1_desc">請朗讀您剛才寫的作文，系統將模擬轉錄。</p>
                    
                    <div class="flex space-x-4">
                        <button id="record-start-btn" onclick="app.handlers.simulateTranscription('start')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition duration-150 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 19.147A.5.5 0 013 18.707V18a3 3 0 016 0v.707a.5.5 0 01-.465.44zM16.535 19.147A.5.5 0 0117 18.707V18a3 3 0 00-6 0v.707a.5.5 0 01-.465.44z"/></svg>
                            <span data-i18n="review_start_recording">開始錄音</span>
                        </button>
                        <button id="record-stop-btn" onclick="app.handlers.simulateTranscription('stop')" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition duration-150" disabled>
                            <span data-i18n="review_stop_recording">停止並轉錄</span>
                        </button>
                    </div>

                    <div class="pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="review_transcribed_text">轉錄結果</label>
                        <textarea id="transcribed-textarea" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" readonly>${app.state.review.transcribedText}</textarea>
                    </div>
                    
                    <button onclick="app.handlers.analyzeOmission()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition duration-150 w-full" ${app.state.review.transcribedText ? '' : 'disabled'}>
                        <span data-i18n="review_step2">步驟 2: 執行差異分析</span>
                    </button>
                </div>

                <!-- Step 2: Comparison (T012) -->
                <div class="card space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700" data-i18n="review_step2">步驟 2: 差異分析</h3>
                    <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                        <span class="text-lg font-bold text-indigo-700" data-i18n="review_omission_rate">遺漏率</span>
                        <span id="omission-rate-display" class="text-2xl font-extrabold text-red-600">${omissionRateDisplay}</span>
                    </div>
                    
                    <p class="text-gray-600 text-sm" data-i18n="review_omission_desc">轉錄結果中遺漏的詞彙會高亮顯示。</p>
                    
                    <div id="comparison-output" class="p-4 border border-gray-300 rounded-lg min-h-[100px] bg-gray-50 leading-relaxed">
                        ${comparisonHtml || `<p class="text-gray-500 italic">Original writing: ${originalText.substring(0, 50)}...</p>`}
                    </div>
                </div>

                <!-- Step 3: AI Diagnosis (T008) -->
                <div class="card space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700" data-i18n="review_step3">步驟 3: AI 診斷</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-500" data-i18n="review_diagnosis_score">預估分數</p>
                            <p class="text-2xl font-bold text-green-600">${isAnalyzed ? estimatedScore.toFixed(1) : 'N/A'}</p>
                        </div>
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-500" data-i18n="review_diagnosis_passive">被動句比例 (目標 30%)</p>
                            <p class="text-2xl font-bold text-indigo-600">${isAnalyzed ? (passiveRatio * 100).toFixed(1) + '%' : 'N/A'}</p>
                        </div>
                    </div>

                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-inner">
                        <p class="font-semibold mb-2 text-gray-700" data-i18n="review_diagnosis_feedback">AI 性能反饋</p>
                        <p class="text-gray-800 whitespace-pre-wrap">${isAnalyzed ? feedback : app.utils.i18n('review_diagnosis_placeholder')}</p>
                    </div>
                </div>
            `;
        };

        // --- Event Handlers and Logic ---

        app.handlers.updateSetting = (key, value) => {
            app.state[key] = value;
            app.utils.saveState();
            if (key === 'targetScore') {
                app.router.renderView(); // Rerender dashboard if visible
            }
        };

        app.handlers.changeLanguage = (lang) => {
            app.state.language = lang;
            app.utils.saveState();
            app.utils.translateUI();
            app.router.renderView(); // Re-render to update complex templates
        };

        app.handlers.openSettings = () => {
            document.getElementById('api-key-input').value = app.state.apiKey;
            document.getElementById('target-score-input').value = app.state.targetScore;
            document.getElementById('language-select').value = app.state.language;
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-modal').classList.add('flex');
        };

        app.handlers.closeSettings = (event) => {
            if (!event || event.target.id === 'settings-modal') {
                document.getElementById('settings-modal').classList.add('hidden');
                document.getElementById('settings-modal').classList.remove('flex');
            }
        };


        // --- Timer Logic (T007) ---

        app.utils.formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        };

        app.handlers.updateTimerUI = () => {
            const display = document.getElementById('timer-display');
            if (display) {
                display.textContent = app.utils.formatTime(app.state.writing.timer);
                
                // Visual warning (T007)
                if (app.state.writing.timer <= 60 && app.state.writing.timer > 0) {
                    display.classList.add('text-yellow-300', 'animate-pulse');
                    if (app.state.writing.timer === 60) {
                        app.utils.showToast(app.utils.i18n('toast_timer_warning'), 'warning');
                    }
                } else {
                    display.classList.remove('text-yellow-300', 'animate-pulse');
                }
            }
        };

        app.handlers.startTimer = () => {
            if (app.state.writing.isRunning) return;
            
            app.state.writing.isRunning = true;
            app.state.writing.timerInterval = setInterval(() => {
                if (app.state.writing.timer > 0) {
                    app.state.writing.timer--;
                    app.handlers.updateTimerUI();
                    app.utils.saveState();
                } else {
                    app.handlers.stopTimer();
                    app.utils.showToast(app.utils.i18n('toast_timer_ended'), 'error');
                    app.handlers.submitWriting();
                }
            }, 1000);
        };

        app.handlers.stopTimer = () => {
            if (app.state.writing.timerInterval) {
                clearInterval(app.state.writing.timerInterval);
                app.state.writing.timerInterval = null;
                app.state.writing.isRunning = false;
            }
        };


        // --- Writing Logic (T009, T010) ---

        app.handlers.checkVerbs = (text) => {
            const usedVerbs = app.data.flowchartVerbs.filter(verb => 
                new RegExp(`\\b${verb}\\b`, 'i').test(text)
            );
            const missingVerbs = app.data.flowchartVerbs.filter(verb => 
                !usedVerbs.includes(verb)
            );
            app.state.writing.missingVerbs = missingVerbs;
            
            const warningDiv = document.getElementById('verb-check-warning');
            const listSpan = document.getElementById('missing-verbs-list');
            
            if (warningDiv && listSpan) {
                if (missingVerbs.length > 0) {
                    warningDiv.classList.remove('hidden');
                    listSpan.textContent = missingVerbs.join(', ');
                } else {
                    warningDiv.classList.add('hidden');
                }
            }
        };

        app.handlers.handleWritingInput = (value) => {
            app.state.writing.draft = value;
            app.state.writing.wordCount = value.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').textContent = app.state.writing.wordCount;
            app.handlers.checkVerbs(value);
            app.utils.saveState();
        };

        app.handlers.toggleBlindMode = (enabled) => {
            app.state.writing.isBlindMode = enabled;
            const textarea = document.getElementById('writing-textarea');
            const flowchart = document.getElementById('flowchart-container');
            const tempBtn = document.getElementById('temp-view-btn');

            if (textarea && flowchart) {
                if (enabled) {
                    textarea.classList.add('blind-mask');
                    flowchart.classList.add('blind-mask');
                    tempBtn.classList.remove('hidden');
                } else {
                    textarea.classList.remove('blind-mask');
                    flowchart.classList.remove('blind-mask');
                    tempBtn.classList.add('hidden');
                }
            }
            app.utils.saveState();
        };

        app.handlers.tempView = () => {
            if (!app.state.writing.isBlindMode) return;

            const textarea = document.getElementById('writing-textarea');
            const flowchart = document.getElementById('flowchart-container');
            const tempBtn = document.getElementById('temp-view-btn');

            textarea.classList.remove('blind-mask');
            flowchart.classList.remove('blind-mask');
            tempBtn.disabled = true;

            setTimeout(() => {
                textarea.classList.add('blind-mask');
                flowchart.classList.add('blind-mask');
                tempBtn.disabled = false;
            }, 3000);
        };

        app.handlers.submitWriting = async () => {
            const draft = app.state.writing.draft.trim();
            if (draft.length < 50) {
                app.utils.showToast(app.utils.i18n('toast_submission_fail'), 'error');
                return;
            }
            
            app.handlers.stopTimer();
            app.state.writing.isRunning = false;

            // Save original text for review
            app.state.review.originalText = draft;
            app.state.review.transcribedText = '';
            app.state.review.comparisonHtml = '';
            app.state.review.diagnosis = defaultState.review.diagnosis;
            app.state.review.omissionRate = 0;
            app.utils.saveState();
            
            // Navigate to review and prompt for transcription
            app.router.navigate('review');
            app.utils.showToast(app.utils.i18n('toast_submission_success'), 'success');
        };

        // --- Review Logic (T011, T012, T008) ---

        app.handlers.simulateTranscription = (action) => {
            const startBtn = document.getElementById('record-start-btn');
            const stopBtn = document.getElementById('record-stop-btn');
            const originalText = app.state.review.originalText;

            if (action === 'start') {
                if (!originalText) {
                    app.utils.showToast("Please submit a writing draft first.", 'warning');
                    return;
                }
                startBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.innerHTML = `<div class="loader mr-2"></div> Recording...`;
                app.utils.showToast(app.utils.i18n('toast_transcription_start'), 'info');

                // Simulate Web Speech API delay
                setTimeout(() => {
                    if (app.state.review.originalText) {
                        // Simulate omission and errors (T011)
                        const words = originalText.split(/\s+/);
                        let transcribed = words.map((word, index) => {
                            // Simulate 10% omission/error rate
                            if (Math.random() < 0.10) {
                                return ''; // Omit
                            }
                            if (Math.random() < 0.05) {
                                return word.toUpperCase(); // Error
                            }
                            return word;
                        }).join(' ').replace(/\s{2,}/g, ' ').trim();
                        
                        app.state.review.transcribedText = transcribed;
                        document.getElementById('transcribed-textarea').value = transcribed;
                        app.utils.saveState();
                        
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        startBtn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 19.147A.5.5 0 013 18.707V18a3 3 0 016 0v.707a.5.5 0 01-.465.44zM16.535 19.147A.5.5 0 0117 18.707V18a3 3 0 00-6 0v.707a.5.5 0 01-.465.44z"/></svg> ${app.utils.i18n('review_start_recording')}`;
                        app.utils.showToast(app.utils.i18n('toast_transcription_end'), 'success');
                        app.router.renderView(); // Re-render to enable analysis button
                    }
                }, 2500);
            }
        };

        app.handlers.analyzeOmission = async () => {
            const original = app.state.review.originalText.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            const transcribed = app.state.review.transcribedText.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");

            if (!original || !transcribed) return;

            const originalWords = original.split(/\s+/).filter(w => w.length > 0);
            const transcribedWords = transcribed.split(/\s+/).filter(w => w.length > 0);

            let comparisonHtml = '';
            let omittedCount = 0;
            let totalWords = originalWords.length;

            // Simple word-by-word comparison (T012)
            originalWords.forEach(word => {
                if (transcribedWords.includes(word)) {
                    comparisonHtml += word + ' ';
                    // Remove the first instance of the word from transcribedWords to prevent double counting
                    const index = transcribedWords.indexOf(word);
                    if (index > -1) {
                        transcribedWords.splice(index, 1);
                    }
                } else {
                    comparisonHtml += `<span class="omitted">${word}</span> `;
                    omittedCount++;
                }
            });

            const omissionRate = totalWords > 0 ? (omittedCount / totalWords) : 0;
            
            app.state.review.comparisonHtml = comparisonHtml;
            app.state.review.omissionRate = omissionRate;
            
            // Trigger AI Diagnosis (T008)
            const analysisResult = await app.utils.GeminiAPIWrapper.call('Analyze Writing Performance', {
                writing: app.state.review.originalText,
                wordCount: app.state.writing.wordCount,
                omissionRate: omissionRate,
            });

            app.state.review.diagnosis = analysisResult;

            // Record History (T014)
            const bottleneckIndex = app.utils.calculateBottleneckIndex(
                analysisResult.estimatedScore, 
                app.state.targetScore, 
                analysisResult.passiveRatio, 
                omissionRate
            );

            const historyEntry = {
                date: new Date().toISOString(),
                score: analysisResult.estimatedScore,
                passiveRatio: analysisResult.passiveRatio,
                omissionRate: omissionRate,
                bottleneckIndex: bottleneckIndex,
            };
            
            app.state.history.push(historyEntry);
            app.state.currentDay++; // Increment day counter
            app.utils.saveState();

            app.router.renderView(); // Re-render review page with results
        };

        // --- History and Export (T014) ---

        app.handlers.exportCSV = () => {
            const history = app.state.history;
            if (history.length === 0) {
                app.utils.showToast("No history to export.", 'warning');
                return;
            }

            const headers = [
                app.utils.i18n('dashboard_history_date'), 
                app.utils.i18n('dashboard_history_score'), 
                app.utils.i18n('dashboard_history_passive'), 
                app.utils.i18n('dashboard_history_omission'), 
                app.utils.i18n('dashboard_history_bottleneck')
            ].join(',');
            
            const rows = history.map(entry => [
                new Date(entry.date).toLocaleDateString(),
                entry.score.toFixed(1),
                (entry.passiveRatio * 100).toFixed(1) + '%',
                (entry.omissionRate * 100).toFixed(1) + '%',
                entry.bottleneckIndex.toFixed(3)
            ].join(','));

            const csvContent = [headers, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "IELTS_Coach_History.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                app.utils.showToast("CSV export successful.", 'success');
            }
        };

        // --- AI Tool Simulation ---
        app.handlers.simulateAITool = (tool) => {
            let message = '';
            if (tool === 'inspiration') {
                message = app.utils.i18n('dashboard_ai_inspiration') + ': Generating high-score ideas and academic vocabulary... (Simulated)';
            } else if (tool === 'rewriter') {
                message = app.utils.i18n('dashboard_ai_rewriter') + ': Rewriting essay to Band 9 level... (Simulated)';
            }
            app.utils.showToast(message, 'info');
        };


        // --- Initialization ---
        const init = () => {
            app.utils.loadState();
            app.utils.translateUI();
            
            // Set initial language selector value
            const langSelect = document.getElementById('language-select');
            if (langSelect) langSelect.value = app.state.language;
            
            app.router.renderView();
            
            // If draft exists and timer was running, restart timer
            if (app.state.writing.draft && app.state.writing.isRunning) {
                app.handlers.startTimer();
            }
        };
        
        document.addEventListener("DOMContentLoaded", init);

        // Standardized Test Hook
        window.injectTestRunner = function(runner) {
            // Allow external tools to access the app instance
            runner.app = app; 
            console.log("🧪 Test Runner Hook Injected");
        };
    </script>
</body>
</html>