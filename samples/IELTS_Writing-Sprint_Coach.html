<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">IELTS Writing Coach</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Utilities */
        .timer-font {
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
        }

        .dark-mode-transition {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .omission-mark {
            background-color: #fecaca;
            color: #b91c1c;
            text-decoration: underline;
            font-weight: 500;
            padding: 1px 2px;
            border-radius: 3px;
        }

        /* Card style mimicry */
        .app-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
        }

        .dark .app-card {
            background-color: #1f2937;
            border-color: #374151;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 dark-mode-transition">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Navigation -->
        <nav id="navbar"
            class="sticky top-0 z-40 bg-white/90 backdrop-blur-sm shadow-md dark:bg-gray-900/90 dark:border-gray-700 dark-mode-transition border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 cursor-pointer"
                            onclick="window.location.reload()" data-i18n="nav_title">IELTS Coach</h1>
                    </div>
                    <div class="flex items-center">
                        <div id="tabs" class="hidden sm:ml-6 sm:flex sm:space-x-4">
                            <button data-tab="sprint"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_sprint">5-Day Sprint</button>
                            <button data-tab="blind"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_blind">Blind Write-back</button>
                            <button data-tab="tools"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_tools">AI Tools</button>
                            <button data-tab="report"
                                class="tab-btn py-2 px-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                data-i18n="tab_report">Progress Report</button>
                        </div>
                        <button id="settings-btn"
                            class="ml-4 p-2 rounded-full text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-300 transition duration-150"
                            aria-label="Settings">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl w-full mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div id="content-container">
                <!-- Content injected here -->
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full dark-mode-transition">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
                            data-i18n="settings_title">Application Settings</h3>

                        <div class="space-y-4">
                            <!-- Language -->
                            <div>
                                <label for="language-select"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                    data-i18n="settings_language">Language</label>
                                <select id="language-select"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="en">English</option>
                                    <option value="zh">繁體中文</option>
                                </select>
                            </div>

                            <!-- Dark Mode -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"
                                    data-i18n="settings_dark_mode">Dark Mode</span>
                                <button id="dark-mode-toggle"
                                    class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-gray-200 dark:bg-indigo-600">
                                    <span
                                        class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 translate-x-0 dark:translate-x-5"></span>
                                </button>
                            </div>

                            <!-- API Key -->
                            <div>
                                <label for="api-key-input"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gemini API
                                    Key</label>
                                <input type="password" id="api-key-input"
                                    class="mt-1 block w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="SK-XXXXXXXXXXXXXX">
                            </div>

                            <!-- Danger Zone -->
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-md font-semibold text-red-600 mb-2" data-i18n="settings_danger">Danger
                                    Zone</h4>
                                <button id="clear-data-btn"
                                    class="w-full bg-red-100 text-red-700 font-semibold py-2 rounded-lg hover:bg-red-200 transition duration-150"
                                    data-i18n="settings_clear_data">Clear All Local Data</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="close-settings-btn"
                            class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm active:scale-95"
                            data-i18n="settings_close">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2 pointer-events-none">
            <!-- Toasts injected here -->
        </div>
    </div>

    <script>
        // GLOBAL CONSTANTS
        const STORAGE_KEY = 'IELTS_COACH_STATE_V2';
        const SPRINT_DURATION_SECONDS = 900; // 15 mins

        // I18N DICTIONARY
        const I18N = {
            en: {
                app_title: "IELTS Writing Coach", nav_title: "IELTS Coach",
                tab_sprint: "5-Day Sprint", tab_blind: "Blind Write-back", tab_tools: "AI Tools", tab_report: "Progress Report",
                settings_title: "Application Settings", settings_language: "Language", settings_dark_mode: "Dark Mode", settings_danger: "Danger Zone", settings_clear_data: "Clear All Local Data", settings_close: "Close",
                sprint_header: "IELTS 5-Day Verb Sprint", sprint_task_title: "Daily Task", sprint_topic: "Topic:", sprint_verbs: "Mandatory Verbs:",
                sprint_status_ready: "Ready", sprint_status_running: "Sprinting", sprint_status_paused: "Paused", sprint_status_finished: "Time Up",
                sprint_start: "Start Verb Sprint (15:00)", sprint_pause: "Pause", sprint_resume: "Resume", sprint_submit: "Submit Essay for Analysis", sprint_feedback_reset: "Start New Sprint Tomorrow",
                sprint_word_count: "Word Count", sprint_passive_mock: "Passive Ratio (Mock)",
                sprint_feedback_title: "AI Analysis Results", sprint_feedback_score: "Estimated Band Score", sprint_feedback_passive_ratio: "Precise Passive Ratio", sprint_feedback_passive_sentences: "Passive Sentences Identified", sprint_feedback_advanced_verbs: "Advanced Verbs Used",
                blind_header: "Blind Write-back System", blind_source_title: "Original Essay Source", blind_reveal: "Click to reveal and grade", blind_write_title: "Your Blind Rewrite", blind_grade: "Grade My Rewrite", blind_omission_rate: "Omission Rate", blind_diagnosis: "AI Diagnosis", blind_pass: "Excellent (Omission < 2%)", blind_fail: "Needs Improvement",
                tools_header: "Advanced AI Writing Tools", tool_inspiration_title: "AI Inspiration Generator", tool_inspiration_prompt: "Essay Topic:", tool_inspiration_generate: "Generate Inspiration",
                tool_analyzer_title: "AI Essay Analyzer", tool_analyzer_prompt: "Paste your essay here:", tool_analyzer_analyze: "Analyze Essay",
                tool_rewriter_title: "Band 9 Rewriter", tool_rewriter_prompt: "Paste your essay here:", tool_rewriter_rewrite: "Rewrite to Band 9",
                report_header: "Progress Report & Bottlenecks", report_bottleneck_title: "Bottleneck Index (Mock)", report_bottleneck_score: "Composite Weakness Score", report_bottleneck_advice: "AI Improvement Advice",
                report_history_title: "Recent Sprint History (Last 10)", report_history_date: "Date", report_history_omission: "Omission Rate", report_history_passive: "Passive Ratio", report_history_score: "Score",
                toast_error: "Error: ", toast_processing: "Processing...", toast_api_error: "API Error. Check key or network.", toast_sprint_submit_fail: "Please use all 6 mandatory verbs.", toast_blind_no_source: "No previous successful sprint found.", toast_sprint_finished: "Time is up! Essay locked."
            },
            zh: {
                app_title: "雅思寫作衝刺教練", nav_title: "雅思教練",
                tab_sprint: "5日動詞衝刺", tab_blind: "盲寫回譯", tab_tools: "AI 輔助工具", tab_report: "進度報告",
                settings_title: "應用程式設定", settings_language: "語言", settings_dark_mode: "深色模式", settings_danger: "危險區域", settings_clear_data: "清除所有本地數據", settings_close: "關閉",
                sprint_header: "雅思 5 日動詞衝刺系統", sprint_task_title: "每日任務", sprint_topic: "主題：", sprint_verbs: "必用動詞：",
                sprint_status_ready: "準備中", sprint_status_running: "衝刺中", sprint_status_paused: "已暫停", sprint_status_finished: "時間到",
                sprint_start: "開始動詞衝刺 (15:00)", sprint_pause: "暫停", sprint_resume: "繼續", sprint_submit: "提交作文進行分析", sprint_feedback_reset: "明日開始新的衝刺",
                sprint_word_count: "字數統計", sprint_passive_mock: "被動語態比例 (模擬)",
                sprint_feedback_title: "AI 分析結果", sprint_feedback_score: "預估雅思分數", sprint_feedback_passive_ratio: "精確被動語態比例", sprint_feedback_passive_sentences: "識別的被動句", sprint_feedback_advanced_verbs: "使用的高級動詞",
                blind_header: "盲寫回譯系統", blind_source_title: "原文來源", blind_reveal: "點擊揭示並評分", blind_write_title: "您的盲寫回譯", blind_grade: "評估我的回寫", blind_omission_rate: "遺漏率", blind_diagnosis: "AI 診斷", blind_pass: "優秀 (遺漏率 < 2%)", blind_fail: "需要改進",
                tools_header: "高級 AI 寫作工具", tool_inspiration_title: "AI 靈感助手", tool_inspiration_prompt: "作文主題：", tool_inspiration_generate: "生成靈感",
                tool_analyzer_title: "AI 文章分析器", tool_analyzer_prompt: "貼上您的作文：", tool_analyzer_analyze: "分析作文",
                tool_rewriter_title: "Band 9 高級改寫器", tool_rewriter_prompt: "貼上您的作文進行 Band 9 改寫：", tool_rewriter_rewrite: "改寫成 Band 9 範文",
                report_header: "進度報告與瓶頸分析", report_bottleneck_title: "瓶頸指數 (模擬)", report_bottleneck_score: "綜合弱點分數", report_bottleneck_advice: "AI 提升建議",
                report_history_title: "近期衝刺歷史 (最近 10 次)", report_history_date: "日期", report_history_omission: "遺漏率", report_history_passive: "被動比例", report_history_score: "分數",
                toast_error: "錯誤：", toast_processing: "處理中...", toast_api_error: "API 錯誤。請檢查 Key 或網路。", toast_sprint_submit_fail: "提交前請確保使用了所有 6 個必用動詞。", toast_blind_no_source: "找不到上次成功的衝刺作文作為原文。", toast_sprint_finished: "時間到！作文已鎖定。"
            }
        };

        // --- APP LOGIC ---
        let app = {
            state: {
                language: 'zh',
                darkMode: false,
                currentTab: 'sprint',
                apiKey: '',
                isProcessing: false,
                sprint: {
                    timer: SPRINT_DURATION_SECONDS,
                    status: 'ready',
                    intervalId: null,
                    taskDate: null,
                    topic: '',
                    mandatoryVerbs: [],
                    essay: '',
                    wordCount: 0,
                    passiveRatioMock: '0.0%',
                    analysisResult: null,
                },
                blind: {
                    sourceEssay: '',
                    rewriteEssay: '',
                    omissionRate: null,
                    isRevealed: false,
                    diagnosis: null,
                },
                history: [],
            },

            saveState() {
                try {
                    const stateToSave = JSON.parse(JSON.stringify(app.state));
                    stateToSave.sprint.intervalId = null; // Clean dirty state
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Save state failed:", e);
                }
            },

            loadState() {
                try {
                    const storedState = localStorage.getItem(STORAGE_KEY);
                    if (storedState) {
                        const loadedState = JSON.parse(storedState);
                        app.state = {
                            ...app.state,
                            ...loadedState,
                            sprint: { ...app.state.sprint, ...loadedState.sprint }, // Soft Merge
                            blind: { ...app.state.blind, ...loadedState.blind }, // Soft Merge
                        };
                        // Deep merge sprint verbs to ensure structure if reloading old state
                        if (loadedState.sprint && loadedState.sprint.mandatoryVerbs) {
                            app.state.sprint.mandatoryVerbs = loadedState.sprint.mandatoryVerbs;
                        }

                        if (!Array.isArray(app.state.history)) app.state.history = [];
                    }
                } catch (e) {
                    console.error("Load state failed, using default:", e);
                }
            },

            applyTranslations() {
                const lang = app.state.language;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (I18N[lang] && I18N[lang][key]) {
                        el.textContent = I18N[lang][key];
                    }
                });
                document.title = I18N[lang].app_title;
                app.updateUI();
            },

            toggleDarkMode(isDark) {
                app.state.darkMode = isDark === undefined ? !app.state.darkMode : isDark;
                document.documentElement.classList.toggle('dark', app.state.darkMode);
                // Sync button visual state (static HTML)
                const toggleBtn = document.getElementById('dark-mode-toggle');
                if (toggleBtn) {
                    toggleBtn.classList.toggle('bg-indigo-600', app.state.darkMode);
                    toggleBtn.classList.toggle('bg-gray-200', !app.state.darkMode);
                }
                app.saveState();
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500 text-white' : type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-600 text-white';

                toast.className = `p-4 rounded-lg shadow-xl ${colors} font-medium transition-all duration-300 transform translate-x-10 opacity-0 pointer-events-auto shadow-lg`;
                toast.textContent = message;

                container.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.classList.remove('translate-x-10', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                });

                setTimeout(() => {
                    toast.classList.add('translate-x-10', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },

            async performAction(action, ...args) {
                if (app.state.isProcessing) return;
                app.state.isProcessing = true;
                app.updateUI();

                try {
                    await action(...args);
                } catch (error) {
                    console.error("Action Error:", error);
                    app.showToast(`${I18N[app.state.language].toast_error} ${error.message}`, 'error');
                } finally {
                    app.state.isProcessing = false;
                    app.updateUI();
                }
            },

            // --- API Wrapper with Real Fetch ---

            async callAPI(prompt, structure = false) {
                const apiKey = app.state.apiKey ? app.state.apiKey.trim() : '';
                if (!apiKey) throw new Error("API Key missing");

                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

                let attempts = 0;
                const delays = [1000, 2000, 3000];

                while (attempts < 3) {
                    try {
                        app.showToast(I18N[app.state.language].toast_processing + ` (${attempts + 1}/3)`);
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: structure ? { responseMimeType: "application/json" } : {}
                            })
                        });

                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(`HTTP ${res.status}: ${err.error?.message || 'Unknown'}`);
                        }

                        const data = await res.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("Empty response");

                        return structure ? JSON.parse(text.replace(/```json\n?|\n?```/g, '').trim()) : text;
                    } catch (e) {
                        console.warn("API Fail:", e);
                        attempts++;
                        if (attempts >= 3) throw e;
                        await new Promise(r => setTimeout(r, delays[attempts - 1]));
                    }
                }
            },

            switchTab(tabName) {
                app.state.currentTab = tabName;
                app.saveState();
                app.renderContent();
            },

            renderContent() {
                const container = document.getElementById('content-container');
                // Tab Selection Visuals
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isActive = btn.dataset.tab === app.state.currentTab;
                    btn.classList.toggle('border-indigo-600', isActive);
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('dark:text-indigo-400', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                });

                // Routing
                switch (app.state.currentTab) {
                    case 'sprint':
                        container.innerHTML = app.renderSprintUI();
                        app.initSprintListeners();
                        app.generateDailyTask();
                        break;
                    case 'blind':
                        container.innerHTML = app.renderBlindWriteUI();
                        app.initBlindWriteListeners();
                        app.loadBlindWriteSource();
                        break;
                    case 'tools':
                        container.innerHTML = app.renderAIToolsUI();
                        app.initAIToolsListeners();
                        break;
                    case 'report':
                        container.innerHTML = app.renderProgressReportUI();
                        app.renderHistoryTable();
                        app.renderRadarChart();
                        break;
                }
                app.updateUI();
            },

            updateUI() {
                const processing = app.state.isProcessing;

                // 1. Handle Global Button Locking
                document.querySelectorAll('button').forEach(btn => {
                    if (['settings-btn', 'close-settings-btn', 'dark-mode-toggle'].includes(btn.id)) return;

                    if (processing) {
                        if (!btn.disabled) {
                            btn.setAttribute('disabled', 'true');
                            // Safe backup of innerHTML to preserve icons
                            if (!btn.dataset.lockedByProcess) {
                                btn.dataset.lockedByProcess = 'true';
                                btn.dataset.originalHtml = btn.innerHTML;
                                btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${I18N[app.state.language].toast_processing}`;
                            }
                        }
                    } else {
                        if (btn.dataset.lockedByProcess === 'true') {
                            btn.removeAttribute('disabled');
                            btn.innerHTML = btn.dataset.originalHtml || btn.textContent;
                            delete btn.dataset.lockedByProcess;
                            delete btn.dataset.originalHtml;
                        }
                    }
                });

                // 2. Component Specific Updates
                if (app.state.currentTab === 'sprint') app.updateSprintUI();
                if (app.state.currentTab === 'blind') app.updateBlindWriteUI();
            },

            // --- MODULE: SPRINT ---

            generateDailyTask() {
                const today = new Date().toISOString().split('T')[0];
                const s = app.state.sprint;
                if (s.taskDate === today && s.mandatoryVerbs.length > 0) {
                    app.updateSprintUI();
                    return;
                }
                // Mock Data Gen
                const verbs = ["articulate", "elucidate", "underscore", "mitigate", "exacerbate", "stipulate", "convey", "denote", "foster", "hinder", "catalyze", "diminish", "transcend", "bolster", "reiterate", "delineate", "substantiate"];
                const topics = [
                    "The role of technology in modern education and critical thinking.",
                    "International cooperation vs. national interests in climate change.",
                    "Government taxes on unhealthy food to combat obesity.",
                    "Social media's influence on democratic processes.",
                    "Remote work's impact on productivity and work-life balance."
                ];

                // Shuffle & Pick
                const selected = [];
                const pool = [...verbs];
                for (let i = 0; i < 6; i++) selected.push({ verb: pool.splice(Math.floor(Math.random() * pool.length), 1)[0], used: false });

                // Reset but keep certain fields if needed (here full reset of daily task)
                app.state.sprint = {
                    ...s,
                    timer: SPRINT_DURATION_SECONDS,
                    status: 'ready',
                    taskDate: today,
                    topic: topics[Math.floor(Math.random() * topics.length)],
                    mandatoryVerbs: selected,
                    essay: '',
                    wordCount: 0,
                    passiveRatioMock: '0.0%',
                    analysisResult: null
                };
                app.saveState();
                app.updateSprintUI();
            },

            startTimer() {
                if (app.state.sprint.status === 'running') return;
                app.state.sprint.status = 'running';
                app.state.sprint.intervalId = setInterval(() => {
                    const s = app.state.sprint;
                    if (s.timer <= 0) {
                        clearInterval(s.intervalId);
                        s.status = 'finished';
                        app.showToast(I18N[app.state.language].toast_sprint_finished, 'info');
                    } else {
                        s.timer--;
                    }
                    app.updateSprintUI();
                    app.saveState();
                }, 1000);
                app.updateSprintUI();
            },

            pauseTimer() {
                clearInterval(app.state.sprint.intervalId);
                app.state.sprint.status = 'paused';
                app.state.sprint.intervalId = null;
                app.saveState();
                app.updateSprintUI();
            },

            renderSprintUI() {
                const s = app.state.sprint;
                const lang = app.state.language;

                // Button Logic
                let btnHtml = '';
                if (s.status === 'running') btnHtml = `<button id="sprint-pause-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition" data-i18n="sprint_pause">${I18N[lang].sprint_pause}</button>`;
                else if (s.status === 'paused') btnHtml = `<button id="sprint-resume-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition" data-i18n="sprint_resume">${I18N[lang].sprint_resume}</button>`;
                else if (s.status === 'ready') btnHtml = `<button id="sprint-start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg active:scale-95 transition" data-i18n="sprint_start">${I18N[lang].sprint_start}</button>`;
                else btnHtml = `<button disabled class="w-full bg-gray-400 text-white font-semibold py-2.5 px-5 rounded-lg border border-gray-300 dark:border-gray-600" data-i18n="sprint_feedback_reset">${I18N[lang].sprint_feedback_reset}</button>`;

                // Submit Button Logic (Crucial Fix: Enabled even if finished, as long as not analyzed)
                const isAnalyzed = s.analysisResult !== null;
                const isSubmitLocked = isAnalyzed;
                // If finished but NOT analyzed, Submit IS available.
                const submitBtnHtml = isAnalyzed ?
                    `<button disabled class="w-full bg-green-800 text-white font-semibold py-2.5 rounded-lg opacity-70 cursor-not-allowed">${I18N[lang].sprint_submit} (Done)</button>` :
                    `<button id="sprint-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg active:scale-95 disabled:bg-gray-400 transition shadow-sm" ${isSubmitLocked ? 'disabled' : ''} data-i18n="sprint_submit">${I18N[lang].sprint_submit}</button>`;

                // Input is Locked only if Analyzed or Time Up? Specification says "Locked after time up". 
                // BUT User experience: if time up, you can't type, but you must submit.
                const isInputLocked = s.status === 'finished' || isAnalyzed;

                const verbList = s.mandatoryVerbs.map(v => `<li class="flex justify-between p-2 rounded ${v.used ? 'bg-green-100 dark:bg-green-900/30' : 'bg-gray-100 dark:bg-gray-700'}"><span class="${v.used ? 'line-through text-green-700 dark:text-green-400' : ''}">${v.verb}</span><span>${v.used ? '✅' : '⬜'}</span></li>`).join('');

                return `
                    <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-gray-100" data-i18n="sprint_header">${I18N[lang].sprint_header}</h2>
                    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="app-card text-center">
                                <p class="text-indigo-600 font-semibold" id="timer-status">${I18N[lang][`sprint_status_${s.status}`]}</p>
                                <div class="timer-font text-7xl font-extrabold my-4 ${s.timer < 60 && s.status === 'running' ? 'text-red-500' : 'dark:text-white'}" id="timer-display">${Math.floor(s.timer / 60).toString().padStart(2, '0')}:${(s.timer % 60).toString().padStart(2, '0')}</div>
                                ${btnHtml}
                            </div>
                            <div class="app-card">
                                <h3 class="font-bold border-b pb-2 mb-3 dark:border-gray-700">${I18N[lang].sprint_task_title}</h3>
                                <p class="text-sm font-medium text-gray-500">${I18N[lang].sprint_topic}</p>
                                <p class="font-bold text-indigo-700 dark:text-indigo-400 mb-4">${s.topic}</p>
                                <p class="text-sm font-medium text-gray-500">${I18N[lang].sprint_verbs}</p>
                                <ul class="space-y-1 mt-2 text-sm" id="verb-list">${verbList}</ul>
                            </div>
                            <div class="app-card grid grid-cols-2 gap-2 text-center">
                                <div><p class="text-xs text-gray-500">${I18N[lang].sprint_word_count}</p><p class="text-2xl font-bold dark:text-white" id="word-count">${s.wordCount}</p></div>
                                <div><p class="text-xs text-gray-500">${I18N[lang].sprint_passive_mock}</p><p class="text-2xl font-bold dark:text-white" id="passive-ratio">${s.passiveRatioMock}</p></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0 space-y-6">
                            <div class="app-card">
                                <textarea id="essay-input" rows="16" ${isInputLocked ? 'disabled' : ''} class="w-full p-4 border rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="Start typing...">${s.essay}</textarea>
                                <div class="mt-4">${submitBtnHtml}</div>
                            </div>
                            ${s.analysisResult ? this.renderAnalysis(s.analysisResult) : ''}
                        </div>
                    </div>
                `;
            },

            renderAnalysis(res) {
                return `
                    <div class="app-card border-l-4 border-indigo-500">
                        <h3 class="text-xl font-bold text-indigo-600 mb-4">${I18N[app.state.language].sprint_feedback_title}</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded"><p class="text-xs text-blue-600 font-bold uppercase">Band Score</p><p class="text-3xl font-black text-blue-800 dark:text-blue-200">${res.score}</p></div>
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded"><p class="text-xs text-blue-600 font-bold uppercase">Passive Ratio</p><p class="text-3xl font-black text-blue-800 dark:text-blue-200">${res.precisePassiveRatio}</p></div>
                        </div>
                        <div class="text-sm space-y-2">
                            <p><strong>Passive Sentences:</strong> <span class="text-gray-600 dark:text-gray-400 italic">${res.passiveSentences.join(' ')}</span></p>
                            <p><strong>Advanced Verbs:</strong> <span class="text-gray-600 dark:text-gray-400">${res.advancedVerbs.map(v => v.verb).join(', ')}</span></p>
                        </div>
                    </div>
                 `;
            },

            updateSprintUI() {
                const s = app.state.sprint;
                const elTimer = document.getElementById('timer-display');
                if (elTimer) {
                    elTimer.textContent = `${Math.floor(s.timer / 60).toString().padStart(2, '0')}:${(s.timer % 60).toString().padStart(2, '0')}`;
                    elTimer.className = `timer-font text-7xl font-extrabold my-4 ${s.timer < 60 && s.status === 'running' ? 'text-red-500' : 'dark:text-white'}`;
                }
                const elStatus = document.getElementById('timer-status');
                if (elStatus) elStatus.textContent = I18N[app.state.language][`sprint_status_${s.status}`];

                // Live update inputs disable state only if changed to avoid focus loss (though rare here)
                const isInputLocked = s.status === 'finished' || s.analysisResult !== null;
                const elInput = document.getElementById('essay-input');
                if (elInput && elInput.disabled !== isInputLocked) elInput.disabled = isInputLocked;

                // Submit button lock state
                const elSubmit = document.getElementById('sprint-submit-btn');
                const isSubmitLocked = s.analysisResult !== null;
                if (elSubmit) elSubmit.disabled = isSubmitLocked;
            },

            initSprintListeners() {
                const container = document.getElementById('content-container');
                // Use delegation for buttons
                container.onclick = (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    if (btn.id === 'sprint-start-btn') app.startTimer();
                    if (btn.id === 'sprint-pause-btn') app.pauseTimer();
                    if (btn.id === 'sprint-resume-btn') app.startTimer();
                    if (btn.id === 'sprint-submit-btn') app.handleSprintSubmission();
                };
                // Input needs direct binding for realtime updates
                const input = document.getElementById('essay-input');
                if (input) input.oninput = (e) => {
                    const txt = e.target.value;
                    const s = app.state.sprint;
                    s.essay = txt;
                    const w = txt.match(/\b\w+\b/g) || [];
                    s.wordCount = w.length;
                    s.passiveRatioMock = (Math.min(15, w.length / 20)).toFixed(1) + '%';
                    s.mandatoryVerbs.forEach(v => v.used = new RegExp(`\\b${v.verb}\\b`, 'i').test(txt));
                    app.saveState();
                    // Refined update: only update specific text nodes to avoid redraw
                    document.getElementById('word-count').textContent = s.wordCount;
                    document.getElementById('passive-ratio').textContent = s.passiveRatioMock;
                    document.getElementById('verb-list').innerHTML = s.mandatoryVerbs.map(v => `<li class="flex justify-between p-2 rounded ${v.used ? 'bg-green-100 dark:bg-green-900/30' : 'bg-gray-100 dark:bg-gray-700'}"><span class="${v.used ? 'line-through text-green-700 dark:text-green-400' : ''}">${v.verb}</span><span>${v.used ? '✅' : '⬜'}</span></li>`).join('');
                };
            },

            async handleSprintSubmission() {
                const s = app.state.sprint;
                // Allow finish state to submit
                if (s.status !== 'finished' && s.timer > 0) app.pauseTimer();

                if (!s.mandatoryVerbs.every(v => v.used)) {
                    app.showToast(I18N[app.state.language].toast_sprint_submit_fail, 'error');
                    return;
                }

                await app.performAction(async () => {
                    const prompt = `Analyze Essay details to JSON: ${s.essay}`;
                    // Call Real API (API wrapper integrated into app object in refined version)
                    const res = await app.callAPI(prompt, true);
                    s.analysisResult = res;
                    app.state.history.unshift({
                        date: s.taskDate,
                        words: s.wordCount,
                        passiveRatio: res.precisePassiveRatio,
                        score: res.score,
                        omissionRate: null,
                        essay: s.essay
                    });
                    app.state.history = app.state.history.slice(0, 10);
                    app.saveState();
                    app.renderContent(); // Full re-render to show analysis results
                    app.showToast('Analysis Complete', 'success');
                });
            },

            // --- MODULE: BLIND WRITE ---
            renderBlindWriteUI() {
                const b = app.state.blind;
                const lang = app.state.language;
                const mask = b.isRevealed ? '' : 'bg-gray-900 text-transparent select-none';
                // Using text-transparent + select-none is safer than opacity for "hiding" text while keeping layout
                // But specifications asked for overlay.
                const overlay = !b.isRevealed ? `<div class="absolute inset-0 flex items-center justify-center bg-gray-800 rounded-lg"><button id="reveal-btn" class="bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700">${I18N[lang].blind_reveal}</button></div>` : '';

                // Diff Logic for Display
                let displayHTML = b.sourceEssay;
                if (b.isRevealed && b.omissionRate) {
                    // Simple diff highlighting
                    const res = this.calculateDiff(b.sourceEssay, b.rewriteEssay);
                    displayHTML = res.html;
                }

                return `
                    <h2 class="text-3xl font-bold mb-6 dark:text-white" data-i18n="blind_header">${I18N[lang].blind_header}</h2>
                    <div class="lg:grid lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="app-card relative min-h-[400px]">
                                <h3 class="font-bold border-b pb-2 mb-4 dark:border-gray-700">${I18N[lang].blind_source_title}</h3>
                                ${overlay}
                                <div class="whitespace-pre-wrap dark:text-gray-300 ${!b.isRevealed ? 'opacity-0' : ''}">${displayHTML}</div>
                            </div>
                            <!-- Result Card -->
                            ${b.omissionRate ? `<div class="app-card border-l-4 ${b.omissionRate < 2 ? 'border-green-500' : 'border-red-500'}">
                                <p class="text-lg font-bold">${I18N[lang].blind_omission_rate}: <span class="text-2xl">${b.omissionRate}%</span></p>
                                <p class="text-sm mt-2 text-gray-600 dark:text-gray-400">${b.diagnosis}</p>
                            </div>` : ''}
                        </div>
                        <div class="app-card">
                            <h3 class="font-bold border-b pb-2 mb-4 dark:border-gray-700">${I18N[lang].blind_write_title}</h3>
                            <textarea id="rewrite-input" class="w-full h-[400px] p-4 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white resize-none" placeholder="Memorize/Rewrite...">${b.rewriteEssay}</textarea>
                            <button id="grade-btn" class="w-full mt-4 bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 font-bold shadow">${I18N[lang].blind_grade}</button>
                        </div>
                    </div>
                `;
            },

            initBlindWriteListeners() {
                const input = document.getElementById('rewrite-input');
                if (input) input.oninput = (e) => { app.state.blind.rewriteEssay = e.target.value; app.saveState(); };

                const gradBtn = document.getElementById('grade-btn');
                if (gradBtn) gradBtn.onclick = () => app.performAction(async () => {
                    const b = app.state.blind;
                    if (!b.isRevealed) { b.isRevealed = true; app.renderContent(); return; }
                    const diff = this.calculateDiff(b.sourceEssay, b.rewriteEssay);
                    b.omissionRate = diff.rate;
                    // AI Call
                    const prompt = `Diagnose memorization errors. Original: "${b.sourceEssay.slice(0, 50)}..." Rewrite: "${b.rewriteEssay.slice(0, 50)}..."`;
                    b.diagnosis = await app.callAPI(prompt);
                    app.saveState();
                    app.renderContent();
                });

                const revBtn = document.getElementById('reveal-btn');
                if (revBtn) revBtn.onclick = () => { app.state.blind.isRevealed = true; app.renderContent(); };
            },

            loadBlindWriteSource() {
                if (!app.state.blind.sourceEssay || app.state.blind.sourceEssay.startsWith("No previous")) {
                    const last = app.state.history[0];
                    app.state.blind.sourceEssay = last ? last.essay : I18N[app.state.language].toast_blind_no_source;
                }
            },

            calculateDiff(original, rewrite) {
                // Simplified Diff for Demo
                const ow = original.split(/\s+/);
                const rw = rewrite.split(/\s+/);
                let missing = 0;
                const html = ow.map(w => {
                    if (rewrite.indexOf(w) === -1) { missing++; return `<span class="omission-mark">${w}</span>`; }
                    return w;
                }).join(' ');
                return { html, rate: ((missing / ow.length) * 100).toFixed(1) };
            },

            // --- MODULE: TOOLS ---
            renderAIToolsUI() {
                const lang = app.state.language;
                const tools = [
                    { id: 'inspiration', title: 'tool_inspiration_title', prompt: 'tool_inspiration_prompt', btn: 'tool_inspiration_generate' },
                    { id: 'analyzer', title: 'tool_analyzer_title', prompt: 'tool_analyzer_prompt', btn: 'tool_analyzer_analyze' },
                    { id: 'rewriter', title: 'tool_rewriter_title', prompt: 'tool_rewriter_prompt', btn: 'tool_rewriter_rewrite' }
                ];
                return `<h2 class="text-3xl font-bold mb-6 dark:text-white" data-i18n="tools_header">${I18N[lang].tools_header}</h2>
                <div class="grid lg:grid-cols-3 gap-6">
                    ${tools.map(t => `
                        <div class="app-card flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-2 text-indigo-600 dark:text-indigo-400" data-i18n="${t.title}">${I18N[lang][t.title]}</h3>
                            <label class="text-xs font-semibold text-gray-500 mb-2" data-i18n="${t.prompt}">${I18N[lang][t.prompt]}</label>
                            <textarea id="${t.id}-input" class="flex-grow p-3 border rounded mb-4 dark:bg-gray-700 dark:border-gray-600 dark:text-white resize-none h-32"></textarea>
                            <button class="tool-run-btn w-full bg-indigo-50 text-indigo-700 border border-indigo-200 py-2 rounded hover:bg-indigo-100 font-medium" data-id="${t.id}" data-i18n="${t.btn}">${I18N[lang][t.btn]}</button>
                            <div id="${t.id}-output" class="mt-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded min-h-[100px] text-sm whitespace-pre-wrap"></div>
                        </div>
                    `).join('')}
                </div>`;
            },

            initAIToolsListeners() {
                document.querySelectorAll('.tool-run-btn').forEach(btn => {
                    btn.onclick = () => app.performAction(async () => {
                        const id = btn.dataset.id;
                        const val = document.getElementById(`${id}-input`).value.trim();
                        if (!val) throw new Error("Input empty");
                        const output = document.getElementById(`${id}-output`);
                        let prompt = id === 'inspiration' ? `Idea generation for: ${val}` : id === 'rewriter' ? `Rewrite efficiently: ${val}` : `Analyze: ${val}`;
                        const isJson = id !== 'rewriter';
                        const res = await app.callAPI(prompt, isJson);
                        output.innerHTML = isJson ? JSON.stringify(res, null, 2) : res;
                    });
                });
            },

            // --- MODULE: REPORT ---
            renderProgressReportUI() {
                const lang = app.state.language;
                return `
                    <h2 class="text-3xl font-bold mb-6 dark:text-white" data-i18n="report_header">${I18N[lang].report_header}</h2>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 app-card">
                            <h3 class="font-bold mb-4">Performance Radar</h3>
                            <div id="radar-chart-container" class="h-64 flex justify-center"></div>
                             <div class="mt-6 border-t pt-4">
                                <h4 class="font-bold text-red-600">Bottleneck Analysis</h4>
                                <ul class="list-disc ml-4 mt-2 text-sm text-gray-600 dark:text-gray-300">
                                   ${app.calculateBottlenecks().map(b => `<li>${b}</li>`).join('')}
                                </ul>
                             </div>
                        </div>
                        <div class="app-card">
                             <h3 class="font-bold mb-4">${I18N[lang].report_history_title}</h3>
                             <div class="overflow-y-auto max-h-[500px]">
                                 <table class="w-full text-sm text-left">
                                     <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">Date</th><th class="p-2">Score</th><th class="p-2">Omission</th></tr></thead>
                                     <tbody>
                                         ${app.state.history.slice(0, 10).map(h => `
                                            <tr class="border-b dark:border-gray-700">
                                                <td class="p-2">${h.date}</td>
                                                <td class="p-2 font-bold">${h.score || '-'}</td>
                                                <td class="p-2 ${h.omissionRate > 2 ? 'text-red-500' : 'text-green-500'}">${h.omissionRate || '-'}%</td>
                                            </tr>
                                         `).join('')}
                                     </tbody>
                                 </table>
                             </div>
                        </div>
                    </div>
                `;
            },

            renderRadarChart() {
                const container = document.getElementById('radar-chart-container');
                if (!container) return;
                const h = app.state.history;
                if (!h.length) { container.innerHTML = "<p class='self-center text-gray-400'>No Data</p>"; return; }

                // Dynamic Data
                const avgScore = h.reduce((a, b) => a + (parseFloat(b.score) || 0), 0) / h.length;
                const avgOmission = h.reduce((a, b) => a + (parseFloat(b.omissionRate) || 0), 0) / h.length;

                // Axis: 0:Task(Score), 1:Struct(Mock), 2:Vocab(Omission), 3:Cohere(Mock)
                const data = [
                    Math.min(10, avgScore),
                    7.5, // Mock Structure
                    Math.max(0, 10 - avgOmission), // Vocab inv prop to omission
                    8.0  // Mock Cohesion
                ];

                const size = 250, cx = 125, cy = 125, r = 100;
                const pts = data.map((val, i) => {
                    const ang = (Math.PI / 2) * i;
                    const len = (val / 10) * r;
                    return `${cx + len * Math.cos(ang)},${cy + len * Math.sin(ang)}`;
                }).join(' ');

                container.innerHTML = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#ddd" />
                    <circle cx="${cx}" cy="${cy}" r="${r * 0.5}" fill="none" stroke="#eee" />
                    <line x1="${cx}" y1="${cy}" x2="${cx + r}" y2="${cy}" stroke="#eee" />
                    <line x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy + r}" stroke="#eee" />
                    <line x1="${cx}" y1="${cy}" x2="${cx - r}" y2="${cy}" stroke="#eee" />
                    <line x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy - r}" stroke="#eee" />
                    <polygon points="${pts}" fill="rgba(79, 70, 229, 0.5)" stroke="#4f46e5" stroke-width="2" />
                    <text x="${cx + r + 5}" y="${cy}" font-size="10" alignment-baseline="middle">Score</text>
                    <text x="${cx}" y="${cy + r + 10}" font-size="10" text-anchor="middle">Structure</text>
                    <text x="${cx - r - 5}" y="${cy}" font-size="10" text-anchor="end" alignment-baseline="middle">Vocab</text>
                    <text x="${cx}" y="${cy - r - 5}" font-size="10" text-anchor="middle">Cohesion</text>
                </svg>`;
            },

            calculateBottlenecks() {
                const h = app.state.history;
                if (!h.length) return ["Not enough data"];
                const advice = [];
                if (h.length < 3) advice.push("Complete more sprints to get detailed analysis");
                // Simple logic
                if (h.some(x => x.score < 6)) advice.push("Review band descriptors for Task Response < 6");
                return advice;
            },

            // --- INITIALIZATION ---
            init() {
                app.loadState();
                app.toggleDarkMode(app.state.darkMode);

                // Bind Global Elements
                document.getElementById('api-key-input').value = app.state.apiKey;
                document.getElementById('language-select').value = app.state.language;

                // Settings DOM Events
                const setModal = document.getElementById('settings-modal');
                document.getElementById('settings-btn').onclick = () => setModal.classList.remove('hidden');
                document.getElementById('close-settings-btn').onclick = () => setModal.classList.add('hidden');
                setModal.onclick = (e) => { if (e.target === setModal || e.target.classList.contains('bg-opacity-75')) setModal.classList.add('hidden'); };

                document.getElementById('dark-mode-toggle').onclick = () => app.toggleDarkMode();
                document.getElementById('language-select').onchange = (e) => { app.state.language = e.target.value; app.saveState(); app.applyTranslations(); app.renderContent(); };
                document.getElementById('api-key-input').oninput = (e) => { app.state.apiKey = e.target.value.trim(); app.saveState(); };
                document.getElementById('clear-data-btn').onclick = () => { if (confirm("Clear all data?")) { localStorage.removeItem(STORAGE_KEY); window.location.reload(); } };

                // Nav Tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.onclick = (e) => app.switchTab(e.target.dataset.tab));

                app.applyTranslations();
                app.renderContent();

                // Resume Timer if needed
                if (app.state.sprint.status === 'running') app.startTimer();
            }
        };

        document.addEventListener("DOMContentLoaded", app.init);
    </script>
</body>

</html>